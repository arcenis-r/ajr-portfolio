<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Arcenis Rojas">
<meta name="dcterms.date" content="2024-01-24">

<title>Arcenis Rojas - Introduction to cepumd</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Arcenis Rojas</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Personal Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../dashboards.html"> 
<span class="menu-text">Dashboards</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/arcenisrojas" target="_blank"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/arcenis-r" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#motivation" id="toc-motivation" class="nav-link active" data-scroll-target="#motivation">Motivation</a></li>
  <li><a href="#overview-of-the-ce-and-ce-pumd" id="toc-overview-of-the-ce-and-ce-pumd" class="nav-link" data-scroll-target="#overview-of-the-ce-and-ce-pumd">Overview of the CE and CE PUMD</a></li>
  <li><a href="#challenges-addressed-by-cepumd" id="toc-challenges-addressed-by-cepumd" class="nav-link" data-scroll-target="#challenges-addressed-by-cepumd">Challenges addressed by cepumd</a></li>
  <li><a href="#cautions-and-recommendations" id="toc-cautions-and-recommendations" class="nav-link" data-scroll-target="#cautions-and-recommendations">Cautions and recommendations</a></li>
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#key-cepumd-functions" id="toc-key-cepumd-functions" class="nav-link" data-scroll-target="#key-cepumd-functions">Key cepumd functions</a></li>
  <li><a href="#example-workflows" id="toc-example-workflows" class="nav-link" data-scroll-target="#example-workflows">Example workflows</a>
  <ul class="collapse">
  <li><a href="#simple-workflow-integrated-pet-expenditures" id="toc-simple-workflow-integrated-pet-expenditures" class="nav-link" data-scroll-target="#simple-workflow-integrated-pet-expenditures">Simple workflow: Integrated pet expenditures</a></li>
  <li><a href="#slightly-more-advanced-workflow-used-car-truck-expenditures-by-urbanicity" id="toc-slightly-more-advanced-workflow-used-car-truck-expenditures-by-urbanicity" class="nav-link" data-scroll-target="#slightly-more-advanced-workflow-used-car-truck-expenditures-by-urbanicity">Slightly more advanced workflow: Used Car &amp; Truck Expenditures by Urbanicity</a></li>
  <li><a href="#very-advanced-workflow-inflation-adjusted-food-away-from-home-expenditures-by-household-size" id="toc-very-advanced-workflow-inflation-adjusted-food-away-from-home-expenditures-by-household-size" class="nav-link" data-scroll-target="#very-advanced-workflow-inflation-adjusted-food-away-from-home-expenditures-by-household-size">Very advanced workflow: Inflation adjusted food away from home expenditures by household size</a></li>
  <li><a href="#dealing-with-inconsistent-code-definitions" id="toc-dealing-with-inconsistent-code-definitions" class="nav-link" data-scroll-target="#dealing-with-inconsistent-code-definitions">Dealing with inconsistent code definitions</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Introduction to cepumd</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">Package Development</div>
    <div class="quarto-category">Data Wrangling</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Arcenis Rojas </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 24, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<div data-layout="[35, 65]">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/cepumd.png" class="img-fluid quarto-figure quarto-figure-center figure-img" alt="cepumd hexsticker" width="300"></p>
</figure>
</div>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[35, 65]">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 35.0%;justify-content: flex-start;">
<p>The purpose of <code>cepumd</code> is to make working with Consumer Expenditure Surveys (CE) Public-Use Microdata (PUMD) easier toward calculating mean, weighted, annual expenditures (henceforth “mean expenditures”). The challenges <code>cepumd</code> seeks to address deal primarily with pulling together the necessary data toward this end. Some of the overarching ideas underlying the package are as follows:</p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 65.0%;justify-content: flex-start;">
<ul>
<li><p>Use a <a href="https://www.tidyverse.org/">Tidyverse</a> framework for most operations and be (hopefully) generally <a href="https://www.tidyverse.org/">Tidyverse</a> friendly</p></li>
<li><p>Balance the effort to make the end user’s experience with CE PUMD easier while being flexible enough to allow that user to perform any analysis with the data they wish</p></li>
<li><p>Only designed to help users calculate mean <strong>expenditures</strong> on and of the consumer unit (CU), i.e., not income, not assets, not liabilities, not gifts.</p></li>
</ul>
</div>
</div>
</div>
</div>
</section>
<section id="overview-of-the-ce-and-ce-pumd" class="level2">
<h2 class="anchored" data-anchor-id="overview-of-the-ce-and-ce-pumd">Overview of the CE and CE PUMD</h2>
<p>First a little history…</p>
<p>The first Consumer Expenditure Survey happened in 1888 (<a href="https://www.bls.gov/opub/hom/cex/history.htm" class="uri">https://www.bls.gov/opub/hom/cex/history.htm</a>), it was first used to revise CPI weights in 1972-1973, and it has been collected on a monthly basis since 1979. For a little bit more detail on the history of the CE, check out the slide deck of a presentation delivered by Steve Henderson (former Chief of the Branch of Information and Analysis) and Adam Safir (current Division Chief of CE) called <a href="https://www.bls.gov/cex/ce-130-presentation-safir-henderson.pdf">130 Years of the Consumer Expenditure Surveys (CE): 1888 - 2018</a></p>
<p>From the CE home page:</p>
<blockquote class="blockquote">
<p>“The Consumer Expenditure Surveys (CE) program provides data on expenditures, income, and demographic characteristics of consumers in the United States. The CE program provides these data in tables, LABSTAT database, news releases, reports, and public use microdata files.</p>
</blockquote>
<blockquote class="blockquote">
<p>CE data are collected by the Census Bureau for BLS in two surveys, the Interview Survey for major and/or recurring items and the Diary Survey for more minor or frequently purchased items. CE data are primarily used to revise the relative importance of goods and services in the market basket of the Consumer Price Index. The CE is the only Federal household survey to provide information on the complete range of consumers’ expenditures and incomes. Here is an overview of the CE program and its methods.”</p>
</blockquote>
<p>Some important things to note are that expenditure data are collected through two different survey instruments (Diary and Interview), expenditure categories are organized hierarchically, and data are stored across thousands of files to which the CE provides access through their website. Also, given the length of the program, it would be difficult to harmonize data across all those years and files, so there are some inconsistencies in the way data are stored, which <code>cepumd</code> seeks to address (more on this further down).</p>
<p>Please visit the following pages to learn more about the CE program overall and CE PUMD more specifically.</p>
<ul>
<li>CE homepage: (<a href="https://www.bls.gov/cex/)" class="uri">https://www.bls.gov/cex/)</a></li>
<li>CE PUMD page: (<a href="https://www.bls.gov/cex/pumd.htm)" class="uri">https://www.bls.gov/cex/pumd.htm)</a></li>
<li>CE PUMD Getting Started Guide: <a href="https://www.bls.gov/cex/pumd-getting-started-guide.htm" class="uri">https://www.bls.gov/cex/pumd-getting-started-guide.htm</a></li>
<li>CE Dictionary for Interview and Diary Surveys (XLSX download) (<a href="https://www.bls.gov/cex/pumd/ce_pumd_interview_diary_dictionary.xlsx)" class="uri">https://www.bls.gov/cex/pumd/ce_pumd_interview_diary_dictionary.xlsx)</a></li>
<li>CE PUMD published tables: (<a href="https://www.bls.gov/cex/tables.htm)" class="uri">https://www.bls.gov/cex/tables.htm)</a></li>
<li>CE PUMD Handbook of Methods: <a href="https://www.bls.gov/opub/hom/cex/" class="uri">https://www.bls.gov/opub/hom/cex/</a></li>
<li>CE Frequently Asked Questions: <a href="https://www.bls.gov/cex/csxfaqs.htm" class="uri">https://www.bls.gov/cex/csxfaqs.htm</a></li>
</ul>
</section>
<section id="challenges-addressed-by-cepumd" class="level2">
<h2 class="anchored" data-anchor-id="challenges-addressed-by-cepumd">Challenges addressed by cepumd</h2>
<p><code>cepumd</code> seeks to address challenges in three categories: data gathering/organization; managing data inconsistencies; and calculating weighted, annual metrics.</p>
<ul>
<li><strong>Data wrangling</strong>
<ul>
<li>Convert hierarchical grouping (HG) files to data tables using <code>ce_hg()</code></li>
<li>Help the user identify the Universal Classification Codes (UCCs) related to their analysis using a combination of <code>ce_hg()</code> and <code>ce_uccs()</code></li>
<li>Combine all required files and variables using <code>ce_prepdata()</code></li>
</ul></li>
<li><strong>Managing data inconsistencies</strong>
<ul>
<li>Provide the ability to re-code variable categories using the CE Dictionary for Interview and Diary Surveys</li>
<li>Resolve some inconsistencies such as differences code definitions between the Interview and Diary (check the definitions of the “FAM_TYPE” variable categories in 2015 for an example)</li>
<li>Provide useful errors or warnings when there are multiple categories of something the user is trying to access, e.g., some titles in the hierarchical grouping files (“stub” or “HG” files) repeat and requires more careful selection of UCCs</li>
</ul></li>
<li><strong>Calculating weighted, annual metrics</strong>
<ul>
<li>Calculate a mean expenditure with <code>ce_mean()</code> or expenditure quantile with <code>ce_quantile()</code></li>
<li>Account for the factor (annual vs.&nbsp;quarterly expenditure)</li>
<li>Account for the “months in scope” of a given consumer unit (CU)</li>
<li>Annualize expenditures for either Diary or Interview expenditures</li>
<li>Integrate Interview and Diary data as necessary</li>
</ul></li>
</ul>
<p>Source code and other package information is available at <a href="https://github.com/arcenis-r/cepumd" class="uri">https://github.com/arcenis-r/cepumd</a></p>
</section>
<section id="cautions-and-recommendations" class="level2">
<h2 class="anchored" data-anchor-id="cautions-and-recommendations">Cautions and recommendations</h2>
<ul>
<li><p>Estimates produced using PUMD, which is top-coded by the CE and has some records suppressed to protect respondent confidentiality, will not match the published estimates released by the CE in most cases. The CE’s published estimates are based on confidential data that are not top-coded nor have records suppressed. You can learn more at <a href="https://www.bls.gov/cex/pumd_disclosure.htm">CE Protection of Respondent Confidentiality</a>.</p></li>
<li><p>When calculating estimates for sub-samples or cross-sections of data it is best to stick to the combinations of variables that the CE uses in it’s publication tables, e.g., income, geography, composition of CU, size of CU. This is because CE data are collected using a <a href="https://www.bls.gov/opub/hom/cex/design.htm">stratified, random sample</a> (a.k.a., “representative sample”) and only analyses conducted using the stratification variables are statistically valid. Using other variables can be helpful to understand spending across different groups, but unweighted estimates are likely more useful for this. <code>cepumd</code> currently does not support unweighted estimates, but data for such an analysis can be prepared using <code>ce_prepdata()</code>.</p></li>
<li><p>Quantiles should only be generated using data from 1 survey instrument as the samples for the Interview and Diary are different.</p></li>
<li><p>Check the expenditure category in the appropriate HG file to ensure that it is the category for which you intend to generate an estimate.</p></li>
<li><p>Store an HG object in the environment and call that directly in <code>ce_prepdata()</code>.</p></li>
</ul>
</section>
<section id="installation" class="level2">
<h2 class="anchored" data-anchor-id="installation">Installation</h2>
<p>You can install the development version of <code>cepumd</code> from its <a href="https://github.com/arcenis-r/cepumd">GitHub repo</a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pak<span class="sc">::</span><span class="fu">pkg_install</span>(<span class="st">"arcenis-r/cepumd"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="key-cepumd-functions" class="level2">
<h2 class="anchored" data-anchor-id="key-cepumd-functions">Key cepumd functions</h2>
<ul>
<li><p>The workhorse of <code>cepumd</code> is <code>ce_prepdata()</code>. It merges the household characteristics file (FMLI/-D) with the corresponding expenditure tabulation file (MTBI/EXPD) for a specified year, adjusts weights for months-in-scope and the number of collection quarters, adjusts some cost values by their periodicity factor (some cost categories are represented as annual figures and others as quarterly). With the recent update it only requires the first 3 arguments to function: the year, the survey type, and one or more valid UCCs. <code>ce_prepdata()</code> now creates all of the other necessary objects within the function if not provided.</p></li>
<li><p>There are two functions for wrangling hierarchical grouping data into more usable formats:</p>
<ul>
<li><code>ce_hg()</code> pulls the requested type of HG file (Interview, Diary, or Integrated) for a specified year.</li>
<li><code>ce_uccs()</code> filters the HG file for the specified expenditure category and returns either a data frame with only that section of the HG file or the Universal Classification Codes (UCCs) that make up that expenditure category.</li>
</ul></li>
<li><p>There are two functions that the user can use to calculate CE summary statistics:</p>
<ul>
<li><code>ce_mean()</code> calculates a mean expenditure, standard error of the mean, coefficient of variation, and an aggregate expenditure.</li>
<li><code>ce_quantiles()</code> calculates weighted expenditure quantiles. It is important to note that calculating medians for integrated expenditures is not recommended because the calculation involves using weights from both the Diary and Survey instruments.</li>
</ul></li>
</ul>
</section>
<section id="example-workflows" class="level2">
<h2 class="anchored" data-anchor-id="example-workflows">Example workflows</h2>
<p>The following are a few sample workflows that show how <code>cepumd</code> can be used. Before jumping into those I’ll first install and load the necessary packages and store some CEPUMD files. I’ll keep the path to those files in a variable called <code>ce_data_dir</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(knitr, readxl, tidyverse, cepumd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="simple-workflow-integrated-pet-expenditures" class="level3">
<h3 class="anchored" data-anchor-id="simple-workflow-integrated-pet-expenditures">Simple workflow: Integrated pet expenditures</h3>
<p>The following is an example of how someone might go about using <code>cepumd</code> to calculate a 2021 annual, weighted estimate of mean expenditures on pets for all of the U.S. using CE integrated data. This is just a quick and easy calculation.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>integ21_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="dv">2021</span>,</span>
<span id="cb3-3"><a href="#cb3-3"></a>  integrated,</span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb3-5"><a href="#cb3-5"></a>)</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="fu">ce_prepdata</span>(</span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="dv">2021</span>,</span>
<span id="cb3-9"><a href="#cb3-9"></a>  integrated,</span>
<span id="cb3-10"><a href="#cb3-10"></a>  integ21_hg,</span>
<span id="cb3-11"><a href="#cb3-11"></a>  <span class="at">uccs =</span> <span class="fu">ce_uccs</span>(integ21_hg, <span class="at">expenditure =</span> <span class="st">"Pets"</span>, <span class="at">ucc_group =</span> <span class="st">"PETS"</span>),</span>
<span id="cb3-12"><a href="#cb3-12"></a>  <span class="at">dia_zp =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"diary21.zip"</span>),</span>
<span id="cb3-13"><a href="#cb3-13"></a>  <span class="at">int_zp =</span> <span class="fu">c</span>(</span>
<span id="cb3-14"><a href="#cb3-14"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw20.zip"</span>),</span>
<span id="cb3-15"><a href="#cb3-15"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw21.zip"</span>)</span>
<span id="cb3-16"><a href="#cb3-16"></a>  )</span>
<span id="cb3-17"><a href="#cb3-17"></a>) <span class="sc">|&gt;</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>  <span class="fu">ce_mean</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">agg_exp</th>
<th style="text-align: right;">mean_exp</th>
<th style="text-align: right;">se</th>
<th style="text-align: right;">cv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">130886736176</td>
<td style="text-align: right;">981.3035</td>
<td style="text-align: right;">53.5767</td>
<td style="text-align: right;">5.459748</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Yup… that’s all it takes. I simply ran <code>ce_hg</code> to get the hierarchical grouping (stub) file for integrated expenditures for 2021; then ran <code>ce_prepdata()</code> with the year, the survey type, the stub file, uccs I needed, and the file paths to where I downloaded the data files; then I piped that directly into <code>ce_mean()</code>. An important thing to notice is that I provided two file paths to the <code>int_zp</code> argument. I did this because calculating integrated CE annual estimates actually requires 5 quarters of data from the Interview survey. Some of the data for calculating 2021 estimates is provided in the 2020 Interview data.This is one of the reasons it’s important to be familiar with <a href="https://www.bls.gov/cex/pumd-getting-started-guide.htm#section6">CE methodology</a> and how it changes over time when working with CE PUMD. Prior to 2020, file storing practices were different as stated in the <a href="https://www.bls.gov/cex/pumd-getting-started-guide.htm#section3">Getting Started Guide Interview Survey section</a>.</p>
</section>
<section id="slightly-more-advanced-workflow-used-car-truck-expenditures-by-urbanicity" class="level3">
<h3 class="anchored" data-anchor-id="slightly-more-advanced-workflow-used-car-truck-expenditures-by-urbanicity">Slightly more advanced workflow: Used Car &amp; Truck Expenditures by Urbanicity</h3>
<p>In this example I’ll calculate estimated annual expenditures on new and used cars by urbanicity also for 2021. Once the data are prepped with <code>ce_data()</code> I’ll just nest the data by urbanicity and run <code>ce_means()</code> and <code>ce_quantiles()</code> on the nested data sets. Since the overwhelming number of reports of vehicle purchases occur in the Interview survey, I’ll only use Interview data.</p>
<p>First I’ll get the stub file and filter it for categories involving new or used cars.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>int21_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="dv">2021</span>,</span>
<span id="cb4-3"><a href="#cb4-3"></a>  interview,</span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb4-5"><a href="#cb4-5"></a>)</span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a>int21_hg <span class="sc">|&gt;</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(title, <span class="st">"[C|c]ars"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">level</th>
<th style="text-align: left;">title</th>
<th style="text-align: left;">ucc</th>
<th style="text-align: left;">survey</th>
<th style="text-align: left;">factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">4</td>
<td style="text-align: left;">Cars and trucks, new</td>
<td style="text-align: left;">NEWCARS</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: left;">New cars</td>
<td style="text-align: left;">450110</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4</td>
<td style="text-align: left;">Cars and trucks, used</td>
<td style="text-align: left;">USEDCARS</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Used cars</td>
<td style="text-align: left;">460110</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>So there’s one UCC for “New cars” and one for “Used cars”. I’ll use the code above to grab those UCCs and prepare my data.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>car_data <span class="ot">&lt;-</span> <span class="fu">ce_prepdata</span>(</span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="dv">2021</span>,</span>
<span id="cb5-3"><a href="#cb5-3"></a>  interview,</span>
<span id="cb5-4"><a href="#cb5-4"></a>  int21_hg,</span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="at">uccs =</span> int21_hg <span class="sc">|&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>    <span class="fu">filter</span>(<span class="fu">str_detect</span>(title, <span class="st">"[C|c]ars"</span>), <span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ucc))) <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="fu">pull</span>(ucc),</span>
<span id="cb5-8"><a href="#cb5-8"></a>  bls_urbn,  <span class="co"># &lt;------- this is the variable for urbanicity</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>  <span class="at">int_zp =</span> <span class="fu">c</span>(</span>
<span id="cb5-10"><a href="#cb5-10"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw20.zip"</span>),</span>
<span id="cb5-11"><a href="#cb5-11"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw21.zip"</span>)</span>
<span id="cb5-12"><a href="#cb5-12"></a>  ),</span>
<span id="cb5-13"><a href="#cb5-13"></a>  <span class="at">recode_variables =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-14"><a href="#cb5-14"></a>  <span class="at">dict_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"ce-data-dict.xlsx"</span>)</span>
<span id="cb5-15"><a href="#cb5-15"></a>)</span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a>car_data <span class="sc">|&gt;</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>  <span class="fu">group_nest</span>(bls_urbn) <span class="sc">|&gt;</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>  <span class="fu">mutate</span>(<span class="at">ce_ann_means =</span> <span class="fu">map</span>(data, ce_mean)) <span class="sc">|&gt;</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>  <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">|&gt;</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>  <span class="fu">unnest</span>(ce_ann_means) <span class="sc">|&gt;</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">bls_urbn</th>
<th style="text-align: right;">agg_exp</th>
<th style="text-align: right;">mean_exp</th>
<th style="text-align: right;">se</th>
<th style="text-align: right;">cv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Urban</td>
<td style="text-align: right;">168458799558</td>
<td style="text-align: right;">1341.7184</td>
<td style="text-align: right;">106.2495</td>
<td style="text-align: right;">7.918912</td>
</tr>
<tr class="even">
<td style="text-align: left;">Rural</td>
<td style="text-align: right;">4756065697</td>
<td style="text-align: right;">591.5108</td>
<td style="text-align: right;">155.0020</td>
<td style="text-align: right;">26.204421</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Getting the annual, weighted estimate of the median (or another quantile) would be just as easy. Since I’m using interview data only here (it would be bad practice to try to calculate quantiles with integrated data), this would be a good example. I’ll calculate the first percentile and the median along with the 0.991 through 0.999 quantiles for the overall sample rather than breaking it down by urbanicity.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">ce_quantiles</span>(</span>
<span id="cb6-2"><a href="#cb6-2"></a>  car_data,</span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="fu">seq</span>(<span class="fl">0.99</span>, <span class="fl">0.999</span>, <span class="at">by =</span> <span class="fl">0.001</span>))</span>
<span id="cb6-4"><a href="#cb6-4"></a>) <span class="sc">|&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">probs</th>
<th style="text-align: right;">quantile</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1.0%</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">50.0%</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">95.0%</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">99.0%</td>
<td style="text-align: right;">8300</td>
</tr>
<tr class="odd">
<td style="text-align: left;">99.1%</td>
<td style="text-align: right;">10000</td>
</tr>
<tr class="even">
<td style="text-align: left;">99.2%</td>
<td style="text-align: right;">12434</td>
</tr>
<tr class="odd">
<td style="text-align: left;">99.3%</td>
<td style="text-align: right;">15000</td>
</tr>
<tr class="even">
<td style="text-align: left;">99.4%</td>
<td style="text-align: right;">17850</td>
</tr>
<tr class="odd">
<td style="text-align: left;">99.5%</td>
<td style="text-align: right;">20000</td>
</tr>
<tr class="even">
<td style="text-align: left;">99.6%</td>
<td style="text-align: right;">22948</td>
</tr>
<tr class="odd">
<td style="text-align: left;">99.7%</td>
<td style="text-align: right;">26593</td>
</tr>
<tr class="even">
<td style="text-align: left;">99.8%</td>
<td style="text-align: right;">30000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">99.9%</td>
<td style="text-align: right;">40000</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>At least 95% of households in the Interview survey did not report expenditures on cars in 2021, which explains why the mean is so low.</p>
</section>
<section id="very-advanced-workflow-inflation-adjusted-food-away-from-home-expenditures-by-household-size" class="level3">
<h3 class="anchored" data-anchor-id="very-advanced-workflow-inflation-adjusted-food-away-from-home-expenditures-by-household-size">Very advanced workflow: Inflation adjusted food away from home expenditures by household size</h3>
<p>In this last example I’m going to assume very little knowledge about the CE. I’d like to compare mean annual expenditures on food away from home between 2010 and 2020 by household size and I want to convert expenditures to 2023 dollars using the CPI. First I’d go to the <a href="https://www.bls.gov/cex/pumd_data.htm#csv">CE PUMD Data Files</a> page and download the files that I need for both years. I’ll also go to the <a href="https://www.bls.gov/cex/pumd_doc.htm">CE PUMD Documentation</a> page to download the hierarchical grouping files to get the UCCs for “Food away from home” and the CE Dictionary to find out what variable has data on the household size.</p>
<p>With all that done, now I want to look at the hierarchical grouping files for 2010 and 2020 for integrated data as they relate to “Food away from home”.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>integ10_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="dv">2010</span>,</span>
<span id="cb7-3"><a href="#cb7-3"></a>  integrated,</span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb7-5"><a href="#cb7-5"></a>)</span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a>integ20_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb7-8"><a href="#cb7-8"></a>  <span class="dv">2020</span>,</span>
<span id="cb7-9"><a href="#cb7-9"></a>  integrated,</span>
<span id="cb7-10"><a href="#cb7-10"></a>  <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb7-11"><a href="#cb7-11"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>First I’ll explore the titles of the hierarchical grouping files to see if any of them mention “food away”</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>integ10_hg <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">str_to_lower</span>(title), <span class="st">"food away"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">level</th>
<th style="text-align: left;">title</th>
<th style="text-align: left;">ucc</th>
<th style="text-align: left;">survey</th>
<th style="text-align: left;">factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">Food away from home</td>
<td style="text-align: left;">FOODAWAY</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Now I’ll do the same for 2020.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>integ20_hg <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">str_to_lower</span>(title), <span class="st">"food away"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">level</th>
<th style="text-align: left;">title</th>
<th style="text-align: left;">ucc</th>
<th style="text-align: left;">survey</th>
<th style="text-align: left;">factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">Food away from home</td>
<td style="text-align: left;">FOODAW</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Here I’ll take note of the title, which is the same in both years (“Food away from home”). I’ll use that to get the UCCs for both years.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>food_away_uccs_10 <span class="ot">&lt;-</span> integ10_hg <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">ce_uccs</span>(<span class="at">expenditure =</span> <span class="st">"Food away from home"</span>)</span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a>food_away_uccs_20 <span class="ot">&lt;-</span> integ20_hg <span class="sc">|&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>  <span class="fu">ce_uccs</span>(<span class="at">expenditure =</span> <span class="st">"Food away from home"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here’s a quick look at the UCCs from 2010.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>food_away_uccs_10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "190111" "190112" "190113" "190114" "190211" "190212" "190213" "190214"
 [9] "190311" "190312" "190313" "190314" "190321" "190322" "190323" "190324"
[17] "190901" "190902" "190903" "790430" "800700"</code></pre>
</div>
</div>
<p>Now the 2020 UCCs.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>food_away_uccs_10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "190111" "190112" "190113" "190114" "190211" "190212" "190213" "190214"
 [9] "190311" "190312" "190313" "190314" "190321" "190322" "190323" "190324"
[17] "190901" "190902" "190903" "790430" "800700"</code></pre>
</div>
</div>
<p>The vectors of UCCs look identical, but I’ll keep both just to be cautious.</p>
<p>Next I’ll turn to finding the variable for household size in the CE data dictionary. It’s important to remember that the dictionary is stored as an “XLSX” file. I’ll use functions from the <code>readxl</code> package to work with the dictionary.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">excel_sheets</span>(<span class="fu">file.path</span>(ce_data_dir, <span class="st">"ce-data-dict.xlsx"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Cover"     "Variables" "Codes "   </code></pre>
</div>
</div>
<p>Now I’ll see what variables contain anything about the number of household members. To do that I’ll have to load the sheet from the dictionary containing the variable definitions. I also want to filter the variable data to only the FMLI where the “Last year” column is missing, i.e., the variable definition is still in use.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>ce_variables <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(</span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">file.path</span>(ce_data_dir, <span class="st">"ce-data-dict.xlsx"</span>),</span>
<span id="cb17-3"><a href="#cb17-3"></a>  <span class="at">sheet =</span> <span class="st">"Variables"</span></span>
<span id="cb17-4"><a href="#cb17-4"></a>)</span>
<span id="cb17-5"><a href="#cb17-5"></a></span>
<span id="cb17-6"><a href="#cb17-6"></a>ce_variables <span class="sc">|&gt;</span></span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="fu">filter</span>(</span>
<span id="cb17-8"><a href="#cb17-8"></a>    <span class="fu">str_detect</span>(File, <span class="st">"FMLI"</span>),</span>
<span id="cb17-9"><a href="#cb17-9"></a>    <span class="fu">str_detect</span>(</span>
<span id="cb17-10"><a href="#cb17-10"></a>      <span class="fu">tolower</span>(<span class="st">`</span><span class="at">Variable description</span><span class="st">`</span>), <span class="st">"number of members"</span></span>
<span id="cb17-11"><a href="#cb17-11"></a>    )</span>
<span id="cb17-12"><a href="#cb17-12"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb17-13"><a href="#cb17-13"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 5%">
<col style="width: 14%">
<col style="width: 6%">
<col style="width: 4%">
<col style="width: 6%">
<col style="width: 28%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Survey</th>
<th style="text-align: left;">File</th>
<th style="text-align: left;">Variable Name</th>
<th style="text-align: left;">Variable description</th>
<th style="text-align: left;">Formula</th>
<th style="text-align: left;">Flag name</th>
<th style="text-align: left;">Section number</th>
<th style="text-align: left;">Section description</th>
<th style="text-align: left;">Section part</th>
<th style="text-align: right;">First year</th>
<th style="text-align: right;">First Quarter</th>
<th style="text-align: right;">Last quarter</th>
<th style="text-align: right;">Last year</th>
<th style="text-align: left;">Comment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">INTERVIEW</td>
<td style="text-align: left;">FMLI</td>
<td style="text-align: left;">AS_COMP5</td>
<td style="text-align: left;">Number of members under age 2 in CU</td>
<td style="text-align: left;">COUNT (AGE &lt; 2)</td>
<td style="text-align: left;">AS_C_MP5</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">CU characteristics, income, weights, and summary level expenditures.</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">1984</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">INTERVIEW</td>
<td style="text-align: left;">FMLI</td>
<td style="text-align: left;">AS_COMP5</td>
<td style="text-align: left;">Number of members under age 2 in CU</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">AS_C_MP5</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">CU characteristics, income, weights, and summary level expenditures.</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">1980</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1981</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">INTERVIEW</td>
<td style="text-align: left;">FMLI</td>
<td style="text-align: left;">FAM_SIZE</td>
<td style="text-align: left;">Number of Members in CU</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">FAM__IZE</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">CU characteristics, income, weights, and summary level expenditures.</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">1984</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">INTERVIEW</td>
<td style="text-align: left;">FMLI</td>
<td style="text-align: left;">FAM_SIZE</td>
<td style="text-align: left;">Number of Members in CU</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">FAM__IZE</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">CU characteristics, income, weights, and summary level expenditures.</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">1980</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1981</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>It looks like FAM_SIZE is the variable I want. I can see that this variable was used from 1980 through 1981 then was dropped and re-introduced in 1984 and has been in use since. So it looks like it’s available for my 2 years of interest. Next I’ll check whether the FAM_SIZE variable has any value codes associated with it. I’ll have to pull in the “Codes” sheet. (Check your spelling here.)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>ce_codes <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(</span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">file.path</span>(ce_data_dir, <span class="st">"ce-data-dict.xlsx"</span>),</span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="at">sheet =</span> <span class="st">"Codes "</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>)</span>
<span id="cb18-5"><a href="#cb18-5"></a></span>
<span id="cb18-6"><a href="#cb18-6"></a>ce_codes <span class="sc">|&gt;</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>  <span class="fu">filter</span>(File <span class="sc">%in%</span> <span class="st">"FMLI"</span>, Variable <span class="sc">%in%</span> <span class="st">"FAM_SIZE"</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-8"><a href="#cb18-8"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table>
<colgroup>
<col style="width: 6%">
<col style="width: 4%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 15%">
<col style="width: 9%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 11%">
<col style="width: 7%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Survey</th>
<th style="text-align: left;">File</th>
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Code value</th>
<th style="text-align: left;">Code description</th>
<th style="text-align: right;">First year</th>
<th style="text-align: right;">First quarter</th>
<th style="text-align: right;">Last year</th>
<th style="text-align: right;">Last quarter</th>
<th style="text-align: left;">Comment</th>
<th style="text-align: left;">…11</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<p>It looks like FAM_SIZE is not a coded variable (no observations in the “Codes” sheet), so it must be numeric. With all that, I’m ready to prepare my data. I’ll start by preparing the 2010 data and getting a summary of the FAM_SIZE variable since it is a continuous variable.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>food_away_data_10 <span class="ot">&lt;-</span> <span class="fu">ce_prepdata</span>(</span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="dv">2010</span>,</span>
<span id="cb19-3"><a href="#cb19-3"></a>  integrated,</span>
<span id="cb19-4"><a href="#cb19-4"></a>  integ10_hg,</span>
<span id="cb19-5"><a href="#cb19-5"></a>  food_away_uccs_10,</span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="at">dia_zp =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"diary10.zip"</span>),</span>
<span id="cb19-7"><a href="#cb19-7"></a>  <span class="at">int_zp =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw10.zip"</span>),</span>
<span id="cb19-8"><a href="#cb19-8"></a>  fam_size</span>
<span id="cb19-9"><a href="#cb19-9"></a>)</span>
<span id="cb19-10"><a href="#cb19-10"></a></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="fu">summary</span>(food_away_data_10<span class="sc">$</span>fam_size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   2.000   2.666   4.000  14.000 </code></pre>
</div>
</div>
<p>Since some households have as many as 14 people, I’ll create a FAM_SIZE label with any number greater than 4 taking on the value “5+”. Next, I’ll prepare the 2020 data and row bind it with the 2010 data as well as create the “fam_size_label” variable. I’m also going to convert “ref_mo” and “ref_yr” to character to make it compatible with the CPI data that I’ll get later. I’ll also take a look at just a snippet of the data.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>food_away_data_20 <span class="ot">&lt;-</span> <span class="fu">ce_prepdata</span>(</span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="dv">2020</span>,</span>
<span id="cb21-3"><a href="#cb21-3"></a>  integrated,</span>
<span id="cb21-4"><a href="#cb21-4"></a>  integ10_hg,</span>
<span id="cb21-5"><a href="#cb21-5"></a>  food_away_uccs_20,</span>
<span id="cb21-6"><a href="#cb21-6"></a>  <span class="at">dia_zp =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"diary20.zip"</span>),</span>
<span id="cb21-7"><a href="#cb21-7"></a>  <span class="at">int_zp =</span> <span class="fu">c</span>(</span>
<span id="cb21-8"><a href="#cb21-8"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw19.zip"</span>),</span>
<span id="cb21-9"><a href="#cb21-9"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw20.zip"</span>)</span>
<span id="cb21-10"><a href="#cb21-10"></a>  ),</span>
<span id="cb21-11"><a href="#cb21-11"></a>  fam_size</span>
<span id="cb21-12"><a href="#cb21-12"></a>)</span>
<span id="cb21-13"><a href="#cb21-13"></a></span>
<span id="cb21-14"><a href="#cb21-14"></a>food_away_comp_data <span class="ot">&lt;-</span> food_away_data_10 <span class="sc">|&gt;</span></span>
<span id="cb21-15"><a href="#cb21-15"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="st">"2010"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-16"><a href="#cb21-16"></a>  <span class="fu">bind_rows</span>(food_away_data_20 <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">year =</span> <span class="st">"2020"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb21-17"><a href="#cb21-17"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-18"><a href="#cb21-18"></a>    <span class="at">fam_size_label =</span> <span class="fu">if_else</span>(fam_size <span class="sc">&gt;</span> <span class="dv">4</span>, <span class="st">"5+"</span>, <span class="fu">as.character</span>(fam_size)),</span>
<span id="cb21-19"><a href="#cb21-19"></a>    <span class="at">ref_yr =</span> <span class="fu">as.character</span>(ref_yr)</span>
<span id="cb21-20"><a href="#cb21-20"></a>  )</span>
<span id="cb21-21"><a href="#cb21-21"></a></span>
<span id="cb21-22"><a href="#cb21-22"></a>food_away_comp_data <span class="sc">|&gt;</span></span>
<span id="cb21-23"><a href="#cb21-23"></a>  <span class="fu">select</span>(survey, year, newid, finlwt21, cost, ucc, ref_yr, ref_mo) <span class="sc">|&gt;</span></span>
<span id="cb21-24"><a href="#cb21-24"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ucc)) <span class="sc">|&gt;</span></span>
<span id="cb21-25"><a href="#cb21-25"></a>  <span class="fu">group_by</span>(year, survey) <span class="sc">|&gt;</span></span>
<span id="cb21-26"><a href="#cb21-26"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-27"><a href="#cb21-27"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-28"><a href="#cb21-28"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">survey</th>
<th style="text-align: left;">year</th>
<th style="text-align: left;">newid</th>
<th style="text-align: right;">finlwt21</th>
<th style="text-align: right;">cost</th>
<th style="text-align: left;">ucc</th>
<th style="text-align: left;">ref_yr</th>
<th style="text-align: right;">ref_mo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">01047471</td>
<td style="text-align: right;">43881.11</td>
<td style="text-align: right;">2.30971</td>
<td style="text-align: left;">190321</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">01077871</td>
<td style="text-align: right;">24204.65</td>
<td style="text-align: right;">66.30000</td>
<td style="text-align: left;">190111</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">01116361</td>
<td style="text-align: right;">62846.94</td>
<td style="text-align: right;">18.33000</td>
<td style="text-align: left;">190313</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">02265533</td>
<td style="text-align: right;">12788.96</td>
<td style="text-align: right;">144.00000</td>
<td style="text-align: left;">790430</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">02309802</td>
<td style="text-align: right;">22657.97</td>
<td style="text-align: right;">33.33333</td>
<td style="text-align: left;">790430</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="even">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">02247652</td>
<td style="text-align: right;">15588.84</td>
<td style="text-align: right;">52.00000</td>
<td style="text-align: left;">790430</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04630171</td>
<td style="text-align: right;">33468.71</td>
<td style="text-align: right;">523.51000</td>
<td style="text-align: left;">190211</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">11</td>
</tr>
<tr class="even">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04591042</td>
<td style="text-align: right;">60503.51</td>
<td style="text-align: right;">137.67000</td>
<td style="text-align: left;">190311</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04436801</td>
<td style="text-align: right;">49119.67</td>
<td style="text-align: right;">156.00000</td>
<td style="text-align: left;">190112</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04316443</td>
<td style="text-align: right;">16358.45</td>
<td style="text-align: right;">52.00000</td>
<td style="text-align: left;">800700</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04227663</td>
<td style="text-align: right;">27787.28</td>
<td style="text-align: right;">100.00000</td>
<td style="text-align: left;">190901</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04234823</td>
<td style="text-align: right;">28645.27</td>
<td style="text-align: right;">92.00000</td>
<td style="text-align: left;">790430</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>I’ll now get CPI data for the years in the analysis and for 2023 to set as a base using the <code>blsR</code> package (<a href="https://github.com/groditi/blsR" class="uri">https://github.com/groditi/blsR</a>). I’m going to use the “All Urban Consumers (Current Series)” series, which has series ID “CUUR0000SA0”.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>cpi_data <span class="ot">&lt;-</span> blsR<span class="sc">::</span><span class="fu">get_series</span>(</span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="st">"CUUR0000SA0"</span>,</span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="at">start_year =</span> <span class="dv">2010</span>,</span>
<span id="cb22-4"><a href="#cb22-4"></a>  <span class="at">end_year =</span> <span class="dv">2023</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>) <span class="sc">|&gt;</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>  <span class="fu">pluck</span>(<span class="st">"data"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-7"><a href="#cb22-7"></a>  <span class="fu">map</span>(</span>
<span id="cb22-8"><a href="#cb22-8"></a>    \(x) <span class="fu">list_flatten</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb22-9"><a href="#cb22-9"></a>      <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>      <span class="fu">filter</span>(<span class="sc">!</span>name <span class="sc">%in%</span> <span class="st">"footnotes"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-11"><a href="#cb22-11"></a>      <span class="fu">unnest</span>(value) <span class="sc">|&gt;</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>      <span class="fu">pivot_wider</span>(<span class="at">values_from =</span> value, <span class="at">names_from =</span> name)</span>
<span id="cb22-13"><a href="#cb22-13"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-14"><a href="#cb22-14"></a>  <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-15"><a href="#cb22-15"></a>  <span class="fu">rename</span>(<span class="at">cpi =</span> <span class="st">"value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-16"><a href="#cb22-16"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">match</span>(periodName, month.name))</span>
<span id="cb22-17"><a href="#cb22-17"></a></span>
<span id="cb22-18"><a href="#cb22-18"></a>cpi_base <span class="ot">&lt;-</span> cpi_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="st">"2023"</span>, month <span class="sc">%in%</span> <span class="st">"12"</span>)</span>
<span id="cb22-19"><a href="#cb22-19"></a></span>
<span id="cb22-20"><a href="#cb22-20"></a>cpi_data <span class="ot">&lt;-</span> cpi_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="fu">unique</span>(food_away_comp_data<span class="sc">$</span>ref_yr))</span>
<span id="cb22-21"><a href="#cb22-21"></a></span>
<span id="cb22-22"><a href="#cb22-22"></a>cpi_data <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">year</th>
<th style="text-align: left;">period</th>
<th style="text-align: left;">periodName</th>
<th style="text-align: left;">cpi</th>
<th style="text-align: right;">month</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2021</td>
<td style="text-align: left;">M12</td>
<td style="text-align: left;">December</td>
<td style="text-align: left;">278.802</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021</td>
<td style="text-align: left;">M11</td>
<td style="text-align: left;">November</td>
<td style="text-align: left;">277.948</td>
<td style="text-align: right;">11</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2021</td>
<td style="text-align: left;">M10</td>
<td style="text-align: left;">October</td>
<td style="text-align: left;">276.589</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021</td>
<td style="text-align: left;">M09</td>
<td style="text-align: left;">September</td>
<td style="text-align: left;">274.310</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2021</td>
<td style="text-align: left;">M08</td>
<td style="text-align: left;">August</td>
<td style="text-align: left;">273.567</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021</td>
<td style="text-align: left;">M07</td>
<td style="text-align: left;">July</td>
<td style="text-align: left;">273.003</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2021</td>
<td style="text-align: left;">M06</td>
<td style="text-align: left;">June</td>
<td style="text-align: left;">271.696</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021</td>
<td style="text-align: left;">M05</td>
<td style="text-align: left;">May</td>
<td style="text-align: left;">269.195</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2021</td>
<td style="text-align: left;">M04</td>
<td style="text-align: left;">April</td>
<td style="text-align: left;">267.054</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">2021</td>
<td style="text-align: left;">M03</td>
<td style="text-align: left;">March</td>
<td style="text-align: left;">264.877</td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The base that I’m going to covert to is December 2023.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>cpi_base <span class="sc">|&gt;</span> <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">year</th>
<th style="text-align: left;">period</th>
<th style="text-align: left;">periodName</th>
<th style="text-align: left;">cpi</th>
<th style="text-align: right;">month</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2023</td>
<td style="text-align: left;">M12</td>
<td style="text-align: left;">December</td>
<td style="text-align: left;">306.746</td>
<td style="text-align: right;">12</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Next I’m going to join the CPI data to the CE data and adjust the “cost” variable for inflation. Note that I replace resulting missing values in the “cost” variable with “0”. Missing values will result when I multiply a cost of “0” by an adjustment factor and <code>ce_mean()</code> will not function with missing values.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>food_away_comp_data <span class="ot">&lt;-</span> food_away_comp_data <span class="sc">|&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="fu">left_join</span>(</span>
<span id="cb24-3"><a href="#cb24-3"></a>    <span class="fu">select</span>(cpi_data, year, month, cpi),</span>
<span id="cb24-4"><a href="#cb24-4"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ref_yr"</span> <span class="ot">=</span> <span class="st">"year"</span>, <span class="st">"ref_mo"</span> <span class="ot">=</span> <span class="st">"month"</span>)</span>
<span id="cb24-5"><a href="#cb24-5"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb24-6"><a href="#cb24-6"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-7"><a href="#cb24-7"></a>    <span class="at">base_cpi =</span> <span class="fu">pull</span>(cpi_base, cpi),</span>
<span id="cb24-8"><a href="#cb24-8"></a>    <span class="fu">across</span>(<span class="fu">c</span>(base_cpi, cpi), as.numeric),</span>
<span id="cb24-9"><a href="#cb24-9"></a>    <span class="at">cost =</span> cost <span class="sc">*</span> (base_cpi <span class="sc">/</span> cpi) <span class="sc">|&gt;</span> <span class="fu">replace_na</span>(<span class="dv">0</span>)</span>
<span id="cb24-10"><a href="#cb24-10"></a>  )</span>
<span id="cb24-11"><a href="#cb24-11"></a></span>
<span id="cb24-12"><a href="#cb24-12"></a>food_away_comp_data <span class="sc">|&gt;</span></span>
<span id="cb24-13"><a href="#cb24-13"></a>  <span class="fu">select</span>(survey, year, newid, finlwt21, cost, ucc, ref_yr, ref_mo) <span class="sc">|&gt;</span></span>
<span id="cb24-14"><a href="#cb24-14"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ucc)) <span class="sc">|&gt;</span></span>
<span id="cb24-15"><a href="#cb24-15"></a>  <span class="fu">group_by</span>(year, survey) <span class="sc">|&gt;</span></span>
<span id="cb24-16"><a href="#cb24-16"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-17"><a href="#cb24-17"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb24-18"><a href="#cb24-18"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">survey</th>
<th style="text-align: left;">year</th>
<th style="text-align: left;">newid</th>
<th style="text-align: right;">finlwt21</th>
<th style="text-align: right;">cost</th>
<th style="text-align: left;">ucc</th>
<th style="text-align: left;">ref_yr</th>
<th style="text-align: right;">ref_mo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">01062182</td>
<td style="text-align: right;">31911.373</td>
<td style="text-align: right;">632.33499</td>
<td style="text-align: left;">190111</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">01132291</td>
<td style="text-align: right;">42762.166</td>
<td style="text-align: right;">75.39493</td>
<td style="text-align: left;">190312</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">01151261</td>
<td style="text-align: right;">34508.670</td>
<td style="text-align: right;">71.78432</td>
<td style="text-align: left;">190321</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">11</td>
</tr>
<tr class="even">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">02222433</td>
<td style="text-align: right;">3456.019</td>
<td style="text-align: right;">33.02286</td>
<td style="text-align: left;">790430</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">02202583</td>
<td style="text-align: right;">14948.874</td>
<td style="text-align: right;">233.51876</td>
<td style="text-align: left;">190903</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2010</td>
<td style="text-align: left;">02183355</td>
<td style="text-align: right;">15016.399</td>
<td style="text-align: right;">703.51037</td>
<td style="text-align: left;">190903</td>
<td style="text-align: left;">2010</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04433811</td>
<td style="text-align: right;">74006.452</td>
<td style="text-align: right;">63.35846</td>
<td style="text-align: left;">190311</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04438592</td>
<td style="text-align: right;">32749.351</td>
<td style="text-align: right;">64.59171</td>
<td style="text-align: left;">190211</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04636492</td>
<td style="text-align: right;">41910.471</td>
<td style="text-align: right;">306.47607</td>
<td style="text-align: left;">190211</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">11</td>
</tr>
<tr class="even">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04291913</td>
<td style="text-align: right;">70403.081</td>
<td style="text-align: right;">356.52248</td>
<td style="text-align: left;">190903</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04386872</td>
<td style="text-align: right;">20595.360</td>
<td style="text-align: right;">1181.86902</td>
<td style="text-align: left;">800700</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">I</td>
<td style="text-align: left;">2020</td>
<td style="text-align: left;">04683051</td>
<td style="text-align: right;">33054.288</td>
<td style="text-align: right;">280.67215</td>
<td style="text-align: left;">800700</td>
<td style="text-align: left;">2020</td>
<td style="text-align: right;">12</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The next step is to calculate means, for which I’ll use some more Tidyverse functions.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>food_away_means <span class="ot">&lt;-</span> food_away_comp_data <span class="sc">|&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="fu">group_nest</span>(year, fam_size_label, <span class="at">.key =</span> <span class="st">"data"</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="fu">mutate</span>(<span class="at">ce_mn_df =</span> <span class="fu">map</span>(data, ce_mean)) <span class="sc">|&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4"></a>  <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">|&gt;</span> </span>
<span id="cb25-5"><a href="#cb25-5"></a>  <span class="fu">unnest</span>(ce_mn_df) <span class="sc">|&gt;</span></span>
<span id="cb25-6"><a href="#cb25-6"></a>  <span class="fu">mutate</span>(<span class="at">lower =</span> mean_exp <span class="sc">-</span> cv, <span class="at">upper =</span> mean_exp <span class="sc">+</span> cv)</span>
<span id="cb25-7"><a href="#cb25-7"></a></span>
<span id="cb25-8"><a href="#cb25-8"></a>food_away_means <span class="sc">|&gt;</span> <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 6%">
<col style="width: 18%">
<col style="width: 16%">
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">year</th>
<th style="text-align: left;">fam_size_label</th>
<th style="text-align: right;">agg_exp</th>
<th style="text-align: right;">mean_exp</th>
<th style="text-align: right;">se</th>
<th style="text-align: right;">cv</th>
<th style="text-align: right;">lower</th>
<th style="text-align: right;">upper</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2010</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">77335813000</td>
<td style="text-align: right;">2207.926</td>
<td style="text-align: right;">87.23315</td>
<td style="text-align: right;">3.950909</td>
<td style="text-align: right;">2203.975</td>
<td style="text-align: right;">2211.877</td>
</tr>
<tr class="even">
<td style="text-align: left;">2010</td>
<td style="text-align: left;">2</td>
<td style="text-align: right;">137538943234</td>
<td style="text-align: right;">3479.533</td>
<td style="text-align: right;">102.54849</td>
<td style="text-align: right;">2.947192</td>
<td style="text-align: right;">3476.585</td>
<td style="text-align: right;">3482.480</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2010</td>
<td style="text-align: left;">3</td>
<td style="text-align: right;">70833802054</td>
<td style="text-align: right;">4028.171</td>
<td style="text-align: right;">187.60152</td>
<td style="text-align: right;">4.657238</td>
<td style="text-align: right;">4023.514</td>
<td style="text-align: right;">4032.829</td>
</tr>
<tr class="even">
<td style="text-align: left;">2010</td>
<td style="text-align: left;">4</td>
<td style="text-align: right;">78621552689</td>
<td style="text-align: right;">4994.423</td>
<td style="text-align: right;">196.31421</td>
<td style="text-align: right;">3.930669</td>
<td style="text-align: right;">4990.492</td>
<td style="text-align: right;">4998.354</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2010</td>
<td style="text-align: left;">5+</td>
<td style="text-align: right;">60764779535</td>
<td style="text-align: right;">4668.419</td>
<td style="text-align: right;">252.13159</td>
<td style="text-align: right;">5.400792</td>
<td style="text-align: right;">4663.018</td>
<td style="text-align: right;">4673.820</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">67173826416</td>
<td style="text-align: right;">1713.043</td>
<td style="text-align: right;">84.53129</td>
<td style="text-align: right;">4.934569</td>
<td style="text-align: right;">1708.108</td>
<td style="text-align: right;">1717.977</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020</td>
<td style="text-align: left;">2</td>
<td style="text-align: right;">122787510310</td>
<td style="text-align: right;">2825.619</td>
<td style="text-align: right;">131.55436</td>
<td style="text-align: right;">4.655771</td>
<td style="text-align: right;">2820.963</td>
<td style="text-align: right;">2830.275</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020</td>
<td style="text-align: left;">3</td>
<td style="text-align: right;">61184160903</td>
<td style="text-align: right;">3170.855</td>
<td style="text-align: right;">203.25085</td>
<td style="text-align: right;">6.409971</td>
<td style="text-align: right;">3164.445</td>
<td style="text-align: right;">3177.265</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2020</td>
<td style="text-align: left;">4</td>
<td style="text-align: right;">68948170493</td>
<td style="text-align: right;">4210.973</td>
<td style="text-align: right;">262.49920</td>
<td style="text-align: right;">6.233695</td>
<td style="text-align: right;">4204.739</td>
<td style="text-align: right;">4217.206</td>
</tr>
<tr class="even">
<td style="text-align: left;">2020</td>
<td style="text-align: left;">5+</td>
<td style="text-align: right;">48767026459</td>
<td style="text-align: right;">3737.376</td>
<td style="text-align: right;">327.18302</td>
<td style="text-align: right;">8.754351</td>
<td style="text-align: right;">3728.622</td>
<td style="text-align: right;">3746.130</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Plotting these data would be pretty straightforward, as well.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>food_away_means <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> fam_size_label, <span class="at">y =</span> mean_exp, <span class="at">fill =</span> year, <span class="at">group =</span> year)) <span class="sc">+</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">width =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb26-4"><a href="#cb26-4"></a>  <span class="fu">geom_errorbar</span>(</span>
<span id="cb26-5"><a href="#cb26-5"></a>    <span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb26-6"><a href="#cb26-6"></a>    <span class="at">width =</span> <span class="fl">0.4</span>,</span>
<span id="cb26-7"><a href="#cb26-7"></a>    <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.75</span>)</span>
<span id="cb26-8"><a href="#cb26-8"></a>  ) <span class="sc">+</span></span>
<span id="cb26-9"><a href="#cb26-9"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb26-10"><a href="#cb26-10"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb26-11"><a href="#cb26-11"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-12"><a href="#cb26-12"></a>    <span class="at">title =</span></span>
<span id="cb26-13"><a href="#cb26-13"></a>      <span class="st">"Estimated annual mean food away from home expenditures by CU size"</span>,</span>
<span id="cb26-14"><a href="#cb26-14"></a>    <span class="at">x =</span> <span class="st">"CU size"</span>,</span>
<span id="cb26-15"><a href="#cb26-15"></a>    <span class="at">y =</span> <span class="st">"Estimated, weighted, annual mean expenditure"</span>,</span>
<span id="cb26-16"><a href="#cb26-16"></a>    <span class="at">fill =</span> <span class="st">"Year"</span></span>
<span id="cb26-17"><a href="#cb26-17"></a>  ) <span class="sc">+</span></span>
<span id="cb26-18"><a href="#cb26-18"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb26-19"><a href="#cb26-19"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>), <span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cepumd-intro_files/figure-html/plot-food-away-means-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here we can see that on an inflation-adjusted basis, households of all sizes had higher expenditures on food away from home in 2010 than they did in 2020.</p>
<p>Now I’ll generate a plot of the expenditures at each weighted, annual, estimated quantile (from 0.01 through 0.99, by 0.01) for the same years, but only using Diary data, since most of the UCCs (16 out of 21) in the “food away from home” category come from the Diary.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>food_away_comp_quantiles <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2020</span>),</span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">c</span>(</span>
<span id="cb27-4"><a href="#cb27-4"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"diary10.zip"</span>),</span>
<span id="cb27-5"><a href="#cb27-5"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"diary20.zip"</span>)</span>
<span id="cb27-6"><a href="#cb27-6"></a>  ),</span>
<span id="cb27-7"><a href="#cb27-7"></a>  \(x, y) {</span>
<span id="cb27-8"><a href="#cb27-8"></a>    dia_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb27-9"><a href="#cb27-9"></a>      x,</span>
<span id="cb27-10"><a href="#cb27-10"></a>      diary,</span>
<span id="cb27-11"><a href="#cb27-11"></a>      <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb27-12"><a href="#cb27-12"></a>    )</span>
<span id="cb27-13"><a href="#cb27-13"></a>    </span>
<span id="cb27-14"><a href="#cb27-14"></a>    food_uccs <span class="ot">&lt;-</span> <span class="fu">ce_uccs</span>(dia_hg, <span class="at">expenditure =</span> <span class="st">"Food away from home"</span>)</span>
<span id="cb27-15"><a href="#cb27-15"></a>    </span>
<span id="cb27-16"><a href="#cb27-16"></a>    <span class="fu">ce_prepdata</span>(</span>
<span id="cb27-17"><a href="#cb27-17"></a>      x,</span>
<span id="cb27-18"><a href="#cb27-18"></a>      diary,</span>
<span id="cb27-19"><a href="#cb27-19"></a>      dia_hg,</span>
<span id="cb27-20"><a href="#cb27-20"></a>      food_uccs,</span>
<span id="cb27-21"><a href="#cb27-21"></a>      <span class="at">dia_zp =</span> y</span>
<span id="cb27-22"><a href="#cb27-22"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb27-23"><a href="#cb27-23"></a>      <span class="fu">mutate</span>(<span class="at">year =</span> x, <span class="at">ref_yr =</span> <span class="fu">as.character</span>(ref_yr))</span>
<span id="cb27-24"><a href="#cb27-24"></a>  }</span>
<span id="cb27-25"><a href="#cb27-25"></a>) <span class="sc">|&gt;</span></span>
<span id="cb27-26"><a href="#cb27-26"></a>  <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span></span>
<span id="cb27-27"><a href="#cb27-27"></a>  <span class="fu">left_join</span>(</span>
<span id="cb27-28"><a href="#cb27-28"></a>    <span class="fu">select</span>(cpi_data, year, month, cpi),</span>
<span id="cb27-29"><a href="#cb27-29"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ref_yr"</span> <span class="ot">=</span> <span class="st">"year"</span>, <span class="st">"ref_mo"</span> <span class="ot">=</span> <span class="st">"month"</span>)</span>
<span id="cb27-30"><a href="#cb27-30"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb27-31"><a href="#cb27-31"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">factor</span>(year)) <span class="sc">|&gt;</span></span>
<span id="cb27-32"><a href="#cb27-32"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>year) <span class="sc">|&gt;</span></span>
<span id="cb27-33"><a href="#cb27-33"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-34"><a href="#cb27-34"></a>    <span class="at">fa_qtile =</span> <span class="fu">map</span>(data, ce_quantiles, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.95</span>, <span class="at">by =</span> <span class="fl">0.05</span>), <span class="fl">0.99</span>))</span>
<span id="cb27-35"><a href="#cb27-35"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb27-36"><a href="#cb27-36"></a>  <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">|&gt;</span></span>
<span id="cb27-37"><a href="#cb27-37"></a>  <span class="fu">unnest</span>(fa_qtile) <span class="sc">|&gt;</span></span>
<span id="cb27-38"><a href="#cb27-38"></a>  <span class="fu">mutate</span>(<span class="at">probs =</span> <span class="fu">parse_number</span>(probs) <span class="sc">/</span> <span class="dv">100</span>)</span>
<span id="cb27-39"><a href="#cb27-39"></a></span>
<span id="cb27-40"><a href="#cb27-40"></a>food_away_comp_quantiles <span class="sc">|&gt;</span></span>
<span id="cb27-41"><a href="#cb27-41"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> probs, <span class="at">y =</span> quantile, <span class="at">group =</span> year, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb27-42"><a href="#cb27-42"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb27-43"><a href="#cb27-43"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb27-44"><a href="#cb27-44"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb27-45"><a href="#cb27-45"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb27-46"><a href="#cb27-46"></a>  <span class="fu">labs</span>(</span>
<span id="cb27-47"><a href="#cb27-47"></a>    <span class="at">title =</span></span>
<span id="cb27-48"><a href="#cb27-48"></a>      <span class="st">"Estimated, annual food away from home expenditure quantiles"</span>,</span>
<span id="cb27-49"><a href="#cb27-49"></a>    <span class="at">x =</span> <span class="st">"Quantile"</span>,</span>
<span id="cb27-50"><a href="#cb27-50"></a>    <span class="at">y =</span> <span class="st">"Estimated, weighted, annual expenditure"</span>,</span>
<span id="cb27-51"><a href="#cb27-51"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb27-52"><a href="#cb27-52"></a>  ) <span class="sc">+</span></span>
<span id="cb27-53"><a href="#cb27-53"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb27-54"><a href="#cb27-54"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>), <span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cepumd-intro_files/figure-html/plot-food-away-quantiles-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Interestingly the expenditures don’t appear to have changed much between 2010 and 2020 across quantiles on an inflation-adjusted basis, but we can see that across all quantiles, CU’s spent less in 2020 than they did in 2010 on food away from home, which is consistent with the means that we calculated above. There are a lot of 0-value reported expenditures, though, in the CE on food away from home. Unfortunately, I can’t perform an analysis using only respondents that did have expenditures in this category, i.e., dropping the 0’s, because whether someone had an expenditure on food away from home is not one of the variables used for generating the survey weights. In other words, the analysis can be done, but it would not be statistically valid and I definitely wouldn’t be able to infer from it. This is just another cautionary note to anyone using this package who might use it in a way that does not follow statistically sound practices. Please visit the <a href="https://www.bls.gov/cex/">CE’s website</a> and read the <a href="https://www.bls.gov/cex/tables.htm">CE PUMD Getting Started Guide</a> for more information.</p>
</section>
<section id="dealing-with-inconsistent-code-definitions" class="level3">
<h3 class="anchored" data-anchor-id="dealing-with-inconsistent-code-definitions">Dealing with inconsistent code definitions</h3>
<p>In this workflow I’m going to calculate estimated mean utilities expenditures for 2015 using integrated data by CU composition using the FAM_TYPE variable. In this case I’m going to start by looking at the codes for that variable to show how one might run into an inconsistency in code definitions across survey instruments. First I’m going to set up a sub-directory in my temporary directory and store what I’ll need to get started.</p>
<p>First, I’ll look at code descriptions for the “FAM_TYPE” variable in the dictionary and I’m going to focus on the code values of 3, 5, and 7. I still have the <code>ce_codes</code> object in memory, so I’ll just use that.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>ce_codes <span class="sc">|&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3"></a>  <span class="fu">filter</span>(</span>
<span id="cb28-4"><a href="#cb28-4"></a>    variable <span class="sc">%in%</span> <span class="st">"FAM_TYPE"</span>,</span>
<span id="cb28-5"><a href="#cb28-5"></a>  first_year <span class="sc">&lt;=</span> <span class="dv">2015</span>,</span>
<span id="cb28-6"><a href="#cb28-6"></a>  (last_year <span class="sc">&gt;=</span> <span class="dv">2015</span> <span class="sc">|</span> <span class="fu">is.na</span>(last_year)),</span>
<span id="cb28-7"><a href="#cb28-7"></a>  code_value <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"3"</span>, <span class="st">"5"</span>, <span class="st">"7"</span>)</span>
<span id="cb28-8"><a href="#cb28-8"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb28-9"><a href="#cb28-9"></a>  <span class="fu">select</span>(survey, code_value, code_description) <span class="sc">|&gt;</span></span>
<span id="cb28-10"><a href="#cb28-10"></a>  <span class="fu">arrange</span>(code_value, survey) <span class="sc">|&gt;</span></span>
<span id="cb28-11"><a href="#cb28-11"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 13%">
<col style="width: 73%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">survey</th>
<th style="text-align: left;">code_value</th>
<th style="text-align: left;">code_description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">DIARY</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">Married couple, own children only, oldest child &gt; 6, &lt; 18</td>
</tr>
<tr class="even">
<td style="text-align: left;">INTERVIEW</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">Married Couple, own children only oldest child &gt;= 6, &lt;= 17</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DIARY</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">All other Married couple families</td>
</tr>
<tr class="even">
<td style="text-align: left;">INTERVIEW</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">All other Husband and wife families</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DIARY</td>
<td style="text-align: left;">7</td>
<td style="text-align: left;">One parent, female, own children, at least one age &lt; 18</td>
</tr>
<tr class="even">
<td style="text-align: left;">INTERVIEW</td>
<td style="text-align: left;">7</td>
<td style="text-align: left;">One parent, female, own children, at least one age &lt; 18</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The code descriptions for these 3 code values are different across instruments. To resolve this I’m going to create a table containing only codes from the Interview survey.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>fam_type_codes <span class="ot">&lt;-</span> ce_codes <span class="sc">|&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb29-3"><a href="#cb29-3"></a>  <span class="fu">filter</span>(</span>
<span id="cb29-4"><a href="#cb29-4"></a>    variable <span class="sc">%in%</span> <span class="st">"FAM_TYPE"</span>,</span>
<span id="cb29-5"><a href="#cb29-5"></a>    first_year <span class="sc">&lt;=</span> <span class="dv">2015</span>,</span>
<span id="cb29-6"><a href="#cb29-6"></a>    (last_year <span class="sc">&gt;=</span> <span class="dv">2015</span> <span class="sc">|</span> <span class="fu">is.na</span>(last_year))</span>
<span id="cb29-7"><a href="#cb29-7"></a>  )</span>
<span id="cb29-8"><a href="#cb29-8"></a></span>
<span id="cb29-9"><a href="#cb29-9"></a>codes2keep <span class="ot">&lt;-</span> fam_type_codes <span class="sc">|&gt;</span></span>
<span id="cb29-10"><a href="#cb29-10"></a>  <span class="fu">filter</span>(survey <span class="sc">%in%</span> <span class="st">"INTERVIEW"</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-11"><a href="#cb29-11"></a>  <span class="fu">select</span>(code_value, code_description)</span>
<span id="cb29-12"><a href="#cb29-12"></a></span>
<span id="cb29-13"><a href="#cb29-13"></a>fam_type_codes <span class="ot">&lt;-</span> fam_type_codes <span class="sc">|&gt;</span></span>
<span id="cb29-14"><a href="#cb29-14"></a>  <span class="fu">select</span>(<span class="sc">-</span>code_description) <span class="sc">|&gt;</span></span>
<span id="cb29-15"><a href="#cb29-15"></a>  <span class="fu">left_join</span>(codes2keep, <span class="at">by =</span> <span class="st">"code_value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-16"><a href="#cb29-16"></a>  <span class="fu">relocate</span>(code_description, <span class="at">.after =</span> code_value)</span>
<span id="cb29-17"><a href="#cb29-17"></a></span>
<span id="cb29-18"><a href="#cb29-18"></a>fam_type_codes <span class="sc">|&gt;</span></span>
<span id="cb29-19"><a href="#cb29-19"></a>  <span class="fu">filter</span>(code_value <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"3"</span>, <span class="st">"5"</span>, <span class="st">"7"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb29-20"><a href="#cb29-20"></a>  <span class="fu">select</span>(survey, code_value, code_description) <span class="sc">|&gt;</span></span>
<span id="cb29-21"><a href="#cb29-21"></a>  <span class="fu">arrange</span>(code_value, survey) <span class="sc">|&gt;</span></span>
<span id="cb29-22"><a href="#cb29-22"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 13%">
<col style="width: 73%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">survey</th>
<th style="text-align: left;">code_value</th>
<th style="text-align: left;">code_description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">DIARY</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">Married Couple, own children only oldest child &gt;= 6, &lt;= 17</td>
</tr>
<tr class="even">
<td style="text-align: left;">INTERVIEW</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">Married Couple, own children only oldest child &gt;= 6, &lt;= 17</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DIARY</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">All other Husband and wife families</td>
</tr>
<tr class="even">
<td style="text-align: left;">INTERVIEW</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">All other Husband and wife families</td>
</tr>
<tr class="odd">
<td style="text-align: left;">DIARY</td>
<td style="text-align: left;">7</td>
<td style="text-align: left;">One parent, female, own children, at least one age &lt; 18</td>
</tr>
<tr class="even">
<td style="text-align: left;">INTERVIEW</td>
<td style="text-align: left;">7</td>
<td style="text-align: left;">One parent, female, own children, at least one age &lt; 18</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Now the codes are consistent across survey instruments and I can use this code-book in my call to <code>ce_prepdata()</code> using the “own_code-book” argument. Then I’ll pass that to <code>ce_mean()</code> per usual.</p>
<p>Next I’ll get some information about how utilities expenditures are organized using the stub file.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>integ15_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="dv">2015</span>,</span>
<span id="cb30-3"><a href="#cb30-3"></a>  integrated,</span>
<span id="cb30-4"><a href="#cb30-4"></a>  <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb30-5"><a href="#cb30-5"></a>)</span>
<span id="cb30-6"><a href="#cb30-6"></a></span>
<span id="cb30-7"><a href="#cb30-7"></a>integ15_hg <span class="sc">|&gt;</span></span>
<span id="cb30-8"><a href="#cb30-8"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">str_to_lower</span>(title), <span class="st">"utilities"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb30-9"><a href="#cb30-9"></a>  <span class="fu">kable</span>(<span class="at">bookmarks =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">level</th>
<th style="text-align: left;">title</th>
<th style="text-align: left;">ucc</th>
<th style="text-align: left;">survey</th>
<th style="text-align: left;">factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">Utilities, fuels, and public services</td>
<td style="text-align: left;">UTILS</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The expenditure category associated with utilities is “Utilities, fuels, and public services”. I’ll store that title to work with later and narrow down the section of the stub file that includes only these expenditures.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>utilities_title <span class="ot">&lt;-</span> integ15_hg <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">str_to_lower</span>(title), <span class="st">"utilities"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb31-3"><a href="#cb31-3"></a>  <span class="fu">pull</span>(title)</span>
<span id="cb31-4"><a href="#cb31-4"></a></span>
<span id="cb31-5"><a href="#cb31-5"></a>utilities_hg <span class="ot">&lt;-</span> <span class="fu">ce_uccs</span>(</span>
<span id="cb31-6"><a href="#cb31-6"></a>  integ15_hg,</span>
<span id="cb31-7"><a href="#cb31-7"></a>  <span class="at">expenditure =</span> utilities_title,</span>
<span id="cb31-8"><a href="#cb31-8"></a>  <span class="at">uccs_only =</span> <span class="cn">FALSE</span></span>
<span id="cb31-9"><a href="#cb31-9"></a>)</span>
<span id="cb31-10"><a href="#cb31-10"></a></span>
<span id="cb31-11"><a href="#cb31-11"></a>utilities_hg <span class="sc">|&gt;</span> <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 7%">
<col style="width: 64%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">level</th>
<th style="text-align: left;">title</th>
<th style="text-align: left;">ucc</th>
<th style="text-align: left;">survey</th>
<th style="text-align: left;">factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: left;">Utilities, fuels, and public services</td>
<td style="text-align: left;">UTILS</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: left;">Natural gas</td>
<td style="text-align: left;">NATRLG</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Utility-natural gas (renter)</td>
<td style="text-align: left;">260211</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Utility-natural gas (owned home)</td>
<td style="text-align: left;">260212</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Utility-natural gas (owned vacation)</td>
<td style="text-align: left;">260213</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Utility-natural gas (rented vacation)</td>
<td style="text-align: left;">260214</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4</td>
<td style="text-align: left;">Electricity</td>
<td style="text-align: left;">ELECTR</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Electricity (renter)</td>
<td style="text-align: left;">260111</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Electricity (owned home)</td>
<td style="text-align: left;">260112</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Electricity (owned vacation)</td>
<td style="text-align: left;">260113</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Electricity (rented vacation)</td>
<td style="text-align: left;">260114</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: left;">Fuel oil and other fuels</td>
<td style="text-align: left;">OTHRFU</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Fuel oil</td>
<td style="text-align: left;">FUELOI</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Fuel oil (renter)</td>
<td style="text-align: left;">250111</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Fuel oil (owned home)</td>
<td style="text-align: left;">250112</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Fuel oil (owned vacation)</td>
<td style="text-align: left;">250113</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Fuel oil (rented vacation)</td>
<td style="text-align: left;">250114</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Coal, wood, and other fuels</td>
<td style="text-align: left;">CLWDOT</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Coal, wood, other fuels (renter)</td>
<td style="text-align: left;">250911</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Coal, wood, other fuels (owned home)</td>
<td style="text-align: left;">250912</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Coal, wood, other fuels (owned vacation)</td>
<td style="text-align: left;">250913</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Coal, wood, other fuels (rented vacation)</td>
<td style="text-align: left;">250914</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Bottled gas</td>
<td style="text-align: left;">BOTTLG</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Gas, btld/tank (renter)</td>
<td style="text-align: left;">250211</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Gas, btld/tank (owned home)</td>
<td style="text-align: left;">250212</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Gas, btld/tank (owned vacation)</td>
<td style="text-align: left;">250213</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Gas, btld/tank (rented vacation)</td>
<td style="text-align: left;">250214</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: left;">Telephone services</td>
<td style="text-align: left;">PHONE</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Residential phone service, VOIP, and phone cards</td>
<td style="text-align: left;">RESPHO</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Phone cards</td>
<td style="text-align: left;">270104</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Residential telephone including VOIP</td>
<td style="text-align: left;">270106</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Cellular phone service</td>
<td style="text-align: left;">270102</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4</td>
<td style="text-align: left;">Water and other public services</td>
<td style="text-align: left;">WATER</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Water and sewerage maintenance</td>
<td style="text-align: left;">SEWER</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Water/sewer maint. (renter)</td>
<td style="text-align: left;">270211</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Water/sewer maint. (owned home)</td>
<td style="text-align: left;">270212</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Water/sewer maint. (owned vacation)</td>
<td style="text-align: left;">270213</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Water/sewer maint. (rented vacation)</td>
<td style="text-align: left;">270214</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Trash and garbage collection</td>
<td style="text-align: left;">TRASH</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Trash/garb. coll. (renter)</td>
<td style="text-align: left;">270411</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Trash/garb. coll. (owned home)</td>
<td style="text-align: left;">270412</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Trash/garb. coll. (owned vacation)</td>
<td style="text-align: left;">270413</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Trash/garb. coll. (rented vacation)</td>
<td style="text-align: left;">270414</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: left;">Septic tank cleaning</td>
<td style="text-align: left;">SEPTAN</td>
<td style="text-align: left;">G</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Septic tank clean. (renter)</td>
<td style="text-align: left;">270901</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Septic tank clean. (owned home)</td>
<td style="text-align: left;">270902</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Septic tank clean. (owned vacation)</td>
<td style="text-align: left;">270903</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: left;">Septic tank clean. (rented vacation)</td>
<td style="text-align: left;">270904</td>
<td style="text-align: left;">I</td>
<td style="text-align: left;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>I also want to know what survey instruments the expenditures are collected through for published estimates. My stub file is the integrated stub file, so I should see both “I” and “D” in the survey column of the stub file if expenditures are collected through both instruments.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>utilities_hg <span class="sc">|&gt;</span> <span class="fu">distinct</span>(survey) <span class="sc">|&gt;</span> <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">survey</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">G</td>
</tr>
<tr class="even">
<td style="text-align: left;">I</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>It seems utilities expenditures are collected only through the Interview survey, so I’ll only need to use Interview data files to calculate estimates.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>fam_type_utilities <span class="ot">&lt;-</span> <span class="fu">ce_prepdata</span>(</span>
<span id="cb33-2"><a href="#cb33-2"></a>  <span class="dv">2015</span>,</span>
<span id="cb33-3"><a href="#cb33-3"></a>  interview,</span>
<span id="cb33-4"><a href="#cb33-4"></a>  utilities_hg,</span>
<span id="cb33-5"><a href="#cb33-5"></a>  <span class="at">uccs =</span> <span class="fu">ce_uccs</span>(utilities_hg, <span class="at">expenditure =</span> utilities_title),</span>
<span id="cb33-6"><a href="#cb33-6"></a>  fam_type, </span>
<span id="cb33-7"><a href="#cb33-7"></a>  <span class="at">int_zp =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw15.zip"</span>),</span>
<span id="cb33-8"><a href="#cb33-8"></a>  <span class="at">recode_variables =</span> <span class="cn">TRUE</span>,</span>
<span id="cb33-9"><a href="#cb33-9"></a>  <span class="at">dict_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"ce-data-dict.xlsx"</span>)</span>
<span id="cb33-10"><a href="#cb33-10"></a>) <span class="sc">|&gt;</span></span>
<span id="cb33-11"><a href="#cb33-11"></a>  <span class="fu">group_nest</span>(fam_type) <span class="sc">|&gt;</span></span>
<span id="cb33-12"><a href="#cb33-12"></a>  <span class="fu">mutate</span>(<span class="at">ce_mean_df =</span> <span class="fu">map</span>(data, ce_mean)) <span class="sc">|&gt;</span></span>
<span id="cb33-13"><a href="#cb33-13"></a>  <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">|&gt;</span></span>
<span id="cb33-14"><a href="#cb33-14"></a>  <span class="fu">unnest</span>(ce_mean_df)</span>
<span id="cb33-15"><a href="#cb33-15"></a></span>
<span id="cb33-16"><a href="#cb33-16"></a>fam_type_utilities <span class="sc">|&gt;</span></span>
<span id="cb33-17"><a href="#cb33-17"></a>  <span class="fu">arrange</span>(fam_type) <span class="sc">|&gt;</span></span>
<span id="cb33-18"><a href="#cb33-18"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 58%">
<col style="width: 12%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">fam_type</th>
<th style="text-align: right;">agg_exp</th>
<th style="text-align: right;">mean_exp</th>
<th style="text-align: right;">se</th>
<th style="text-align: right;">cv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Married Couple only</td>
<td style="text-align: right;">122623482952</td>
<td style="text-align: right;">4378.377</td>
<td style="text-align: right;">76.25699</td>
<td style="text-align: right;">1.741673</td>
</tr>
<tr class="even">
<td style="text-align: left;">Married Couple, own children only, oldest child &lt; 6</td>
<td style="text-align: right;">21592090354</td>
<td style="text-align: right;">4073.529</td>
<td style="text-align: right;">241.48233</td>
<td style="text-align: right;">5.928087</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Married Couple, own children only oldest child &gt;= 6, &lt;= 17</td>
<td style="text-align: right;">73899626502</td>
<td style="text-align: right;">5136.781</td>
<td style="text-align: right;">132.53306</td>
<td style="text-align: right;">2.580080</td>
</tr>
<tr class="even">
<td style="text-align: left;">Married Couple, own children only, oldest child &gt; 17</td>
<td style="text-align: right;">53687574363</td>
<td style="text-align: right;">5585.027</td>
<td style="text-align: right;">190.15164</td>
<td style="text-align: right;">3.404668</td>
</tr>
<tr class="odd">
<td style="text-align: left;">All other Husband and wife families</td>
<td style="text-align: right;">26767356778</td>
<td style="text-align: right;">5699.177</td>
<td style="text-align: right;">331.83382</td>
<td style="text-align: right;">5.822487</td>
</tr>
<tr class="even">
<td style="text-align: left;">One parent, male, own children at least one age &lt; 18</td>
<td style="text-align: right;">4647315390</td>
<td style="text-align: right;">3887.863</td>
<td style="text-align: right;">532.21229</td>
<td style="text-align: right;">13.689069</td>
</tr>
<tr class="odd">
<td style="text-align: left;">One parent, female, own children, at least one age &lt; 18</td>
<td style="text-align: right;">22862016917</td>
<td style="text-align: right;">3684.480</td>
<td style="text-align: right;">237.12762</td>
<td style="text-align: right;">6.435851</td>
</tr>
<tr class="even">
<td style="text-align: left;">Single consumers</td>
<td style="text-align: right;">88002147354</td>
<td style="text-align: right;">2348.182</td>
<td style="text-align: right;">40.59815</td>
<td style="text-align: right;">1.728919</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Other families</td>
<td style="text-align: right;">84986387660</td>
<td style="text-align: right;">3942.345</td>
<td style="text-align: right;">122.97865</td>
<td style="text-align: right;">3.119429</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>And finally, a quick lollipop plot.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>fam_type_utilities <span class="sc">|&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>  <span class="fu">mutate</span>(<span class="at">fam_type =</span> <span class="fu">fct_reorder</span>(fam_type, mean_exp)) <span class="sc">|&gt;</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mean_exp, <span class="at">y =</span> fam_type, mean_exp)) <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">xend =</span> mean_exp, <span class="at">yend =</span> fam_type)) <span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">str_wrap</span>(x, <span class="at">width =</span> <span class="dv">25</span>)) <span class="sc">+</span></span>
<span id="cb34-7"><a href="#cb34-7"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb34-8"><a href="#cb34-8"></a>  <span class="fu">labs</span>(</span>
<span id="cb34-9"><a href="#cb34-9"></a>    <span class="at">y =</span> <span class="st">"CU composition (FAM_TYPE)"</span>,</span>
<span id="cb34-10"><a href="#cb34-10"></a>    <span class="at">x =</span> <span class="st">"Estimated, weighted, annual mean expenditure"</span>,</span>
<span id="cb34-11"><a href="#cb34-11"></a>    <span class="at">title =</span></span>
<span id="cb34-12"><a href="#cb34-12"></a>      <span class="st">"Estimated annual mean utilities expenditures by CU composition"</span></span>
<span id="cb34-13"><a href="#cb34-13"></a>  ) <span class="sc">+</span></span>
<span id="cb34-14"><a href="#cb34-14"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="cepumd-intro_files/figure-html/plot-fam-type-utilities-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>That wraps up this introduction to <code>cepumd</code>. Thank you for taking a look. If you find any bugs, please report them on the <a href="https://github.com/arcenis-r/cepumd/issues">Github repo issues section</a>.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/arcenis-r\.github\.io\/ajr-portfolio");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          trigger: 'click',
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          positionFixed: true,
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="arcenis-r/ajr-portfolio" data-repo-id="MDEwOlJlcG9zaXRvcnkxNzg3MDY3MTM=" data-category="General" data-category-id="DIC_kwDOCqbZGc4CdJXz" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb35" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb35-1"><a href="#cb35-1"></a><span class="co">---</span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="an">title:</span><span class="co"> "Introduction to cepumd"</span></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="an">author:</span><span class="co"> "Arcenis Rojas"</span></span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="an">date:</span><span class="co"> "01/24/2024"</span></span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb35-6"><a href="#cb35-6"></a><span class="an">execute:</span></span>
<span id="cb35-7"><a href="#cb35-7"></a><span class="co">  warning: false</span></span>
<span id="cb35-8"><a href="#cb35-8"></a><span class="co">  error: false</span></span>
<span id="cb35-9"><a href="#cb35-9"></a><span class="an">bibliography:</span><span class="co"> cepumd-intro-references.bib</span></span>
<span id="cb35-10"><a href="#cb35-10"></a><span class="an">categories:</span></span>
<span id="cb35-11"><a href="#cb35-11"></a><span class="co">  - Package Development</span></span>
<span id="cb35-12"><a href="#cb35-12"></a><span class="co">  - Data Wrangling</span></span>
<span id="cb35-13"><a href="#cb35-13"></a><span class="co">---</span></span>
<span id="cb35-14"><a href="#cb35-14"></a></span>
<span id="cb35-15"><a href="#cb35-15"></a><span class="fu">## Motivation</span></span>
<span id="cb35-16"><a href="#cb35-16"></a></span>
<span id="cb35-17"><a href="#cb35-17"></a>::: {layout="<span class="co">[</span><span class="ot">35, 65</span><span class="co">]</span>"}</span>
<span id="cb35-18"><a href="#cb35-18"></a><span class="al">![](images/cepumd.png)</span>{fig-alt="cepumd hexsticker" fig-align="center" width="300"}</span>
<span id="cb35-19"><a href="#cb35-19"></a></span>
<span id="cb35-20"><a href="#cb35-20"></a>::: {layout="<span class="co">[</span><span class="ot">35, 65</span><span class="co">]</span>"}</span>
<span id="cb35-21"><a href="#cb35-21"></a>The purpose of <span class="in">`cepumd`</span> is to make working with Consumer Expenditure Surveys (CE) Public-Use Microdata (PUMD) easier toward calculating mean, weighted, annual expenditures (henceforth "mean expenditures"). The challenges <span class="in">`cepumd`</span> seeks to address deal primarily with pulling together the necessary data toward this end. Some of the overarching ideas underlying the package are as follows:</span>
<span id="cb35-22"><a href="#cb35-22"></a></span>
<span id="cb35-23"><a href="#cb35-23"></a><span class="ss">-   </span>Use a <span class="co">[</span><span class="ot">Tidyverse</span><span class="co">](https://www.tidyverse.org/)</span> framework for most operations and be (hopefully) generally <span class="co">[</span><span class="ot">Tidyverse</span><span class="co">](https://www.tidyverse.org/)</span> friendly</span>
<span id="cb35-24"><a href="#cb35-24"></a></span>
<span id="cb35-25"><a href="#cb35-25"></a><span class="ss">-   </span>Balance the effort to make the end user's experience with CE PUMD easier while being flexible enough to allow that user to perform any analysis with the data they wish</span>
<span id="cb35-26"><a href="#cb35-26"></a></span>
<span id="cb35-27"><a href="#cb35-27"></a><span class="ss">-   </span>Only designed to help users calculate mean **expenditures** on and of the consumer unit (CU), i.e., not income, not assets, not liabilities, not gifts.</span>
<span id="cb35-28"><a href="#cb35-28"></a>:::</span>
<span id="cb35-29"><a href="#cb35-29"></a>:::</span>
<span id="cb35-30"><a href="#cb35-30"></a></span>
<span id="cb35-31"><a href="#cb35-31"></a><span class="fu">## Overview of the CE and CE PUMD</span></span>
<span id="cb35-32"><a href="#cb35-32"></a></span>
<span id="cb35-33"><a href="#cb35-33"></a>First a little history...</span>
<span id="cb35-34"><a href="#cb35-34"></a></span>
<span id="cb35-35"><a href="#cb35-35"></a>The first Consumer Expenditure Survey happened in 1888 (<span class="ot">&lt;https://www.bls.gov/opub/hom/cex/history.htm&gt;</span>), it was first used to revise CPI weights in 1972-1973, and it has been collected on a monthly basis since 1979. For a little bit more detail on the history of the CE, check out the slide deck of a presentation delivered by Steve Henderson (former Chief of the Branch of Information and Analysis) and Adam Safir (current Division Chief of CE) called <span class="co">[</span><span class="ot">130 Years of the Consumer Expenditure Surveys (CE): 1888 - 2018</span><span class="co">](https://www.bls.gov/cex/ce-130-presentation-safir-henderson.pdf)</span></span>
<span id="cb35-36"><a href="#cb35-36"></a></span>
<span id="cb35-37"><a href="#cb35-37"></a>From the CE home page:</span>
<span id="cb35-38"><a href="#cb35-38"></a></span>
<span id="cb35-39"><a href="#cb35-39"></a><span class="at">&gt; "The Consumer Expenditure Surveys (CE) program provides data on expenditures, income, and demographic characteristics of consumers in the United States. The CE program provides these data in tables, LABSTAT database, news releases, reports, and public use microdata files.</span></span>
<span id="cb35-40"><a href="#cb35-40"></a></span>
<span id="cb35-41"><a href="#cb35-41"></a><span class="at">&gt; CE data are collected by the Census Bureau for BLS in two surveys, the Interview Survey for major and/or recurring items and the Diary Survey for more minor or frequently purchased items. CE data are primarily used to revise the relative importance of goods and services in the market basket of the Consumer Price Index. The CE is the only Federal household survey to provide information on the complete range of consumers' expenditures and incomes. Here is an overview of the CE program and its methods."</span></span>
<span id="cb35-42"><a href="#cb35-42"></a></span>
<span id="cb35-43"><a href="#cb35-43"></a>Some important things to note are that expenditure data are collected through two different survey instruments (Diary and Interview), expenditure categories are organized hierarchically, and data are stored across thousands of files to which the CE provides access through their website. Also, given the length of the program, it would be difficult to harmonize data across all those years and files, so there are some inconsistencies in the way data are stored, which <span class="in">`cepumd`</span> seeks to address (more on this further down).</span>
<span id="cb35-44"><a href="#cb35-44"></a></span>
<span id="cb35-45"><a href="#cb35-45"></a>Please visit the following pages to learn more about the CE program overall and CE PUMD more specifically.</span>
<span id="cb35-46"><a href="#cb35-46"></a></span>
<span id="cb35-47"><a href="#cb35-47"></a><span class="ss">-   </span>CE homepage: (<span class="ot">&lt;https://www.bls.gov/cex/)&gt;</span></span>
<span id="cb35-48"><a href="#cb35-48"></a><span class="ss">-   </span>CE PUMD page: (<span class="ot">&lt;https://www.bls.gov/cex/pumd.htm)&gt;</span></span>
<span id="cb35-49"><a href="#cb35-49"></a><span class="ss">-   </span>CE PUMD Getting Started Guide: <span class="ot">&lt;https://www.bls.gov/cex/pumd-getting-started-guide.htm&gt;</span></span>
<span id="cb35-50"><a href="#cb35-50"></a><span class="ss">-   </span>CE Dictionary for Interview and Diary Surveys (XLSX download) (<span class="ot">&lt;https://www.bls.gov/cex/pumd/ce_pumd_interview_diary_dictionary.xlsx)&gt;</span></span>
<span id="cb35-51"><a href="#cb35-51"></a><span class="ss">-   </span>CE PUMD published tables: (<span class="ot">&lt;https://www.bls.gov/cex/tables.htm)&gt;</span></span>
<span id="cb35-52"><a href="#cb35-52"></a><span class="ss">-   </span>CE PUMD Handbook of Methods: <span class="ot">&lt;https://www.bls.gov/opub/hom/cex/&gt;</span></span>
<span id="cb35-53"><a href="#cb35-53"></a><span class="ss">-   </span>CE Frequently Asked Questions: <span class="ot">&lt;https://www.bls.gov/cex/csxfaqs.htm&gt;</span></span>
<span id="cb35-54"><a href="#cb35-54"></a></span>
<span id="cb35-55"><a href="#cb35-55"></a><span class="fu">## Challenges addressed by cepumd</span></span>
<span id="cb35-56"><a href="#cb35-56"></a></span>
<span id="cb35-57"><a href="#cb35-57"></a><span class="in">`cepumd`</span> seeks to address challenges in three categories: data gathering/organization; managing data inconsistencies; and calculating weighted, annual metrics.</span>
<span id="cb35-58"><a href="#cb35-58"></a></span>
<span id="cb35-59"><a href="#cb35-59"></a><span class="ss">-   </span>**Data wrangling**</span>
<span id="cb35-60"><a href="#cb35-60"></a><span class="ss">    -   </span>Convert hierarchical grouping (HG) files to data tables using <span class="in">`ce_hg()`</span></span>
<span id="cb35-61"><a href="#cb35-61"></a><span class="ss">    -   </span>Help the user identify the Universal Classification Codes (UCCs) related to their analysis using a combination of <span class="in">`ce_hg()`</span> and <span class="in">`ce_uccs()`</span></span>
<span id="cb35-62"><a href="#cb35-62"></a><span class="ss">    -   </span>Combine all required files and variables using <span class="in">`ce_prepdata()`</span></span>
<span id="cb35-63"><a href="#cb35-63"></a><span class="ss">-   </span>**Managing data inconsistencies**</span>
<span id="cb35-64"><a href="#cb35-64"></a><span class="ss">    -   </span>Provide the ability to re-code variable categories using the CE Dictionary for Interview and Diary Surveys</span>
<span id="cb35-65"><a href="#cb35-65"></a><span class="ss">    -   </span>Resolve some inconsistencies such as differences code definitions between the Interview and Diary (check the definitions of the "FAM_TYPE" variable categories in 2015 for an example)</span>
<span id="cb35-66"><a href="#cb35-66"></a><span class="ss">    -   </span>Provide useful errors or warnings when there are multiple categories of something the user is trying to access, e.g., some titles in the hierarchical grouping files ("stub" or "HG" files) repeat and requires more careful selection of UCCs</span>
<span id="cb35-67"><a href="#cb35-67"></a><span class="ss">-   </span>**Calculating weighted, annual metrics**</span>
<span id="cb35-68"><a href="#cb35-68"></a><span class="ss">    -   </span>Calculate a mean expenditure with <span class="in">`ce_mean()`</span> or expenditure quantile with <span class="in">`ce_quantile()`</span></span>
<span id="cb35-69"><a href="#cb35-69"></a><span class="ss">    -   </span>Account for the factor (annual vs. quarterly expenditure)</span>
<span id="cb35-70"><a href="#cb35-70"></a><span class="ss">    -   </span>Account for the "months in scope" of a given consumer unit (CU)</span>
<span id="cb35-71"><a href="#cb35-71"></a><span class="ss">    -   </span>Annualize expenditures for either Diary or Interview expenditures</span>
<span id="cb35-72"><a href="#cb35-72"></a><span class="ss">    -   </span>Integrate Interview and Diary data as necessary</span>
<span id="cb35-73"><a href="#cb35-73"></a></span>
<span id="cb35-74"><a href="#cb35-74"></a>Source code and other package information is available at <span class="ot">&lt;https://github.com/arcenis-r/cepumd&gt;</span></span>
<span id="cb35-75"><a href="#cb35-75"></a></span>
<span id="cb35-76"><a href="#cb35-76"></a><span class="fu">## Cautions and recommendations</span></span>
<span id="cb35-77"><a href="#cb35-77"></a></span>
<span id="cb35-78"><a href="#cb35-78"></a><span class="ss">-   </span>Estimates produced using PUMD, which is top-coded by the CE and has some records suppressed to protect respondent confidentiality, will not match the published estimates released by the CE in most cases. The CE's published estimates are based on confidential data that are not top-coded nor have records suppressed. You can learn more at <span class="co">[</span><span class="ot">CE Protection of Respondent Confidentiality</span><span class="co">](https://www.bls.gov/cex/pumd_disclosure.htm)</span>.</span>
<span id="cb35-79"><a href="#cb35-79"></a></span>
<span id="cb35-80"><a href="#cb35-80"></a><span class="ss">-   </span>When calculating estimates for sub-samples or cross-sections of data it is best to stick to the combinations of variables that the CE uses in it's publication tables, e.g., income, geography, composition of CU, size of CU. This is because CE data are collected using a <span class="co">[</span><span class="ot">stratified, random sample</span><span class="co">](https://www.bls.gov/opub/hom/cex/design.htm)</span> (a.k.a., "representative sample") and only analyses conducted using the stratification variables are statistically valid. Using other variables can be helpful to understand spending across different groups, but unweighted estimates are likely more useful for this. <span class="in">`cepumd`</span> currently does not support unweighted estimates, but data for such an analysis can be prepared using <span class="in">`ce_prepdata()`</span>.</span>
<span id="cb35-81"><a href="#cb35-81"></a></span>
<span id="cb35-82"><a href="#cb35-82"></a><span class="ss">-   </span>Quantiles should only be generated using data from 1 survey instrument as the samples for the Interview and Diary are different.</span>
<span id="cb35-83"><a href="#cb35-83"></a></span>
<span id="cb35-84"><a href="#cb35-84"></a><span class="ss">-   </span>Check the expenditure category in the appropriate HG file to ensure that it is the category for which you intend to generate an estimate.</span>
<span id="cb35-85"><a href="#cb35-85"></a></span>
<span id="cb35-86"><a href="#cb35-86"></a><span class="ss">-   </span>Store an HG object in the environment and call that directly in <span class="in">`ce_prepdata()`</span>.</span>
<span id="cb35-87"><a href="#cb35-87"></a></span>
<span id="cb35-88"><a href="#cb35-88"></a><span class="fu">## Installation</span></span>
<span id="cb35-89"><a href="#cb35-89"></a></span>
<span id="cb35-90"><a href="#cb35-90"></a>You can install the development version of <span class="in">`cepumd`</span> from its <span class="co">[</span><span class="ot">GitHub repo</span><span class="co">](https://github.com/arcenis-r/cepumd)</span>.</span>
<span id="cb35-91"><a href="#cb35-91"></a></span>
<span id="cb35-94"><a href="#cb35-94"></a><span class="in">```{r}</span></span>
<span id="cb35-95"><a href="#cb35-95"></a><span class="co">#| label: install-cepumd</span></span>
<span id="cb35-96"><a href="#cb35-96"></a><span class="co">#| eval: false</span></span>
<span id="cb35-97"><a href="#cb35-97"></a></span>
<span id="cb35-98"><a href="#cb35-98"></a>pak<span class="sc">::</span><span class="fu">pkg_install</span>(<span class="st">"arcenis-r/cepumd"</span>)</span>
<span id="cb35-99"><a href="#cb35-99"></a></span>
<span id="cb35-100"><a href="#cb35-100"></a><span class="in">```</span></span>
<span id="cb35-101"><a href="#cb35-101"></a></span>
<span id="cb35-102"><a href="#cb35-102"></a><span class="fu">## Key cepumd functions</span></span>
<span id="cb35-103"><a href="#cb35-103"></a></span>
<span id="cb35-104"><a href="#cb35-104"></a><span class="ss">-   </span>The workhorse of <span class="in">`cepumd`</span> is <span class="in">`ce_prepdata()`</span>. It merges the household characteristics file (FMLI/-D) with the corresponding expenditure tabulation file (MTBI/EXPD) for a specified year, adjusts weights for months-in-scope and the number of collection quarters, adjusts some cost values by their periodicity factor (some cost categories are represented as annual figures and others as quarterly). With the recent update it only requires the first 3 arguments to function: the year, the survey type, and one or more valid UCCs. <span class="in">`ce_prepdata()`</span> now creates all of the other necessary objects within the function if not provided.</span>
<span id="cb35-105"><a href="#cb35-105"></a></span>
<span id="cb35-106"><a href="#cb35-106"></a><span class="ss">-   </span>There are two functions for wrangling hierarchical grouping data into more usable formats:</span>
<span id="cb35-107"><a href="#cb35-107"></a></span>
<span id="cb35-108"><a href="#cb35-108"></a><span class="ss">    -   </span><span class="in">`ce_hg()`</span> pulls the requested type of HG file (Interview, Diary, or Integrated) for a specified year.</span>
<span id="cb35-109"><a href="#cb35-109"></a><span class="ss">    -   </span><span class="in">`ce_uccs()`</span> filters the HG file for the specified expenditure category and returns either a data frame with only that section of the HG file or the Universal Classification Codes (UCCs) that make up that expenditure category.</span>
<span id="cb35-110"><a href="#cb35-110"></a></span>
<span id="cb35-111"><a href="#cb35-111"></a><span class="ss">-   </span>There are two functions that the user can use to calculate CE summary statistics:</span>
<span id="cb35-112"><a href="#cb35-112"></a></span>
<span id="cb35-113"><a href="#cb35-113"></a><span class="ss">    -   </span><span class="in">`ce_mean()`</span> calculates a mean expenditure, standard error of the mean, coefficient of variation, and an aggregate expenditure.</span>
<span id="cb35-114"><a href="#cb35-114"></a><span class="ss">    -   </span><span class="in">`ce_quantiles()`</span> calculates weighted expenditure quantiles. It is important to note that calculating medians for integrated expenditures is not recommended because the calculation involves using weights from both the Diary and Survey instruments.</span>
<span id="cb35-115"><a href="#cb35-115"></a></span>
<span id="cb35-116"><a href="#cb35-116"></a><span class="fu">## Example workflows</span></span>
<span id="cb35-117"><a href="#cb35-117"></a></span>
<span id="cb35-118"><a href="#cb35-118"></a>The following are a few sample workflows that show how <span class="in">`cepumd`</span> can be used. Before jumping into those I'll first install and load the necessary packages and store some CEPUMD files. I'll keep the path to those files in a variable called <span class="in">`ce_data_dir`</span>.</span>
<span id="cb35-119"><a href="#cb35-119"></a></span>
<span id="cb35-122"><a href="#cb35-122"></a><span class="in">```{r}</span></span>
<span id="cb35-123"><a href="#cb35-123"></a><span class="co">#| label: store-data-dir</span></span>
<span id="cb35-124"><a href="#cb35-124"></a><span class="co">#| include: false</span></span>
<span id="cb35-125"><a href="#cb35-125"></a></span>
<span id="cb35-126"><a href="#cb35-126"></a>ce_data_dir <span class="ot">&lt;-</span> <span class="st">"C:/r-projects/ce_data_dir"</span></span>
<span id="cb35-127"><a href="#cb35-127"></a></span>
<span id="cb35-128"><a href="#cb35-128"></a><span class="in">```</span></span>
<span id="cb35-129"><a href="#cb35-129"></a></span>
<span id="cb35-132"><a href="#cb35-132"></a><span class="in">```{r}</span></span>
<span id="cb35-133"><a href="#cb35-133"></a><span class="co">#| label: load-pkgs</span></span>
<span id="cb35-134"><a href="#cb35-134"></a></span>
<span id="cb35-135"><a href="#cb35-135"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(knitr, readxl, tidyverse, cepumd)</span>
<span id="cb35-136"><a href="#cb35-136"></a></span>
<span id="cb35-137"><a href="#cb35-137"></a><span class="in">```</span></span>
<span id="cb35-138"><a href="#cb35-138"></a></span>
<span id="cb35-139"><a href="#cb35-139"></a><span class="fu">### Simple workflow: Integrated pet expenditures</span></span>
<span id="cb35-140"><a href="#cb35-140"></a></span>
<span id="cb35-141"><a href="#cb35-141"></a>The following is an example of how someone might go about using <span class="in">`cepumd`</span> to calculate a 2021 annual, weighted estimate of mean expenditures on pets for all of the U.S. using CE integrated data. This is just a quick and easy calculation.</span>
<span id="cb35-142"><a href="#cb35-142"></a></span>
<span id="cb35-145"><a href="#cb35-145"></a><span class="in">```{r}</span></span>
<span id="cb35-146"><a href="#cb35-146"></a><span class="co">#| label: simple-wflow</span></span>
<span id="cb35-147"><a href="#cb35-147"></a><span class="co">#| cache: true</span></span>
<span id="cb35-148"><a href="#cb35-148"></a></span>
<span id="cb35-149"><a href="#cb35-149"></a>integ21_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb35-150"><a href="#cb35-150"></a>  <span class="dv">2021</span>,</span>
<span id="cb35-151"><a href="#cb35-151"></a>  integrated,</span>
<span id="cb35-152"><a href="#cb35-152"></a>  <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb35-153"><a href="#cb35-153"></a>)</span>
<span id="cb35-154"><a href="#cb35-154"></a></span>
<span id="cb35-155"><a href="#cb35-155"></a><span class="fu">ce_prepdata</span>(</span>
<span id="cb35-156"><a href="#cb35-156"></a>  <span class="dv">2021</span>,</span>
<span id="cb35-157"><a href="#cb35-157"></a>  integrated,</span>
<span id="cb35-158"><a href="#cb35-158"></a>  integ21_hg,</span>
<span id="cb35-159"><a href="#cb35-159"></a>  <span class="at">uccs =</span> <span class="fu">ce_uccs</span>(integ21_hg, <span class="at">expenditure =</span> <span class="st">"Pets"</span>, <span class="at">ucc_group =</span> <span class="st">"PETS"</span>),</span>
<span id="cb35-160"><a href="#cb35-160"></a>  <span class="at">dia_zp =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"diary21.zip"</span>),</span>
<span id="cb35-161"><a href="#cb35-161"></a>  <span class="at">int_zp =</span> <span class="fu">c</span>(</span>
<span id="cb35-162"><a href="#cb35-162"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw20.zip"</span>),</span>
<span id="cb35-163"><a href="#cb35-163"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw21.zip"</span>)</span>
<span id="cb35-164"><a href="#cb35-164"></a>  )</span>
<span id="cb35-165"><a href="#cb35-165"></a>) <span class="sc">|&gt;</span></span>
<span id="cb35-166"><a href="#cb35-166"></a>  <span class="fu">ce_mean</span>() <span class="sc">|&gt;</span></span>
<span id="cb35-167"><a href="#cb35-167"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-168"><a href="#cb35-168"></a><span class="in">```</span></span>
<span id="cb35-169"><a href="#cb35-169"></a></span>
<span id="cb35-170"><a href="#cb35-170"></a>Yup... that's all it takes. I simply ran <span class="in">`ce_hg`</span> to get the hierarchical grouping (stub) file for integrated expenditures for 2021; then ran <span class="in">`ce_prepdata()`</span> with the year, the survey type, the stub file, uccs I needed, and the file paths to where I downloaded the data files; then I piped that directly into <span class="in">`ce_mean()`</span>. An important thing to notice is that I provided two file paths to the <span class="in">`int_zp`</span> argument. I did this because calculating integrated CE annual estimates actually requires 5 quarters of data from the Interview survey. Some of the data for calculating 2021 estimates is provided in the 2020 Interview data.This is one of the reasons it's important to be familiar with <span class="co">[</span><span class="ot">CE methodology</span><span class="co">](https://www.bls.gov/cex/pumd-getting-started-guide.htm#section6)</span> and how it changes over time when working with CE PUMD. Prior to 2020, file storing practices were different as stated in the <span class="co">[</span><span class="ot">Getting Started Guide Interview Survey section</span><span class="co">](https://www.bls.gov/cex/pumd-getting-started-guide.htm#section3)</span>.</span>
<span id="cb35-171"><a href="#cb35-171"></a></span>
<span id="cb35-172"><a href="#cb35-172"></a><span class="fu">### Slightly more advanced workflow: Used Car &amp; Truck Expenditures by Urbanicity</span></span>
<span id="cb35-173"><a href="#cb35-173"></a></span>
<span id="cb35-174"><a href="#cb35-174"></a>In this example I'll calculate estimated annual expenditures on new and used cars by urbanicity also for 2021. Once the data are prepped with <span class="in">`ce_data()`</span> I'll just nest the data by urbanicity and run <span class="in">`ce_means()`</span> and <span class="in">`ce_quantiles()`</span> on the nested data sets. Since the overwhelming number of reports of vehicle purchases occur in the Interview survey, I'll only use Interview data.</span>
<span id="cb35-175"><a href="#cb35-175"></a></span>
<span id="cb35-176"><a href="#cb35-176"></a>First I'll get the stub file and filter it for categories involving new or used cars.</span>
<span id="cb35-177"><a href="#cb35-177"></a></span>
<span id="cb35-180"><a href="#cb35-180"></a><span class="in">```{r}</span></span>
<span id="cb35-181"><a href="#cb35-181"></a><span class="co">#| label: new-used-cars</span></span>
<span id="cb35-182"><a href="#cb35-182"></a></span>
<span id="cb35-183"><a href="#cb35-183"></a>int21_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb35-184"><a href="#cb35-184"></a>  <span class="dv">2021</span>,</span>
<span id="cb35-185"><a href="#cb35-185"></a>  interview,</span>
<span id="cb35-186"><a href="#cb35-186"></a>  <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb35-187"><a href="#cb35-187"></a>)</span>
<span id="cb35-188"><a href="#cb35-188"></a></span>
<span id="cb35-189"><a href="#cb35-189"></a>int21_hg <span class="sc">|&gt;</span></span>
<span id="cb35-190"><a href="#cb35-190"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(title, <span class="st">"[C|c]ars"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-191"><a href="#cb35-191"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-192"><a href="#cb35-192"></a></span>
<span id="cb35-193"><a href="#cb35-193"></a><span class="in">```</span></span>
<span id="cb35-194"><a href="#cb35-194"></a></span>
<span id="cb35-195"><a href="#cb35-195"></a>So there's one UCC for "New cars" and one for "Used cars". I'll use the code above to grab those UCCs and prepare my data.</span>
<span id="cb35-196"><a href="#cb35-196"></a></span>
<span id="cb35-199"><a href="#cb35-199"></a><span class="in">```{r}</span></span>
<span id="cb35-200"><a href="#cb35-200"></a><span class="co">#| label: cars-trucks-means</span></span>
<span id="cb35-201"><a href="#cb35-201"></a><span class="co">#| cache: true</span></span>
<span id="cb35-202"><a href="#cb35-202"></a></span>
<span id="cb35-203"><a href="#cb35-203"></a>car_data <span class="ot">&lt;-</span> <span class="fu">ce_prepdata</span>(</span>
<span id="cb35-204"><a href="#cb35-204"></a>  <span class="dv">2021</span>,</span>
<span id="cb35-205"><a href="#cb35-205"></a>  interview,</span>
<span id="cb35-206"><a href="#cb35-206"></a>  int21_hg,</span>
<span id="cb35-207"><a href="#cb35-207"></a>  <span class="at">uccs =</span> int21_hg <span class="sc">|&gt;</span></span>
<span id="cb35-208"><a href="#cb35-208"></a>    <span class="fu">filter</span>(<span class="fu">str_detect</span>(title, <span class="st">"[C|c]ars"</span>), <span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">as.numeric</span>(ucc))) <span class="sc">|&gt;</span></span>
<span id="cb35-209"><a href="#cb35-209"></a>    <span class="fu">pull</span>(ucc),</span>
<span id="cb35-210"><a href="#cb35-210"></a>  bls_urbn,  <span class="co"># &lt;------- this is the variable for urbanicity</span></span>
<span id="cb35-211"><a href="#cb35-211"></a>  <span class="at">int_zp =</span> <span class="fu">c</span>(</span>
<span id="cb35-212"><a href="#cb35-212"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw20.zip"</span>),</span>
<span id="cb35-213"><a href="#cb35-213"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw21.zip"</span>)</span>
<span id="cb35-214"><a href="#cb35-214"></a>  ),</span>
<span id="cb35-215"><a href="#cb35-215"></a>  <span class="at">recode_variables =</span> <span class="cn">TRUE</span>,</span>
<span id="cb35-216"><a href="#cb35-216"></a>  <span class="at">dict_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"ce-data-dict.xlsx"</span>)</span>
<span id="cb35-217"><a href="#cb35-217"></a>)</span>
<span id="cb35-218"><a href="#cb35-218"></a></span>
<span id="cb35-219"><a href="#cb35-219"></a>car_data <span class="sc">|&gt;</span></span>
<span id="cb35-220"><a href="#cb35-220"></a>  <span class="fu">group_nest</span>(bls_urbn) <span class="sc">|&gt;</span></span>
<span id="cb35-221"><a href="#cb35-221"></a>  <span class="fu">mutate</span>(<span class="at">ce_ann_means =</span> <span class="fu">map</span>(data, ce_mean)) <span class="sc">|&gt;</span></span>
<span id="cb35-222"><a href="#cb35-222"></a>  <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">|&gt;</span></span>
<span id="cb35-223"><a href="#cb35-223"></a>  <span class="fu">unnest</span>(ce_ann_means) <span class="sc">|&gt;</span></span>
<span id="cb35-224"><a href="#cb35-224"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-225"><a href="#cb35-225"></a></span>
<span id="cb35-226"><a href="#cb35-226"></a><span class="in">```</span></span>
<span id="cb35-227"><a href="#cb35-227"></a></span>
<span id="cb35-228"><a href="#cb35-228"></a>Getting the annual, weighted estimate of the median (or another quantile) would be just as easy. Since I'm using interview data only here (it would be bad practice to try to calculate quantiles with integrated data), this would be a good example. I'll calculate the first percentile and the median along with the 0.991 through 0.999 quantiles for the overall sample rather than breaking it down by urbanicity.</span>
<span id="cb35-229"><a href="#cb35-229"></a></span>
<span id="cb35-232"><a href="#cb35-232"></a><span class="in">```{r}</span></span>
<span id="cb35-233"><a href="#cb35-233"></a><span class="co">#| label: cars-trucks-quantiles</span></span>
<span id="cb35-234"><a href="#cb35-234"></a><span class="co">#| cache: true</span></span>
<span id="cb35-235"><a href="#cb35-235"></a></span>
<span id="cb35-236"><a href="#cb35-236"></a><span class="fu">ce_quantiles</span>(</span>
<span id="cb35-237"><a href="#cb35-237"></a>  car_data,</span>
<span id="cb35-238"><a href="#cb35-238"></a>  <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="fu">seq</span>(<span class="fl">0.99</span>, <span class="fl">0.999</span>, <span class="at">by =</span> <span class="fl">0.001</span>))</span>
<span id="cb35-239"><a href="#cb35-239"></a>) <span class="sc">|&gt;</span></span>
<span id="cb35-240"><a href="#cb35-240"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-241"><a href="#cb35-241"></a></span>
<span id="cb35-242"><a href="#cb35-242"></a><span class="in">```</span></span>
<span id="cb35-243"><a href="#cb35-243"></a></span>
<span id="cb35-244"><a href="#cb35-244"></a>At least 95% of households in the Interview survey did not report expenditures on cars in 2021, which explains why the mean is so low.</span>
<span id="cb35-245"><a href="#cb35-245"></a></span>
<span id="cb35-246"><a href="#cb35-246"></a><span class="fu">### Very advanced workflow: Inflation adjusted food away from home expenditures by household size</span></span>
<span id="cb35-247"><a href="#cb35-247"></a></span>
<span id="cb35-248"><a href="#cb35-248"></a>In this last example I'm going to assume very little knowledge about the CE. I'd like to compare mean annual expenditures on food away from home between 2010 and 2020 by household size and I want to convert expenditures to 2023 dollars using the CPI. First I'd go to the <span class="co">[</span><span class="ot">CE PUMD Data Files</span><span class="co">](https://www.bls.gov/cex/pumd_data.htm#csv)</span> page and download the files that I need for both years. I'll also go to the <span class="co">[</span><span class="ot">CE PUMD Documentation</span><span class="co">](https://www.bls.gov/cex/pumd_doc.htm)</span> page to download the hierarchical grouping files to get the UCCs for "Food away from home" and the CE Dictionary to find out what variable has data on the household size.</span>
<span id="cb35-249"><a href="#cb35-249"></a></span>
<span id="cb35-250"><a href="#cb35-250"></a>With all that done, now I want to look at the hierarchical grouping files for 2010 and 2020 for integrated data as they relate to "Food away from home".</span>
<span id="cb35-251"><a href="#cb35-251"></a></span>
<span id="cb35-254"><a href="#cb35-254"></a><span class="in">```{r}</span></span>
<span id="cb35-255"><a href="#cb35-255"></a><span class="co">#| label: convert-food-stubs</span></span>
<span id="cb35-256"><a href="#cb35-256"></a></span>
<span id="cb35-257"><a href="#cb35-257"></a>integ10_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb35-258"><a href="#cb35-258"></a>  <span class="dv">2010</span>,</span>
<span id="cb35-259"><a href="#cb35-259"></a>  integrated,</span>
<span id="cb35-260"><a href="#cb35-260"></a>  <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb35-261"><a href="#cb35-261"></a>)</span>
<span id="cb35-262"><a href="#cb35-262"></a></span>
<span id="cb35-263"><a href="#cb35-263"></a>integ20_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb35-264"><a href="#cb35-264"></a>  <span class="dv">2020</span>,</span>
<span id="cb35-265"><a href="#cb35-265"></a>  integrated,</span>
<span id="cb35-266"><a href="#cb35-266"></a>  <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb35-267"><a href="#cb35-267"></a>)</span>
<span id="cb35-268"><a href="#cb35-268"></a></span>
<span id="cb35-269"><a href="#cb35-269"></a><span class="in">```</span></span>
<span id="cb35-270"><a href="#cb35-270"></a></span>
<span id="cb35-271"><a href="#cb35-271"></a>First I'll explore the titles of the hierarchical grouping files to see if any of them mention "food away"</span>
<span id="cb35-272"><a href="#cb35-272"></a></span>
<span id="cb35-275"><a href="#cb35-275"></a><span class="in">```{r}</span></span>
<span id="cb35-276"><a href="#cb35-276"></a><span class="co">#| label: check-stub-title2010</span></span>
<span id="cb35-277"><a href="#cb35-277"></a></span>
<span id="cb35-278"><a href="#cb35-278"></a>integ10_hg <span class="sc">|&gt;</span></span>
<span id="cb35-279"><a href="#cb35-279"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">str_to_lower</span>(title), <span class="st">"food away"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-280"><a href="#cb35-280"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-281"><a href="#cb35-281"></a></span>
<span id="cb35-282"><a href="#cb35-282"></a><span class="in">```</span></span>
<span id="cb35-283"><a href="#cb35-283"></a></span>
<span id="cb35-284"><a href="#cb35-284"></a>Now I'll do the same for 2020.</span>
<span id="cb35-285"><a href="#cb35-285"></a></span>
<span id="cb35-288"><a href="#cb35-288"></a><span class="in">```{r}</span></span>
<span id="cb35-289"><a href="#cb35-289"></a><span class="co">#| label: check-stub-title2020</span></span>
<span id="cb35-290"><a href="#cb35-290"></a></span>
<span id="cb35-291"><a href="#cb35-291"></a>integ20_hg <span class="sc">|&gt;</span></span>
<span id="cb35-292"><a href="#cb35-292"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">str_to_lower</span>(title), <span class="st">"food away"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-293"><a href="#cb35-293"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-294"><a href="#cb35-294"></a></span>
<span id="cb35-295"><a href="#cb35-295"></a><span class="in">```</span></span>
<span id="cb35-296"><a href="#cb35-296"></a></span>
<span id="cb35-297"><a href="#cb35-297"></a>Here I'll take note of the title, which is the same in both years ("Food away from home"). I'll use that to get the UCCs for both years.</span>
<span id="cb35-298"><a href="#cb35-298"></a></span>
<span id="cb35-301"><a href="#cb35-301"></a><span class="in">```{r}</span></span>
<span id="cb35-302"><a href="#cb35-302"></a><span class="co">#| label: get-food-uccs</span></span>
<span id="cb35-303"><a href="#cb35-303"></a></span>
<span id="cb35-304"><a href="#cb35-304"></a>food_away_uccs_10 <span class="ot">&lt;-</span> integ10_hg <span class="sc">|&gt;</span></span>
<span id="cb35-305"><a href="#cb35-305"></a>  <span class="fu">ce_uccs</span>(<span class="at">expenditure =</span> <span class="st">"Food away from home"</span>)</span>
<span id="cb35-306"><a href="#cb35-306"></a></span>
<span id="cb35-307"><a href="#cb35-307"></a>food_away_uccs_20 <span class="ot">&lt;-</span> integ20_hg <span class="sc">|&gt;</span></span>
<span id="cb35-308"><a href="#cb35-308"></a>  <span class="fu">ce_uccs</span>(<span class="at">expenditure =</span> <span class="st">"Food away from home"</span>)</span>
<span id="cb35-309"><a href="#cb35-309"></a><span class="in">```</span></span>
<span id="cb35-310"><a href="#cb35-310"></a></span>
<span id="cb35-311"><a href="#cb35-311"></a>Here's a quick look at the UCCs from 2010.</span>
<span id="cb35-312"><a href="#cb35-312"></a></span>
<span id="cb35-315"><a href="#cb35-315"></a><span class="in">```{r}</span></span>
<span id="cb35-316"><a href="#cb35-316"></a><span class="co">#| label: show-food-uccs10</span></span>
<span id="cb35-317"><a href="#cb35-317"></a></span>
<span id="cb35-318"><a href="#cb35-318"></a>food_away_uccs_10</span>
<span id="cb35-319"><a href="#cb35-319"></a></span>
<span id="cb35-320"><a href="#cb35-320"></a><span class="in">```</span></span>
<span id="cb35-321"><a href="#cb35-321"></a></span>
<span id="cb35-322"><a href="#cb35-322"></a>Now the 2020 UCCs.</span>
<span id="cb35-323"><a href="#cb35-323"></a></span>
<span id="cb35-326"><a href="#cb35-326"></a><span class="in">```{r}</span></span>
<span id="cb35-327"><a href="#cb35-327"></a><span class="co">#| label: show-food-uccs20</span></span>
<span id="cb35-328"><a href="#cb35-328"></a></span>
<span id="cb35-329"><a href="#cb35-329"></a>food_away_uccs_10</span>
<span id="cb35-330"><a href="#cb35-330"></a><span class="in">```</span></span>
<span id="cb35-331"><a href="#cb35-331"></a></span>
<span id="cb35-332"><a href="#cb35-332"></a>The vectors of UCCs look identical, but I'll keep both just to be cautious.</span>
<span id="cb35-333"><a href="#cb35-333"></a></span>
<span id="cb35-334"><a href="#cb35-334"></a>Next I'll turn to finding the variable for household size in the CE data dictionary. It's important to remember that the dictionary is stored as an "XLSX" file. I'll use functions from the <span class="in">`readxl`</span> package to work with the dictionary.</span>
<span id="cb35-335"><a href="#cb35-335"></a></span>
<span id="cb35-338"><a href="#cb35-338"></a><span class="in">```{r}</span></span>
<span id="cb35-339"><a href="#cb35-339"></a><span class="co">#| label: show-dict-sheets</span></span>
<span id="cb35-340"><a href="#cb35-340"></a></span>
<span id="cb35-341"><a href="#cb35-341"></a><span class="fu">excel_sheets</span>(<span class="fu">file.path</span>(ce_data_dir, <span class="st">"ce-data-dict.xlsx"</span>))</span>
<span id="cb35-342"><a href="#cb35-342"></a></span>
<span id="cb35-343"><a href="#cb35-343"></a><span class="in">```</span></span>
<span id="cb35-344"><a href="#cb35-344"></a></span>
<span id="cb35-345"><a href="#cb35-345"></a>Now I'll see what variables contain anything about the number of household members. To do that I'll have to load the sheet from the dictionary containing the variable definitions. I also want to filter the variable data to only the FMLI where the "Last year" column is missing, i.e., the variable definition is still in use.</span>
<span id="cb35-346"><a href="#cb35-346"></a></span>
<span id="cb35-349"><a href="#cb35-349"></a><span class="in">```{r}</span></span>
<span id="cb35-350"><a href="#cb35-350"></a><span class="co">#| label: cu-size-vars</span></span>
<span id="cb35-351"><a href="#cb35-351"></a></span>
<span id="cb35-352"><a href="#cb35-352"></a>ce_variables <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(</span>
<span id="cb35-353"><a href="#cb35-353"></a>  <span class="fu">file.path</span>(ce_data_dir, <span class="st">"ce-data-dict.xlsx"</span>),</span>
<span id="cb35-354"><a href="#cb35-354"></a>  <span class="at">sheet =</span> <span class="st">"Variables"</span></span>
<span id="cb35-355"><a href="#cb35-355"></a>)</span>
<span id="cb35-356"><a href="#cb35-356"></a></span>
<span id="cb35-357"><a href="#cb35-357"></a>ce_variables <span class="sc">|&gt;</span></span>
<span id="cb35-358"><a href="#cb35-358"></a>  <span class="fu">filter</span>(</span>
<span id="cb35-359"><a href="#cb35-359"></a>    <span class="fu">str_detect</span>(File, <span class="st">"FMLI"</span>),</span>
<span id="cb35-360"><a href="#cb35-360"></a>    <span class="fu">str_detect</span>(</span>
<span id="cb35-361"><a href="#cb35-361"></a>      <span class="fu">tolower</span>(<span class="st">`</span><span class="at">Variable description</span><span class="st">`</span>), <span class="st">"number of members"</span></span>
<span id="cb35-362"><a href="#cb35-362"></a>    )</span>
<span id="cb35-363"><a href="#cb35-363"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb35-364"><a href="#cb35-364"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-365"><a href="#cb35-365"></a><span class="in">```</span></span>
<span id="cb35-366"><a href="#cb35-366"></a></span>
<span id="cb35-367"><a href="#cb35-367"></a>It looks like FAM_SIZE is the variable I want. I can see that this variable was used from 1980 through 1981 then was dropped and re-introduced in 1984 and has been in use since. So it looks like it's available for my 2 years of interest. Next I'll check whether the FAM_SIZE variable has any value codes associated with it. I'll have to pull in the "Codes" sheet. (Check your spelling here.)</span>
<span id="cb35-368"><a href="#cb35-368"></a></span>
<span id="cb35-371"><a href="#cb35-371"></a><span class="in">```{r}</span></span>
<span id="cb35-372"><a href="#cb35-372"></a><span class="co">#| label: fam-size-codes</span></span>
<span id="cb35-373"><a href="#cb35-373"></a></span>
<span id="cb35-374"><a href="#cb35-374"></a>ce_codes <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(</span>
<span id="cb35-375"><a href="#cb35-375"></a>  <span class="fu">file.path</span>(ce_data_dir, <span class="st">"ce-data-dict.xlsx"</span>),</span>
<span id="cb35-376"><a href="#cb35-376"></a>  <span class="at">sheet =</span> <span class="st">"Codes "</span></span>
<span id="cb35-377"><a href="#cb35-377"></a>)</span>
<span id="cb35-378"><a href="#cb35-378"></a></span>
<span id="cb35-379"><a href="#cb35-379"></a>ce_codes <span class="sc">|&gt;</span></span>
<span id="cb35-380"><a href="#cb35-380"></a>  <span class="fu">filter</span>(File <span class="sc">%in%</span> <span class="st">"FMLI"</span>, Variable <span class="sc">%in%</span> <span class="st">"FAM_SIZE"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-381"><a href="#cb35-381"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-382"><a href="#cb35-382"></a><span class="in">```</span></span>
<span id="cb35-383"><a href="#cb35-383"></a></span>
<span id="cb35-384"><a href="#cb35-384"></a>It looks like FAM_SIZE is not a coded variable (no observations in the "Codes" sheet), so it must be numeric. With all that, I'm ready to prepare my data. I'll start by preparing the 2010 data and getting a summary of the FAM_SIZE variable since it is a continuous variable.</span>
<span id="cb35-385"><a href="#cb35-385"></a></span>
<span id="cb35-388"><a href="#cb35-388"></a><span class="in">```{r}</span></span>
<span id="cb35-389"><a href="#cb35-389"></a><span class="co">#| label: prep-data10</span></span>
<span id="cb35-390"><a href="#cb35-390"></a><span class="co">#| cache: true</span></span>
<span id="cb35-391"><a href="#cb35-391"></a></span>
<span id="cb35-392"><a href="#cb35-392"></a>food_away_data_10 <span class="ot">&lt;-</span> <span class="fu">ce_prepdata</span>(</span>
<span id="cb35-393"><a href="#cb35-393"></a>  <span class="dv">2010</span>,</span>
<span id="cb35-394"><a href="#cb35-394"></a>  integrated,</span>
<span id="cb35-395"><a href="#cb35-395"></a>  integ10_hg,</span>
<span id="cb35-396"><a href="#cb35-396"></a>  food_away_uccs_10,</span>
<span id="cb35-397"><a href="#cb35-397"></a>  <span class="at">dia_zp =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"diary10.zip"</span>),</span>
<span id="cb35-398"><a href="#cb35-398"></a>  <span class="at">int_zp =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw10.zip"</span>),</span>
<span id="cb35-399"><a href="#cb35-399"></a>  fam_size</span>
<span id="cb35-400"><a href="#cb35-400"></a>)</span>
<span id="cb35-401"><a href="#cb35-401"></a></span>
<span id="cb35-402"><a href="#cb35-402"></a><span class="fu">summary</span>(food_away_data_10<span class="sc">$</span>fam_size)</span>
<span id="cb35-403"><a href="#cb35-403"></a><span class="in">```</span></span>
<span id="cb35-404"><a href="#cb35-404"></a></span>
<span id="cb35-405"><a href="#cb35-405"></a>Since some households have as many as 14 people, I'll create a FAM_SIZE label with any number greater than 4 taking on the value "5+". Next, I'll prepare the 2020 data and row bind it with the 2010 data as well as create the "fam_size_label" variable. I'm also going to convert "ref_mo" and "ref_yr" to character to make it compatible with the CPI data that I'll get later. I'll also take a look at just a snippet of the data.</span>
<span id="cb35-406"><a href="#cb35-406"></a></span>
<span id="cb35-409"><a href="#cb35-409"></a><span class="in">```{r}</span></span>
<span id="cb35-410"><a href="#cb35-410"></a><span class="co">#| label: prep-data20</span></span>
<span id="cb35-411"><a href="#cb35-411"></a><span class="co">#| cache: true</span></span>
<span id="cb35-412"><a href="#cb35-412"></a></span>
<span id="cb35-413"><a href="#cb35-413"></a>food_away_data_20 <span class="ot">&lt;-</span> <span class="fu">ce_prepdata</span>(</span>
<span id="cb35-414"><a href="#cb35-414"></a>  <span class="dv">2020</span>,</span>
<span id="cb35-415"><a href="#cb35-415"></a>  integrated,</span>
<span id="cb35-416"><a href="#cb35-416"></a>  integ10_hg,</span>
<span id="cb35-417"><a href="#cb35-417"></a>  food_away_uccs_20,</span>
<span id="cb35-418"><a href="#cb35-418"></a>  <span class="at">dia_zp =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"diary20.zip"</span>),</span>
<span id="cb35-419"><a href="#cb35-419"></a>  <span class="at">int_zp =</span> <span class="fu">c</span>(</span>
<span id="cb35-420"><a href="#cb35-420"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw19.zip"</span>),</span>
<span id="cb35-421"><a href="#cb35-421"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw20.zip"</span>)</span>
<span id="cb35-422"><a href="#cb35-422"></a>  ),</span>
<span id="cb35-423"><a href="#cb35-423"></a>  fam_size</span>
<span id="cb35-424"><a href="#cb35-424"></a>)</span>
<span id="cb35-425"><a href="#cb35-425"></a></span>
<span id="cb35-426"><a href="#cb35-426"></a>food_away_comp_data <span class="ot">&lt;-</span> food_away_data_10 <span class="sc">|&gt;</span></span>
<span id="cb35-427"><a href="#cb35-427"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="st">"2010"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-428"><a href="#cb35-428"></a>  <span class="fu">bind_rows</span>(food_away_data_20 <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">year =</span> <span class="st">"2020"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-429"><a href="#cb35-429"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-430"><a href="#cb35-430"></a>    <span class="at">fam_size_label =</span> <span class="fu">if_else</span>(fam_size <span class="sc">&gt;</span> <span class="dv">4</span>, <span class="st">"5+"</span>, <span class="fu">as.character</span>(fam_size)),</span>
<span id="cb35-431"><a href="#cb35-431"></a>    <span class="at">ref_yr =</span> <span class="fu">as.character</span>(ref_yr)</span>
<span id="cb35-432"><a href="#cb35-432"></a>  )</span>
<span id="cb35-433"><a href="#cb35-433"></a></span>
<span id="cb35-434"><a href="#cb35-434"></a>food_away_comp_data <span class="sc">|&gt;</span></span>
<span id="cb35-435"><a href="#cb35-435"></a>  <span class="fu">select</span>(survey, year, newid, finlwt21, cost, ucc, ref_yr, ref_mo) <span class="sc">|&gt;</span></span>
<span id="cb35-436"><a href="#cb35-436"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ucc)) <span class="sc">|&gt;</span></span>
<span id="cb35-437"><a href="#cb35-437"></a>  <span class="fu">group_by</span>(year, survey) <span class="sc">|&gt;</span></span>
<span id="cb35-438"><a href="#cb35-438"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-439"><a href="#cb35-439"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb35-440"><a href="#cb35-440"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-441"><a href="#cb35-441"></a><span class="in">```</span></span>
<span id="cb35-442"><a href="#cb35-442"></a></span>
<span id="cb35-443"><a href="#cb35-443"></a>I'll now get CPI data for the years in the analysis and for 2023 to set as a base using the <span class="in">`blsR`</span> package (<span class="ot">&lt;https://github.com/groditi/blsR&gt;</span>). I'm going to use the "All Urban Consumers (Current Series)" series, which has series ID "CUUR0000SA0".</span>
<span id="cb35-444"><a href="#cb35-444"></a></span>
<span id="cb35-447"><a href="#cb35-447"></a><span class="in">```{r}</span></span>
<span id="cb35-448"><a href="#cb35-448"></a><span class="co">#| label: get-cpi-data</span></span>
<span id="cb35-449"><a href="#cb35-449"></a><span class="co">#| cache: true</span></span>
<span id="cb35-450"><a href="#cb35-450"></a></span>
<span id="cb35-451"><a href="#cb35-451"></a>cpi_data <span class="ot">&lt;-</span> blsR<span class="sc">::</span><span class="fu">get_series</span>(</span>
<span id="cb35-452"><a href="#cb35-452"></a>  <span class="st">"CUUR0000SA0"</span>,</span>
<span id="cb35-453"><a href="#cb35-453"></a>  <span class="at">start_year =</span> <span class="dv">2010</span>,</span>
<span id="cb35-454"><a href="#cb35-454"></a>  <span class="at">end_year =</span> <span class="dv">2023</span></span>
<span id="cb35-455"><a href="#cb35-455"></a>) <span class="sc">|&gt;</span></span>
<span id="cb35-456"><a href="#cb35-456"></a>  <span class="fu">pluck</span>(<span class="st">"data"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-457"><a href="#cb35-457"></a>  <span class="fu">map</span>(</span>
<span id="cb35-458"><a href="#cb35-458"></a>    \(x) <span class="fu">list_flatten</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb35-459"><a href="#cb35-459"></a>      <span class="fu">enframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb35-460"><a href="#cb35-460"></a>      <span class="fu">filter</span>(<span class="sc">!</span>name <span class="sc">%in%</span> <span class="st">"footnotes"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-461"><a href="#cb35-461"></a>      <span class="fu">unnest</span>(value) <span class="sc">|&gt;</span></span>
<span id="cb35-462"><a href="#cb35-462"></a>      <span class="fu">pivot_wider</span>(<span class="at">values_from =</span> value, <span class="at">names_from =</span> name)</span>
<span id="cb35-463"><a href="#cb35-463"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb35-464"><a href="#cb35-464"></a>  <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span></span>
<span id="cb35-465"><a href="#cb35-465"></a>  <span class="fu">rename</span>(<span class="at">cpi =</span> <span class="st">"value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-466"><a href="#cb35-466"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">match</span>(periodName, month.name))</span>
<span id="cb35-467"><a href="#cb35-467"></a></span>
<span id="cb35-468"><a href="#cb35-468"></a>cpi_base <span class="ot">&lt;-</span> cpi_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="st">"2023"</span>, month <span class="sc">%in%</span> <span class="st">"12"</span>)</span>
<span id="cb35-469"><a href="#cb35-469"></a></span>
<span id="cb35-470"><a href="#cb35-470"></a>cpi_data <span class="ot">&lt;-</span> cpi_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="fu">unique</span>(food_away_comp_data<span class="sc">$</span>ref_yr))</span>
<span id="cb35-471"><a href="#cb35-471"></a></span>
<span id="cb35-472"><a href="#cb35-472"></a>cpi_data <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">|&gt;</span> <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-473"><a href="#cb35-473"></a><span class="in">```</span></span>
<span id="cb35-474"><a href="#cb35-474"></a></span>
<span id="cb35-475"><a href="#cb35-475"></a>The base that I'm going to covert to is December 2023.</span>
<span id="cb35-476"><a href="#cb35-476"></a></span>
<span id="cb35-479"><a href="#cb35-479"></a><span class="in">```{r}</span></span>
<span id="cb35-480"><a href="#cb35-480"></a><span class="co">#| label: show-cpi-base</span></span>
<span id="cb35-481"><a href="#cb35-481"></a></span>
<span id="cb35-482"><a href="#cb35-482"></a>cpi_base <span class="sc">|&gt;</span> <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-483"><a href="#cb35-483"></a></span>
<span id="cb35-484"><a href="#cb35-484"></a><span class="in">```</span></span>
<span id="cb35-485"><a href="#cb35-485"></a></span>
<span id="cb35-486"><a href="#cb35-486"></a>Next I'm going to join the CPI data to the CE data and adjust the "cost" variable for inflation. Note that I replace resulting missing values in the "cost" variable with "0". Missing values will result when I multiply a cost of "0" by an adjustment factor and <span class="in">`ce_mean()`</span> will not function with missing values.</span>
<span id="cb35-487"><a href="#cb35-487"></a></span>
<span id="cb35-490"><a href="#cb35-490"></a><span class="in">```{r}</span></span>
<span id="cb35-491"><a href="#cb35-491"></a><span class="co">#| label: inflation-adjust</span></span>
<span id="cb35-492"><a href="#cb35-492"></a></span>
<span id="cb35-493"><a href="#cb35-493"></a>food_away_comp_data <span class="ot">&lt;-</span> food_away_comp_data <span class="sc">|&gt;</span></span>
<span id="cb35-494"><a href="#cb35-494"></a>  <span class="fu">left_join</span>(</span>
<span id="cb35-495"><a href="#cb35-495"></a>    <span class="fu">select</span>(cpi_data, year, month, cpi),</span>
<span id="cb35-496"><a href="#cb35-496"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ref_yr"</span> <span class="ot">=</span> <span class="st">"year"</span>, <span class="st">"ref_mo"</span> <span class="ot">=</span> <span class="st">"month"</span>)</span>
<span id="cb35-497"><a href="#cb35-497"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb35-498"><a href="#cb35-498"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-499"><a href="#cb35-499"></a>    <span class="at">base_cpi =</span> <span class="fu">pull</span>(cpi_base, cpi),</span>
<span id="cb35-500"><a href="#cb35-500"></a>    <span class="fu">across</span>(<span class="fu">c</span>(base_cpi, cpi), as.numeric),</span>
<span id="cb35-501"><a href="#cb35-501"></a>    <span class="at">cost =</span> cost <span class="sc">*</span> (base_cpi <span class="sc">/</span> cpi) <span class="sc">|&gt;</span> <span class="fu">replace_na</span>(<span class="dv">0</span>)</span>
<span id="cb35-502"><a href="#cb35-502"></a>  )</span>
<span id="cb35-503"><a href="#cb35-503"></a></span>
<span id="cb35-504"><a href="#cb35-504"></a>food_away_comp_data <span class="sc">|&gt;</span></span>
<span id="cb35-505"><a href="#cb35-505"></a>  <span class="fu">select</span>(survey, year, newid, finlwt21, cost, ucc, ref_yr, ref_mo) <span class="sc">|&gt;</span></span>
<span id="cb35-506"><a href="#cb35-506"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ucc)) <span class="sc">|&gt;</span></span>
<span id="cb35-507"><a href="#cb35-507"></a>  <span class="fu">group_by</span>(year, survey) <span class="sc">|&gt;</span></span>
<span id="cb35-508"><a href="#cb35-508"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-509"><a href="#cb35-509"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb35-510"><a href="#cb35-510"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-511"><a href="#cb35-511"></a></span>
<span id="cb35-512"><a href="#cb35-512"></a><span class="in">```</span></span>
<span id="cb35-513"><a href="#cb35-513"></a></span>
<span id="cb35-514"><a href="#cb35-514"></a>The next step is to calculate means, for which I'll use some more Tidyverse functions.</span>
<span id="cb35-515"><a href="#cb35-515"></a></span>
<span id="cb35-518"><a href="#cb35-518"></a><span class="in">```{r}</span></span>
<span id="cb35-519"><a href="#cb35-519"></a><span class="co">#| label: get-food-away-means</span></span>
<span id="cb35-520"><a href="#cb35-520"></a><span class="co">#| cache: true</span></span>
<span id="cb35-521"><a href="#cb35-521"></a></span>
<span id="cb35-522"><a href="#cb35-522"></a>food_away_means <span class="ot">&lt;-</span> food_away_comp_data <span class="sc">|&gt;</span></span>
<span id="cb35-523"><a href="#cb35-523"></a>  <span class="fu">group_nest</span>(year, fam_size_label, <span class="at">.key =</span> <span class="st">"data"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-524"><a href="#cb35-524"></a>  <span class="fu">mutate</span>(<span class="at">ce_mn_df =</span> <span class="fu">map</span>(data, ce_mean)) <span class="sc">|&gt;</span></span>
<span id="cb35-525"><a href="#cb35-525"></a>  <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">|&gt;</span> </span>
<span id="cb35-526"><a href="#cb35-526"></a>  <span class="fu">unnest</span>(ce_mn_df) <span class="sc">|&gt;</span></span>
<span id="cb35-527"><a href="#cb35-527"></a>  <span class="fu">mutate</span>(<span class="at">lower =</span> mean_exp <span class="sc">-</span> cv, <span class="at">upper =</span> mean_exp <span class="sc">+</span> cv)</span>
<span id="cb35-528"><a href="#cb35-528"></a></span>
<span id="cb35-529"><a href="#cb35-529"></a>food_away_means <span class="sc">|&gt;</span> <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-530"><a href="#cb35-530"></a></span>
<span id="cb35-531"><a href="#cb35-531"></a><span class="in">```</span></span>
<span id="cb35-532"><a href="#cb35-532"></a></span>
<span id="cb35-533"><a href="#cb35-533"></a>Plotting these data would be pretty straightforward, as well.</span>
<span id="cb35-534"><a href="#cb35-534"></a></span>
<span id="cb35-537"><a href="#cb35-537"></a><span class="in">```{r}</span></span>
<span id="cb35-538"><a href="#cb35-538"></a><span class="co">#| label: plot-food-away-means</span></span>
<span id="cb35-539"><a href="#cb35-539"></a></span>
<span id="cb35-540"><a href="#cb35-540"></a>food_away_means <span class="sc">|&gt;</span></span>
<span id="cb35-541"><a href="#cb35-541"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> fam_size_label, <span class="at">y =</span> mean_exp, <span class="at">fill =</span> year, <span class="at">group =</span> year)) <span class="sc">+</span></span>
<span id="cb35-542"><a href="#cb35-542"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">width =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb35-543"><a href="#cb35-543"></a>  <span class="fu">geom_errorbar</span>(</span>
<span id="cb35-544"><a href="#cb35-544"></a>    <span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb35-545"><a href="#cb35-545"></a>    <span class="at">width =</span> <span class="fl">0.4</span>,</span>
<span id="cb35-546"><a href="#cb35-546"></a>    <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.75</span>)</span>
<span id="cb35-547"><a href="#cb35-547"></a>  ) <span class="sc">+</span></span>
<span id="cb35-548"><a href="#cb35-548"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb35-549"><a href="#cb35-549"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb35-550"><a href="#cb35-550"></a>  <span class="fu">labs</span>(</span>
<span id="cb35-551"><a href="#cb35-551"></a>    <span class="at">title =</span></span>
<span id="cb35-552"><a href="#cb35-552"></a>      <span class="st">"Estimated annual mean food away from home expenditures by CU size"</span>,</span>
<span id="cb35-553"><a href="#cb35-553"></a>    <span class="at">x =</span> <span class="st">"CU size"</span>,</span>
<span id="cb35-554"><a href="#cb35-554"></a>    <span class="at">y =</span> <span class="st">"Estimated, weighted, annual mean expenditure"</span>,</span>
<span id="cb35-555"><a href="#cb35-555"></a>    <span class="at">fill =</span> <span class="st">"Year"</span></span>
<span id="cb35-556"><a href="#cb35-556"></a>  ) <span class="sc">+</span></span>
<span id="cb35-557"><a href="#cb35-557"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb35-558"><a href="#cb35-558"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>), <span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb35-559"><a href="#cb35-559"></a><span class="in">```</span></span>
<span id="cb35-560"><a href="#cb35-560"></a></span>
<span id="cb35-561"><a href="#cb35-561"></a>Here we can see that on an inflation-adjusted basis, households of all sizes had higher expenditures on food away from home in 2010 than they did in 2020.</span>
<span id="cb35-562"><a href="#cb35-562"></a></span>
<span id="cb35-563"><a href="#cb35-563"></a>Now I'll generate a plot of the expenditures at each weighted, annual, estimated quantile (from 0.01 through 0.99, by 0.01) for the same years, but only using Diary data, since most of the UCCs (16 out of 21) in the "food away from home" category come from the Diary.</span>
<span id="cb35-564"><a href="#cb35-564"></a></span>
<span id="cb35-567"><a href="#cb35-567"></a><span class="in">```{r}</span></span>
<span id="cb35-568"><a href="#cb35-568"></a><span class="co">#| label: plot-food-away-quantiles</span></span>
<span id="cb35-569"><a href="#cb35-569"></a><span class="co">#| cache: true</span></span>
<span id="cb35-570"><a href="#cb35-570"></a></span>
<span id="cb35-571"><a href="#cb35-571"></a>food_away_comp_quantiles <span class="ot">&lt;-</span> <span class="fu">map2</span>(</span>
<span id="cb35-572"><a href="#cb35-572"></a>  <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2020</span>),</span>
<span id="cb35-573"><a href="#cb35-573"></a>  <span class="fu">c</span>(</span>
<span id="cb35-574"><a href="#cb35-574"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"diary10.zip"</span>),</span>
<span id="cb35-575"><a href="#cb35-575"></a>    <span class="fu">file.path</span>(ce_data_dir, <span class="st">"diary20.zip"</span>)</span>
<span id="cb35-576"><a href="#cb35-576"></a>  ),</span>
<span id="cb35-577"><a href="#cb35-577"></a>  \(x, y) {</span>
<span id="cb35-578"><a href="#cb35-578"></a>    dia_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb35-579"><a href="#cb35-579"></a>      x,</span>
<span id="cb35-580"><a href="#cb35-580"></a>      diary,</span>
<span id="cb35-581"><a href="#cb35-581"></a>      <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb35-582"><a href="#cb35-582"></a>    )</span>
<span id="cb35-583"><a href="#cb35-583"></a>    </span>
<span id="cb35-584"><a href="#cb35-584"></a>    food_uccs <span class="ot">&lt;-</span> <span class="fu">ce_uccs</span>(dia_hg, <span class="at">expenditure =</span> <span class="st">"Food away from home"</span>)</span>
<span id="cb35-585"><a href="#cb35-585"></a>    </span>
<span id="cb35-586"><a href="#cb35-586"></a>    <span class="fu">ce_prepdata</span>(</span>
<span id="cb35-587"><a href="#cb35-587"></a>      x,</span>
<span id="cb35-588"><a href="#cb35-588"></a>      diary,</span>
<span id="cb35-589"><a href="#cb35-589"></a>      dia_hg,</span>
<span id="cb35-590"><a href="#cb35-590"></a>      food_uccs,</span>
<span id="cb35-591"><a href="#cb35-591"></a>      <span class="at">dia_zp =</span> y</span>
<span id="cb35-592"><a href="#cb35-592"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb35-593"><a href="#cb35-593"></a>      <span class="fu">mutate</span>(<span class="at">year =</span> x, <span class="at">ref_yr =</span> <span class="fu">as.character</span>(ref_yr))</span>
<span id="cb35-594"><a href="#cb35-594"></a>  }</span>
<span id="cb35-595"><a href="#cb35-595"></a>) <span class="sc">|&gt;</span></span>
<span id="cb35-596"><a href="#cb35-596"></a>  <span class="fu">list_rbind</span>() <span class="sc">|&gt;</span></span>
<span id="cb35-597"><a href="#cb35-597"></a>  <span class="fu">left_join</span>(</span>
<span id="cb35-598"><a href="#cb35-598"></a>    <span class="fu">select</span>(cpi_data, year, month, cpi),</span>
<span id="cb35-599"><a href="#cb35-599"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ref_yr"</span> <span class="ot">=</span> <span class="st">"year"</span>, <span class="st">"ref_mo"</span> <span class="ot">=</span> <span class="st">"month"</span>)</span>
<span id="cb35-600"><a href="#cb35-600"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb35-601"><a href="#cb35-601"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">factor</span>(year)) <span class="sc">|&gt;</span></span>
<span id="cb35-602"><a href="#cb35-602"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>year) <span class="sc">|&gt;</span></span>
<span id="cb35-603"><a href="#cb35-603"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-604"><a href="#cb35-604"></a>    <span class="at">fa_qtile =</span> <span class="fu">map</span>(data, ce_quantiles, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.95</span>, <span class="at">by =</span> <span class="fl">0.05</span>), <span class="fl">0.99</span>))</span>
<span id="cb35-605"><a href="#cb35-605"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb35-606"><a href="#cb35-606"></a>  <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">|&gt;</span></span>
<span id="cb35-607"><a href="#cb35-607"></a>  <span class="fu">unnest</span>(fa_qtile) <span class="sc">|&gt;</span></span>
<span id="cb35-608"><a href="#cb35-608"></a>  <span class="fu">mutate</span>(<span class="at">probs =</span> <span class="fu">parse_number</span>(probs) <span class="sc">/</span> <span class="dv">100</span>)</span>
<span id="cb35-609"><a href="#cb35-609"></a></span>
<span id="cb35-610"><a href="#cb35-610"></a>food_away_comp_quantiles <span class="sc">|&gt;</span></span>
<span id="cb35-611"><a href="#cb35-611"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> probs, <span class="at">y =</span> quantile, <span class="at">group =</span> year, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb35-612"><a href="#cb35-612"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb35-613"><a href="#cb35-613"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb35-614"><a href="#cb35-614"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb35-615"><a href="#cb35-615"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb35-616"><a href="#cb35-616"></a>  <span class="fu">labs</span>(</span>
<span id="cb35-617"><a href="#cb35-617"></a>    <span class="at">title =</span></span>
<span id="cb35-618"><a href="#cb35-618"></a>      <span class="st">"Estimated, annual food away from home expenditure quantiles"</span>,</span>
<span id="cb35-619"><a href="#cb35-619"></a>    <span class="at">x =</span> <span class="st">"Quantile"</span>,</span>
<span id="cb35-620"><a href="#cb35-620"></a>    <span class="at">y =</span> <span class="st">"Estimated, weighted, annual expenditure"</span>,</span>
<span id="cb35-621"><a href="#cb35-621"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb35-622"><a href="#cb35-622"></a>  ) <span class="sc">+</span></span>
<span id="cb35-623"><a href="#cb35-623"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb35-624"><a href="#cb35-624"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>), <span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb35-625"><a href="#cb35-625"></a><span class="in">```</span></span>
<span id="cb35-626"><a href="#cb35-626"></a></span>
<span id="cb35-627"><a href="#cb35-627"></a>Interestingly the expenditures don't appear to have changed much between 2010 and 2020 across quantiles on an inflation-adjusted basis, but we can see that across all quantiles, CU's spent less in 2020 than they did in 2010 on food away from home, which is consistent with the means that we calculated above. There are a lot of 0-value reported expenditures, though, in the CE on food away from home. Unfortunately, I can't perform an analysis using only respondents that did have expenditures in this category, i.e., dropping the 0's, because whether someone had an expenditure on food away from home is not one of the variables used for generating the survey weights. In other words, the analysis can be done, but it would not be statistically valid and I definitely wouldn't be able to infer from it. This is just another cautionary note to anyone using this package who might use it in a way that does not follow statistically sound practices. Please visit the <span class="co">[</span><span class="ot">CE's website</span><span class="co">](https://www.bls.gov/cex/)</span> and read the <span class="co">[</span><span class="ot">CE PUMD Getting Started Guide</span><span class="co">](https://www.bls.gov/cex/tables.htm)</span> for more information.</span>
<span id="cb35-628"><a href="#cb35-628"></a></span>
<span id="cb35-629"><a href="#cb35-629"></a><span class="fu">### Dealing with inconsistent code definitions</span></span>
<span id="cb35-630"><a href="#cb35-630"></a></span>
<span id="cb35-631"><a href="#cb35-631"></a>In this workflow I'm going to calculate estimated mean utilities expenditures for 2015 using integrated data by CU composition using the FAM_TYPE variable. In this case I'm going to start by looking at the codes for that variable to show how one might run into an inconsistency in code definitions across survey instruments. First I'm going to set up a sub-directory in my temporary directory and store what I'll need to get started.</span>
<span id="cb35-632"><a href="#cb35-632"></a></span>
<span id="cb35-633"><a href="#cb35-633"></a>First, I'll look at code descriptions for the "FAM_TYPE" variable in the dictionary and I'm going to focus on the code values of 3, 5, and 7. I still have the <span class="in">`ce_codes`</span> object in memory, so I'll just use that.</span>
<span id="cb35-634"><a href="#cb35-634"></a></span>
<span id="cb35-637"><a href="#cb35-637"></a><span class="in">```{r}</span></span>
<span id="cb35-638"><a href="#cb35-638"></a><span class="co">#| label: show-fam-type-codes</span></span>
<span id="cb35-639"><a href="#cb35-639"></a></span>
<span id="cb35-640"><a href="#cb35-640"></a>ce_codes <span class="sc">|&gt;</span></span>
<span id="cb35-641"><a href="#cb35-641"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb35-642"><a href="#cb35-642"></a>  <span class="fu">filter</span>(</span>
<span id="cb35-643"><a href="#cb35-643"></a>    variable <span class="sc">%in%</span> <span class="st">"FAM_TYPE"</span>,</span>
<span id="cb35-644"><a href="#cb35-644"></a>  first_year <span class="sc">&lt;=</span> <span class="dv">2015</span>,</span>
<span id="cb35-645"><a href="#cb35-645"></a>  (last_year <span class="sc">&gt;=</span> <span class="dv">2015</span> <span class="sc">|</span> <span class="fu">is.na</span>(last_year)),</span>
<span id="cb35-646"><a href="#cb35-646"></a>  code_value <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"3"</span>, <span class="st">"5"</span>, <span class="st">"7"</span>)</span>
<span id="cb35-647"><a href="#cb35-647"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb35-648"><a href="#cb35-648"></a>  <span class="fu">select</span>(survey, code_value, code_description) <span class="sc">|&gt;</span></span>
<span id="cb35-649"><a href="#cb35-649"></a>  <span class="fu">arrange</span>(code_value, survey) <span class="sc">|&gt;</span></span>
<span id="cb35-650"><a href="#cb35-650"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-651"><a href="#cb35-651"></a></span>
<span id="cb35-652"><a href="#cb35-652"></a><span class="in">```</span></span>
<span id="cb35-653"><a href="#cb35-653"></a></span>
<span id="cb35-654"><a href="#cb35-654"></a>The code descriptions for these 3 code values are different across instruments. To resolve this I'm going to create a table containing only codes from the Interview survey.</span>
<span id="cb35-655"><a href="#cb35-655"></a></span>
<span id="cb35-658"><a href="#cb35-658"></a><span class="in">```{r}</span></span>
<span id="cb35-659"><a href="#cb35-659"></a><span class="co">#| label: create-own-codeset</span></span>
<span id="cb35-660"><a href="#cb35-660"></a><span class="co">#| cache: true</span></span>
<span id="cb35-661"><a href="#cb35-661"></a></span>
<span id="cb35-662"><a href="#cb35-662"></a>fam_type_codes <span class="ot">&lt;-</span> ce_codes <span class="sc">|&gt;</span></span>
<span id="cb35-663"><a href="#cb35-663"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb35-664"><a href="#cb35-664"></a>  <span class="fu">filter</span>(</span>
<span id="cb35-665"><a href="#cb35-665"></a>    variable <span class="sc">%in%</span> <span class="st">"FAM_TYPE"</span>,</span>
<span id="cb35-666"><a href="#cb35-666"></a>    first_year <span class="sc">&lt;=</span> <span class="dv">2015</span>,</span>
<span id="cb35-667"><a href="#cb35-667"></a>    (last_year <span class="sc">&gt;=</span> <span class="dv">2015</span> <span class="sc">|</span> <span class="fu">is.na</span>(last_year))</span>
<span id="cb35-668"><a href="#cb35-668"></a>  )</span>
<span id="cb35-669"><a href="#cb35-669"></a></span>
<span id="cb35-670"><a href="#cb35-670"></a>codes2keep <span class="ot">&lt;-</span> fam_type_codes <span class="sc">|&gt;</span></span>
<span id="cb35-671"><a href="#cb35-671"></a>  <span class="fu">filter</span>(survey <span class="sc">%in%</span> <span class="st">"INTERVIEW"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-672"><a href="#cb35-672"></a>  <span class="fu">select</span>(code_value, code_description)</span>
<span id="cb35-673"><a href="#cb35-673"></a></span>
<span id="cb35-674"><a href="#cb35-674"></a>fam_type_codes <span class="ot">&lt;-</span> fam_type_codes <span class="sc">|&gt;</span></span>
<span id="cb35-675"><a href="#cb35-675"></a>  <span class="fu">select</span>(<span class="sc">-</span>code_description) <span class="sc">|&gt;</span></span>
<span id="cb35-676"><a href="#cb35-676"></a>  <span class="fu">left_join</span>(codes2keep, <span class="at">by =</span> <span class="st">"code_value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-677"><a href="#cb35-677"></a>  <span class="fu">relocate</span>(code_description, <span class="at">.after =</span> code_value)</span>
<span id="cb35-678"><a href="#cb35-678"></a></span>
<span id="cb35-679"><a href="#cb35-679"></a>fam_type_codes <span class="sc">|&gt;</span></span>
<span id="cb35-680"><a href="#cb35-680"></a>  <span class="fu">filter</span>(code_value <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"3"</span>, <span class="st">"5"</span>, <span class="st">"7"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-681"><a href="#cb35-681"></a>  <span class="fu">select</span>(survey, code_value, code_description) <span class="sc">|&gt;</span></span>
<span id="cb35-682"><a href="#cb35-682"></a>  <span class="fu">arrange</span>(code_value, survey) <span class="sc">|&gt;</span></span>
<span id="cb35-683"><a href="#cb35-683"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-684"><a href="#cb35-684"></a></span>
<span id="cb35-685"><a href="#cb35-685"></a><span class="in">```</span></span>
<span id="cb35-686"><a href="#cb35-686"></a></span>
<span id="cb35-687"><a href="#cb35-687"></a>Now the codes are consistent across survey instruments and I can use this code-book in my call to <span class="in">`ce_prepdata()`</span> using the "own_code-book" argument. Then I'll pass that to <span class="in">`ce_mean()`</span> per usual.</span>
<span id="cb35-688"><a href="#cb35-688"></a></span>
<span id="cb35-689"><a href="#cb35-689"></a>Next I'll get some information about how utilities expenditures are organized using the stub file.</span>
<span id="cb35-690"><a href="#cb35-690"></a></span>
<span id="cb35-693"><a href="#cb35-693"></a><span class="in">```{r}</span></span>
<span id="cb35-694"><a href="#cb35-694"></a>integ15_hg <span class="ot">&lt;-</span> <span class="fu">ce_hg</span>(</span>
<span id="cb35-695"><a href="#cb35-695"></a>  <span class="dv">2015</span>,</span>
<span id="cb35-696"><a href="#cb35-696"></a>  integrated,</span>
<span id="cb35-697"><a href="#cb35-697"></a>  <span class="at">hg_zip_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"stubs.zip"</span>)</span>
<span id="cb35-698"><a href="#cb35-698"></a>)</span>
<span id="cb35-699"><a href="#cb35-699"></a></span>
<span id="cb35-700"><a href="#cb35-700"></a>integ15_hg <span class="sc">|&gt;</span></span>
<span id="cb35-701"><a href="#cb35-701"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">str_to_lower</span>(title), <span class="st">"utilities"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-702"><a href="#cb35-702"></a>  <span class="fu">kable</span>(<span class="at">bookmarks =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-703"><a href="#cb35-703"></a><span class="in">```</span></span>
<span id="cb35-704"><a href="#cb35-704"></a></span>
<span id="cb35-705"><a href="#cb35-705"></a>The expenditure category associated with utilities is "Utilities, fuels, and public services". I'll store that title to work with later and narrow down the section of the stub file that includes only these expenditures.</span>
<span id="cb35-706"><a href="#cb35-706"></a></span>
<span id="cb35-709"><a href="#cb35-709"></a><span class="in">```{r}</span></span>
<span id="cb35-710"><a href="#cb35-710"></a><span class="co">#| label: get-utilities-hg</span></span>
<span id="cb35-711"><a href="#cb35-711"></a></span>
<span id="cb35-712"><a href="#cb35-712"></a>utilities_title <span class="ot">&lt;-</span> integ15_hg <span class="sc">|&gt;</span></span>
<span id="cb35-713"><a href="#cb35-713"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(<span class="fu">str_to_lower</span>(title), <span class="st">"utilities"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-714"><a href="#cb35-714"></a>  <span class="fu">pull</span>(title)</span>
<span id="cb35-715"><a href="#cb35-715"></a></span>
<span id="cb35-716"><a href="#cb35-716"></a>utilities_hg <span class="ot">&lt;-</span> <span class="fu">ce_uccs</span>(</span>
<span id="cb35-717"><a href="#cb35-717"></a>  integ15_hg,</span>
<span id="cb35-718"><a href="#cb35-718"></a>  <span class="at">expenditure =</span> utilities_title,</span>
<span id="cb35-719"><a href="#cb35-719"></a>  <span class="at">uccs_only =</span> <span class="cn">FALSE</span></span>
<span id="cb35-720"><a href="#cb35-720"></a>)</span>
<span id="cb35-721"><a href="#cb35-721"></a></span>
<span id="cb35-722"><a href="#cb35-722"></a>utilities_hg <span class="sc">|&gt;</span> <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-723"><a href="#cb35-723"></a></span>
<span id="cb35-724"><a href="#cb35-724"></a><span class="in">```</span></span>
<span id="cb35-725"><a href="#cb35-725"></a></span>
<span id="cb35-726"><a href="#cb35-726"></a>I also want to know what survey instruments the expenditures are collected through for published estimates. My stub file is the integrated stub file, so I should see both "I" and "D" in the survey column of the stub file if expenditures are collected through both instruments.</span>
<span id="cb35-727"><a href="#cb35-727"></a></span>
<span id="cb35-730"><a href="#cb35-730"></a><span class="in">```{r}</span></span>
<span id="cb35-731"><a href="#cb35-731"></a><span class="co">#| label: check-utilities-instruments</span></span>
<span id="cb35-732"><a href="#cb35-732"></a></span>
<span id="cb35-733"><a href="#cb35-733"></a>utilities_hg <span class="sc">|&gt;</span> <span class="fu">distinct</span>(survey) <span class="sc">|&gt;</span> <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-734"><a href="#cb35-734"></a></span>
<span id="cb35-735"><a href="#cb35-735"></a><span class="in">```</span></span>
<span id="cb35-736"><a href="#cb35-736"></a></span>
<span id="cb35-737"><a href="#cb35-737"></a>It seems utilities expenditures are collected only through the Interview survey, so I'll only need to use Interview data files to calculate estimates.</span>
<span id="cb35-738"><a href="#cb35-738"></a></span>
<span id="cb35-741"><a href="#cb35-741"></a><span class="in">```{r}</span></span>
<span id="cb35-742"><a href="#cb35-742"></a><span class="co">#| label: fam-type-utilities</span></span>
<span id="cb35-743"><a href="#cb35-743"></a><span class="co">#| cache: true</span></span>
<span id="cb35-744"><a href="#cb35-744"></a></span>
<span id="cb35-745"><a href="#cb35-745"></a>fam_type_utilities <span class="ot">&lt;-</span> <span class="fu">ce_prepdata</span>(</span>
<span id="cb35-746"><a href="#cb35-746"></a>  <span class="dv">2015</span>,</span>
<span id="cb35-747"><a href="#cb35-747"></a>  interview,</span>
<span id="cb35-748"><a href="#cb35-748"></a>  utilities_hg,</span>
<span id="cb35-749"><a href="#cb35-749"></a>  <span class="at">uccs =</span> <span class="fu">ce_uccs</span>(utilities_hg, <span class="at">expenditure =</span> utilities_title),</span>
<span id="cb35-750"><a href="#cb35-750"></a>  fam_type, </span>
<span id="cb35-751"><a href="#cb35-751"></a>  <span class="at">int_zp =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"intrvw15.zip"</span>),</span>
<span id="cb35-752"><a href="#cb35-752"></a>  <span class="at">recode_variables =</span> <span class="cn">TRUE</span>,</span>
<span id="cb35-753"><a href="#cb35-753"></a>  <span class="at">dict_path =</span> <span class="fu">file.path</span>(ce_data_dir, <span class="st">"ce-data-dict.xlsx"</span>)</span>
<span id="cb35-754"><a href="#cb35-754"></a>) <span class="sc">|&gt;</span></span>
<span id="cb35-755"><a href="#cb35-755"></a>  <span class="fu">group_nest</span>(fam_type) <span class="sc">|&gt;</span></span>
<span id="cb35-756"><a href="#cb35-756"></a>  <span class="fu">mutate</span>(<span class="at">ce_mean_df =</span> <span class="fu">map</span>(data, ce_mean)) <span class="sc">|&gt;</span></span>
<span id="cb35-757"><a href="#cb35-757"></a>  <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">|&gt;</span></span>
<span id="cb35-758"><a href="#cb35-758"></a>  <span class="fu">unnest</span>(ce_mean_df)</span>
<span id="cb35-759"><a href="#cb35-759"></a></span>
<span id="cb35-760"><a href="#cb35-760"></a>fam_type_utilities <span class="sc">|&gt;</span></span>
<span id="cb35-761"><a href="#cb35-761"></a>  <span class="fu">arrange</span>(fam_type) <span class="sc">|&gt;</span></span>
<span id="cb35-762"><a href="#cb35-762"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-763"><a href="#cb35-763"></a></span>
<span id="cb35-764"><a href="#cb35-764"></a><span class="in">```</span></span>
<span id="cb35-765"><a href="#cb35-765"></a></span>
<span id="cb35-766"><a href="#cb35-766"></a>And finally, a quick lollipop plot.</span>
<span id="cb35-767"><a href="#cb35-767"></a></span>
<span id="cb35-770"><a href="#cb35-770"></a><span class="in">```{r}</span></span>
<span id="cb35-771"><a href="#cb35-771"></a><span class="co">#| label: plot-fam-type-utilities</span></span>
<span id="cb35-772"><a href="#cb35-772"></a></span>
<span id="cb35-773"><a href="#cb35-773"></a>fam_type_utilities <span class="sc">|&gt;</span></span>
<span id="cb35-774"><a href="#cb35-774"></a>  <span class="fu">mutate</span>(<span class="at">fam_type =</span> <span class="fu">fct_reorder</span>(fam_type, mean_exp)) <span class="sc">|&gt;</span></span>
<span id="cb35-775"><a href="#cb35-775"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mean_exp, <span class="at">y =</span> fam_type, mean_exp)) <span class="sc">+</span></span>
<span id="cb35-776"><a href="#cb35-776"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">xend =</span> mean_exp, <span class="at">yend =</span> fam_type)) <span class="sc">+</span></span>
<span id="cb35-777"><a href="#cb35-777"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb35-778"><a href="#cb35-778"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">str_wrap</span>(x, <span class="at">width =</span> <span class="dv">25</span>)) <span class="sc">+</span></span>
<span id="cb35-779"><a href="#cb35-779"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb35-780"><a href="#cb35-780"></a>  <span class="fu">labs</span>(</span>
<span id="cb35-781"><a href="#cb35-781"></a>    <span class="at">y =</span> <span class="st">"CU composition (FAM_TYPE)"</span>,</span>
<span id="cb35-782"><a href="#cb35-782"></a>    <span class="at">x =</span> <span class="st">"Estimated, weighted, annual mean expenditure"</span>,</span>
<span id="cb35-783"><a href="#cb35-783"></a>    <span class="at">title =</span></span>
<span id="cb35-784"><a href="#cb35-784"></a>      <span class="st">"Estimated annual mean utilities expenditures by CU composition"</span></span>
<span id="cb35-785"><a href="#cb35-785"></a>  ) <span class="sc">+</span></span>
<span id="cb35-786"><a href="#cb35-786"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb35-787"><a href="#cb35-787"></a></span>
<span id="cb35-788"><a href="#cb35-788"></a><span class="in">```</span></span>
<span id="cb35-789"><a href="#cb35-789"></a></span>
<span id="cb35-790"><a href="#cb35-790"></a><span class="fu">## Conclusion</span></span>
<span id="cb35-791"><a href="#cb35-791"></a></span>
<span id="cb35-792"><a href="#cb35-792"></a>That wraps up this introduction to <span class="in">`cepumd`</span>. Thank you for taking a look. If you find any bugs, please report them on the <span class="co">[</span><span class="ot">Github repo issues section</span><span class="co">](https://github.com/arcenis-r/cepumd/issues)</span>.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>