<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Arcenis Rojas">
<meta name="dcterms.date" content="2024-04-03">

<title>Sentiment Analysis of NYC’s Mayor Eric Adams’ Speeches – Arcenis Rojas</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-c70c0031252f74d50129453a9c8e908e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Arcenis Rojas</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Personal Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../dashboards.html"> 
<span class="menu-text">Dashboards</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/arcenisrojas" target="_blank"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/arcenis-r" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#project-description" id="toc-project-description" class="nav-link active" data-scroll-target="#project-description">Project description</a></li>
  <li><a href="#getting-speech-data" id="toc-getting-speech-data" class="nav-link" data-scroll-target="#getting-speech-data">Getting speech data</a>
  <ul class="collapse">
  <li><a href="#finding-speech-transcripts" id="toc-finding-speech-transcripts" class="nav-link" data-scroll-target="#finding-speech-transcripts">Finding speech transcripts</a></li>
  <li><a href="#challenges-in-webscraping" id="toc-challenges-in-webscraping" class="nav-link" data-scroll-target="#challenges-in-webscraping">Challenges in webscraping</a></li>
  <li><a href="#webscraping-code" id="toc-webscraping-code" class="nav-link" data-scroll-target="#webscraping-code">Webscraping code</a></li>
  </ul></li>
  <li><a href="#sentiment-analysis-over-time" id="toc-sentiment-analysis-over-time" class="nav-link" data-scroll-target="#sentiment-analysis-over-time">Sentiment analysis over time</a></li>
  <li><a href="#word-cloud-animation" id="toc-word-cloud-animation" class="nav-link" data-scroll-target="#word-cloud-animation">Word cloud animation</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Sentiment Analysis of NYC’s Mayor Eric Adams’ Speeches</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Problem-Solving in Action</p>
  <div class="quarto-categories">
    <div class="quarto-category">Web Scraping</div>
    <div class="quarto-category">Text Analysis</div>
    <div class="quarto-category">Animation</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Arcenis Rojas </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 3, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="project-description" class="level2">
<h2 class="anchored" data-anchor-id="project-description">Project description</h2>
<p>This project came from a question that I had about how the sentiment in NYC Mayor Eric Adams’ speeches might have changed over the last few years given some of the different challenges he’s had in office ranging from COVID-19-related policies to more recent issues with immigration in NYC. As often happens, this simple question introduced unanticipated challenges and again made me really grateful to the open-source community.</p>
<p>For this analysis I relied heavily on <a href="https://www.tidyverse.org/">tidyverse</a> <span class="citation" data-cites="tidyverse">(<a href="#ref-tidyverse" role="doc-biblioref">Wickham et al. 2019</a>)</span> packages for data wrangling; the <a href="https://rvest.tidyverse.org/">rvest</a> <span class="citation" data-cites="rvest">(<a href="#ref-rvest" role="doc-biblioref">Wickham 2024</a>)</span> and <a href="https://dmi3kno.github.io/polite/">polite</a> <span class="citation" data-cites="polite">(<a href="#ref-polite" role="doc-biblioref">Perepolkin 2023</a>)</span> packages for webscraping; the <a href="https://juliasilge.github.io/tidytext/">tidytext</a> <span class="citation" data-cites="tidytext">(<a href="#ref-tidytext" role="doc-biblioref">Silge and Robinson 2016</a>)</span>, <a href="https://github.com/EmilHvitfeldt/textdata">textdata</a> <span class="citation" data-cites="textdata">(<a href="#ref-textdata" role="doc-biblioref">Hvitfeldt 2022</a>)</span>, and <a href="https://github.com/trinker/textclean">textclean</a> <span class="citation" data-cites="textclean">(<a href="#ref-textclean" role="doc-biblioref">Rinker 2018</a>)</span> packages for text analysis functions; and the <a href="https://ggplot2.tidyverse.org/">ggplot2</a> <span class="citation" data-cites="ggplot2">(<a href="#ref-ggplot2" role="doc-biblioref">Wickham 2016</a>)</span>, <a href="https://lepennec.github.io/ggwordcloud/index.html">ggwordcloud</a> <span class="citation" data-cites="ggwordcloud">(<a href="#ref-ggwordcloud" role="doc-biblioref">Le Pennec and Slowikowski 2023</a>)</span>, and <a href="https://gganimate.com/">gganimate</a> <span class="citation" data-cites="gganimate">(<a href="#ref-gganimate" role="doc-biblioref">Pedersen and Robinson 2024</a>)</span> packages for visualization.</p>
</section>
<section id="getting-speech-data" class="level2">
<h2 class="anchored" data-anchor-id="getting-speech-data">Getting speech data</h2>
<p>To perform this analysis I would have to find a repository of his speeches online and figure out how to scrape them. Because I thought there would be a lot of speeches, I knew that I would run into issues dealing with having to add delays to my scraping function so as not to run into conflict with the rules of the site. I also thought about the problem of having to scrape pages with Javascript on them and remembered that <a href="https://hadley.nz/">Hadley Wickham</a> <a href="https://www.linkedin.com/feed/update/urn:li:activity:7159172919758065665?updateEntityUrn=urn%3Ali%3Afs_feedUpdate%3A%28V2%2Curn%3Ali%3Aactivity%3A7159172919758065665%29">posted on LinkedIn</a> about an experimental update to <a href="https://rvest.tidyverse.org/">rvest</a> that included tools for scraping live sites using <a href="https://rstudio.github.io/chromote/">chromote</a>. Without remembering this I probably would not have pursued the project because the alternative for scraping live web pages with R is <a href="https://docs.ropensci.org/RSelenium/articles/basics.html">RSelenium</a> (at least as far as I know), which requires a lot more set-up work than this project would have been worth.</p>
<p>As far as dealing with the robots on the NYC news site, I also wanted to scrape in an ethical way. Thinking about this led me to two things: 1) <a href="https://towardsdatascience.com/ethics-in-web-scraping-b96b18136f01">Rules for ethical webscraping</a> and 2) the <a href="https://dmi3kno.github.io/polite/">polite</a> package. First, there is the practical consideration that some sites place limits on the frequency with which they will serve results to clients and if the scraping process doesn’t respect that one may end up getting one result with content and a bunch of empty results thereafter if not just outright errors. Aside from this practical consideration, my position is that if I’m getting all this great data for free (that someone is paying to host) the least I can do is identify myself to the host so the host knows I mean no harm.</p>
<section id="finding-speech-transcripts" class="level3">
<h3 class="anchored" data-anchor-id="finding-speech-transcripts">Finding speech transcripts</h3>
<p>Once I decided to go ahead, the first challenge was to get transcripts of Mayor Adams’ speeches. A simple web search led me to the <a href="https://www.nyc.gov/">NYC.gov</a> website which has a section for <a href="https://www.nyc.gov/office-of-the-mayor/news.page">news coming out of the office of the Mayor</a>. I noticed that this site had more than his speeches, but there were some titles of articles that started with the word “Transcript”. After looking through a few pages I saw that this was the case for many articles, so I thought I could use this to isolate the articles that contained speeches. The next step was figuring out how to scrape the data.</p>
</section>
<section id="challenges-in-webscraping" class="level3">
<h3 class="anchored" data-anchor-id="challenges-in-webscraping">Challenges in webscraping</h3>
<p>I first figured out that I would have to scrape in two stages. In the first stage, I would have to scrape all of the pages containing news article titles and their corresponding links, which would require knowing how many pages of links there are. I would then have to filter these links for the ones that contained speech transcripts. In the second stage I would have to go to each of the links from the first stage and scrape the speech text.</p>
<p>Going into the first stage I wanted to use <code>polite::nod()</code> to jump from one page to the next. However, I learned that all of the pages with search results were live pages (Javascript) and <code>polite::scrape()</code> is designed to work with static elements, so there were elements of the page that I wasn’t getting. I thought I would either be stuck or have to make a trade-off between getting output and behaving ethically until I found <a href="https://github.com/yusuzech/r-web-scraping-cheat-sheet">yusuzech’s Cheat Sheet for Web Scraping Using R</a> in which he talks about different ways to deal with this particular challenge. There I learned about an <a href="https://blog.hartleybrody.com/web-scraping-cheat-sheet/">entry in Hartley Brody’s blog</a> containing his Web Scraping Cheat Sheet. In the “More Advanced Topics” section he mentioned that a page with live elements (Javascript) requires that the content be in static form <em>somewhere</em> on the server. I was able to find that page for the NYC site, which then required identifying the links that I needed using <a href="https://en.wikipedia.org/wiki/Regular_expression">regex</a>, which was a much smaller problem than choosing between getting data from a live site and scraping ethically.</p>
</section>
<section id="webscraping-code" class="level3">
<h3 class="anchored" data-anchor-id="webscraping-code">Webscraping code</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(xml2)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(rvest)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(polite)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">library</span>(tidytext)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">library</span>(textclean)</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">library</span>(textdata)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="fu">library</span>(ggwordcloud)</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co"># Resolve common namespace conflicts about function names</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>conflicted<span class="sc">::</span><span class="fu">conflict_prefer</span>(<span class="st">"filter"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb1-13"><a href="#cb1-13"></a>conflicted<span class="sc">::</span><span class="fu">conflict_prefer</span>(<span class="st">"lag"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="cf">if</span> (<span class="st">"tidymodels"</span> <span class="sc">%in%</span> <span class="fu">.packages</span>()) <span class="fu">tidymodels_prefer</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Below is the code that I used for scraping the data. I tried to parallize this code, but I learned that code that uses external pointers will error out with the different packages I tried for parallelization.</p>
<p>Here I declare a function for the first stage of the web scraping process which takes as arguments the <code>polite::bow()</code> object and the number of the search page to scrape.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This function jumps to the static site that lists the search results in <code>polite::nod()</code>. The query in the path string shows that all of the results are from the dates between 12/31/2021 and 12/31/2024.</p>
</div>
</div>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-2"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-2-1"><a href="#annotated-cell-2-1"></a>get_article_links <span class="ot">&lt;-</span> <span class="cf">function</span>(bow_obj, srch_pg_num) {</span>
<span id="annotated-cell-2-2"><a href="#annotated-cell-2-2"></a>  <span class="fu">message</span>(<span class="fu">str_c</span>(<span class="st">"Scraping links from page "</span>, srch_pg_num))</span>
<span id="annotated-cell-2-3"><a href="#annotated-cell-2-3"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="1">1</button><span id="annotated-cell-2-4" class="code-annotation-target"><a href="#annotated-cell-2-4"></a>  search_sess <span class="ot">&lt;-</span> <span class="fu">nod</span>(</span>
<span id="annotated-cell-2-5"><a href="#annotated-cell-2-5"></a>    bow_obj,</span>
<span id="annotated-cell-2-6"><a href="#annotated-cell-2-6"></a>    <span class="at">path =</span> <span class="fu">str_c</span>(</span>
<span id="annotated-cell-2-7"><a href="#annotated-cell-2-7"></a>      <span class="st">"/home/lscs/NewsFilterService.page"</span>,</span>
<span id="annotated-cell-2-8"><a href="#annotated-cell-2-8"></a>      <span class="st">"?category=all&amp;contentType=all&amp;startDate=12/31/2021&amp;endDate=12/31/2024&amp;"</span>,</span>
<span id="annotated-cell-2-9"><a href="#annotated-cell-2-9"></a>      <span class="st">"language=english&amp;pageNumber="</span>,</span>
<span id="annotated-cell-2-10"><a href="#annotated-cell-2-10"></a>      srch_pg_num</span>
<span id="annotated-cell-2-11"><a href="#annotated-cell-2-11"></a>    )</span>
<span id="annotated-cell-2-12"><a href="#annotated-cell-2-12"></a>  )</span>
<span id="annotated-cell-2-13"><a href="#annotated-cell-2-13"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="2">2</button><span id="annotated-cell-2-14" class="code-annotation-target"><a href="#annotated-cell-2-14"></a>  <span class="fu">scrape</span>(search_sess) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-15"><a href="#annotated-cell-2-15"></a>    <span class="fu">as_list</span>() <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="3">3</button><span id="annotated-cell-2-16" class="code-annotation-target"><a href="#annotated-cell-2-16"></a>    <span class="fu">pluck</span>(<span class="st">"root"</span>, <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="4">4</button><span id="annotated-cell-2-17" class="code-annotation-target"><a href="#annotated-cell-2-17"></a>    <span class="fu">str_extract</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">{(.*)"</span>) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="5">5</button><span id="annotated-cell-2-18" class="code-annotation-target"><a href="#annotated-cell-2-18"></a>    <span class="fu">str_extract_all</span>(<span class="st">'(?&lt;=URL":")[</span><span class="sc">\\</span><span class="st">/</span><span class="sc">\\</span><span class="st">-a-z0-9]+'</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-19"><a href="#annotated-cell-2-19"></a>    <span class="fu">flatten_chr</span>() <span class="sc">|&gt;</span>                                                            </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="6">6</button><span id="annotated-cell-2-20" class="code-annotation-target"><a href="#annotated-cell-2-20"></a>    <span class="fu">str_subset</span>(<span class="st">"transcript"</span>) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="7">7</button><span id="annotated-cell-2-21" class="code-annotation-target"><a href="#annotated-cell-2-21"></a>    <span class="fu">enframe</span>(<span class="at">value =</span> <span class="st">"speech_link"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-22"><a href="#annotated-cell-2-22"></a>    <span class="fu">select</span>(<span class="sc">-</span>name)</span>
<span id="annotated-cell-2-23"><a href="#annotated-cell-2-23"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-2" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="4" data-code-annotation="1">Jump from the root node of the website to the search page of interest</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="14" data-code-annotation="2">Scrape the HTML as XML text</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="16" data-code-annotation="3">Keep only the second element of the root node (exclude head elements)</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="17" data-code-annotation="4">Keep everything after some additional metadata elements</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="18" data-code-annotation="5">Extract everything that proceeded the text indicating a URL</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="20" data-code-annotation="6">Keep only the URL’s that contained the term “transcript”</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="21" data-code-annotation="7">Put the vector of links into a dataframe</span>
</dd>
</dl>
</div>
</div>
<p>The next function scrapes a page containing speech data taking as arguments the <code>polite::bow()</code> object, one of the links from the first stage, and a number of the link being read to track progress.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-3"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-3-1"><a href="#annotated-cell-3-1"></a>get_speech_data <span class="ot">&lt;-</span> <span class="cf">function</span>(bow_obj, article_path, <span class="at">speech_num =</span> <span class="dv">1</span>) {</span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2"></a>  <span class="fu">message</span>(<span class="fu">str_c</span>(<span class="st">"Scraping speech number "</span>, speech_num))</span>
<span id="annotated-cell-3-3"><a href="#annotated-cell-3-3"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1">1</button><span id="annotated-cell-3-4" class="code-annotation-target"><a href="#annotated-cell-3-4"></a>  speech_html <span class="ot">&lt;-</span> <span class="fu">nod</span>(bow_obj, <span class="at">path =</span> article_path) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-5"><a href="#annotated-cell-3-5"></a>    <span class="fu">scrape</span>(<span class="at">accept =</span> <span class="st">"html"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-6"><a href="#annotated-cell-3-6"></a>    <span class="fu">html_element</span>(<span class="st">".ls-col .ls-col-body .ls-row.main"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-7"><a href="#annotated-cell-3-7"></a>    <span class="fu">html_element</span>(<span class="st">".iw_component .container .col-content"</span>)</span>
<span id="annotated-cell-3-8"><a href="#annotated-cell-3-8"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2">2</button><span id="annotated-cell-3-9" class="code-annotation-target"><a href="#annotated-cell-3-9"></a>  speech_date <span class="ot">&lt;-</span> speech_html <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-10"><a href="#annotated-cell-3-10"></a>    <span class="fu">html_elements</span>(<span class="st">".richtext p .date"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-11"><a href="#annotated-cell-3-11"></a>    <span class="fu">html_text2</span>()</span>
<span id="annotated-cell-3-12"><a href="#annotated-cell-3-12"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="3">3</button><span id="annotated-cell-3-13" class="code-annotation-target"><a href="#annotated-cell-3-13"></a>  speech_content <span class="ot">&lt;-</span> speech_html <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-14"><a href="#annotated-cell-3-14"></a>    <span class="fu">html_element</span>(<span class="st">".richtext"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-15"><a href="#annotated-cell-3-15"></a>    <span class="fu">html_elements</span>(<span class="st">"p"</span>)</span>
<span id="annotated-cell-3-16"><a href="#annotated-cell-3-16"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="4">4</button><span id="annotated-cell-3-17" class="code-annotation-target"><a href="#annotated-cell-3-17"></a>  <span class="fu">data.frame</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="5">5</button><span id="annotated-cell-3-18" class="code-annotation-target"><a href="#annotated-cell-3-18"></a>    <span class="at">speech_title =</span> speech_html <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-19"><a href="#annotated-cell-3-19"></a>      <span class="fu">html_element</span>(<span class="st">".article-title"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-20"><a href="#annotated-cell-3-20"></a>      <span class="fu">html_text2</span>(),</span>
<span id="annotated-cell-3-21"><a href="#annotated-cell-3-21"></a>    <span class="at">speech_date =</span> speech_date,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="6">6</button><span id="annotated-cell-3-22" class="code-annotation-target"><a href="#annotated-cell-3-22"></a>    <span class="at">speaker =</span> speech_content <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-23"><a href="#annotated-cell-3-23"></a>      <span class="fu">map</span>(</span>
<span id="annotated-cell-3-24"><a href="#annotated-cell-3-24"></a>        \(x) {</span>
<span id="annotated-cell-3-25"><a href="#annotated-cell-3-25"></a>          bold_txt <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span> <span class="fu">html_elements</span>(<span class="st">"strong"</span>) <span class="sc">|&gt;</span> <span class="fu">html_text</span>()</span>
<span id="annotated-cell-3-26"><a href="#annotated-cell-3-26"></a>          </span>
<span id="annotated-cell-3-27"><a href="#annotated-cell-3-27"></a>          <span class="fu">ifelse</span>(<span class="fu">length</span>(bold_txt) <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA_character_</span>, bold_txt)</span>
<span id="annotated-cell-3-28"><a href="#annotated-cell-3-28"></a>        }</span>
<span id="annotated-cell-3-29"><a href="#annotated-cell-3-29"></a>      ) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-30"><a href="#annotated-cell-3-30"></a>      <span class="fu">flatten_chr</span>(),</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="7">7</button><span id="annotated-cell-3-31" class="code-annotation-target"><a href="#annotated-cell-3-31"></a>    <span class="at">speech_text =</span> <span class="fu">html_text2</span>(speech_content)</span>
<span id="annotated-cell-3-32"><a href="#annotated-cell-3-32"></a>  ) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-33"><a href="#annotated-cell-3-33"></a>    <span class="fu">filter</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="8">8</button><span id="annotated-cell-3-34" class="code-annotation-target"><a href="#annotated-cell-3-34"></a>      <span class="sc">!</span>speech_text <span class="sc">%in%</span> speech_date,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="9">9</button><span id="annotated-cell-3-35" class="code-annotation-target"><a href="#annotated-cell-3-35"></a>      <span class="fu">str_detect</span>(speech_text, <span class="st">"^</span><span class="sc">\\</span><span class="st">#+$"</span>, <span class="at">negate =</span> <span class="cn">TRUE</span>)</span>
<span id="annotated-cell-3-36"><a href="#annotated-cell-3-36"></a>    ) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="10">10</button><span id="annotated-cell-3-37" class="code-annotation-target"><a href="#annotated-cell-3-37"></a>    <span class="fu">mutate</span>(</span>
<span id="annotated-cell-3-38"><a href="#annotated-cell-3-38"></a>      <span class="at">speaker =</span> <span class="fu">str_extract</span>(speaker, <span class="st">".*(?&lt;=:)"</span>),</span>
<span id="annotated-cell-3-39"><a href="#annotated-cell-3-39"></a>      <span class="at">speech_text =</span> <span class="fu">if_else</span>(</span>
<span id="annotated-cell-3-40"><a href="#annotated-cell-3-40"></a>        <span class="sc">!</span><span class="fu">is.na</span>(speaker),</span>
<span id="annotated-cell-3-41"><a href="#annotated-cell-3-41"></a>        <span class="fu">str_remove</span>(speech_text, speaker),</span>
<span id="annotated-cell-3-42"><a href="#annotated-cell-3-42"></a>        speech_text</span>
<span id="annotated-cell-3-43"><a href="#annotated-cell-3-43"></a>      ) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-44"><a href="#annotated-cell-3-44"></a>        <span class="fu">str_trim</span>() <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-45"><a href="#annotated-cell-3-45"></a>        <span class="fu">str_squish</span>(),</span>
<span id="annotated-cell-3-46"><a href="#annotated-cell-3-46"></a>      <span class="at">speaker =</span> <span class="fu">str_remove</span>(speaker, <span class="st">":$"</span>)</span>
<span id="annotated-cell-3-47"><a href="#annotated-cell-3-47"></a>    ) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="11">11</button><span id="annotated-cell-3-48" class="code-annotation-target"><a href="#annotated-cell-3-48"></a>    <span class="fu">fill</span>(speaker, <span class="at">.direction =</span> <span class="st">"down"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-49"><a href="#annotated-cell-3-49"></a>    <span class="fu">group_by</span>(speech_title, speech_date, speaker) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="12">12</button><span id="annotated-cell-3-50" class="code-annotation-target"><a href="#annotated-cell-3-50"></a>    <span class="fu">summarise</span>(</span>
<span id="annotated-cell-3-51"><a href="#annotated-cell-3-51"></a>      <span class="at">speech_text =</span> <span class="fu">str_flatten</span>(speech_text, <span class="at">collapse =</span> <span class="st">" "</span>),</span>
<span id="annotated-cell-3-52"><a href="#annotated-cell-3-52"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="annotated-cell-3-53"><a href="#annotated-cell-3-53"></a>    ) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="13">13</button><span id="annotated-cell-3-54" class="code-annotation-target"><a href="#annotated-cell-3-54"></a>    <span class="fu">filter</span>(</span>
<span id="annotated-cell-3-55"><a href="#annotated-cell-3-55"></a>      speaker <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Eric Adams"</span>) <span class="sc">||</span> <span class="fu">str_detect</span>(speaker, <span class="st">"Mayor"</span>)</span>
<span id="annotated-cell-3-56"><a href="#annotated-cell-3-56"></a>    )</span>
<span id="annotated-cell-3-57"><a href="#annotated-cell-3-57"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="4" data-code-annotation="1">Jump from the root node of the website to the page containing the speech text and scrape the text</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="9" data-code-annotation="2">Store the date from the text</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="13" data-code-annotation="3">Store all of the content that is in a paragraph element</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="17" data-code-annotation="4">Create a dataframe to organize all the data</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="18" data-code-annotation="5">Create a column for the speech title</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="22" data-code-annotation="6">Extract the bold text which indicates who the speaker is (some transcripts had multiple speakers)</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="31" data-code-annotation="7">Create a column to store the speech text</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="34" data-code-annotation="8">Filter out any rows in which the speech text is the date (the date is stored in a separate column)</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="35" data-code-annotation="9">Remove rows that only contain hash tags in the speech text</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="37" data-code-annotation="10">Clean up the speech text and speaker data columns</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="48" data-code-annotation="11">Fill the speaker column down to ensure that every paragraph has a speaker associated with it</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="12">12</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="50" data-code-annotation="12">Collapse all of the text together by speaker</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="13">13</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="54" data-code-annotation="13">Keep only text spoken by Mayor Eric Adams</span>
</dd>
</dl>
</div>
</div>
<p>Next is the code to actually scrape the data using the above functions. You might notice that I used <code>possibly()</code> from the <code>purrr</code> package. I used this for error handling because I wanted to be able to filter each of the data sets for any empty results. Of course, empty results were a lot less likely because the <code>polite::bow()</code> object stored all the necessary permissions. I thought the redundancy was more helpful than harmful here given how long this code would have to run. This process resulted in 280 search pages and about 1,100 speeches with a couple of seconds of wait time between requests, so I had a strong incentive to minimize errors and to be able to easily identify operations that either returned errors or empty results.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Store the domain of the NYC.gov website</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>nyc_root <span class="ot">&lt;-</span> <span class="st">"https://www.nyc.gov"</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co"># Instantiate a session with permissions to the NYC website</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>nyc_sess <span class="ot">&lt;-</span> <span class="fu">bow</span>(nyc_root, <span class="at">user_agent =</span> <span class="st">"arcenis-r"</span>, <span class="at">force =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co"># Get the number of pages of news article links</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>num_search_pages <span class="ot">&lt;-</span> <span class="fu">read_html_live</span>(</span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="fu">str_c</span>(nyc_root, <span class="st">"/office-of-the-mayor/news.page"</span>)</span>
<span id="cb2-10"><a href="#cb2-10"></a>) <span class="sc">|&gt;</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="fu">html_element</span>(<span class="st">".main-search-results"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="fu">html_text2</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>  <span class="fu">str_extract</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">d+(?= pages)"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>  <span class="fu">as.numeric</span>()</span>
<span id="cb2-15"><a href="#cb2-15"></a></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co"># Get the links to all news articles from each page</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>speech_links <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">search_page_num =</span> <span class="fu">seq</span>(<span class="dv">1</span>, num_search_pages)) <span class="sc">|&gt;</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="at">page_links =</span> <span class="fu">map</span>(</span>
<span id="cb2-20"><a href="#cb2-20"></a>      search_page_num,</span>
<span id="cb2-21"><a href="#cb2-21"></a>      <span class="fu">possibly</span>(\(x) <span class="fu">get_article_links</span>(nyc_sess, x), <span class="cn">NULL</span>)</span>
<span id="cb2-22"><a href="#cb2-22"></a>    )</span>
<span id="cb2-23"><a href="#cb2-23"></a>  )</span>
<span id="cb2-24"><a href="#cb2-24"></a></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co"># Scrape speeches</span></span>
<span id="cb2-26"><a href="#cb2-26"></a>nyc_mayor_speeches <span class="ot">&lt;-</span> speech_links <span class="sc">|&gt;</span></span>
<span id="cb2-27"><a href="#cb2-27"></a>  <span class="fu">unnest</span>(page_links) <span class="sc">|&gt;</span></span>
<span id="cb2-28"><a href="#cb2-28"></a>  <span class="fu">mutate</span>(<span class="at">speech_number =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-30"><a href="#cb2-30"></a>    <span class="at">speech_data =</span> <span class="fu">map2</span>(</span>
<span id="cb2-31"><a href="#cb2-31"></a>      speech_link, speech_number,</span>
<span id="cb2-32"><a href="#cb2-32"></a>      <span class="fu">possibly</span>(\(x, y) <span class="fu">get_speech_data</span>(nyc_sess, x, y), <span class="cn">NULL</span>)</span>
<span id="cb2-33"><a href="#cb2-33"></a>    )</span>
<span id="cb2-34"><a href="#cb2-34"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="sentiment-analysis-over-time" class="level2">
<h2 class="anchored" data-anchor-id="sentiment-analysis-over-time">Sentiment analysis over time</h2>
<p>With the data secured, the next step would be to look at changes in the sentiment of his speeches over time. To do that I tokenized the speech data and used both the AFINN-111 valence lexicon <span class="citation" data-cites="nielsen11">(<a href="#ref-nielsen11" role="doc-biblioref">Nielsen 2011</a>)</span> and the NRC word-emotion association lexicon <span class="citation" data-cites="mohammad13">(<a href="#ref-mohammad13" role="doc-biblioref">Mohammad and Turney 2013</a>)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>speech_df <span class="ot">&lt;-</span> nyc_mayor_speeches <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(search_page_num, speech_number)) <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="at">speech_text =</span> <span class="fu">str_to_lower</span>(speech_text) <span class="sc">|&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>      <span class="fu">replace_url</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>      <span class="fu">replace_html</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>      <span class="fu">replace_contraction</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>      <span class="fu">replace_word_elongation</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>      <span class="fu">replace_ordinal</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>      <span class="fu">replace_date</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>      <span class="fu">replace_money</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>      <span class="fu">replace_number</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>      <span class="fu">replace_kern</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>      <span class="fu">replace_curly_quote</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>      <span class="fu">replace_non_ascii</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>      <span class="fu">str_squish</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>      <span class="fu">str_trim</span>(),</span>
<span id="cb3-18"><a href="#cb3-18"></a>    <span class="at">speech_date =</span> <span class="fu">mdy</span>(speech_date)</span>
<span id="cb3-19"><a href="#cb3-19"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>  <span class="fu">group_by</span>(speech_date) <span class="sc">|&gt;</span></span>
<span id="cb3-21"><a href="#cb3-21"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-22"><a href="#cb3-22"></a>    <span class="at">speech_id =</span> <span class="fu">str_c</span>(</span>
<span id="cb3-23"><a href="#cb3-23"></a>      speech_date <span class="sc">|&gt;</span> <span class="fu">as.character</span>() <span class="sc">|&gt;</span> <span class="fu">str_remove_all</span>(<span class="st">"-"</span>),</span>
<span id="cb3-24"><a href="#cb3-24"></a>      <span class="fu">row_number</span>()</span>
<span id="cb3-25"><a href="#cb3-25"></a>    )</span>
<span id="cb3-26"><a href="#cb3-26"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-27"><a href="#cb3-27"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb3-28"><a href="#cb3-28"></a></span>
<span id="cb3-29"><a href="#cb3-29"></a>speech_word_tokens <span class="ot">&lt;-</span> speech_df <span class="sc">|&gt;</span></span>
<span id="cb3-30"><a href="#cb3-30"></a>  <span class="fu">unnest_tokens</span>(word, speech_text) <span class="sc">|&gt;</span></span>
<span id="cb3-31"><a href="#cb3-31"></a>  <span class="fu">anti_join</span>(stop_words, <span class="at">by =</span> <span class="st">"word"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-32"><a href="#cb3-32"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(<span class="fu">as.numeric</span>(word)))</span>
<span id="cb3-33"><a href="#cb3-33"></a></span>
<span id="cb3-34"><a href="#cb3-34"></a>speech_tf_idf <span class="ot">&lt;-</span> speech_word_tokens <span class="sc">|&gt;</span></span>
<span id="cb3-35"><a href="#cb3-35"></a>  <span class="fu">count</span>(speech_id, word, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-36"><a href="#cb3-36"></a>  <span class="fu">group_by</span>(speech_id) <span class="sc">|&gt;</span></span>
<span id="cb3-37"><a href="#cb3-37"></a>  <span class="fu">mutate</span>(<span class="at">speech_word_count =</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb3-38"><a href="#cb3-38"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-39"><a href="#cb3-39"></a>  <span class="fu">bind_tf_idf</span>(word, speech_id, n)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>This first plot shows sentiment over time based on the AFINN-111 lexicon with a linear modeling smoother. This lexicon applies a value between -5 (most negative) and 5 (most positive) to each word in the lexicon. I calculated sentiment by date by taking the mean sentiment of all of the words used on each day. It appears that the sentiment in Eric Adams’ speeches has become more positive over time.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>I calculated average sentiment by day rather than by speech because Eric Adams made multiple speeches on some days.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>speech_word_tokens <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="fu">inner_join</span>(<span class="fu">get_sentiments</span>(<span class="st">"afinn"</span>), <span class="at">by =</span> <span class="st">"word"</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="fu">group_by</span>(speech_date) <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="fu">summarise</span>(<span class="at">mean_valence =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(speech_date, mean_valence)) <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> y <span class="sc">~</span> x) <span class="sc">+</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-9"><a href="#cb4-9"></a>    <span class="at">title =</span> <span class="st">"Sentiment in Eric Adams' Speeches Over Time"</span>,</span>
<span id="cb4-10"><a href="#cb4-10"></a>    <span class="at">subtitle =</span> <span class="st">"Sentiment based on the AFINN lexicon"</span>,</span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="at">y =</span> <span class="st">"Average Speech Sentiment"</span>,</span>
<span id="cb4-12"><a href="#cb4-12"></a>    <span class="at">x =</span> <span class="cn">NULL</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>  ) <span class="sc">+</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>  <span class="fu">theme</span>(</span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb4-17"><a href="#cb4-17"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb4-18"><a href="#cb4-18"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="eric-adams-sentiment-analysis_files/figure-html/plot-sentiment-afinn-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The below plot shows sentiment over time based on the NRC lexicon. This lexicon assigns each word a label indicating a given emotion such as anger, joy, or disgust. It also assigns “positive” and “negative” labels, which I filtered out. For this plot I calculated the percentage of words that were related to each emotion out of all non-stop words in the speech and applied a gamma smoother. This plot shows that there were spikes in disgust, fear, and sadness in the first half of 2023. The reduction of these negative emotions in Eric Adams’ speeches could account for the apparent positive trend in the last plot; the emotional content got less negative.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Stop words</strong> are words that are inconsequential to determining the meaning of a set of words or distinguish that set of words from other words. They also tend to be very common.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>speech_word_tokens <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">group_by</span>(speech_date) <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="fu">count</span>(word) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="fu">mutate</span>(<span class="at">total_words =</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb5-6"><a href="#cb5-6"></a>    <span class="fu">get_sentiments</span>(<span class="st">"nrc"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>      <span class="fu">filter</span>(<span class="sc">!</span>sentiment <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"positive"</span>, <span class="st">"negative"</span>)),</span>
<span id="cb5-8"><a href="#cb5-8"></a>    <span class="at">by =</span> <span class="st">"word"</span>, <span class="at">relationship =</span> <span class="st">"many-to-many"</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>  <span class="fu">group_by</span>(speech_date, sentiment) <span class="sc">|&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>  <span class="fu">reframe</span>(<span class="at">sentiment_pct =</span> <span class="fu">sum</span>(n) <span class="sc">/</span> total_words) <span class="sc">|&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> speech_date, <span class="at">y =</span> sentiment_pct)) <span class="sc">+</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>, <span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">bs =</span> <span class="st">"cs"</span>)) <span class="sc">+</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-16"><a href="#cb5-16"></a>    <span class="at">title =</span> <span class="st">"Sentiment in Eric Adams' Speeches Over Time"</span>,</span>
<span id="cb5-17"><a href="#cb5-17"></a>    <span class="at">subtitle =</span> <span class="st">"Sentiment based on the NRC lexicon"</span>,</span>
<span id="cb5-18"><a href="#cb5-18"></a>    <span class="at">y =</span> <span class="st">"Percentage Speech Sentiment"</span>,</span>
<span id="cb5-19"><a href="#cb5-19"></a>    <span class="at">x =</span> <span class="cn">NULL</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>  ) <span class="sc">+</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>sentiment, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>  <span class="fu">theme</span>(</span>
<span id="cb5-24"><a href="#cb5-24"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb5-25"><a href="#cb5-25"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb5-26"><a href="#cb5-26"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="eric-adams-sentiment-analysis_files/figure-html/plot-sentiment-nrc-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="word-cloud-animation" class="level2">
<h2 class="anchored" data-anchor-id="word-cloud-animation">Word cloud animation</h2>
<p>Below is a short animation of word clouds for each month in the data. Each word cloud includes 50 words with the highest TF-IDF (term frequency, inverse document frequency) values by month.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">set.seed</span>(<span class="dv">98457</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a>wrdcld_data <span class="ot">&lt;-</span> speech_tf_idf <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="fu">left_join</span>(<span class="fu">select</span>(speech_df, speech_id, speech_date), <span class="at">by =</span> <span class="st">"speech_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-5"><a href="#cb6-5"></a>    <span class="at">speech_yrmo =</span> <span class="fu">floor_date</span>(speech_date, <span class="st">"month"</span>)</span>
<span id="cb6-6"><a href="#cb6-6"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>  <span class="fu">group_by</span>(speech_yrmo) <span class="sc">|&gt;</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="fu">slice_max</span>(tf_idf, <span class="at">n =</span> <span class="dv">50</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-11"><a href="#cb6-11"></a>    <span class="at">yrmo_label =</span> <span class="fu">format</span>(speech_date, <span class="at">format =</span> <span class="st">"%B, %Y"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>      <span class="fu">fct_reorder</span>(speech_yrmo),</span>
<span id="cb6-13"><a href="#cb6-13"></a>    <span class="at">word_size =</span> <span class="fu">abs</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="fu">log</span>(tf_idf)),</span>
<span id="cb6-14"><a href="#cb6-14"></a>    <span class="at">word_color =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">factor</span>(),</span>
<span id="cb6-15"><a href="#cb6-15"></a>    <span class="at">word_angle =</span> <span class="dv">45</span> <span class="sc">*</span> <span class="fu">sample</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">2</span>, <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb6-16"><a href="#cb6-16"></a>  )</span>
<span id="cb6-17"><a href="#cb6-17"></a></span>
<span id="cb6-18"><a href="#cb6-18"></a>num_frames <span class="ot">&lt;-</span> wrdcld_data <span class="sc">|&gt;</span></span>
<span id="cb6-19"><a href="#cb6-19"></a>  <span class="fu">distinct</span>(speech_yrmo) <span class="sc">|&gt;</span></span>
<span id="cb6-20"><a href="#cb6-20"></a>  <span class="fu">count</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb6-22"><a href="#cb6-22"></a></span>
<span id="cb6-23"><a href="#cb6-23"></a>adams_cloud <span class="ot">&lt;-</span> wrdcld_data <span class="sc">|&gt;</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb6-25"><a href="#cb6-25"></a>    <span class="fu">aes</span>(<span class="at">label =</span> word, <span class="at">size =</span> tf_idf, <span class="at">color =</span> word_color, <span class="at">angle =</span> word_angle)</span>
<span id="cb6-26"><a href="#cb6-26"></a>  ) <span class="sc">+</span></span>
<span id="cb6-27"><a href="#cb6-27"></a>  <span class="fu">geom_text_wordcloud_area</span>() <span class="sc">+</span></span>
<span id="cb6-28"><a href="#cb6-28"></a>  <span class="fu">scale_size_area</span>(<span class="at">max_size =</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb6-29"><a href="#cb6-29"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"{closest_state}"</span>) <span class="sc">+</span></span>
<span id="cb6-30"><a href="#cb6-30"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb6-31"><a href="#cb6-31"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb6-32"><a href="#cb6-32"></a>  <span class="fu">transition_states</span>(speech_yrmo) <span class="sc">+</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>  <span class="fu">enter_fade</span>() <span class="sc">+</span></span>
<span id="cb6-34"><a href="#cb6-34"></a>  <span class="fu">exit_fade</span>() <span class="sc">+</span></span>
<span id="cb6-35"><a href="#cb6-35"></a>  <span class="fu">ease_aes</span>(<span class="st">"sine-in-out"</span>)</span>
<span id="cb6-36"><a href="#cb6-36"></a></span>
<span id="cb6-37"><a href="#cb6-37"></a><span class="fu">animate</span>(adams_cloud, <span class="at">fps =</span> <span class="fl">0.5</span>, <span class="at">nframes =</span> num_frames)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="eric-adams-sentiment-analysis_files/figure-html/word-cloud-animation-1.gif" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-textdata" class="csl-entry" role="listitem">
Hvitfeldt, Emil. 2022. <span>“Textdata: Download and Load Various Text Datasets.”</span> <a href="https://CRAN.R-project.org/package=textdata">https://CRAN.R-project.org/package=textdata</a>.
</div>
<div id="ref-ggwordcloud" class="csl-entry" role="listitem">
Le Pennec, Erwan, and Kamil Slowikowski. 2023. <span>“Ggwordcloud: A Word Cloud Geom for ’Ggplot2’.”</span> <a href="https://CRAN.R-project.org/package=ggwordcloud">https://CRAN.R-project.org/package=ggwordcloud</a>.
</div>
<div id="ref-mohammad13" class="csl-entry" role="listitem">
Mohammad, Saif M., and Peter D. Turney. 2013. <span>“CROWDSOURCING a WORD–EMOTION ASSOCIATION LEXICON.”</span> <em>Computational Intelligence</em> 29 (3): 436–65. <a href="https://doi.org/10.1111/j.1467-8640.2012.00460.x">https://doi.org/10.1111/j.1467-8640.2012.00460.x</a>.
</div>
<div id="ref-nielsen11" class="csl-entry" role="listitem">
Nielsen, Finn Äruprup. 2011. <span>“A New ANEW: Evaluation of a Word List for Sentiment Analysis in Microblogs.”</span> <em>CoRR</em> abs/1103.2903. <a href="http://arxiv.org/abs/1103.2903">http://arxiv.org/abs/1103.2903</a>.
</div>
<div id="ref-gganimate" class="csl-entry" role="listitem">
Pedersen, Thomas Lin, and David Robinson. 2024. <span>“Gganimate: A Grammar of Animated Graphics.”</span> <a href="https://CRAN.R-project.org/package=gganimate">https://CRAN.R-project.org/package=gganimate</a>.
</div>
<div id="ref-polite" class="csl-entry" role="listitem">
Perepolkin, Dmytro. 2023. <span>“Polite: Be Nice on the Web.”</span> <a href="https://CRAN.R-project.org/package=polite">https://CRAN.R-project.org/package=polite</a>.
</div>
<div id="ref-textclean" class="csl-entry" role="listitem">
Rinker, Tyler W. 2018. <span>“<span></span>Textclean<span></span>: Text Cleaning Tools.”</span> <a href="https://github.com/trinker/textclean">https://github.com/trinker/textclean</a>.
</div>
<div id="ref-tidytext" class="csl-entry" role="listitem">
Silge, Julia, and David Robinson. 2016. <span>“Tidytext: Text Mining and Analysis Using Tidy Data Principles in r”</span> 1. <a href="https://doi.org/10.21105/joss.00037">https://doi.org/10.21105/joss.00037</a>.
</div>
<div id="ref-ggplot2" class="csl-entry" role="listitem">
Wickham, Hadley. 2016. <span>“Ggplot2: Elegant Graphics for Data Analysis.”</span> <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-rvest" class="csl-entry" role="listitem">
———. 2024. <span>“Rvest: Easily Harvest (Scrape) Web Pages.”</span> <a href="https://CRAN.R-project.org/package=rvest">https://CRAN.R-project.org/package=rvest</a>.
</div>
<div id="ref-tidyverse" class="csl-entry" role="listitem">
Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. <span>“Welcome to the <span></span>Tidyverse<span></span>”</span> 4: 1686. <a href="https://doi.org/10.21105/joss.01686">https://doi.org/10.21105/joss.01686</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("^(?:http:|https:)\/\/arcenis-r\.github\.io\/ajr-portfolio");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            trigger: 'click',
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            positionFixed: true,
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "arcenis-r/ajr-portfolio";
    script.dataset.repoId = "MDEwOlJlcG9zaXRvcnkxNzg3MDY3MTM=";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOCqbZGc4CdJXz";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1"></a><span class="co">---</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="an">title:</span><span class="co"> "Sentiment Analysis of NYC's Mayor Eric Adams' Speeches"</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="an">subtitle:</span><span class="co"> "Problem-Solving in Action"</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="an">author:</span><span class="co"> "Arcenis Rojas"</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="an">date:</span><span class="co"> "04/03/2024"</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="an">execute:</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">  warning: false</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">  error: false</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="an">bibliography:</span><span class="co"> eric-adams-speeches.bib</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="an">categories:</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="co">  - Web Scraping</span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="co">  - Text Analysis</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co">  - Animation</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="co">---</span></span>
<span id="cb7-16"><a href="#cb7-16"></a></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="fu">## Project description</span></span>
<span id="cb7-18"><a href="#cb7-18"></a></span>
<span id="cb7-19"><a href="#cb7-19"></a>This project came from a question that I had about how the sentiment in NYC Mayor Eric Adams' speeches might have changed over the last few years given some of the different challenges he's had in office ranging from COVID-19-related policies to more recent issues with immigration in NYC. As often happens, this simple question introduced unanticipated challenges and again made me really grateful to the open-source community.</span>
<span id="cb7-20"><a href="#cb7-20"></a></span>
<span id="cb7-21"><a href="#cb7-21"></a>For this analysis I relied heavily on <span class="co">[</span><span class="ot">tidyverse</span><span class="co">](https://www.tidyverse.org/)</span> <span class="co">[</span><span class="ot">@tidyverse</span><span class="co">]</span> packages for data wrangling; the <span class="co">[</span><span class="ot">rvest</span><span class="co">](https://rvest.tidyverse.org/)</span> <span class="co">[</span><span class="ot">@rvest</span><span class="co">]</span> and <span class="co">[</span><span class="ot">polite</span><span class="co">](https://dmi3kno.github.io/polite/)</span> <span class="co">[</span><span class="ot">@polite</span><span class="co">]</span> packages for webscraping; the <span class="co">[</span><span class="ot">tidytext</span><span class="co">](https://juliasilge.github.io/tidytext/)</span> <span class="co">[</span><span class="ot">@tidytext</span><span class="co">]</span>, <span class="co">[</span><span class="ot">textdata</span><span class="co">](https://github.com/EmilHvitfeldt/textdata)</span> <span class="co">[</span><span class="ot">@textdata</span><span class="co">]</span>, and <span class="co">[</span><span class="ot">textclean</span><span class="co">](https://github.com/trinker/textclean)</span> <span class="co">[</span><span class="ot">@textclean</span><span class="co">]</span> packages for text analysis functions; and the <span class="co">[</span><span class="ot">ggplot2</span><span class="co">](https://ggplot2.tidyverse.org/)</span> <span class="co">[</span><span class="ot">@ggplot2</span><span class="co">]</span>, <span class="co">[</span><span class="ot">ggwordcloud</span><span class="co">](https://lepennec.github.io/ggwordcloud/index.html)</span> <span class="co">[</span><span class="ot">@ggwordcloud</span><span class="co">]</span>, and <span class="co">[</span><span class="ot">gganimate</span><span class="co">](https://gganimate.com/)</span> <span class="co">[</span><span class="ot">@gganimate</span><span class="co">]</span> packages for visualization.</span>
<span id="cb7-22"><a href="#cb7-22"></a></span>
<span id="cb7-23"><a href="#cb7-23"></a><span class="fu">## Getting speech data</span></span>
<span id="cb7-24"><a href="#cb7-24"></a></span>
<span id="cb7-25"><a href="#cb7-25"></a>To perform this analysis I would have to find a repository of his speeches online and figure out how to scrape them. Because I thought there would be a lot of speeches, I knew that I would run into issues dealing with having to add delays to my scraping function so as not to run into conflict with the rules of the site. I also thought about the problem of having to scrape pages with Javascript on them and remembered that <span class="co">[</span><span class="ot">Hadley Wickham</span><span class="co">](https://hadley.nz/)</span> <span class="co">[</span><span class="ot">posted on LinkedIn</span><span class="co">](https://www.linkedin.com/feed/update/urn:li:activity:7159172919758065665?updateEntityUrn=urn%3Ali%3Afs_feedUpdate%3A%28V2%2Curn%3Ali%3Aactivity%3A7159172919758065665%29)</span> about an experimental update to <span class="co">[</span><span class="ot">rvest</span><span class="co">](https://rvest.tidyverse.org/)</span> that included tools for scraping live sites using <span class="co">[</span><span class="ot">chromote</span><span class="co">](https://rstudio.github.io/chromote/)</span>. Without remembering this I probably would not have pursued the project because the alternative for scraping live web pages with R is <span class="co">[</span><span class="ot">RSelenium</span><span class="co">](https://docs.ropensci.org/RSelenium/articles/basics.html)</span> (at least as far as I know), which requires a lot more set-up work than this project would have been worth.</span>
<span id="cb7-26"><a href="#cb7-26"></a></span>
<span id="cb7-27"><a href="#cb7-27"></a>As far as dealing with the robots on the NYC news site, I also wanted to scrape in an ethical way. Thinking about this led me to two things: 1) <span class="co">[</span><span class="ot">Rules for ethical webscraping</span><span class="co">](https://towardsdatascience.com/ethics-in-web-scraping-b96b18136f01)</span> and 2) the <span class="co">[</span><span class="ot">polite</span><span class="co">](https://dmi3kno.github.io/polite/)</span> package. First, there is the practical consideration that some sites place limits on the frequency with which they will serve results to clients and if the scraping process doesn't respect that one may end up getting one result with content and a bunch of empty results thereafter if not just outright errors. Aside from this practical consideration, my position is that if I'm getting all this great data for free (that someone is paying to host) the least I can do is identify myself to the host so the host knows I mean no harm.</span>
<span id="cb7-28"><a href="#cb7-28"></a></span>
<span id="cb7-29"><a href="#cb7-29"></a><span class="fu">### Finding speech transcripts</span></span>
<span id="cb7-30"><a href="#cb7-30"></a></span>
<span id="cb7-31"><a href="#cb7-31"></a>Once I decided to go ahead, the first challenge was to get transcripts of Mayor Adams' speeches. A simple web search led me to the <span class="co">[</span><span class="ot">NYC.gov</span><span class="co">](https://www.nyc.gov/)</span> website which has a section for <span class="co">[</span><span class="ot">news coming out of the office of the Mayor</span><span class="co">](https://www.nyc.gov/office-of-the-mayor/news.page)</span>. I noticed that this site had more than his speeches, but there were some titles of articles that started with the word "Transcript". After looking through a few pages I saw that this was the case for many articles, so I thought I could use this to isolate the articles that contained speeches. The next step was figuring out how to scrape the data.</span>
<span id="cb7-32"><a href="#cb7-32"></a></span>
<span id="cb7-33"><a href="#cb7-33"></a><span class="fu">### Challenges in webscraping</span></span>
<span id="cb7-34"><a href="#cb7-34"></a></span>
<span id="cb7-35"><a href="#cb7-35"></a>I first figured out that I would have to scrape in two stages. In the first stage, I would have to scrape all of the pages containing news article titles and their corresponding links, which would require knowing how many pages of links there are. I would then have to filter these links for the ones that contained speech transcripts. In the second stage I would have to go to each of the links from the first stage and scrape the speech text.</span>
<span id="cb7-36"><a href="#cb7-36"></a></span>
<span id="cb7-37"><a href="#cb7-37"></a>Going into the first stage I wanted to use <span class="in">`polite::nod()`</span> to jump from one page to the next. However, I learned that all of the pages with search results were live pages (Javascript) and <span class="in">`polite::scrape()`</span> is designed to work with static elements, so there were elements of the page that I wasn't getting. I thought I would either be stuck or have to make a trade-off between getting output and behaving ethically until I found <span class="co">[</span><span class="ot">yusuzech's Cheat Sheet for Web Scraping Using R</span><span class="co">](https://github.com/yusuzech/r-web-scraping-cheat-sheet)</span> in which he talks about different ways to deal with this particular challenge. There I learned about an <span class="co">[</span><span class="ot">entry in Hartley Brody's blog</span><span class="co">](https://blog.hartleybrody.com/web-scraping-cheat-sheet/)</span> containing his Web Scraping Cheat Sheet. In the "More Advanced Topics" section he mentioned that a page with live elements (Javascript) requires that the content be in static form *somewhere* on the server. I was able to find that page for the NYC site, which then required identifying the links that I needed using <span class="co">[</span><span class="ot">regex</span><span class="co">](https://en.wikipedia.org/wiki/Regular_expression)</span>, which was a much smaller problem than choosing between getting data from a live site and scraping ethically.</span>
<span id="cb7-38"><a href="#cb7-38"></a></span>
<span id="cb7-39"><a href="#cb7-39"></a><span class="fu">### Webscraping code</span></span>
<span id="cb7-40"><a href="#cb7-40"></a></span>
<span id="cb7-43"><a href="#cb7-43"></a><span class="in">```{r}</span></span>
<span id="cb7-44"><a href="#cb7-44"></a><span class="co">#| label: webscraping-load-packages</span></span>
<span id="cb7-45"><a href="#cb7-45"></a></span>
<span id="cb7-46"><a href="#cb7-46"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb7-47"><a href="#cb7-47"></a><span class="fu">library</span>(xml2)</span>
<span id="cb7-48"><a href="#cb7-48"></a><span class="fu">library</span>(rvest)</span>
<span id="cb7-49"><a href="#cb7-49"></a><span class="fu">library</span>(polite)</span>
<span id="cb7-50"><a href="#cb7-50"></a><span class="fu">library</span>(tidytext)</span>
<span id="cb7-51"><a href="#cb7-51"></a><span class="fu">library</span>(textclean)</span>
<span id="cb7-52"><a href="#cb7-52"></a><span class="fu">library</span>(textdata)</span>
<span id="cb7-53"><a href="#cb7-53"></a><span class="fu">library</span>(ggwordcloud)</span>
<span id="cb7-54"><a href="#cb7-54"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb7-55"><a href="#cb7-55"></a></span>
<span id="cb7-56"><a href="#cb7-56"></a><span class="co"># Resolve common namespace conflicts about function names</span></span>
<span id="cb7-57"><a href="#cb7-57"></a>conflicted<span class="sc">::</span><span class="fu">conflict_prefer</span>(<span class="st">"filter"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb7-58"><a href="#cb7-58"></a>conflicted<span class="sc">::</span><span class="fu">conflict_prefer</span>(<span class="st">"lag"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb7-59"><a href="#cb7-59"></a><span class="cf">if</span> (<span class="st">"tidymodels"</span> <span class="sc">%in%</span> <span class="fu">.packages</span>()) <span class="fu">tidymodels_prefer</span>()</span>
<span id="cb7-60"><a href="#cb7-60"></a></span>
<span id="cb7-61"><a href="#cb7-61"></a><span class="in">```</span></span>
<span id="cb7-62"><a href="#cb7-62"></a></span>
<span id="cb7-63"><a href="#cb7-63"></a>Below is the code that I used for scraping the data. I tried to parallize this code, but I learned that code that uses external pointers will error out with the different packages I tried for parallelization.</span>
<span id="cb7-64"><a href="#cb7-64"></a></span>
<span id="cb7-65"><a href="#cb7-65"></a>Here I declare a function for the first stage of the web scraping process which takes as arguments the <span class="in">`polite::bow()`</span> object and the number of the search page to scrape.</span>
<span id="cb7-66"><a href="#cb7-66"></a></span>
<span id="cb7-67"><a href="#cb7-67"></a>::: callout-note</span>
<span id="cb7-68"><a href="#cb7-68"></a>This function jumps to the static site that lists the search results in <span class="in">`polite::nod()`</span>. The query in the path string shows that all of the results are from the dates between 12/31/2021 and 12/31/2024.</span>
<span id="cb7-69"><a href="#cb7-69"></a>:::</span>
<span id="cb7-70"><a href="#cb7-70"></a></span>
<span id="cb7-73"><a href="#cb7-73"></a><span class="in">```{r}</span></span>
<span id="cb7-74"><a href="#cb7-74"></a><span class="co">#| label: webscraping-get-article-links-fun</span></span>
<span id="cb7-75"><a href="#cb7-75"></a><span class="co">#| code-fold: show</span></span>
<span id="cb7-76"><a href="#cb7-76"></a><span class="co">#| eval: false</span></span>
<span id="cb7-77"><a href="#cb7-77"></a></span>
<span id="cb7-78"><a href="#cb7-78"></a>get_article_links <span class="ot">&lt;-</span> <span class="cf">function</span>(bow_obj, srch_pg_num) {</span>
<span id="cb7-79"><a href="#cb7-79"></a>  <span class="fu">message</span>(<span class="fu">str_c</span>(<span class="st">"Scraping links from page "</span>, srch_pg_num))</span>
<span id="cb7-80"><a href="#cb7-80"></a>  </span>
<span id="cb7-81"><a href="#cb7-81"></a>  search_sess <span class="ot">&lt;-</span> <span class="fu">nod</span>(                                                     <span class="co"># &lt;1&gt;</span></span>
<span id="cb7-82"><a href="#cb7-82"></a>    bow_obj,</span>
<span id="cb7-83"><a href="#cb7-83"></a>    <span class="at">path =</span> <span class="fu">str_c</span>(</span>
<span id="cb7-84"><a href="#cb7-84"></a>      <span class="st">"/home/lscs/NewsFilterService.page"</span>,</span>
<span id="cb7-85"><a href="#cb7-85"></a>      <span class="st">"?category=all&amp;contentType=all&amp;startDate=12/31/2021&amp;endDate=12/31/2024&amp;"</span>,</span>
<span id="cb7-86"><a href="#cb7-86"></a>      <span class="st">"language=english&amp;pageNumber="</span>,</span>
<span id="cb7-87"><a href="#cb7-87"></a>      srch_pg_num</span>
<span id="cb7-88"><a href="#cb7-88"></a>    )</span>
<span id="cb7-89"><a href="#cb7-89"></a>  )</span>
<span id="cb7-90"><a href="#cb7-90"></a>  </span>
<span id="cb7-91"><a href="#cb7-91"></a>  <span class="fu">scrape</span>(search_sess) <span class="sc">|&gt;</span>                                                  <span class="co"># &lt;2&gt;</span></span>
<span id="cb7-92"><a href="#cb7-92"></a>    <span class="fu">as_list</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-93"><a href="#cb7-93"></a>    <span class="fu">pluck</span>(<span class="st">"root"</span>, <span class="dv">2</span>) <span class="sc">|&gt;</span>                                                   <span class="co"># &lt;3&gt;</span></span>
<span id="cb7-94"><a href="#cb7-94"></a>    <span class="fu">str_extract</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">{(.*)"</span>) <span class="sc">|&gt;</span>                                          <span class="co"># &lt;4&gt;</span></span>
<span id="cb7-95"><a href="#cb7-95"></a>    <span class="fu">str_extract_all</span>(<span class="st">'(?&lt;=URL":")[</span><span class="sc">\\</span><span class="st">/</span><span class="sc">\\</span><span class="st">-a-z0-9]+'</span>) <span class="sc">|&gt;</span>                      <span class="co"># &lt;5&gt;</span></span>
<span id="cb7-96"><a href="#cb7-96"></a>    <span class="fu">flatten_chr</span>() <span class="sc">|&gt;</span>                                                            </span>
<span id="cb7-97"><a href="#cb7-97"></a>    <span class="fu">str_subset</span>(<span class="st">"transcript"</span>) <span class="sc">|&gt;</span>                                           <span class="co"># &lt;6&gt;</span></span>
<span id="cb7-98"><a href="#cb7-98"></a>    <span class="fu">enframe</span>(<span class="at">value =</span> <span class="st">"speech_link"</span>) <span class="sc">|&gt;</span>                                     <span class="co"># &lt;7&gt;</span></span>
<span id="cb7-99"><a href="#cb7-99"></a>    <span class="fu">select</span>(<span class="sc">-</span>name)</span>
<span id="cb7-100"><a href="#cb7-100"></a>}</span>
<span id="cb7-101"><a href="#cb7-101"></a></span>
<span id="cb7-102"><a href="#cb7-102"></a><span class="in">```</span></span>
<span id="cb7-103"><a href="#cb7-103"></a></span>
<span id="cb7-104"><a href="#cb7-104"></a><span class="ss">1.  </span>Jump from the root node of the website to the search page of interest</span>
<span id="cb7-105"><a href="#cb7-105"></a><span class="ss">2.  </span>Scrape the HTML as XML text</span>
<span id="cb7-106"><a href="#cb7-106"></a><span class="ss">3.  </span>Keep only the second element of the root node (exclude head elements)</span>
<span id="cb7-107"><a href="#cb7-107"></a><span class="ss">4.  </span>Keep everything after some additional metadata elements</span>
<span id="cb7-108"><a href="#cb7-108"></a><span class="ss">5.  </span>Extract everything that proceeded the text indicating a URL</span>
<span id="cb7-109"><a href="#cb7-109"></a><span class="ss">6.  </span>Keep only the URL's that contained the term "transcript"</span>
<span id="cb7-110"><a href="#cb7-110"></a><span class="ss">7.  </span>Put the vector of links into a dataframe</span>
<span id="cb7-111"><a href="#cb7-111"></a></span>
<span id="cb7-112"><a href="#cb7-112"></a>The next function scrapes a page containing speech data taking as arguments the <span class="in">`polite::bow()`</span> object, one of the links from the first stage, and a number of the link being read to track progress.</span>
<span id="cb7-113"><a href="#cb7-113"></a></span>
<span id="cb7-116"><a href="#cb7-116"></a><span class="in">```{r}</span></span>
<span id="cb7-117"><a href="#cb7-117"></a><span class="co">#| label: webscraping-get-speech data-fun</span></span>
<span id="cb7-118"><a href="#cb7-118"></a><span class="co">#| code-fold: show</span></span>
<span id="cb7-119"><a href="#cb7-119"></a><span class="co">#| eval: false</span></span>
<span id="cb7-120"><a href="#cb7-120"></a></span>
<span id="cb7-121"><a href="#cb7-121"></a>get_speech_data <span class="ot">&lt;-</span> <span class="cf">function</span>(bow_obj, article_path, <span class="at">speech_num =</span> <span class="dv">1</span>) {</span>
<span id="cb7-122"><a href="#cb7-122"></a>  <span class="fu">message</span>(<span class="fu">str_c</span>(<span class="st">"Scraping speech number "</span>, speech_num))</span>
<span id="cb7-123"><a href="#cb7-123"></a>  </span>
<span id="cb7-124"><a href="#cb7-124"></a>  speech_html <span class="ot">&lt;-</span> <span class="fu">nod</span>(bow_obj, <span class="at">path =</span> article_path) <span class="sc">|&gt;</span>               <span class="co"># &lt;1&gt;</span></span>
<span id="cb7-125"><a href="#cb7-125"></a>    <span class="fu">scrape</span>(<span class="at">accept =</span> <span class="st">"html"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-126"><a href="#cb7-126"></a>    <span class="fu">html_element</span>(<span class="st">".ls-col .ls-col-body .ls-row.main"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-127"><a href="#cb7-127"></a>    <span class="fu">html_element</span>(<span class="st">".iw_component .container .col-content"</span>)</span>
<span id="cb7-128"><a href="#cb7-128"></a>  </span>
<span id="cb7-129"><a href="#cb7-129"></a>  speech_date <span class="ot">&lt;-</span> speech_html <span class="sc">|&gt;</span>                                     <span class="co"># &lt;2&gt;</span></span>
<span id="cb7-130"><a href="#cb7-130"></a>    <span class="fu">html_elements</span>(<span class="st">".richtext p .date"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-131"><a href="#cb7-131"></a>    <span class="fu">html_text2</span>()</span>
<span id="cb7-132"><a href="#cb7-132"></a>  </span>
<span id="cb7-133"><a href="#cb7-133"></a>  speech_content <span class="ot">&lt;-</span> speech_html <span class="sc">|&gt;</span>                                  <span class="co"># &lt;3&gt;</span></span>
<span id="cb7-134"><a href="#cb7-134"></a>    <span class="fu">html_element</span>(<span class="st">".richtext"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-135"><a href="#cb7-135"></a>    <span class="fu">html_elements</span>(<span class="st">"p"</span>)</span>
<span id="cb7-136"><a href="#cb7-136"></a>  </span>
<span id="cb7-137"><a href="#cb7-137"></a>  <span class="fu">data.frame</span>(                                                       <span class="co"># &lt;4&gt;</span></span>
<span id="cb7-138"><a href="#cb7-138"></a>    <span class="at">speech_title =</span> speech_html <span class="sc">|&gt;</span>                                   <span class="co"># &lt;5&gt;</span></span>
<span id="cb7-139"><a href="#cb7-139"></a>      <span class="fu">html_element</span>(<span class="st">".article-title"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-140"><a href="#cb7-140"></a>      <span class="fu">html_text2</span>(),</span>
<span id="cb7-141"><a href="#cb7-141"></a>    <span class="at">speech_date =</span> speech_date,</span>
<span id="cb7-142"><a href="#cb7-142"></a>    <span class="at">speaker =</span> speech_content <span class="sc">|&gt;</span>                                     <span class="co"># &lt;6&gt;</span></span>
<span id="cb7-143"><a href="#cb7-143"></a>      <span class="fu">map</span>(</span>
<span id="cb7-144"><a href="#cb7-144"></a>        \(x) {</span>
<span id="cb7-145"><a href="#cb7-145"></a>          bold_txt <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span> <span class="fu">html_elements</span>(<span class="st">"strong"</span>) <span class="sc">|&gt;</span> <span class="fu">html_text</span>()</span>
<span id="cb7-146"><a href="#cb7-146"></a>          </span>
<span id="cb7-147"><a href="#cb7-147"></a>          <span class="fu">ifelse</span>(<span class="fu">length</span>(bold_txt) <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA_character_</span>, bold_txt)</span>
<span id="cb7-148"><a href="#cb7-148"></a>        }</span>
<span id="cb7-149"><a href="#cb7-149"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb7-150"><a href="#cb7-150"></a>      <span class="fu">flatten_chr</span>(),</span>
<span id="cb7-151"><a href="#cb7-151"></a>    <span class="at">speech_text =</span> <span class="fu">html_text2</span>(speech_content)                        <span class="co"># &lt;7&gt;</span></span>
<span id="cb7-152"><a href="#cb7-152"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-153"><a href="#cb7-153"></a>    <span class="fu">filter</span>(</span>
<span id="cb7-154"><a href="#cb7-154"></a>      <span class="sc">!</span>speech_text <span class="sc">%in%</span> speech_date,                                <span class="co"># &lt;8&gt;</span></span>
<span id="cb7-155"><a href="#cb7-155"></a>      <span class="fu">str_detect</span>(speech_text, <span class="st">"^</span><span class="sc">\\</span><span class="st">#+$"</span>, <span class="at">negate =</span> <span class="cn">TRUE</span>)              <span class="co"># &lt;9&gt;</span></span>
<span id="cb7-156"><a href="#cb7-156"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb7-157"><a href="#cb7-157"></a>    <span class="fu">mutate</span>(                                                         <span class="co"># &lt;10&gt;</span></span>
<span id="cb7-158"><a href="#cb7-158"></a>      <span class="at">speaker =</span> <span class="fu">str_extract</span>(speaker, <span class="st">".*(?&lt;=:)"</span>),</span>
<span id="cb7-159"><a href="#cb7-159"></a>      <span class="at">speech_text =</span> <span class="fu">if_else</span>(</span>
<span id="cb7-160"><a href="#cb7-160"></a>        <span class="sc">!</span><span class="fu">is.na</span>(speaker),</span>
<span id="cb7-161"><a href="#cb7-161"></a>        <span class="fu">str_remove</span>(speech_text, speaker),</span>
<span id="cb7-162"><a href="#cb7-162"></a>        speech_text</span>
<span id="cb7-163"><a href="#cb7-163"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb7-164"><a href="#cb7-164"></a>        <span class="fu">str_trim</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-165"><a href="#cb7-165"></a>        <span class="fu">str_squish</span>(),</span>
<span id="cb7-166"><a href="#cb7-166"></a>      <span class="at">speaker =</span> <span class="fu">str_remove</span>(speaker, <span class="st">":$"</span>)</span>
<span id="cb7-167"><a href="#cb7-167"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb7-168"><a href="#cb7-168"></a>    <span class="fu">fill</span>(speaker, <span class="at">.direction =</span> <span class="st">"down"</span>) <span class="sc">|&gt;</span>                           <span class="co"># &lt;11&gt;</span></span>
<span id="cb7-169"><a href="#cb7-169"></a>    <span class="fu">group_by</span>(speech_title, speech_date, speaker) <span class="sc">|&gt;</span></span>
<span id="cb7-170"><a href="#cb7-170"></a>    <span class="fu">summarise</span>(                                                      <span class="co"># &lt;12&gt;</span></span>
<span id="cb7-171"><a href="#cb7-171"></a>      <span class="at">speech_text =</span> <span class="fu">str_flatten</span>(speech_text, <span class="at">collapse =</span> <span class="st">" "</span>),</span>
<span id="cb7-172"><a href="#cb7-172"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb7-173"><a href="#cb7-173"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb7-174"><a href="#cb7-174"></a>    <span class="fu">filter</span>(                                                         <span class="co"># &lt;13&gt;</span></span>
<span id="cb7-175"><a href="#cb7-175"></a>      speaker <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Eric Adams"</span>) <span class="sc">||</span> <span class="fu">str_detect</span>(speaker, <span class="st">"Mayor"</span>)</span>
<span id="cb7-176"><a href="#cb7-176"></a>    )</span>
<span id="cb7-177"><a href="#cb7-177"></a>}</span>
<span id="cb7-178"><a href="#cb7-178"></a></span>
<span id="cb7-179"><a href="#cb7-179"></a><span class="in">```</span></span>
<span id="cb7-180"><a href="#cb7-180"></a></span>
<span id="cb7-181"><a href="#cb7-181"></a><span class="ss">1.  </span>Jump from the root node of the website to the page containing the speech text and scrape the text</span>
<span id="cb7-182"><a href="#cb7-182"></a><span class="ss">2.  </span>Store the date from the text</span>
<span id="cb7-183"><a href="#cb7-183"></a><span class="ss">3.  </span>Store all of the content that is in a paragraph element</span>
<span id="cb7-184"><a href="#cb7-184"></a><span class="ss">4.  </span>Create a dataframe to organize all the data</span>
<span id="cb7-185"><a href="#cb7-185"></a><span class="ss">5.  </span>Create a column for the speech title</span>
<span id="cb7-186"><a href="#cb7-186"></a><span class="ss">6.  </span>Extract the bold text which indicates who the speaker is (some transcripts had multiple speakers)</span>
<span id="cb7-187"><a href="#cb7-187"></a><span class="ss">7.  </span>Create a column to store the speech text</span>
<span id="cb7-188"><a href="#cb7-188"></a><span class="ss">8.  </span>Filter out any rows in which the speech text is the date (the date is stored in a separate column)</span>
<span id="cb7-189"><a href="#cb7-189"></a><span class="ss">9.  </span>Remove rows that only contain hash tags in the speech text</span>
<span id="cb7-190"><a href="#cb7-190"></a><span class="ss">10. </span>Clean up the speech text and speaker data columns</span>
<span id="cb7-191"><a href="#cb7-191"></a><span class="ss">11. </span>Fill the speaker column down to ensure that every paragraph has a speaker associated with it</span>
<span id="cb7-192"><a href="#cb7-192"></a><span class="ss">12. </span>Collapse all of the text together by speaker</span>
<span id="cb7-193"><a href="#cb7-193"></a><span class="ss">13. </span>Keep only text spoken by Mayor Eric Adams</span>
<span id="cb7-194"><a href="#cb7-194"></a></span>
<span id="cb7-195"><a href="#cb7-195"></a>Next is the code to actually scrape the data using the above functions. You might notice that I used <span class="in">`possibly()`</span> from the <span class="in">`purrr`</span> package. I used this for error handling because I wanted to be able to filter each of the data sets for any empty results. Of course, empty results were a lot less likely because the <span class="in">`polite::bow()`</span> object stored all the necessary permissions. I thought the redundancy was more helpful than harmful here given how long this code would have to run. This process resulted in 280 search pages and about 1,100 speeches with a couple of seconds of wait time between requests, so I had a strong incentive to minimize errors and to be able to easily identify operations that either returned errors or empty results.</span>
<span id="cb7-196"><a href="#cb7-196"></a></span>
<span id="cb7-199"><a href="#cb7-199"></a><span class="in">```{r}</span></span>
<span id="cb7-200"><a href="#cb7-200"></a><span class="co">#| label: webscraping-code</span></span>
<span id="cb7-201"><a href="#cb7-201"></a><span class="co">#| code-fold: show</span></span>
<span id="cb7-202"><a href="#cb7-202"></a><span class="co">#| eval: false</span></span>
<span id="cb7-203"><a href="#cb7-203"></a></span>
<span id="cb7-204"><a href="#cb7-204"></a><span class="co"># Store the domain of the NYC.gov website</span></span>
<span id="cb7-205"><a href="#cb7-205"></a>nyc_root <span class="ot">&lt;-</span> <span class="st">"https://www.nyc.gov"</span></span>
<span id="cb7-206"><a href="#cb7-206"></a></span>
<span id="cb7-207"><a href="#cb7-207"></a><span class="co"># Instantiate a session with permissions to the NYC website</span></span>
<span id="cb7-208"><a href="#cb7-208"></a>nyc_sess <span class="ot">&lt;-</span> <span class="fu">bow</span>(nyc_root, <span class="at">user_agent =</span> <span class="st">"arcenis-r"</span>, <span class="at">force =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-209"><a href="#cb7-209"></a></span>
<span id="cb7-210"><a href="#cb7-210"></a><span class="co"># Get the number of pages of news article links</span></span>
<span id="cb7-211"><a href="#cb7-211"></a>num_search_pages <span class="ot">&lt;-</span> <span class="fu">read_html_live</span>(</span>
<span id="cb7-212"><a href="#cb7-212"></a>  <span class="fu">str_c</span>(nyc_root, <span class="st">"/office-of-the-mayor/news.page"</span>)</span>
<span id="cb7-213"><a href="#cb7-213"></a>) <span class="sc">|&gt;</span></span>
<span id="cb7-214"><a href="#cb7-214"></a>  <span class="fu">html_element</span>(<span class="st">".main-search-results"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-215"><a href="#cb7-215"></a>  <span class="fu">html_text2</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-216"><a href="#cb7-216"></a>  <span class="fu">str_extract</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">d+(?= pages)"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-217"><a href="#cb7-217"></a>  <span class="fu">as.numeric</span>()</span>
<span id="cb7-218"><a href="#cb7-218"></a></span>
<span id="cb7-219"><a href="#cb7-219"></a><span class="co"># Get the links to all news articles from each page</span></span>
<span id="cb7-220"><a href="#cb7-220"></a>speech_links <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">search_page_num =</span> <span class="fu">seq</span>(<span class="dv">1</span>, num_search_pages)) <span class="sc">|&gt;</span></span>
<span id="cb7-221"><a href="#cb7-221"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-222"><a href="#cb7-222"></a>    <span class="at">page_links =</span> <span class="fu">map</span>(</span>
<span id="cb7-223"><a href="#cb7-223"></a>      search_page_num,</span>
<span id="cb7-224"><a href="#cb7-224"></a>      <span class="fu">possibly</span>(\(x) <span class="fu">get_article_links</span>(nyc_sess, x), <span class="cn">NULL</span>)</span>
<span id="cb7-225"><a href="#cb7-225"></a>    )</span>
<span id="cb7-226"><a href="#cb7-226"></a>  )</span>
<span id="cb7-227"><a href="#cb7-227"></a></span>
<span id="cb7-228"><a href="#cb7-228"></a><span class="co"># Scrape speeches</span></span>
<span id="cb7-229"><a href="#cb7-229"></a>nyc_mayor_speeches <span class="ot">&lt;-</span> speech_links <span class="sc">|&gt;</span></span>
<span id="cb7-230"><a href="#cb7-230"></a>  <span class="fu">unnest</span>(page_links) <span class="sc">|&gt;</span></span>
<span id="cb7-231"><a href="#cb7-231"></a>  <span class="fu">mutate</span>(<span class="at">speech_number =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span></span>
<span id="cb7-232"><a href="#cb7-232"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-233"><a href="#cb7-233"></a>    <span class="at">speech_data =</span> <span class="fu">map2</span>(</span>
<span id="cb7-234"><a href="#cb7-234"></a>      speech_link, speech_number,</span>
<span id="cb7-235"><a href="#cb7-235"></a>      <span class="fu">possibly</span>(\(x, y) <span class="fu">get_speech_data</span>(nyc_sess, x, y), <span class="cn">NULL</span>)</span>
<span id="cb7-236"><a href="#cb7-236"></a>    )</span>
<span id="cb7-237"><a href="#cb7-237"></a>  )</span>
<span id="cb7-238"><a href="#cb7-238"></a></span>
<span id="cb7-239"><a href="#cb7-239"></a><span class="in">```</span></span>
<span id="cb7-240"><a href="#cb7-240"></a></span>
<span id="cb7-241"><a href="#cb7-241"></a><span class="fu">## Sentiment analysis over time</span></span>
<span id="cb7-242"><a href="#cb7-242"></a></span>
<span id="cb7-243"><a href="#cb7-243"></a>With the data secured, the next step would be to look at changes in the sentiment of his speeches over time. To do that I tokenized the speech data and used both the AFINN-111 valence lexicon <span class="co">[</span><span class="ot">@nielsen11</span><span class="co">]</span> and the NRC word-emotion association lexicon <span class="co">[</span><span class="ot">@mohammad13</span><span class="co">]</span>.</span>
<span id="cb7-244"><a href="#cb7-244"></a></span>
<span id="cb7-247"><a href="#cb7-247"></a><span class="in">```{r}</span></span>
<span id="cb7-248"><a href="#cb7-248"></a><span class="co">#| label: load-data</span></span>
<span id="cb7-249"><a href="#cb7-249"></a><span class="co">#| echo: false</span></span>
<span id="cb7-250"><a href="#cb7-250"></a></span>
<span id="cb7-251"><a href="#cb7-251"></a>nyc_mayor_speeches <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"C:/r-projects/eric-adams-speeches/speech-text-data.rds"</span>)</span>
<span id="cb7-252"><a href="#cb7-252"></a></span>
<span id="cb7-253"><a href="#cb7-253"></a><span class="in">```</span></span>
<span id="cb7-254"><a href="#cb7-254"></a></span>
<span id="cb7-257"><a href="#cb7-257"></a><span class="in">```{r}</span></span>
<span id="cb7-258"><a href="#cb7-258"></a><span class="co">#| label: clean-speech-data</span></span>
<span id="cb7-259"><a href="#cb7-259"></a></span>
<span id="cb7-260"><a href="#cb7-260"></a>speech_df <span class="ot">&lt;-</span> nyc_mayor_speeches <span class="sc">|&gt;</span></span>
<span id="cb7-261"><a href="#cb7-261"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(search_page_num, speech_number)) <span class="sc">|&gt;</span></span>
<span id="cb7-262"><a href="#cb7-262"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-263"><a href="#cb7-263"></a>    <span class="at">speech_text =</span> <span class="fu">str_to_lower</span>(speech_text) <span class="sc">|&gt;</span></span>
<span id="cb7-264"><a href="#cb7-264"></a>      <span class="fu">replace_url</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-265"><a href="#cb7-265"></a>      <span class="fu">replace_html</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-266"><a href="#cb7-266"></a>      <span class="fu">replace_contraction</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-267"><a href="#cb7-267"></a>      <span class="fu">replace_word_elongation</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-268"><a href="#cb7-268"></a>      <span class="fu">replace_ordinal</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-269"><a href="#cb7-269"></a>      <span class="fu">replace_date</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-270"><a href="#cb7-270"></a>      <span class="fu">replace_money</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-271"><a href="#cb7-271"></a>      <span class="fu">replace_number</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-272"><a href="#cb7-272"></a>      <span class="fu">replace_kern</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-273"><a href="#cb7-273"></a>      <span class="fu">replace_curly_quote</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-274"><a href="#cb7-274"></a>      <span class="fu">replace_non_ascii</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-275"><a href="#cb7-275"></a>      <span class="fu">str_squish</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-276"><a href="#cb7-276"></a>      <span class="fu">str_trim</span>(),</span>
<span id="cb7-277"><a href="#cb7-277"></a>    <span class="at">speech_date =</span> <span class="fu">mdy</span>(speech_date)</span>
<span id="cb7-278"><a href="#cb7-278"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-279"><a href="#cb7-279"></a>  <span class="fu">group_by</span>(speech_date) <span class="sc">|&gt;</span></span>
<span id="cb7-280"><a href="#cb7-280"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-281"><a href="#cb7-281"></a>    <span class="at">speech_id =</span> <span class="fu">str_c</span>(</span>
<span id="cb7-282"><a href="#cb7-282"></a>      speech_date <span class="sc">|&gt;</span> <span class="fu">as.character</span>() <span class="sc">|&gt;</span> <span class="fu">str_remove_all</span>(<span class="st">"-"</span>),</span>
<span id="cb7-283"><a href="#cb7-283"></a>      <span class="fu">row_number</span>()</span>
<span id="cb7-284"><a href="#cb7-284"></a>    )</span>
<span id="cb7-285"><a href="#cb7-285"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-286"><a href="#cb7-286"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-287"><a href="#cb7-287"></a></span>
<span id="cb7-288"><a href="#cb7-288"></a>speech_word_tokens <span class="ot">&lt;-</span> speech_df <span class="sc">|&gt;</span></span>
<span id="cb7-289"><a href="#cb7-289"></a>  <span class="fu">unnest_tokens</span>(word, speech_text) <span class="sc">|&gt;</span></span>
<span id="cb7-290"><a href="#cb7-290"></a>  <span class="fu">anti_join</span>(stop_words, <span class="at">by =</span> <span class="st">"word"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-291"><a href="#cb7-291"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(<span class="fu">as.numeric</span>(word)))</span>
<span id="cb7-292"><a href="#cb7-292"></a></span>
<span id="cb7-293"><a href="#cb7-293"></a>speech_tf_idf <span class="ot">&lt;-</span> speech_word_tokens <span class="sc">|&gt;</span></span>
<span id="cb7-294"><a href="#cb7-294"></a>  <span class="fu">count</span>(speech_id, word, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-295"><a href="#cb7-295"></a>  <span class="fu">group_by</span>(speech_id) <span class="sc">|&gt;</span></span>
<span id="cb7-296"><a href="#cb7-296"></a>  <span class="fu">mutate</span>(<span class="at">speech_word_count =</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb7-297"><a href="#cb7-297"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-298"><a href="#cb7-298"></a>  <span class="fu">bind_tf_idf</span>(word, speech_id, n)</span>
<span id="cb7-299"><a href="#cb7-299"></a></span>
<span id="cb7-300"><a href="#cb7-300"></a><span class="in">```</span></span>
<span id="cb7-301"><a href="#cb7-301"></a></span>
<span id="cb7-302"><a href="#cb7-302"></a>This first plot shows sentiment over time based on the AFINN-111 lexicon with a linear modeling smoother. This lexicon applies a value between -5 (most negative) and 5 (most positive) to each word in the lexicon. I calculated sentiment by date by taking the mean sentiment of all of the words used on each day. It appears that the sentiment in Eric Adams' speeches has become more positive over time.</span>
<span id="cb7-303"><a href="#cb7-303"></a></span>
<span id="cb7-304"><a href="#cb7-304"></a>::: callout-note</span>
<span id="cb7-305"><a href="#cb7-305"></a>I calculated average sentiment by day rather than by speech because Eric Adams made multiple speeches on some days.</span>
<span id="cb7-306"><a href="#cb7-306"></a>:::</span>
<span id="cb7-307"><a href="#cb7-307"></a></span>
<span id="cb7-310"><a href="#cb7-310"></a><span class="in">```{r}</span></span>
<span id="cb7-311"><a href="#cb7-311"></a><span class="co">#| label: plot-sentiment-afinn</span></span>
<span id="cb7-312"><a href="#cb7-312"></a></span>
<span id="cb7-313"><a href="#cb7-313"></a>speech_word_tokens <span class="sc">|&gt;</span></span>
<span id="cb7-314"><a href="#cb7-314"></a>  <span class="fu">inner_join</span>(<span class="fu">get_sentiments</span>(<span class="st">"afinn"</span>), <span class="at">by =</span> <span class="st">"word"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-315"><a href="#cb7-315"></a>  <span class="fu">group_by</span>(speech_date) <span class="sc">|&gt;</span></span>
<span id="cb7-316"><a href="#cb7-316"></a>  <span class="fu">summarise</span>(<span class="at">mean_valence =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-317"><a href="#cb7-317"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(speech_date, mean_valence)) <span class="sc">+</span></span>
<span id="cb7-318"><a href="#cb7-318"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb7-319"><a href="#cb7-319"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> y <span class="sc">~</span> x) <span class="sc">+</span></span>
<span id="cb7-320"><a href="#cb7-320"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-321"><a href="#cb7-321"></a>    <span class="at">title =</span> <span class="st">"Sentiment in Eric Adams' Speeches Over Time"</span>,</span>
<span id="cb7-322"><a href="#cb7-322"></a>    <span class="at">subtitle =</span> <span class="st">"Sentiment based on the AFINN lexicon"</span>,</span>
<span id="cb7-323"><a href="#cb7-323"></a>    <span class="at">y =</span> <span class="st">"Average Speech Sentiment"</span>,</span>
<span id="cb7-324"><a href="#cb7-324"></a>    <span class="at">x =</span> <span class="cn">NULL</span></span>
<span id="cb7-325"><a href="#cb7-325"></a>  ) <span class="sc">+</span></span>
<span id="cb7-326"><a href="#cb7-326"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb7-327"><a href="#cb7-327"></a>  <span class="fu">theme</span>(</span>
<span id="cb7-328"><a href="#cb7-328"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb7-329"><a href="#cb7-329"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb7-330"><a href="#cb7-330"></a>  )</span>
<span id="cb7-331"><a href="#cb7-331"></a></span>
<span id="cb7-332"><a href="#cb7-332"></a><span class="in">```</span></span>
<span id="cb7-333"><a href="#cb7-333"></a></span>
<span id="cb7-334"><a href="#cb7-334"></a>The below plot shows sentiment over time based on the NRC lexicon. This lexicon assigns each word a label indicating a given emotion such as anger, joy, or disgust. It also assigns "positive" and "negative" labels, which I filtered out. For this plot I calculated the percentage of words that were related to each emotion out of all non-stop words in the speech and applied a gamma smoother. This plot shows that there were spikes in disgust, fear, and sadness in the first half of 2023. The reduction of these negative emotions in Eric Adams' speeches could account for the apparent positive trend in the last plot; the emotional content got less negative.</span>
<span id="cb7-335"><a href="#cb7-335"></a></span>
<span id="cb7-336"><a href="#cb7-336"></a>::: callout-note</span>
<span id="cb7-337"><a href="#cb7-337"></a>**Stop words** are words that are inconsequential to determining the meaning of a set of words or distinguish that set of words from other words. They also tend to be very common.</span>
<span id="cb7-338"><a href="#cb7-338"></a>:::</span>
<span id="cb7-339"><a href="#cb7-339"></a></span>
<span id="cb7-342"><a href="#cb7-342"></a><span class="in">```{r}</span></span>
<span id="cb7-343"><a href="#cb7-343"></a><span class="co">#| label: plot-sentiment-nrc</span></span>
<span id="cb7-344"><a href="#cb7-344"></a></span>
<span id="cb7-345"><a href="#cb7-345"></a>speech_word_tokens <span class="sc">|&gt;</span></span>
<span id="cb7-346"><a href="#cb7-346"></a>  <span class="fu">group_by</span>(speech_date) <span class="sc">|&gt;</span></span>
<span id="cb7-347"><a href="#cb7-347"></a>  <span class="fu">count</span>(word) <span class="sc">|&gt;</span></span>
<span id="cb7-348"><a href="#cb7-348"></a>  <span class="fu">mutate</span>(<span class="at">total_words =</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb7-349"><a href="#cb7-349"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb7-350"><a href="#cb7-350"></a>    <span class="fu">get_sentiments</span>(<span class="st">"nrc"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-351"><a href="#cb7-351"></a>      <span class="fu">filter</span>(<span class="sc">!</span>sentiment <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"positive"</span>, <span class="st">"negative"</span>)),</span>
<span id="cb7-352"><a href="#cb7-352"></a>    <span class="at">by =</span> <span class="st">"word"</span>, <span class="at">relationship =</span> <span class="st">"many-to-many"</span></span>
<span id="cb7-353"><a href="#cb7-353"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-354"><a href="#cb7-354"></a>  <span class="fu">group_by</span>(speech_date, sentiment) <span class="sc">|&gt;</span></span>
<span id="cb7-355"><a href="#cb7-355"></a>  <span class="fu">reframe</span>(<span class="at">sentiment_pct =</span> <span class="fu">sum</span>(n) <span class="sc">/</span> total_words) <span class="sc">|&gt;</span></span>
<span id="cb7-356"><a href="#cb7-356"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> speech_date, <span class="at">y =</span> sentiment_pct)) <span class="sc">+</span></span>
<span id="cb7-357"><a href="#cb7-357"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb7-358"><a href="#cb7-358"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>, <span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">bs =</span> <span class="st">"cs"</span>)) <span class="sc">+</span></span>
<span id="cb7-359"><a href="#cb7-359"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-360"><a href="#cb7-360"></a>    <span class="at">title =</span> <span class="st">"Sentiment in Eric Adams' Speeches Over Time"</span>,</span>
<span id="cb7-361"><a href="#cb7-361"></a>    <span class="at">subtitle =</span> <span class="st">"Sentiment based on the NRC lexicon"</span>,</span>
<span id="cb7-362"><a href="#cb7-362"></a>    <span class="at">y =</span> <span class="st">"Percentage Speech Sentiment"</span>,</span>
<span id="cb7-363"><a href="#cb7-363"></a>    <span class="at">x =</span> <span class="cn">NULL</span></span>
<span id="cb7-364"><a href="#cb7-364"></a>  ) <span class="sc">+</span></span>
<span id="cb7-365"><a href="#cb7-365"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>sentiment, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb7-366"><a href="#cb7-366"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb7-367"><a href="#cb7-367"></a>  <span class="fu">theme</span>(</span>
<span id="cb7-368"><a href="#cb7-368"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb7-369"><a href="#cb7-369"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb7-370"><a href="#cb7-370"></a>  )</span>
<span id="cb7-371"><a href="#cb7-371"></a></span>
<span id="cb7-372"><a href="#cb7-372"></a><span class="in">```</span></span>
<span id="cb7-373"><a href="#cb7-373"></a></span>
<span id="cb7-374"><a href="#cb7-374"></a><span class="fu">## Word cloud animation</span></span>
<span id="cb7-375"><a href="#cb7-375"></a></span>
<span id="cb7-376"><a href="#cb7-376"></a>Below is a short animation of word clouds for each month in the data. Each word cloud includes 50 words with the highest TF-IDF (term frequency, inverse document frequency) values by month.</span>
<span id="cb7-377"><a href="#cb7-377"></a></span>
<span id="cb7-380"><a href="#cb7-380"></a><span class="in">```{r}</span></span>
<span id="cb7-381"><a href="#cb7-381"></a><span class="co">#| label: word-cloud-animation</span></span>
<span id="cb7-382"><a href="#cb7-382"></a><span class="co">#| cache: true</span></span>
<span id="cb7-383"><a href="#cb7-383"></a></span>
<span id="cb7-384"><a href="#cb7-384"></a><span class="fu">set.seed</span>(<span class="dv">98457</span>)</span>
<span id="cb7-385"><a href="#cb7-385"></a>wrdcld_data <span class="ot">&lt;-</span> speech_tf_idf <span class="sc">|&gt;</span></span>
<span id="cb7-386"><a href="#cb7-386"></a>  <span class="fu">left_join</span>(<span class="fu">select</span>(speech_df, speech_id, speech_date), <span class="at">by =</span> <span class="st">"speech_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-387"><a href="#cb7-387"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-388"><a href="#cb7-388"></a>    <span class="at">speech_yrmo =</span> <span class="fu">floor_date</span>(speech_date, <span class="st">"month"</span>)</span>
<span id="cb7-389"><a href="#cb7-389"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-390"><a href="#cb7-390"></a>  <span class="fu">group_by</span>(speech_yrmo) <span class="sc">|&gt;</span></span>
<span id="cb7-391"><a href="#cb7-391"></a>  <span class="fu">slice_max</span>(tf_idf, <span class="at">n =</span> <span class="dv">50</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-392"><a href="#cb7-392"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-393"><a href="#cb7-393"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-394"><a href="#cb7-394"></a>    <span class="at">yrmo_label =</span> <span class="fu">format</span>(speech_date, <span class="at">format =</span> <span class="st">"%B, %Y"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-395"><a href="#cb7-395"></a>      <span class="fu">fct_reorder</span>(speech_yrmo),</span>
<span id="cb7-396"><a href="#cb7-396"></a>    <span class="at">word_size =</span> <span class="fu">abs</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="fu">log</span>(tf_idf)),</span>
<span id="cb7-397"><a href="#cb7-397"></a>    <span class="at">word_color =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">factor</span>(),</span>
<span id="cb7-398"><a href="#cb7-398"></a>    <span class="at">word_angle =</span> <span class="dv">45</span> <span class="sc">*</span> <span class="fu">sample</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">2</span>, <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb7-399"><a href="#cb7-399"></a>  )</span>
<span id="cb7-400"><a href="#cb7-400"></a></span>
<span id="cb7-401"><a href="#cb7-401"></a>num_frames <span class="ot">&lt;-</span> wrdcld_data <span class="sc">|&gt;</span></span>
<span id="cb7-402"><a href="#cb7-402"></a>  <span class="fu">distinct</span>(speech_yrmo) <span class="sc">|&gt;</span></span>
<span id="cb7-403"><a href="#cb7-403"></a>  <span class="fu">count</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-404"><a href="#cb7-404"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb7-405"><a href="#cb7-405"></a></span>
<span id="cb7-406"><a href="#cb7-406"></a>adams_cloud <span class="ot">&lt;-</span> wrdcld_data <span class="sc">|&gt;</span></span>
<span id="cb7-407"><a href="#cb7-407"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb7-408"><a href="#cb7-408"></a>    <span class="fu">aes</span>(<span class="at">label =</span> word, <span class="at">size =</span> tf_idf, <span class="at">color =</span> word_color, <span class="at">angle =</span> word_angle)</span>
<span id="cb7-409"><a href="#cb7-409"></a>  ) <span class="sc">+</span></span>
<span id="cb7-410"><a href="#cb7-410"></a>  <span class="fu">geom_text_wordcloud_area</span>() <span class="sc">+</span></span>
<span id="cb7-411"><a href="#cb7-411"></a>  <span class="fu">scale_size_area</span>(<span class="at">max_size =</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb7-412"><a href="#cb7-412"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"{closest_state}"</span>) <span class="sc">+</span></span>
<span id="cb7-413"><a href="#cb7-413"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-414"><a href="#cb7-414"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb7-415"><a href="#cb7-415"></a>  <span class="fu">transition_states</span>(speech_yrmo) <span class="sc">+</span></span>
<span id="cb7-416"><a href="#cb7-416"></a>  <span class="fu">enter_fade</span>() <span class="sc">+</span></span>
<span id="cb7-417"><a href="#cb7-417"></a>  <span class="fu">exit_fade</span>() <span class="sc">+</span></span>
<span id="cb7-418"><a href="#cb7-418"></a>  <span class="fu">ease_aes</span>(<span class="st">"sine-in-out"</span>)</span>
<span id="cb7-419"><a href="#cb7-419"></a></span>
<span id="cb7-420"><a href="#cb7-420"></a><span class="fu">animate</span>(adams_cloud, <span class="at">fps =</span> <span class="fl">0.5</span>, <span class="at">nframes =</span> num_frames)</span>
<span id="cb7-421"><a href="#cb7-421"></a></span>
<span id="cb7-422"><a href="#cb7-422"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>