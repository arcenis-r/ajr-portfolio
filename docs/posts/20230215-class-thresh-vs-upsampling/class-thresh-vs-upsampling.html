<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Arcenis Rojas">
<meta name="dcterms.date" content="2023-02-15">

<title>Arcenis Rojas - Optimal Threshold vs.&nbsp;Upsampling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Arcenis Rojas</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../ce-dashboards.html"> 
<span class="menu-text">CE Dashboards</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Personal Projects</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/arcenisrojas" target="_blank"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/arcenis-r" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#lending-club-data" id="toc-lending-club-data" class="nav-link" data-scroll-target="#lending-club-data">Lending Club Data</a></li>
  <li><a href="#data-exploration" id="toc-data-exploration" class="nav-link" data-scroll-target="#data-exploration">Data Exploration</a></li>
  <li><a href="#create-data-splits-and-other-common-elements" id="toc-create-data-splits-and-other-common-elements" class="nav-link" data-scroll-target="#create-data-splits-and-other-common-elements">Create Data Splits and Other Common Elements</a></li>
  <li><a href="#train-base-model" id="toc-train-base-model" class="nav-link" data-scroll-target="#train-base-model">Train Base Model</a></li>
  <li><a href="#train-upsampled-model" id="toc-train-upsampled-model" class="nav-link" data-scroll-target="#train-upsampled-model">Train Upsampled Model</a></li>
  <li><a href="#compare-model-classification-metrics" id="toc-compare-model-classification-metrics" class="nav-link" data-scroll-target="#compare-model-classification-metrics">Compare Model Classification Metrics</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Optimal Threshold vs.&nbsp;Upsampling</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Dealing with Unbalanced Data</p>
  <div class="quarto-categories">
    <div class="quarto-category">machine learning</div>
    <div class="quarto-category">data science</div>
    <div class="quarto-category">classification</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Arcenis Rojas </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 15, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In any binary classification analysis it is common to have to deal with heavily unbalanced data, i.e., the frequency of the majority class in the dependent variable is overwhelmingly greater than that of the minority class. One of the main reasons this can be problematic is that many classification algorithms are biased toward the majority class. If 95% of the observations belong to the majority class in the training data and the algorithm always predicts the majority class, then it will have achieved 95% accuracy.</p>
<p>There are many ways of dealing with unbalanced data including changing from a classification algorithm to an anomaly detection algorithm like an isoforest or a one-class SVM, using SMOTE to re-balance the data sets in pre-processing, up- or down-sampling, and changing the classification threshold. Here I will only deal with up-sampling and changing the classification threshold to see how it affects classification metrics by way of going through an exercise. I’ll first create and tune a base model then do the same for an up-sampled model using Tidymodels <span class="citation" data-cites="tidymodels">(<a href="#ref-tidymodels" role="doc-biblioref">Kuhn and Wickham 2020</a>)</span>. Hyperparameter tuning will be done with the <code>finetune</code> package <span class="citation" data-cites="finetune">(<a href="#ref-finetune" role="doc-biblioref">Kuhn 2023a</a>)</span>. I’ll then find the optimal threshold for each using the <code>probably</code> package <span class="citation" data-cites="probably">(<a href="#ref-probably" role="doc-biblioref">Kuhn, Vaughan, and Ruiz 2023</a>)</span>. Finally I’ll show a comparison of their respective classification metrics.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(colino)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(themis)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">library</span>(finetune)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">library</span>(probably)</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">library</span>(skimr)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a>conflicted<span class="sc">::</span><span class="fu">conflict_prefer</span>(<span class="st">"filter"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb1-12"><a href="#cb1-12"></a>conflicted<span class="sc">::</span><span class="fu">conflict_prefer</span>(<span class="st">"select"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="fu">tidymodels_prefer</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="lending-club-data" class="level2">
<h2 class="anchored" data-anchor-id="lending-club-data">Lending Club Data</h2>
<p>For this project I’ll be using the <code>lending_club</code> data set from the <code>modeldata</code> <span class="citation" data-cites="modeldata">(<a href="#ref-modeldata" role="doc-biblioref">Kuhn 2023b</a>)</span> package. The data contain the <code>Class</code> variable which indicates whether a loan was “good” or bad”. For the purposes of this analysis I also will consider the “bad” outcome as the event to predict.</p>
</section>
<section id="data-exploration" class="level2">
<h2 class="anchored" data-anchor-id="data-exploration">Data Exploration</h2>
<p>The first step is to load the data using the <code>readr</code> package from the Tidyverse <span class="citation" data-cites="tidyverse">(<a href="#ref-tidyverse" role="doc-biblioref">Wickham et al. 2019</a>)</span> and summarize it using the <code>skimr</code> package <span class="citation" data-cites="skimr">(<a href="#ref-skimr" role="doc-biblioref">Waring et al. 2022</a>)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">data</span>(<span class="st">"lending_club"</span>, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="fu">skim</span>(lending_club) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>complete_rate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">lending_club</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">9857</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">23</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">17</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 22%">
<col style="width: 11%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">term</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">ter: 7047, ter: 2810</td>
</tr>
<tr class="even">
<td style="text-align: left;">sub_grade</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">35</td>
<td style="text-align: left;">C1: 672, B5: 624, A1: 612, B3: 607</td>
</tr>
<tr class="odd">
<td style="text-align: left;">addr_state</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">50</td>
<td style="text-align: left;">CA: 1324, TX: 900, NY: 767, FL: 731</td>
</tr>
<tr class="even">
<td style="text-align: left;">verification_status</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">Sou: 3742, Not: 3434, Ver: 2681</td>
</tr>
<tr class="odd">
<td style="text-align: left;">emp_length</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">emp: 3452, emp: 893, emp: 769, emp: 733</td>
</tr>
<tr class="even">
<td style="text-align: left;">Class</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">goo: 9340, bad: 517</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 25%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">funded_amnt</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">15683.56</td>
<td style="text-align: right;">8879.11</td>
<td style="text-align: right;">1000.00</td>
<td style="text-align: right;">8500.00</td>
<td style="text-align: right;">15000.00</td>
<td style="text-align: right;">21000.00</td>
<td style="text-align: right;">40000.00</td>
<td style="text-align: left;">▆▇▅▃▂</td>
</tr>
<tr class="even">
<td style="text-align: left;">int_rate</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">12.53</td>
<td style="text-align: right;">4.89</td>
<td style="text-align: right;">5.32</td>
<td style="text-align: right;">8.49</td>
<td style="text-align: right;">11.99</td>
<td style="text-align: right;">15.31</td>
<td style="text-align: right;">28.99</td>
<td style="text-align: left;">▇▇▃▂▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">annual_inc</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">80320.36</td>
<td style="text-align: right;">53450.17</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">50000.00</td>
<td style="text-align: right;">68900.00</td>
<td style="text-align: right;">96000.00</td>
<td style="text-align: right;">960000.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">delinq_2yrs</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: right;">0.89</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">22.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">inq_last_6mths</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.58</td>
<td style="text-align: right;">0.88</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">revol_util</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">51.73</td>
<td style="text-align: right;">24.38</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">33.20</td>
<td style="text-align: right;">51.80</td>
<td style="text-align: right;">70.40</td>
<td style="text-align: right;">144.30</td>
<td style="text-align: left;">▅▇▇▂▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">acc_now_delinq</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">open_il_6m</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2.75</td>
<td style="text-align: right;">2.93</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">32.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">open_il_12m</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.74</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">20.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">open_il_24m</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.62</td>
<td style="text-align: right;">1.70</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">30.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">total_bal_il</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">35286.92</td>
<td style="text-align: right;">41923.62</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">9450.00</td>
<td style="text-align: right;">23650.00</td>
<td style="text-align: right;">46297.00</td>
<td style="text-align: right;">585583.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">all_util</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">60.31</td>
<td style="text-align: right;">20.28</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">47.00</td>
<td style="text-align: right;">62.00</td>
<td style="text-align: right;">75.00</td>
<td style="text-align: right;">198.00</td>
<td style="text-align: left;">▂▇▂▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">inq_fi</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.93</td>
<td style="text-align: right;">1.47</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">15.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">inq_last_12m</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2.19</td>
<td style="text-align: right;">2.44</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">32.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">delinq_amnt</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">12.17</td>
<td style="text-align: right;">565.47</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">42428.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">num_il_tl</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">8.64</td>
<td style="text-align: right;">7.52</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: right;">11.00</td>
<td style="text-align: right;">82.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">total_il_high_credit_limit</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">45400.75</td>
<td style="text-align: right;">45103.21</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">16300.00</td>
<td style="text-align: right;">34375.00</td>
<td style="text-align: right;">60786.00</td>
<td style="text-align: right;">554119.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The above data summary shows some important things. First, there are 9,857 observations and 23 variables with no missing values. Also, the data has 6 factor variables and 17 numeric variables. It shows that most of the numeric variables are left skewed. The “sub_grade” and “addr_state” factor variables have 35 and 50 levels respectively. With so many unique values it’s very likely that some of the classes in each of those variables become overwhelmed by majority classes. While there are feature engineering steps that I can take such as consolidating infrequent classes or splitting up <code>sub_grade</code> into constituent parts, I’ll just allow the feature selection step to handle it. Finally, the “Class” factor variable (dependent variable) has two levels with the majority class – “good” – having 9,340 observations and the minority class – “bad” – having 517 observations.</p>
<p>Here I’ll just look at the proportions of the <code>Class</code> variable.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>lending_club <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> Class)) <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">x =</span> (..count..) <span class="sc">/</span> <span class="fu">sum</span>(..count..))) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>  <span class="fu">labs</span>(</span>
<span id="cb3-6"><a href="#cb3-6"></a>    <span class="at">x =</span> <span class="st">"Proportion"</span>,</span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="at">title =</span> <span class="st">"Frequency of loan outcome categories (Class)"</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>  ) <span class="sc">+</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="class-thresh-vs-upsampling_files/figure-html/outcome-frequencies-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here we see a sever class unbalance with only about 5% of loans having a “bad” outcome.</p>
</section>
<section id="create-data-splits-and-other-common-elements" class="level2">
<h2 class="anchored" data-anchor-id="create-data-splits-and-other-common-elements">Create Data Splits and Other Common Elements</h2>
<p>For the analysis I’ll split the data into training (75%) and test (25%) sets stratified by the <code>Class</code> variable. I’ll then create 100 bootstraps of the training data for model tuning, also stratified by the <code>Class</code> variable. Stratification will ensure that both cuts of the data and the bootstraps retain the class unbalance as close to the proportions of the original data.</p>
<p>Here I also create a list of features to control the model tuning process.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Create training/test split</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">set.seed</span>(<span class="dv">95</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a>tt_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(lending_club, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Class)</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co"># Create the bootstrap object</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="fu">set.seed</span>(<span class="dv">386</span>)</span>
<span id="cb4-7"><a href="#cb4-7"></a>bstraps <span class="ot">&lt;-</span> <span class="fu">bootstraps</span>(<span class="fu">training</span>(tt_split), <span class="at">times =</span> <span class="dv">100</span>, <span class="at">strata =</span> Class)</span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co"># Create the model object for the workflows</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>lr_mod <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>(<span class="at">mode =</span> <span class="st">"classification"</span>, <span class="at">engine =</span> <span class="st">"glm"</span>)</span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co"># Create a list of control options</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>race_control <span class="ot">&lt;-</span> <span class="fu">control_race</span>(</span>
<span id="cb4-14"><a href="#cb4-14"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-15"><a href="#cb4-15"></a>  <span class="at">allow_par =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-16"><a href="#cb4-16"></a>  <span class="at">burn_in =</span> <span class="dv">3</span>,</span>
<span id="cb4-17"><a href="#cb4-17"></a>  <span class="at">save_workflow =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-18"><a href="#cb4-18"></a>  <span class="at">save_pred =</span> <span class="cn">TRUE</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="train-base-model" class="level2">
<h2 class="anchored" data-anchor-id="train-base-model">Train Base Model</h2>
<p>The base recipe will perform the following steps:</p>
<ol type="1">
<li><p>Remove variables with near-zero variance</p></li>
<li><p>Scale and center all numeric variables</p></li>
<li><p>Convert categorical variables to dummy variables</p></li>
<li><p>Select variables based on mRMR using the <code>colino</code> package <span class="citation" data-cites="colino">(<a href="#ref-colino" role="doc-biblioref">Pawley, Kuhn, and Jacques-Hamilton 2023</a>)</span>; the percentile threshold used to decide which variables to keep will be chosen through model tuning</p></li>
</ol>
<p>The base recipe will be combined with a logistic regression model specification to put into a workflow. This workflow then goes through a Bayesian hyperparameter tuning process to find the best mRMR threshold as mentioned above. “Best” is defined as the full model specification that yields the highest area under the receiver operator curve (ROC-AUC) because I’ll be choosing the optimal probability threshold on the basis of this curve, even though it would be preferable to choose on the basis of the area under the precision-recall curve (PR-AUC) with unbalanced data. <span class="citation" data-cites="imbal_auprc">(<a href="#ref-imbal_auprc" role="doc-biblioref">Rosenberg 2022</a>)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Create a base recipe</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>base_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Class <span class="sc">~</span> ., <span class="at">data =</span> <span class="fu">training</span>(tt_split)) <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="fu">step_nzv</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">one_hot =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="fu">step_select_mrmr</span>(</span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="fu">all_predictors</span>(),</span>
<span id="cb5-8"><a href="#cb5-8"></a>    <span class="at">threshold =</span> <span class="fu">tune</span>(),</span>
<span id="cb5-9"><a href="#cb5-9"></a>    <span class="at">outcome =</span> <span class="st">"Class"</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>  )</span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="co"># First tune the base model to get the best set of variables with MRMR</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>base_wflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> <span class="fu">add_recipe</span>(base_rec) <span class="sc">|&gt;</span> <span class="fu">add_model</span>(lr_mod)</span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="fu">set.seed</span>(<span class="dv">40</span>)</span>
<span id="cb5-16"><a href="#cb5-16"></a>base_tuned <span class="ot">&lt;-</span> <span class="fu">tune_race_win_loss</span>(</span>
<span id="cb5-17"><a href="#cb5-17"></a>  base_wflow,</span>
<span id="cb5-18"><a href="#cb5-18"></a>  <span class="at">resamples =</span> bstraps,</span>
<span id="cb5-19"><a href="#cb5-19"></a>  <span class="at">control =</span> race_control,</span>
<span id="cb5-20"><a href="#cb5-20"></a>  <span class="at">grid =</span> <span class="dv">10</span>,</span>
<span id="cb5-21"><a href="#cb5-21"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(pr_auc, roc_auc, accuracy)</span>
<span id="cb5-22"><a href="#cb5-22"></a>)</span>
<span id="cb5-23"><a href="#cb5-23"></a></span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="co"># Get the workflow with the best MRMR threshold</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>best_base <span class="ot">&lt;-</span> <span class="fu">select_best</span>(base_tuned, <span class="st">"roc_auc"</span>)</span>
<span id="cb5-26"><a href="#cb5-26"></a></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="co"># Get the MRMR threshold from the best base model</span></span>
<span id="cb5-28"><a href="#cb5-28"></a>mrmr_threshold <span class="ot">&lt;-</span> best_base <span class="sc">|&gt;</span> <span class="fu">pull</span>(threshold)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The mRMR threshold associated with the best model is 0.9478018 .</p>
</section>
<section id="train-upsampled-model" class="level2">
<h2 class="anchored" data-anchor-id="train-upsampled-model">Train Upsampled Model</h2>
<p>The upsampled model will only add the pre-processing step of upsampling the minority class to the same proportion as the majority class (or close to it) by resampling observations with a <code>Class</code> value from the minority class using the <code>themis</code> package <span class="citation" data-cites="themis">(<a href="#ref-themis" role="doc-biblioref">Hvitfeldt 2023</a>)</span>. To ensure that this is the only difference, I’ll take the mRMR threshold that was tuned for the base model directly from the best base model and specify it as the threshold for the upsampling model.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Build a recipe for upsampling by first updating the MRMR step from the base recipe with the threshold from the tuning process then adding upsampling</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>upsample_rec <span class="ot">&lt;-</span> base_rec</span>
<span id="cb6-3"><a href="#cb6-3"></a>select_mrmr_step <span class="ot">&lt;-</span> <span class="fu">tidy</span>(upsample_rec) <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">filter</span>(type <span class="sc">%in%</span> <span class="st">"select_mrmr"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="fu">pull</span>(number)</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a>upsample_rec<span class="sc">$</span>steps[[select_mrmr_step]] <span class="ot">&lt;-</span> <span class="fu">update</span>(</span>
<span id="cb6-8"><a href="#cb6-8"></a>  upsample_rec<span class="sc">$</span>steps[[select_mrmr_step]],</span>
<span id="cb6-9"><a href="#cb6-9"></a>  <span class="at">threshold =</span> mrmr_threshold</span>
<span id="cb6-10"><a href="#cb6-10"></a>)</span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a>upsample_rec <span class="ot">&lt;-</span> upsample_rec <span class="sc">|&gt;</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>  <span class="fu">step_upsample</span>(Class, <span class="at">over_ratio =</span> <span class="fu">tune</span>())</span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co"># Create the upsample workflow object</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>upsample_wflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> <span class="fu">add_recipe</span>(upsample_rec) <span class="sc">|&gt;</span> <span class="fu">add_model</span>(lr_mod)</span>
<span id="cb6-17"><a href="#cb6-17"></a></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="co"># Tune the workflow containing the upsample recipe</span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="fu">set.seed</span>(<span class="dv">40</span>)</span>
<span id="cb6-20"><a href="#cb6-20"></a>upsample_tuned <span class="ot">&lt;-</span> <span class="fu">tune_race_win_loss</span>(</span>
<span id="cb6-21"><a href="#cb6-21"></a>  upsample_wflow,</span>
<span id="cb6-22"><a href="#cb6-22"></a>  <span class="at">resamples =</span> bstraps,</span>
<span id="cb6-23"><a href="#cb6-23"></a>  <span class="at">control =</span> race_control,</span>
<span id="cb6-24"><a href="#cb6-24"></a>  <span class="at">grid =</span> <span class="dv">10</span>,</span>
<span id="cb6-25"><a href="#cb6-25"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(pr_auc, roc_auc, accuracy)</span>
<span id="cb6-26"><a href="#cb6-26"></a>)</span>
<span id="cb6-27"><a href="#cb6-27"></a></span>
<span id="cb6-28"><a href="#cb6-28"></a><span class="co"># Get the workflow with the best MRMR threshold</span></span>
<span id="cb6-29"><a href="#cb6-29"></a>best_upsample <span class="ot">&lt;-</span> <span class="fu">select_best</span>(upsample_tuned, <span class="st">"roc_auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The best over-sampling ratio is 1.1065577 .</p>
</section>
<section id="compare-model-classification-metrics" class="level2">
<h2 class="anchored" data-anchor-id="compare-model-classification-metrics">Compare Model Classification Metrics</h2>
<p>Now that I’ve run both models and gotten the best hyperparameters for each, I’ll finalize both models and ensure that I have the same sets of variables in the models.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># Get evaluation datasets for both workflows</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">set.seed</span>(<span class="dv">75</span>)</span>
<span id="cb7-3"><a href="#cb7-3"></a>eval_base <span class="ot">&lt;-</span> base_wflow <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="fu">finalize_workflow</span>(best_base) <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="fu">last_fit</span>(tt_split)</span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co"># Build the evaluation tibble for the upsample case</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="fu">set.seed</span>(<span class="dv">212</span>)</span>
<span id="cb7-9"><a href="#cb7-9"></a>eval_upsample <span class="ot">&lt;-</span> upsample_wflow <span class="sc">|&gt;</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>  <span class="fu">finalize_workflow</span>(<span class="fu">select_best</span>(upsample_tuned, <span class="st">"roc_auc"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>  <span class="fu">last_fit</span>(tt_split)</span>
<span id="cb7-12"><a href="#cb7-12"></a></span>
<span id="cb7-13"><a href="#cb7-13"></a>eval_base <span class="sc">|&gt;</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="fu">extract_fit_engine</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>  <span class="fu">tidy</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>  <span class="fu">select</span>(<span class="at">base =</span> term) <span class="sc">|&gt;</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb7-18"><a href="#cb7-18"></a>    eval_upsample <span class="sc">|&gt;</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>      <span class="fu">extract_fit_engine</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>      <span class="fu">tidy</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-21"><a href="#cb7-21"></a>      <span class="fu">select</span>(<span class="at">upsample =</span> term)</span>
<span id="cb7-22"><a href="#cb7-22"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-23"><a href="#cb7-23"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-24"><a href="#cb7-24"></a>  <span class="fu">kable_styling</span>(<span class="st">"striped"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">base</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">upsample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: left;">(Intercept)</td>
</tr>
<tr class="even">
<td style="text-align: left;">int_rate</td>
<td style="text-align: left;">int_rate</td>
</tr>
<tr class="odd">
<td style="text-align: left;">inq_last_6mths</td>
<td style="text-align: left;">inq_last_6mths</td>
</tr>
<tr class="even">
<td style="text-align: left;">open_il_12m</td>
<td style="text-align: left;">open_il_12m</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sub_grade_G4</td>
<td style="text-align: left;">sub_grade_G4</td>
</tr>
<tr class="even">
<td style="text-align: left;">addr_state_SD</td>
<td style="text-align: left;">addr_state_SD</td>
</tr>
<tr class="odd">
<td style="text-align: left;">verification_status_Verified</td>
<td style="text-align: left;">verification_status_Verified</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The above table shows that both models ended up with the same sets of variables. Next we’ll find the optimal threshold cut-offs for each set of predictions on the test data using Youden’s J-Index.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>base_preds <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="at">truth =</span> <span class="fu">collect_predictions</span>(eval_base) <span class="sc">|&gt;</span> <span class="fu">pull</span>(Class),</span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="at">estimate =</span> <span class="fu">collect_predictions</span>(eval_base) <span class="sc">|&gt;</span> <span class="fu">pull</span>(.pred_bad),</span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="at">pred_class =</span> <span class="fu">collect_predictions</span>(eval_base) <span class="sc">|&gt;</span> <span class="fu">pull</span>(.pred_class)</span>
<span id="cb8-5"><a href="#cb8-5"></a>)</span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co"># Find the optimal classification threshold for the base model</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>opt_thresh_base <span class="ot">&lt;-</span> base_preds <span class="sc">|&gt;</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>  <span class="fu">threshold_perf</span>(truth, estimate, <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">1000</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>  <span class="fu">filter</span>(.metric <span class="sc">%in%</span> <span class="st">"j_index"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>  <span class="fu">slice_max</span>(.estimate, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>  <span class="fu">pull</span>(.threshold)</span>
<span id="cb8-13"><a href="#cb8-13"></a></span>
<span id="cb8-14"><a href="#cb8-14"></a>upsample_preds <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="at">truth =</span> <span class="fu">collect_predictions</span>(eval_upsample) <span class="sc">|&gt;</span> <span class="fu">pull</span>(Class),</span>
<span id="cb8-16"><a href="#cb8-16"></a>  <span class="at">estimate =</span> <span class="fu">collect_predictions</span>(eval_upsample) <span class="sc">|&gt;</span> <span class="fu">pull</span>(.pred_bad),</span>
<span id="cb8-17"><a href="#cb8-17"></a>  <span class="at">pred_class =</span> <span class="fu">collect_predictions</span>(eval_upsample) <span class="sc">|&gt;</span> <span class="fu">pull</span>(.pred_class)</span>
<span id="cb8-18"><a href="#cb8-18"></a>)</span>
<span id="cb8-19"><a href="#cb8-19"></a></span>
<span id="cb8-20"><a href="#cb8-20"></a><span class="co"># Find the optimal classification threshold for the upsample model</span></span>
<span id="cb8-21"><a href="#cb8-21"></a>opt_thresh_upsample <span class="ot">&lt;-</span> upsample_preds <span class="sc">|&gt;</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>  <span class="fu">threshold_perf</span>(truth, estimate, <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">1000</span>))<span class="sc">|&gt;</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>  <span class="fu">filter</span>(.metric <span class="sc">%in%</span> <span class="st">"j_index"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>  <span class="fu">slice_max</span>(.estimate, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>  <span class="fu">pull</span>(.threshold)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The optimal probability threshold for classifying a loan as bad with the base model is 0.0550551 and that for the upsampling model is 0.5525526</p>
<p>Each table of predictions currently has 3 columns showing the actual class for a given observation (truth), the prediction probability associated with that observation being a bad loan (estimate), and a predicted class based on a probability threshold of 0.5 (pred_class). The table below shows the first few predictions from the base model.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>base_preds <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="fu">kable_styling</span>(<span class="st">"striped"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">truth</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">pred_class</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.0350714</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="even">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.0107027</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="odd">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.0297951</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="even">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.0432709</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="odd">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.0335889</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="even">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.0310299</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="odd">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.0452632</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="even">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.0226798</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="odd">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.0170578</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="even">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.0286983</td>
<td style="text-align: left;">good</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Now I’d like to add to each of these tables another column containing the predicted class based on the optimal probability threshold for each respective table. The below table shows a few cases for which the predicted class using a 0.5 probability threshold does not match the predicted class using the optimal probability threshold of 0.5525526 .</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>base_preds <span class="ot">&lt;-</span> base_preds <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="at">opt_pred_class =</span> <span class="fu">if_else</span>(estimate <span class="sc">&gt;=</span> opt_thresh_base, <span class="st">"bad"</span>, <span class="st">"good"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>      <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"bad"</span>, <span class="st">"good"</span>))</span>
<span id="cb10-5"><a href="#cb10-5"></a>  )</span>
<span id="cb10-6"><a href="#cb10-6"></a></span>
<span id="cb10-7"><a href="#cb10-7"></a>upsample_preds <span class="ot">&lt;-</span> upsample_preds <span class="sc">|&gt;</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-9"><a href="#cb10-9"></a>    <span class="at">opt_pred_class =</span> <span class="fu">if_else</span>(</span>
<span id="cb10-10"><a href="#cb10-10"></a>      estimate <span class="sc">&gt;=</span> opt_thresh_upsample,</span>
<span id="cb10-11"><a href="#cb10-11"></a>      <span class="st">"bad"</span>,</span>
<span id="cb10-12"><a href="#cb10-12"></a>      <span class="st">"good"</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>      <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"bad"</span>, <span class="st">"good"</span>))</span>
<span id="cb10-15"><a href="#cb10-15"></a>  )</span>
<span id="cb10-16"><a href="#cb10-16"></a></span>
<span id="cb10-17"><a href="#cb10-17"></a>upsample_preds <span class="sc">|&gt;</span> </span>
<span id="cb10-18"><a href="#cb10-18"></a>  <span class="fu">filter</span>(opt_pred_class <span class="sc">!=</span> pred_class) <span class="sc">|&gt;</span></span>
<span id="cb10-19"><a href="#cb10-19"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-20"><a href="#cb10-20"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-21"><a href="#cb10-21"></a>  <span class="fu">kable_styling</span>(<span class="st">"striped"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">truth</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">pred_class</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">opt_pred_class</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.5030688</td>
<td style="text-align: left;">bad</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="even">
<td style="text-align: left;">bad</td>
<td style="text-align: right;">0.5284232</td>
<td style="text-align: left;">bad</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="odd">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.5373165</td>
<td style="text-align: left;">bad</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="even">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.5007787</td>
<td style="text-align: left;">bad</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="odd">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.5173375</td>
<td style="text-align: left;">bad</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="even">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.5463947</td>
<td style="text-align: left;">bad</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bad</td>
<td style="text-align: right;">0.5297278</td>
<td style="text-align: left;">bad</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="even">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.5227147</td>
<td style="text-align: left;">bad</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="odd">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.5284232</td>
<td style="text-align: left;">bad</td>
<td style="text-align: left;">good</td>
</tr>
<tr class="even">
<td style="text-align: left;">good</td>
<td style="text-align: right;">0.5284232</td>
<td style="text-align: left;">bad</td>
<td style="text-align: left;">good</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Next I’ll plot confusion matrices for each set of predictions.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>conf_mats <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">base =</span> base_preds, <span class="at">upsample =</span> upsample_preds) <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>  <span class="fu">map</span>(</span>
<span id="cb11-3"><a href="#cb11-3"></a>    \(x) <span class="fu">list</span>(</span>
<span id="cb11-4"><a href="#cb11-4"></a>      <span class="fu">conf_mat</span>(x, <span class="at">truth =</span> truth, <span class="at">estimate =</span> pred_class),</span>
<span id="cb11-5"><a href="#cb11-5"></a>      <span class="fu">conf_mat</span>(x, <span class="at">truth =</span> truth, <span class="at">estimate =</span> opt_pred_class)</span>
<span id="cb11-6"><a href="#cb11-6"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>      <span class="fu">set_names</span>(<span class="st">"standard"</span>, <span class="st">"optimal"</span>)</span>
<span id="cb11-8"><a href="#cb11-8"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>  <span class="fu">list_flatten</span>()</span>
<span id="cb11-10"><a href="#cb11-10"></a></span>
<span id="cb11-11"><a href="#cb11-11"></a>conf_mat_plots <span class="ot">&lt;-</span> conf_mats <span class="sc">|&gt;</span></span>
<span id="cb11-12"><a href="#cb11-12"></a>  <span class="fu">imap</span>(</span>
<span id="cb11-13"><a href="#cb11-13"></a>    \(x, y) {</span>
<span id="cb11-14"><a href="#cb11-14"></a>      plot_title <span class="ot">&lt;-</span> <span class="fu">str_replace</span>(y, <span class="st">"_"</span>, <span class="st">" "</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-15"><a href="#cb11-15"></a>        <span class="fu">str_to_title</span>()</span>
<span id="cb11-16"><a href="#cb11-16"></a>      </span>
<span id="cb11-17"><a href="#cb11-17"></a>      <span class="fu">autoplot</span>(x, <span class="at">type =</span> <span class="st">"heatmap"</span>) <span class="sc">+</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>        <span class="fu">ggtitle</span>(plot_title) <span class="sc">+</span></span>
<span id="cb11-19"><a href="#cb11-19"></a>        <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb11-20"><a href="#cb11-20"></a>    }</span>
<span id="cb11-21"><a href="#cb11-21"></a>  )</span>
<span id="cb11-22"><a href="#cb11-22"></a></span>
<span id="cb11-23"><a href="#cb11-23"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> conf_mat_plots)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="class-thresh-vs-upsampling_files/figure-html/plot-conf-mats-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The above confusion matrices show that both changing the probability threshold for classification as a bad loan and upsampling have a significant impact on the number of positive predictions (“bad” loan), even though most of those are predicted incorrectly with this model. It’s also interesting to note that doing both – changing the probability threshold and upsampling – shows very little improvement over doing just one or the other. Below are some classification metrics for each model specification.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>conf_mats <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="fu">imap</span>(</span>
<span id="cb12-3"><a href="#cb12-3"></a>    \(x, y) <span class="fu">summary</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>      <span class="fu">select</span>(<span class="sc">-</span>.estimator) <span class="sc">|&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>      <span class="fu">set_names</span>(<span class="st">"metric"</span>, <span class="fu">str_replace</span>(y, <span class="st">"_"</span>, <span class="st">" "</span>) <span class="sc">|&gt;</span> <span class="fu">str_to_title</span>())</span>
<span id="cb12-6"><a href="#cb12-6"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>  <span class="fu">reduce</span>(left_join, <span class="at">by =</span> <span class="st">"metric"</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-9"><a href="#cb12-9"></a>  <span class="fu">kable_styling</span>(<span class="st">"striped"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">metric</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Base Standard</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Base Optimal</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Upsample Standard</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Upsample Optimal</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">accuracy</td>
<td style="text-align: right;">0.9436105</td>
<td style="text-align: right;">0.7083164</td>
<td style="text-align: right;">0.6908722</td>
<td style="text-align: right;">0.7452333</td>
</tr>
<tr class="even">
<td style="text-align: left;">kap</td>
<td style="text-align: right;">0.0103118</td>
<td style="text-align: right;">0.1137115</td>
<td style="text-align: right;">0.1086066</td>
<td style="text-align: right;">0.1316040</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sens</td>
<td style="text-align: right;">0.0073529</td>
<td style="text-align: right;">0.6470588</td>
<td style="text-align: right;">0.6691176</td>
<td style="text-align: right;">0.6176471</td>
</tr>
<tr class="even">
<td style="text-align: left;">spec</td>
<td style="text-align: right;">0.9982825</td>
<td style="text-align: right;">0.7118935</td>
<td style="text-align: right;">0.6921426</td>
<td style="text-align: right;">0.7526836</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ppv</td>
<td style="text-align: right;">0.2000000</td>
<td style="text-align: right;">0.1159420</td>
<td style="text-align: right;">0.1126238</td>
<td style="text-align: right;">0.1272727</td>
</tr>
<tr class="even">
<td style="text-align: left;">npv</td>
<td style="text-align: right;">0.9451220</td>
<td style="text-align: right;">0.9718640</td>
<td style="text-align: right;">0.9728425</td>
<td style="text-align: right;">0.9711911</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mcc</td>
<td style="text-align: right;">0.0285977</td>
<td style="text-align: right;">0.1775336</td>
<td style="text-align: right;">0.1757144</td>
<td style="text-align: right;">0.1909560</td>
</tr>
<tr class="even">
<td style="text-align: left;">j_index</td>
<td style="text-align: right;">0.0056355</td>
<td style="text-align: right;">0.3589523</td>
<td style="text-align: right;">0.3612602</td>
<td style="text-align: right;">0.3703306</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bal_accuracy</td>
<td style="text-align: right;">0.5028177</td>
<td style="text-align: right;">0.6794762</td>
<td style="text-align: right;">0.6806301</td>
<td style="text-align: right;">0.6851653</td>
</tr>
<tr class="even">
<td style="text-align: left;">detection_prevalence</td>
<td style="text-align: right;">0.0020284</td>
<td style="text-align: right;">0.3079108</td>
<td style="text-align: right;">0.3277890</td>
<td style="text-align: right;">0.2677485</td>
</tr>
<tr class="odd">
<td style="text-align: left;">precision</td>
<td style="text-align: right;">0.2000000</td>
<td style="text-align: right;">0.1159420</td>
<td style="text-align: right;">0.1126238</td>
<td style="text-align: right;">0.1272727</td>
</tr>
<tr class="even">
<td style="text-align: left;">recall</td>
<td style="text-align: right;">0.0073529</td>
<td style="text-align: right;">0.6470588</td>
<td style="text-align: right;">0.6691176</td>
<td style="text-align: right;">0.6176471</td>
</tr>
<tr class="odd">
<td style="text-align: left;">f_meas</td>
<td style="text-align: right;">0.0141844</td>
<td style="text-align: right;">0.1966480</td>
<td style="text-align: right;">0.1927966</td>
<td style="text-align: right;">0.2110553</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>The first thing that one might notices from the above is how high the accuracy is for the base model. It’s important to remember, though, that when a data set is so unbalanced all a model has to do is predict the majority class all the time and it will have high accuracy. That model, though, has a very low sensitivity and high specificity. The high specificity, again, is due to the fact that the actual data has an overwhelming proportion of the majority class. Looking across at the metrics for the other models one sees drops in both accuracy and specificity, but much more significant increases in sensitivity from the base model. It’s also useful to note that other metrics like balanced accuracy, kappa, mcc, and f_measure also improve. This is further evidence of the effect that the imbalance in classes has on the base model.</p>


<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-themis" class="csl-entry" role="listitem">
Hvitfeldt, Emil. 2023. <span>“Themis: Extra Recipes Steps for Dealing with Unbalanced Data.”</span> <a href="https://CRAN.R-project.org/package=themis">https://CRAN.R-project.org/package=themis</a>.
</div>
<div id="ref-finetune" class="csl-entry" role="listitem">
Kuhn, Max. 2023a. <span>“Finetune: Additional Functions for Model Tuning.”</span> <a href="https://CRAN.R-project.org/package=finetune">https://CRAN.R-project.org/package=finetune</a>.
</div>
<div id="ref-modeldata" class="csl-entry" role="listitem">
———. 2023b. <span>“Modeldata: Data Sets Useful for Modeling Examples.”</span> <a href="https://CRAN.R-project.org/package=modeldata">https://CRAN.R-project.org/package=modeldata</a>.
</div>
<div id="ref-probably" class="csl-entry" role="listitem">
Kuhn, Max, Davis Vaughan, and Edgar Ruiz. 2023. <span>“Probably: Tools for Post-Processing Class Probability Estimates.”</span> <a href="https://CRAN.R-project.org/package=probably">https://CRAN.R-project.org/package=probably</a>.
</div>
<div id="ref-tidymodels" class="csl-entry" role="listitem">
Kuhn, Max, and Hadley Wickham. 2020. <span>“Tidymodels: A Collection of Packages for Modeling and Machine Learning Using Tidyverse Principles.”</span> <a href="https://www.tidymodels.org">https://www.tidymodels.org</a>.
</div>
<div id="ref-colino" class="csl-entry" role="listitem">
Pawley, Steven, Max Kuhn, and Rowan Jacques-Hamilton. 2023. <span>“Colino: Recipes Steps for Supervised Filter-Based Feature Selection.”</span> <a href="https://stevenpawley.github.io/colino">https://stevenpawley.github.io/colino</a>.
</div>
<div id="ref-imbal_auprc" class="csl-entry" role="listitem">
Rosenberg, Daniel. 2022. <span>“Unbalanced Data? Stop Using ROC-AUC and Use AUPRC Instead.”</span> 2022. <a href="https://towardsdatascience.com/imbalanced-data-stop-using-roc-auc-and-use-auprc-instead-46af4910a494">https://towardsdatascience.com/imbalanced-data-stop-using-roc-auc-and-use-auprc-instead-46af4910a494</a>.
</div>
<div id="ref-skimr" class="csl-entry" role="listitem">
Waring, Elin, Michael Quinn, Amelia McNamara, Eduardo Arino de la Rubia, Hao Zhu, and Shannon Ellis. 2022. <span>“Skimr: Compact and Flexible Summaries of Data.”</span> <a href="https://CRAN.R-project.org/package=skimr">https://CRAN.R-project.org/package=skimr</a>.
</div>
<div id="ref-tidyverse" class="csl-entry" role="listitem">
Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. <span>“Welcome to the <span></span>Tidyverse<span></span>”</span> 4: 1686. <a href="https://doi.org/10.21105/joss.01686">https://doi.org/10.21105/joss.01686</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.arcenis-r\.github\.io\/ajr-portfolio");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          trigger: 'click',
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          positionFixed: true,
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="arcenis-r/ajr-portfolio" data-repo-id="MDEwOlJlcG9zaXRvcnkxNzg3MDY3MTM=" data-category="General" data-category-id="DIC_kwDOCqbZGc4CdJXz" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb13" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb13-1"><a href="#cb13-1"></a><span class="co">---</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="an">title:</span><span class="co"> "Optimal Threshold vs. Upsampling"</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="an">subtitle:</span><span class="co"> "Dealing with Unbalanced Data"</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="an">author:</span><span class="co"> "Arcenis Rojas"</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="an">execute:</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="co">  warning: false</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="co">  error: false</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="an">bibliography:</span><span class="co"> class-thresh-vs-upsampling-references.bib</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="an">date:</span><span class="co"> "2/15/2023"</span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="an">categories:</span></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="co">  - machine learning</span></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="co">  - data science</span></span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="co">  - classification</span></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="co">---</span></span>
<span id="cb13-15"><a href="#cb13-15"></a></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="fu">## Introduction</span></span>
<span id="cb13-17"><a href="#cb13-17"></a></span>
<span id="cb13-18"><a href="#cb13-18"></a>In any binary classification analysis it is common to have to deal with heavily unbalanced data, i.e., the frequency of the majority class in the dependent variable is overwhelmingly greater than that of the minority class. One of the main reasons this can be problematic is that many classification algorithms are biased toward the majority class. If 95% of the observations belong to the majority class in the training data and the algorithm always predicts the majority class, then it will have achieved 95% accuracy.</span>
<span id="cb13-19"><a href="#cb13-19"></a></span>
<span id="cb13-20"><a href="#cb13-20"></a>There are many ways of dealing with unbalanced data including changing from a classification algorithm to an anomaly detection algorithm like an isoforest or a one-class SVM, using SMOTE to re-balance the data sets in pre-processing, up- or down-sampling, and changing the classification threshold. Here I will only deal with up-sampling and changing the classification threshold to see how it affects classification metrics by way of going through an exercise. I'll first create and tune a base model then do the same for an up-sampled model using Tidymodels <span class="co">[</span><span class="ot">@tidymodels</span><span class="co">]</span>. Hyperparameter tuning will be done with the <span class="in">`finetune`</span> package <span class="co">[</span><span class="ot">@finetune</span><span class="co">]</span>. I'll then find the optimal threshold for each using the <span class="in">`probably`</span> package <span class="co">[</span><span class="ot">@probably</span><span class="co">]</span>. Finally I'll show a comparison of their respective classification metrics.</span>
<span id="cb13-21"><a href="#cb13-21"></a></span>
<span id="cb13-24"><a href="#cb13-24"></a><span class="in">```{r}</span></span>
<span id="cb13-25"><a href="#cb13-25"></a><span class="co">#| label: set-up</span></span>
<span id="cb13-26"><a href="#cb13-26"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb13-27"><a href="#cb13-27"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb13-28"><a href="#cb13-28"></a><span class="fu">library</span>(colino)</span>
<span id="cb13-29"><a href="#cb13-29"></a><span class="fu">library</span>(themis)</span>
<span id="cb13-30"><a href="#cb13-30"></a><span class="fu">library</span>(finetune)</span>
<span id="cb13-31"><a href="#cb13-31"></a><span class="fu">library</span>(probably)</span>
<span id="cb13-32"><a href="#cb13-32"></a><span class="fu">library</span>(skimr)</span>
<span id="cb13-33"><a href="#cb13-33"></a><span class="fu">library</span>(knitr)</span>
<span id="cb13-34"><a href="#cb13-34"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb13-35"><a href="#cb13-35"></a></span>
<span id="cb13-36"><a href="#cb13-36"></a>conflicted<span class="sc">::</span><span class="fu">conflict_prefer</span>(<span class="st">"filter"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb13-37"><a href="#cb13-37"></a>conflicted<span class="sc">::</span><span class="fu">conflict_prefer</span>(<span class="st">"select"</span>, <span class="st">"dplyr"</span>)</span>
<span id="cb13-38"><a href="#cb13-38"></a><span class="fu">tidymodels_prefer</span>()</span>
<span id="cb13-39"><a href="#cb13-39"></a><span class="in">```</span></span>
<span id="cb13-40"><a href="#cb13-40"></a></span>
<span id="cb13-41"><a href="#cb13-41"></a><span class="fu">## Lending Club Data</span></span>
<span id="cb13-42"><a href="#cb13-42"></a></span>
<span id="cb13-43"><a href="#cb13-43"></a>For this project I'll be using the <span class="in">`lending_club`</span> data set from the <span class="in">`modeldata`</span> <span class="co">[</span><span class="ot">@modeldata</span><span class="co">]</span> package. The data contain the <span class="in">`Class`</span> variable which indicates whether a loan was "good" or bad". For the purposes of this analysis I also will consider the "bad" outcome as the event to predict.</span>
<span id="cb13-44"><a href="#cb13-44"></a></span>
<span id="cb13-45"><a href="#cb13-45"></a><span class="fu">## Data Exploration</span></span>
<span id="cb13-46"><a href="#cb13-46"></a></span>
<span id="cb13-47"><a href="#cb13-47"></a>The first step is to load the data using the <span class="in">`readr`</span> package from the Tidyverse <span class="co">[</span><span class="ot">@tidyverse</span><span class="co">]</span> and summarize it using the <span class="in">`skimr`</span> package <span class="co">[</span><span class="ot">@skimr</span><span class="co">]</span>.</span>
<span id="cb13-48"><a href="#cb13-48"></a></span>
<span id="cb13-51"><a href="#cb13-51"></a><span class="in">```{r}</span></span>
<span id="cb13-52"><a href="#cb13-52"></a><span class="co">#| label: load-data</span></span>
<span id="cb13-53"><a href="#cb13-53"></a></span>
<span id="cb13-54"><a href="#cb13-54"></a><span class="fu">data</span>(<span class="st">"lending_club"</span>, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb13-55"><a href="#cb13-55"></a></span>
<span id="cb13-56"><a href="#cb13-56"></a><span class="fu">skim</span>(lending_club) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>complete_rate)</span>
<span id="cb13-57"><a href="#cb13-57"></a><span class="in">```</span></span>
<span id="cb13-58"><a href="#cb13-58"></a></span>
<span id="cb13-59"><a href="#cb13-59"></a>The above data summary shows some important things. First, there are 9,857 observations and 23 variables with no missing values. Also, the data has 6 factor variables and 17 numeric variables. It shows that most of the numeric variables are left skewed. The "sub_grade" and "addr_state" factor variables have 35 and 50 levels respectively. With so many unique values it's very likely that some of the classes in each of those variables become overwhelmed by majority classes. While there are feature engineering steps that I can take such as consolidating infrequent classes or splitting up <span class="in">`sub_grade`</span> into constituent parts, I'll just allow the feature selection step to handle it. Finally, the "Class" factor variable (dependent variable) has two levels with the majority class – "good" – having 9,340 observations and the minority class – "bad" – having 517 observations.</span>
<span id="cb13-60"><a href="#cb13-60"></a></span>
<span id="cb13-61"><a href="#cb13-61"></a>Here I'll just look at the proportions of the <span class="in">`Class`</span> variable.</span>
<span id="cb13-62"><a href="#cb13-62"></a></span>
<span id="cb13-65"><a href="#cb13-65"></a><span class="in">```{r}</span></span>
<span id="cb13-66"><a href="#cb13-66"></a><span class="co">#| label: outcome-frequencies</span></span>
<span id="cb13-67"><a href="#cb13-67"></a></span>
<span id="cb13-68"><a href="#cb13-68"></a>lending_club <span class="sc">|&gt;</span></span>
<span id="cb13-69"><a href="#cb13-69"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> Class)) <span class="sc">+</span></span>
<span id="cb13-70"><a href="#cb13-70"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">x =</span> (..count..) <span class="sc">/</span> <span class="fu">sum</span>(..count..))) <span class="sc">+</span></span>
<span id="cb13-71"><a href="#cb13-71"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb13-72"><a href="#cb13-72"></a>  <span class="fu">labs</span>(</span>
<span id="cb13-73"><a href="#cb13-73"></a>    <span class="at">x =</span> <span class="st">"Proportion"</span>,</span>
<span id="cb13-74"><a href="#cb13-74"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb13-75"><a href="#cb13-75"></a>    <span class="at">title =</span> <span class="st">"Frequency of loan outcome categories (Class)"</span></span>
<span id="cb13-76"><a href="#cb13-76"></a>  ) <span class="sc">+</span></span>
<span id="cb13-77"><a href="#cb13-77"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb13-78"><a href="#cb13-78"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb13-79"><a href="#cb13-79"></a><span class="in">```</span></span>
<span id="cb13-80"><a href="#cb13-80"></a></span>
<span id="cb13-81"><a href="#cb13-81"></a>Here we see a sever class unbalance with only about 5% of loans having a "bad" outcome.</span>
<span id="cb13-82"><a href="#cb13-82"></a></span>
<span id="cb13-83"><a href="#cb13-83"></a><span class="fu">## Create Data Splits and Other Common Elements</span></span>
<span id="cb13-84"><a href="#cb13-84"></a></span>
<span id="cb13-85"><a href="#cb13-85"></a>For the analysis I'll split the data into training (75%) and test (25%) sets stratified by the <span class="in">`Class`</span> variable. I'll then create 100 bootstraps of the training data for model tuning, also stratified by the <span class="in">`Class`</span> variable. Stratification will ensure that both cuts of the data and the bootstraps retain the class unbalance as close to the proportions of the original data.</span>
<span id="cb13-86"><a href="#cb13-86"></a></span>
<span id="cb13-87"><a href="#cb13-87"></a>Here I also create a list of features to control the model tuning process.</span>
<span id="cb13-88"><a href="#cb13-88"></a></span>
<span id="cb13-91"><a href="#cb13-91"></a><span class="in">```{r}</span></span>
<span id="cb13-92"><a href="#cb13-92"></a><span class="co">#| label: common-elements</span></span>
<span id="cb13-93"><a href="#cb13-93"></a></span>
<span id="cb13-94"><a href="#cb13-94"></a><span class="co"># Create training/test split</span></span>
<span id="cb13-95"><a href="#cb13-95"></a><span class="fu">set.seed</span>(<span class="dv">95</span>)</span>
<span id="cb13-96"><a href="#cb13-96"></a>tt_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(lending_club, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Class)</span>
<span id="cb13-97"><a href="#cb13-97"></a></span>
<span id="cb13-98"><a href="#cb13-98"></a><span class="co"># Create the bootstrap object</span></span>
<span id="cb13-99"><a href="#cb13-99"></a><span class="fu">set.seed</span>(<span class="dv">386</span>)</span>
<span id="cb13-100"><a href="#cb13-100"></a>bstraps <span class="ot">&lt;-</span> <span class="fu">bootstraps</span>(<span class="fu">training</span>(tt_split), <span class="at">times =</span> <span class="dv">100</span>, <span class="at">strata =</span> Class)</span>
<span id="cb13-101"><a href="#cb13-101"></a></span>
<span id="cb13-102"><a href="#cb13-102"></a><span class="co"># Create the model object for the workflows</span></span>
<span id="cb13-103"><a href="#cb13-103"></a>lr_mod <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>(<span class="at">mode =</span> <span class="st">"classification"</span>, <span class="at">engine =</span> <span class="st">"glm"</span>)</span>
<span id="cb13-104"><a href="#cb13-104"></a></span>
<span id="cb13-105"><a href="#cb13-105"></a><span class="co"># Create a list of control options</span></span>
<span id="cb13-106"><a href="#cb13-106"></a>race_control <span class="ot">&lt;-</span> <span class="fu">control_race</span>(</span>
<span id="cb13-107"><a href="#cb13-107"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-108"><a href="#cb13-108"></a>  <span class="at">allow_par =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-109"><a href="#cb13-109"></a>  <span class="at">burn_in =</span> <span class="dv">3</span>,</span>
<span id="cb13-110"><a href="#cb13-110"></a>  <span class="at">save_workflow =</span> <span class="cn">TRUE</span>,</span>
<span id="cb13-111"><a href="#cb13-111"></a>  <span class="at">save_pred =</span> <span class="cn">TRUE</span></span>
<span id="cb13-112"><a href="#cb13-112"></a>)</span>
<span id="cb13-113"><a href="#cb13-113"></a><span class="in">```</span></span>
<span id="cb13-114"><a href="#cb13-114"></a></span>
<span id="cb13-115"><a href="#cb13-115"></a><span class="fu">## Train Base Model</span></span>
<span id="cb13-116"><a href="#cb13-116"></a></span>
<span id="cb13-117"><a href="#cb13-117"></a>The base recipe will perform the following steps:</span>
<span id="cb13-118"><a href="#cb13-118"></a></span>
<span id="cb13-119"><a href="#cb13-119"></a><span class="ss">1.  </span>Remove variables with near-zero variance</span>
<span id="cb13-120"><a href="#cb13-120"></a></span>
<span id="cb13-121"><a href="#cb13-121"></a><span class="ss">2.  </span>Scale and center all numeric variables</span>
<span id="cb13-122"><a href="#cb13-122"></a></span>
<span id="cb13-123"><a href="#cb13-123"></a><span class="ss">3.  </span>Convert categorical variables to dummy variables</span>
<span id="cb13-124"><a href="#cb13-124"></a></span>
<span id="cb13-125"><a href="#cb13-125"></a><span class="ss">4.  </span>Select variables based on mRMR using the <span class="in">`colino`</span> package <span class="co">[</span><span class="ot">@colino</span><span class="co">]</span>; the percentile threshold used to decide which variables to keep will be chosen through model tuning</span>
<span id="cb13-126"><a href="#cb13-126"></a></span>
<span id="cb13-127"><a href="#cb13-127"></a>The base recipe will be combined with a logistic regression model specification to put into a workflow. This workflow then goes through a Bayesian hyperparameter tuning process to find the best mRMR threshold as mentioned above. "Best" is defined as the full model specification that yields the highest area under the receiver operator curve (ROC-AUC) because I'll be choosing the optimal probability threshold on the basis of this curve, even though it would be preferable to choose on the basis of the area under the precision-recall curve (PR-AUC) with unbalanced data. <span class="co">[</span><span class="ot">@imbal_auprc</span><span class="co">]</span></span>
<span id="cb13-128"><a href="#cb13-128"></a></span>
<span id="cb13-131"><a href="#cb13-131"></a><span class="in">```{r}</span></span>
<span id="cb13-132"><a href="#cb13-132"></a><span class="co">#| label: base-wflow</span></span>
<span id="cb13-133"><a href="#cb13-133"></a><span class="co">#| cache: true</span></span>
<span id="cb13-134"><a href="#cb13-134"></a></span>
<span id="cb13-135"><a href="#cb13-135"></a><span class="co"># Create a base recipe</span></span>
<span id="cb13-136"><a href="#cb13-136"></a>base_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Class <span class="sc">~</span> ., <span class="at">data =</span> <span class="fu">training</span>(tt_split)) <span class="sc">|&gt;</span></span>
<span id="cb13-137"><a href="#cb13-137"></a>  <span class="fu">step_nzv</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb13-138"><a href="#cb13-138"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb13-139"><a href="#cb13-139"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">one_hot =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-140"><a href="#cb13-140"></a>  <span class="fu">step_select_mrmr</span>(</span>
<span id="cb13-141"><a href="#cb13-141"></a>    <span class="fu">all_predictors</span>(),</span>
<span id="cb13-142"><a href="#cb13-142"></a>    <span class="at">threshold =</span> <span class="fu">tune</span>(),</span>
<span id="cb13-143"><a href="#cb13-143"></a>    <span class="at">outcome =</span> <span class="st">"Class"</span></span>
<span id="cb13-144"><a href="#cb13-144"></a>  )</span>
<span id="cb13-145"><a href="#cb13-145"></a></span>
<span id="cb13-146"><a href="#cb13-146"></a><span class="co"># First tune the base model to get the best set of variables with MRMR</span></span>
<span id="cb13-147"><a href="#cb13-147"></a>base_wflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> <span class="fu">add_recipe</span>(base_rec) <span class="sc">|&gt;</span> <span class="fu">add_model</span>(lr_mod)</span>
<span id="cb13-148"><a href="#cb13-148"></a></span>
<span id="cb13-149"><a href="#cb13-149"></a><span class="fu">set.seed</span>(<span class="dv">40</span>)</span>
<span id="cb13-150"><a href="#cb13-150"></a>base_tuned <span class="ot">&lt;-</span> <span class="fu">tune_race_win_loss</span>(</span>
<span id="cb13-151"><a href="#cb13-151"></a>  base_wflow,</span>
<span id="cb13-152"><a href="#cb13-152"></a>  <span class="at">resamples =</span> bstraps,</span>
<span id="cb13-153"><a href="#cb13-153"></a>  <span class="at">control =</span> race_control,</span>
<span id="cb13-154"><a href="#cb13-154"></a>  <span class="at">grid =</span> <span class="dv">10</span>,</span>
<span id="cb13-155"><a href="#cb13-155"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(pr_auc, roc_auc, accuracy)</span>
<span id="cb13-156"><a href="#cb13-156"></a>)</span>
<span id="cb13-157"><a href="#cb13-157"></a></span>
<span id="cb13-158"><a href="#cb13-158"></a><span class="co"># Get the workflow with the best MRMR threshold</span></span>
<span id="cb13-159"><a href="#cb13-159"></a>best_base <span class="ot">&lt;-</span> <span class="fu">select_best</span>(base_tuned, <span class="st">"roc_auc"</span>)</span>
<span id="cb13-160"><a href="#cb13-160"></a></span>
<span id="cb13-161"><a href="#cb13-161"></a><span class="co"># Get the MRMR threshold from the best base model</span></span>
<span id="cb13-162"><a href="#cb13-162"></a>mrmr_threshold <span class="ot">&lt;-</span> best_base <span class="sc">|&gt;</span> <span class="fu">pull</span>(threshold)</span>
<span id="cb13-163"><a href="#cb13-163"></a><span class="in">```</span></span>
<span id="cb13-164"><a href="#cb13-164"></a></span>
<span id="cb13-165"><a href="#cb13-165"></a>The mRMR threshold associated with the best model is <span class="in">`r mrmr_threshold`</span> .</span>
<span id="cb13-166"><a href="#cb13-166"></a></span>
<span id="cb13-167"><a href="#cb13-167"></a><span class="fu">## Train Upsampled Model</span></span>
<span id="cb13-168"><a href="#cb13-168"></a></span>
<span id="cb13-169"><a href="#cb13-169"></a>The upsampled model will only add the pre-processing step of upsampling the minority class to the same proportion as the majority class (or close to it) by resampling observations with a <span class="in">`Class`</span> value from the minority class using the <span class="in">`themis`</span> package <span class="co">[</span><span class="ot">@themis</span><span class="co">]</span>. To ensure that this is the only difference, I'll take the mRMR threshold that was tuned for the base model directly from the best base model and specify it as the threshold for the upsampling model.</span>
<span id="cb13-170"><a href="#cb13-170"></a></span>
<span id="cb13-173"><a href="#cb13-173"></a><span class="in">```{r}</span></span>
<span id="cb13-174"><a href="#cb13-174"></a><span class="co">#| label: upsample-wflow</span></span>
<span id="cb13-175"><a href="#cb13-175"></a><span class="co">#| cache: true</span></span>
<span id="cb13-176"><a href="#cb13-176"></a></span>
<span id="cb13-177"><a href="#cb13-177"></a><span class="co"># Build a recipe for upsampling by first updating the MRMR step from the base recipe with the threshold from the tuning process then adding upsampling</span></span>
<span id="cb13-178"><a href="#cb13-178"></a>upsample_rec <span class="ot">&lt;-</span> base_rec</span>
<span id="cb13-179"><a href="#cb13-179"></a>select_mrmr_step <span class="ot">&lt;-</span> <span class="fu">tidy</span>(upsample_rec) <span class="sc">|&gt;</span></span>
<span id="cb13-180"><a href="#cb13-180"></a>  <span class="fu">filter</span>(type <span class="sc">%in%</span> <span class="st">"select_mrmr"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-181"><a href="#cb13-181"></a>  <span class="fu">pull</span>(number)</span>
<span id="cb13-182"><a href="#cb13-182"></a></span>
<span id="cb13-183"><a href="#cb13-183"></a>upsample_rec<span class="sc">$</span>steps[[select_mrmr_step]] <span class="ot">&lt;-</span> <span class="fu">update</span>(</span>
<span id="cb13-184"><a href="#cb13-184"></a>  upsample_rec<span class="sc">$</span>steps[[select_mrmr_step]],</span>
<span id="cb13-185"><a href="#cb13-185"></a>  <span class="at">threshold =</span> mrmr_threshold</span>
<span id="cb13-186"><a href="#cb13-186"></a>)</span>
<span id="cb13-187"><a href="#cb13-187"></a></span>
<span id="cb13-188"><a href="#cb13-188"></a>upsample_rec <span class="ot">&lt;-</span> upsample_rec <span class="sc">|&gt;</span></span>
<span id="cb13-189"><a href="#cb13-189"></a>  <span class="fu">step_upsample</span>(Class, <span class="at">over_ratio =</span> <span class="fu">tune</span>())</span>
<span id="cb13-190"><a href="#cb13-190"></a></span>
<span id="cb13-191"><a href="#cb13-191"></a><span class="co"># Create the upsample workflow object</span></span>
<span id="cb13-192"><a href="#cb13-192"></a>upsample_wflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> <span class="fu">add_recipe</span>(upsample_rec) <span class="sc">|&gt;</span> <span class="fu">add_model</span>(lr_mod)</span>
<span id="cb13-193"><a href="#cb13-193"></a></span>
<span id="cb13-194"><a href="#cb13-194"></a><span class="co"># Tune the workflow containing the upsample recipe</span></span>
<span id="cb13-195"><a href="#cb13-195"></a><span class="fu">set.seed</span>(<span class="dv">40</span>)</span>
<span id="cb13-196"><a href="#cb13-196"></a>upsample_tuned <span class="ot">&lt;-</span> <span class="fu">tune_race_win_loss</span>(</span>
<span id="cb13-197"><a href="#cb13-197"></a>  upsample_wflow,</span>
<span id="cb13-198"><a href="#cb13-198"></a>  <span class="at">resamples =</span> bstraps,</span>
<span id="cb13-199"><a href="#cb13-199"></a>  <span class="at">control =</span> race_control,</span>
<span id="cb13-200"><a href="#cb13-200"></a>  <span class="at">grid =</span> <span class="dv">10</span>,</span>
<span id="cb13-201"><a href="#cb13-201"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(pr_auc, roc_auc, accuracy)</span>
<span id="cb13-202"><a href="#cb13-202"></a>)</span>
<span id="cb13-203"><a href="#cb13-203"></a></span>
<span id="cb13-204"><a href="#cb13-204"></a><span class="co"># Get the workflow with the best MRMR threshold</span></span>
<span id="cb13-205"><a href="#cb13-205"></a>best_upsample <span class="ot">&lt;-</span> <span class="fu">select_best</span>(upsample_tuned, <span class="st">"roc_auc"</span>)</span>
<span id="cb13-206"><a href="#cb13-206"></a><span class="in">```</span></span>
<span id="cb13-207"><a href="#cb13-207"></a></span>
<span id="cb13-208"><a href="#cb13-208"></a>The best over-sampling ratio is <span class="in">`r best_upsample |&gt; pull(over_ratio)`</span> .</span>
<span id="cb13-209"><a href="#cb13-209"></a></span>
<span id="cb13-210"><a href="#cb13-210"></a><span class="fu">## Compare Model Classification Metrics</span></span>
<span id="cb13-211"><a href="#cb13-211"></a></span>
<span id="cb13-212"><a href="#cb13-212"></a>Now that I've run both models and gotten the best hyperparameters for each, I'll finalize both models and ensure that I have the same sets of variables in the models.</span>
<span id="cb13-213"><a href="#cb13-213"></a></span>
<span id="cb13-216"><a href="#cb13-216"></a><span class="in">```{r}</span></span>
<span id="cb13-217"><a href="#cb13-217"></a><span class="co">#| label: finalize-models</span></span>
<span id="cb13-218"><a href="#cb13-218"></a></span>
<span id="cb13-219"><a href="#cb13-219"></a><span class="co"># Get evaluation datasets for both workflows</span></span>
<span id="cb13-220"><a href="#cb13-220"></a><span class="fu">set.seed</span>(<span class="dv">75</span>)</span>
<span id="cb13-221"><a href="#cb13-221"></a>eval_base <span class="ot">&lt;-</span> base_wflow <span class="sc">|&gt;</span></span>
<span id="cb13-222"><a href="#cb13-222"></a>  <span class="fu">finalize_workflow</span>(best_base) <span class="sc">|&gt;</span></span>
<span id="cb13-223"><a href="#cb13-223"></a>  <span class="fu">last_fit</span>(tt_split)</span>
<span id="cb13-224"><a href="#cb13-224"></a></span>
<span id="cb13-225"><a href="#cb13-225"></a><span class="co"># Build the evaluation tibble for the upsample case</span></span>
<span id="cb13-226"><a href="#cb13-226"></a><span class="fu">set.seed</span>(<span class="dv">212</span>)</span>
<span id="cb13-227"><a href="#cb13-227"></a>eval_upsample <span class="ot">&lt;-</span> upsample_wflow <span class="sc">|&gt;</span></span>
<span id="cb13-228"><a href="#cb13-228"></a>  <span class="fu">finalize_workflow</span>(<span class="fu">select_best</span>(upsample_tuned, <span class="st">"roc_auc"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb13-229"><a href="#cb13-229"></a>  <span class="fu">last_fit</span>(tt_split)</span>
<span id="cb13-230"><a href="#cb13-230"></a></span>
<span id="cb13-231"><a href="#cb13-231"></a>eval_base <span class="sc">|&gt;</span></span>
<span id="cb13-232"><a href="#cb13-232"></a>  <span class="fu">extract_fit_engine</span>() <span class="sc">|&gt;</span></span>
<span id="cb13-233"><a href="#cb13-233"></a>  <span class="fu">tidy</span>() <span class="sc">|&gt;</span></span>
<span id="cb13-234"><a href="#cb13-234"></a>  <span class="fu">select</span>(<span class="at">base =</span> term) <span class="sc">|&gt;</span></span>
<span id="cb13-235"><a href="#cb13-235"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb13-236"><a href="#cb13-236"></a>    eval_upsample <span class="sc">|&gt;</span></span>
<span id="cb13-237"><a href="#cb13-237"></a>      <span class="fu">extract_fit_engine</span>() <span class="sc">|&gt;</span></span>
<span id="cb13-238"><a href="#cb13-238"></a>      <span class="fu">tidy</span>() <span class="sc">|&gt;</span></span>
<span id="cb13-239"><a href="#cb13-239"></a>      <span class="fu">select</span>(<span class="at">upsample =</span> term)</span>
<span id="cb13-240"><a href="#cb13-240"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-241"><a href="#cb13-241"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-242"><a href="#cb13-242"></a>  <span class="fu">kable_styling</span>(<span class="st">"striped"</span>)</span>
<span id="cb13-243"><a href="#cb13-243"></a><span class="in">```</span></span>
<span id="cb13-244"><a href="#cb13-244"></a></span>
<span id="cb13-245"><a href="#cb13-245"></a>The above table shows that both models ended up with the same sets of variables. Next we'll find the optimal threshold cut-offs for each set of predictions on the test data using Youden's J-Index.</span>
<span id="cb13-246"><a href="#cb13-246"></a></span>
<span id="cb13-249"><a href="#cb13-249"></a><span class="in">```{r}</span></span>
<span id="cb13-250"><a href="#cb13-250"></a><span class="co">#| label: find-opt-cutoffs</span></span>
<span id="cb13-251"><a href="#cb13-251"></a></span>
<span id="cb13-252"><a href="#cb13-252"></a>base_preds <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb13-253"><a href="#cb13-253"></a>  <span class="at">truth =</span> <span class="fu">collect_predictions</span>(eval_base) <span class="sc">|&gt;</span> <span class="fu">pull</span>(Class),</span>
<span id="cb13-254"><a href="#cb13-254"></a>  <span class="at">estimate =</span> <span class="fu">collect_predictions</span>(eval_base) <span class="sc">|&gt;</span> <span class="fu">pull</span>(.pred_bad),</span>
<span id="cb13-255"><a href="#cb13-255"></a>  <span class="at">pred_class =</span> <span class="fu">collect_predictions</span>(eval_base) <span class="sc">|&gt;</span> <span class="fu">pull</span>(.pred_class)</span>
<span id="cb13-256"><a href="#cb13-256"></a>)</span>
<span id="cb13-257"><a href="#cb13-257"></a></span>
<span id="cb13-258"><a href="#cb13-258"></a><span class="co"># Find the optimal classification threshold for the base model</span></span>
<span id="cb13-259"><a href="#cb13-259"></a>opt_thresh_base <span class="ot">&lt;-</span> base_preds <span class="sc">|&gt;</span></span>
<span id="cb13-260"><a href="#cb13-260"></a>  <span class="fu">threshold_perf</span>(truth, estimate, <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">1000</span>)) <span class="sc">|&gt;</span></span>
<span id="cb13-261"><a href="#cb13-261"></a>  <span class="fu">filter</span>(.metric <span class="sc">%in%</span> <span class="st">"j_index"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-262"><a href="#cb13-262"></a>  <span class="fu">slice_max</span>(.estimate, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-263"><a href="#cb13-263"></a>  <span class="fu">pull</span>(.threshold)</span>
<span id="cb13-264"><a href="#cb13-264"></a></span>
<span id="cb13-265"><a href="#cb13-265"></a>upsample_preds <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb13-266"><a href="#cb13-266"></a>  <span class="at">truth =</span> <span class="fu">collect_predictions</span>(eval_upsample) <span class="sc">|&gt;</span> <span class="fu">pull</span>(Class),</span>
<span id="cb13-267"><a href="#cb13-267"></a>  <span class="at">estimate =</span> <span class="fu">collect_predictions</span>(eval_upsample) <span class="sc">|&gt;</span> <span class="fu">pull</span>(.pred_bad),</span>
<span id="cb13-268"><a href="#cb13-268"></a>  <span class="at">pred_class =</span> <span class="fu">collect_predictions</span>(eval_upsample) <span class="sc">|&gt;</span> <span class="fu">pull</span>(.pred_class)</span>
<span id="cb13-269"><a href="#cb13-269"></a>)</span>
<span id="cb13-270"><a href="#cb13-270"></a></span>
<span id="cb13-271"><a href="#cb13-271"></a><span class="co"># Find the optimal classification threshold for the upsample model</span></span>
<span id="cb13-272"><a href="#cb13-272"></a>opt_thresh_upsample <span class="ot">&lt;-</span> upsample_preds <span class="sc">|&gt;</span></span>
<span id="cb13-273"><a href="#cb13-273"></a>  <span class="fu">threshold_perf</span>(truth, estimate, <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">1000</span>))<span class="sc">|&gt;</span></span>
<span id="cb13-274"><a href="#cb13-274"></a>  <span class="fu">filter</span>(.metric <span class="sc">%in%</span> <span class="st">"j_index"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-275"><a href="#cb13-275"></a>  <span class="fu">slice_max</span>(.estimate, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-276"><a href="#cb13-276"></a>  <span class="fu">pull</span>(.threshold)</span>
<span id="cb13-277"><a href="#cb13-277"></a><span class="in">```</span></span>
<span id="cb13-278"><a href="#cb13-278"></a></span>
<span id="cb13-279"><a href="#cb13-279"></a>The optimal probability threshold for classifying a loan as bad with the base model is <span class="in">`r opt_thresh_base`</span> and that for the upsampling model is <span class="in">`r opt_thresh_upsample`</span></span>
<span id="cb13-280"><a href="#cb13-280"></a></span>
<span id="cb13-281"><a href="#cb13-281"></a>Each table of predictions currently has 3 columns showing the actual class for a given observation (truth), the prediction probability associated with that observation being a bad loan (estimate), and a predicted class based on a probability threshold of 0.5 (pred_class). The table below shows the first few predictions from the base model.</span>
<span id="cb13-282"><a href="#cb13-282"></a></span>
<span id="cb13-285"><a href="#cb13-285"></a><span class="in">```{r}</span></span>
<span id="cb13-286"><a href="#cb13-286"></a><span class="co">#| label: show-base-preds</span></span>
<span id="cb13-287"><a href="#cb13-287"></a>base_preds <span class="sc">|&gt;</span></span>
<span id="cb13-288"><a href="#cb13-288"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-289"><a href="#cb13-289"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-290"><a href="#cb13-290"></a>  <span class="fu">kable_styling</span>(<span class="st">"striped"</span>)</span>
<span id="cb13-291"><a href="#cb13-291"></a><span class="in">```</span></span>
<span id="cb13-292"><a href="#cb13-292"></a></span>
<span id="cb13-293"><a href="#cb13-293"></a>Now I'd like to add to each of these tables another column containing the predicted class based on the optimal probability threshold for each respective table. The below table shows a few cases for which the predicted class using a 0.5 probability threshold does not match the predicted class using the optimal probability threshold of <span class="in">`r opt_thresh_upsample`</span> .</span>
<span id="cb13-294"><a href="#cb13-294"></a></span>
<span id="cb13-297"><a href="#cb13-297"></a><span class="in">```{r}</span></span>
<span id="cb13-298"><a href="#cb13-298"></a><span class="co">#| label: add-opt-thresh-class</span></span>
<span id="cb13-299"><a href="#cb13-299"></a></span>
<span id="cb13-300"><a href="#cb13-300"></a>base_preds <span class="ot">&lt;-</span> base_preds <span class="sc">|&gt;</span></span>
<span id="cb13-301"><a href="#cb13-301"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-302"><a href="#cb13-302"></a>    <span class="at">opt_pred_class =</span> <span class="fu">if_else</span>(estimate <span class="sc">&gt;=</span> opt_thresh_base, <span class="st">"bad"</span>, <span class="st">"good"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-303"><a href="#cb13-303"></a>      <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"bad"</span>, <span class="st">"good"</span>))</span>
<span id="cb13-304"><a href="#cb13-304"></a>  )</span>
<span id="cb13-305"><a href="#cb13-305"></a></span>
<span id="cb13-306"><a href="#cb13-306"></a>upsample_preds <span class="ot">&lt;-</span> upsample_preds <span class="sc">|&gt;</span></span>
<span id="cb13-307"><a href="#cb13-307"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-308"><a href="#cb13-308"></a>    <span class="at">opt_pred_class =</span> <span class="fu">if_else</span>(</span>
<span id="cb13-309"><a href="#cb13-309"></a>      estimate <span class="sc">&gt;=</span> opt_thresh_upsample,</span>
<span id="cb13-310"><a href="#cb13-310"></a>      <span class="st">"bad"</span>,</span>
<span id="cb13-311"><a href="#cb13-311"></a>      <span class="st">"good"</span></span>
<span id="cb13-312"><a href="#cb13-312"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb13-313"><a href="#cb13-313"></a>      <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"bad"</span>, <span class="st">"good"</span>))</span>
<span id="cb13-314"><a href="#cb13-314"></a>  )</span>
<span id="cb13-315"><a href="#cb13-315"></a></span>
<span id="cb13-316"><a href="#cb13-316"></a>upsample_preds <span class="sc">|&gt;</span> </span>
<span id="cb13-317"><a href="#cb13-317"></a>  <span class="fu">filter</span>(opt_pred_class <span class="sc">!=</span> pred_class) <span class="sc">|&gt;</span></span>
<span id="cb13-318"><a href="#cb13-318"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-319"><a href="#cb13-319"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-320"><a href="#cb13-320"></a>  <span class="fu">kable_styling</span>(<span class="st">"striped"</span>)</span>
<span id="cb13-321"><a href="#cb13-321"></a><span class="in">```</span></span>
<span id="cb13-322"><a href="#cb13-322"></a></span>
<span id="cb13-323"><a href="#cb13-323"></a>Next I'll plot confusion matrices for each set of predictions.</span>
<span id="cb13-324"><a href="#cb13-324"></a></span>
<span id="cb13-327"><a href="#cb13-327"></a><span class="in">```{r}</span></span>
<span id="cb13-328"><a href="#cb13-328"></a><span class="co">#| label: plot-conf-mats</span></span>
<span id="cb13-329"><a href="#cb13-329"></a></span>
<span id="cb13-330"><a href="#cb13-330"></a>conf_mats <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">base =</span> base_preds, <span class="at">upsample =</span> upsample_preds) <span class="sc">|&gt;</span></span>
<span id="cb13-331"><a href="#cb13-331"></a>  <span class="fu">map</span>(</span>
<span id="cb13-332"><a href="#cb13-332"></a>    \(x) <span class="fu">list</span>(</span>
<span id="cb13-333"><a href="#cb13-333"></a>      <span class="fu">conf_mat</span>(x, <span class="at">truth =</span> truth, <span class="at">estimate =</span> pred_class),</span>
<span id="cb13-334"><a href="#cb13-334"></a>      <span class="fu">conf_mat</span>(x, <span class="at">truth =</span> truth, <span class="at">estimate =</span> opt_pred_class)</span>
<span id="cb13-335"><a href="#cb13-335"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb13-336"><a href="#cb13-336"></a>      <span class="fu">set_names</span>(<span class="st">"standard"</span>, <span class="st">"optimal"</span>)</span>
<span id="cb13-337"><a href="#cb13-337"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-338"><a href="#cb13-338"></a>  <span class="fu">list_flatten</span>()</span>
<span id="cb13-339"><a href="#cb13-339"></a></span>
<span id="cb13-340"><a href="#cb13-340"></a>conf_mat_plots <span class="ot">&lt;-</span> conf_mats <span class="sc">|&gt;</span></span>
<span id="cb13-341"><a href="#cb13-341"></a>  <span class="fu">imap</span>(</span>
<span id="cb13-342"><a href="#cb13-342"></a>    \(x, y) {</span>
<span id="cb13-343"><a href="#cb13-343"></a>      plot_title <span class="ot">&lt;-</span> <span class="fu">str_replace</span>(y, <span class="st">"_"</span>, <span class="st">" "</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-344"><a href="#cb13-344"></a>        <span class="fu">str_to_title</span>()</span>
<span id="cb13-345"><a href="#cb13-345"></a>      </span>
<span id="cb13-346"><a href="#cb13-346"></a>      <span class="fu">autoplot</span>(x, <span class="at">type =</span> <span class="st">"heatmap"</span>) <span class="sc">+</span></span>
<span id="cb13-347"><a href="#cb13-347"></a>        <span class="fu">ggtitle</span>(plot_title) <span class="sc">+</span></span>
<span id="cb13-348"><a href="#cb13-348"></a>        <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb13-349"><a href="#cb13-349"></a>    }</span>
<span id="cb13-350"><a href="#cb13-350"></a>  )</span>
<span id="cb13-351"><a href="#cb13-351"></a></span>
<span id="cb13-352"><a href="#cb13-352"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(<span class="at">plotlist =</span> conf_mat_plots)</span>
<span id="cb13-353"><a href="#cb13-353"></a><span class="in">```</span></span>
<span id="cb13-354"><a href="#cb13-354"></a></span>
<span id="cb13-355"><a href="#cb13-355"></a>The above confusion matrices show that both changing the probability threshold for classification as a bad loan and upsampling have a significant impact on the number of positive predictions ("bad" loan), even though most of those are predicted incorrectly with this model. It's also interesting to note that doing both – changing the probability threshold and upsampling – shows very little improvement over doing just one or the other. Below are some classification metrics for each model specification.</span>
<span id="cb13-356"><a href="#cb13-356"></a></span>
<span id="cb13-359"><a href="#cb13-359"></a><span class="in">```{r}</span></span>
<span id="cb13-360"><a href="#cb13-360"></a><span class="co">#| label: compare-metrics</span></span>
<span id="cb13-361"><a href="#cb13-361"></a></span>
<span id="cb13-362"><a href="#cb13-362"></a>conf_mats <span class="sc">|&gt;</span></span>
<span id="cb13-363"><a href="#cb13-363"></a>  <span class="fu">imap</span>(</span>
<span id="cb13-364"><a href="#cb13-364"></a>    \(x, y) <span class="fu">summary</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb13-365"><a href="#cb13-365"></a>      <span class="fu">select</span>(<span class="sc">-</span>.estimator) <span class="sc">|&gt;</span></span>
<span id="cb13-366"><a href="#cb13-366"></a>      <span class="fu">set_names</span>(<span class="st">"metric"</span>, <span class="fu">str_replace</span>(y, <span class="st">"_"</span>, <span class="st">" "</span>) <span class="sc">|&gt;</span> <span class="fu">str_to_title</span>())</span>
<span id="cb13-367"><a href="#cb13-367"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-368"><a href="#cb13-368"></a>  <span class="fu">reduce</span>(left_join, <span class="at">by =</span> <span class="st">"metric"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-369"><a href="#cb13-369"></a>  <span class="fu">kable</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-370"><a href="#cb13-370"></a>  <span class="fu">kable_styling</span>(<span class="st">"striped"</span>)</span>
<span id="cb13-371"><a href="#cb13-371"></a><span class="in">```</span></span>
<span id="cb13-372"><a href="#cb13-372"></a></span>
<span id="cb13-373"><a href="#cb13-373"></a>The first thing that one might notices from the above is how high the accuracy is for the base model. It's important to remember, though, that when a data set is so unbalanced all a model has to do is predict the majority class all the time and it will have high accuracy. That model, though, has a very low sensitivity and high specificity. The high specificity, again, is due to the fact that the actual data has an overwhelming proportion of the majority class. Looking across at the metrics for the other models one sees drops in both accuracy and specificity, but much more significant increases in sensitivity from the base model. It's also useful to note that other metrics like balanced accuracy, kappa, mcc, and f_measure also improve. This is further evidence of the effect that the imbalance in classes has on the base model.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>