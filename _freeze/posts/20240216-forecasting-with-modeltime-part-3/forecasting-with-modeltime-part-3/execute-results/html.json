{
  "hash": "43aefd528fa57bb732b458c5bec473bc",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Forecasting with {modeltime} - Part III\"\nsubtitle: \"Global vs. iterative modeling\"\nauthor: \"Arcenis Rojas\"\ndate: \"2/16/2024\"\nbibliography: references.bib\nfig-height: 6\nfig-width: 8\ncategories:\n  - time series analysis\n  - econometrics\n  - data viz\n  - regression\n---\n\n\nIn my previous post on this topic – [Forecasting with {modeltime} - Part II](../20240215-forecasting-with-modeltime-part-2/forecasting-with-modeltime-part-2.qmd) – I performed a basic analysis of the Case-Shiller HPI time series for four U.S. cities (Dallas, Detroit, NYC, and San Diego). In this post I'm going to use some of the conclusions from that analysis to build ARIMA models using both a \"global\" modeling process and an \"iterative\" modeling process using the [modeltime](https://business-science.github.io/modeltime/index.html) [@modeltime] and [tidymodels](https://www.tidymodels.org/) [@tidymodels] frameworks.\n\nOne of the distinguishing features of `modeltime` among other time series modeling frameworks is that it works very well with `tidymodels`. In fact, like `tidymodels` , `modeltime` serves as a platform for building consistent workflows using algorithms from other packages. `modeltime` builds on top of `tidymodels` to create a framework for dealing with the specific challenges of time series modelling and putting it all in a convenient, consistent API.\n\nI'll also be using [tidyverse](https://www.tidyverse.org/) [@tidyverse] and [gt](https://gt.rstudio.com/) [@gt], per usual, and [timetk](https://business-science.github.io/timetk/) [@timetk]. `modeltime` and `timetk` are developed and maintained by the good people at [Business Science](https://www.business-science.io/) and `tidyverse`, `tidymodels`, and `gt` are developed and maintained by the generous folks at [Posit](https://posit.co/).\n\n## Time Series Analysis Review\n\nIn the aforementioned time series analysis I found that the time series data for all four cities had a strong trend and a strong seasonal component. The trend was mostly muted by using a lag of 1 and the seasonal component of each series was generally muted by differencing twelve times, which makes sense given that the data are monthly (annual seasonal cycle). I was able to use these methods to greatly reduce the influence of non-stationary components according to the Augmented Dickey-Fuller test. The ACF and PACF plots led me to conclude to use an AR(3) and MA(5) ARIMA model. To deal with the seasonality I differenced the data twelve times. This will translate to a seasonal differencing component of (1) in the ARIMA model. In the previous post I wrote that I would be performing ARIMA rather than SARIMA... things change.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(timetk)\nlibrary(modeltime)\nlibrary(tidymodels)\nlibrary(gt)\nconflicted::conflict_prefer(\"filter\", \"dplyr\")\nconflicted::conflict_prefer(\"lag\", \"dplyr\")\ntidymodels_prefer()\n```\n:::\n\n\n\n\n## Differences between global and iterative modeling\n\nConventionally, time series models work by regressing the outcome – the most recent or future observation(s) – on previous observations of itself. We can refer to this as a \"local\" model because the variance in the data corresponds to only the single time series. A global model, on the other hand, pools the data to get a global variance and uses that information to make forecasts.\n\nThe primary advantages of a global model are speed and scalability. A second advantage is that each, individual forecasting model can \"learn\" from the history of the other time series that it's pooled with. The disadvantage is that each individual model will likely be less accurate than if it was fit on an individual basis.\n\nThe advantage of modeling time series locally and iteratively is that this process most likely yields the highest quality fit and accuracy for each, individual model. The disadvantage is that as the number of models grows, so do the computational burden and processing time.\n\nIn two sections below I'll demonstrate both processes with an ARIMA model using the parameters mentioned above and in the last section I'll compare the results from both.\n\n## Building a global ARIMA model\n\nAs mentioned above, `modeltime` follows the Tidymodels convention. As such, it starts with partitioning data into training and testing data sets, continues with writing a recipe and model specification (and combining them in a `workflow` object), follows with fitting the model, and continues with model evaluation and selection.\n\n::: callout-tip\nFor more information on the Tidymodels framework, please check out <https://www.tmwr.org/>.\n:::\n\n### Splitting data\n\nFor a global modeling process one can use the timetk::time_series_split() function which will create a list containing the data set, one vector of training data IDs and one of testing data IDs, and a 1-column data set containing all IDs.\n\nThe time_series_split() function uses 5 initial cross-validation periods by default with each one being progressively longer using a specified period of time as the assessment period. This assessment period is specified by the asses argument.\n\n\n::: {.cell}\n\n```{.r .cell-code}\necon_splits_global <- econ_data |>\n  time_series_split(\n    assess = \"2 year\",\n    cumulative = TRUE,\n    date_var = date   \n  )\n\nstr(econ_splits_global)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nList of 4\n $ data  : tibble [816 × 3] (S3: tbl_df/tbl/data.frame)\n  ..$ city: chr [1:816] \"Dallas\" \"San Diego\" \"New York\" \"Detroit\" ...\n  ..$ date: Date[1:816], format: \"2006-01-01\" \"2006-01-01\" ...\n  ..$ hpi : num [1:816] 122 247 213 127 121 ...\n $ in_id : int [1:720] 1 2 3 4 5 6 7 8 9 10 ...\n $ out_id: int [1:96] 721 722 723 724 725 726 727 728 729 730 ...\n $ id    : tibble [1 × 1] (S3: tbl_df/tbl/data.frame)\n  ..$ id: chr \"Slice1\"\n - attr(*, \"class\")= chr [1:2] \"ts_cv_split\" \"rsplit\"\n```\n\n\n:::\n:::\n\n\n### Specifying a modeling workflow and fit the model\n\nTo specify the workflow I'll first write the recipe...\n\n::: {.callout-caution title=\"Lagging/Differencing as a recipe step\" collapse=\"true\"}\nOne might be tempted to add lags and differences in the recipe, but this leads to a mess that's really difficult to get out of. It all starts with the fact that a lagged and/or differenced variable will have a different name and will create missing values. I found that it's best to handle these operations in the model specification.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\narima_rec_global <- recipe(hpi ~ date, data = training(econ_splits_global))\n\narima_rec_global |> summary() |> gt_bold_head()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"shtqkfvejh\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#shtqkfvejh table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#shtqkfvejh thead, #shtqkfvejh tbody, #shtqkfvejh tfoot, #shtqkfvejh tr, #shtqkfvejh td, #shtqkfvejh th {\n  border-style: none;\n}\n\n#shtqkfvejh p {\n  margin: 0;\n  padding: 0;\n}\n\n#shtqkfvejh .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#shtqkfvejh .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#shtqkfvejh .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#shtqkfvejh .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#shtqkfvejh .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#shtqkfvejh .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#shtqkfvejh .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#shtqkfvejh .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#shtqkfvejh .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#shtqkfvejh .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#shtqkfvejh .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#shtqkfvejh .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#shtqkfvejh .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#shtqkfvejh .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#shtqkfvejh .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#shtqkfvejh .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#shtqkfvejh .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#shtqkfvejh .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#shtqkfvejh .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#shtqkfvejh .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#shtqkfvejh .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#shtqkfvejh .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#shtqkfvejh .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#shtqkfvejh .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#shtqkfvejh .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#shtqkfvejh .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#shtqkfvejh .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#shtqkfvejh .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#shtqkfvejh .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#shtqkfvejh .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#shtqkfvejh .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#shtqkfvejh .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#shtqkfvejh .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#shtqkfvejh .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#shtqkfvejh .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#shtqkfvejh .gt_left {\n  text-align: left;\n}\n\n#shtqkfvejh .gt_center {\n  text-align: center;\n}\n\n#shtqkfvejh .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#shtqkfvejh .gt_font_normal {\n  font-weight: normal;\n}\n\n#shtqkfvejh .gt_font_bold {\n  font-weight: bold;\n}\n\n#shtqkfvejh .gt_font_italic {\n  font-style: italic;\n}\n\n#shtqkfvejh .gt_super {\n  font-size: 65%;\n}\n\n#shtqkfvejh .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#shtqkfvejh .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#shtqkfvejh .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#shtqkfvejh .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#shtqkfvejh .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#shtqkfvejh .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#shtqkfvejh .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"variable\">variable</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"type\">type</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"role\">role</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"source\">source</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"variable\" class=\"gt_row gt_left\">date</td>\n<td headers=\"type\" class=\"gt_row gt_center\">date</td>\n<td headers=\"role\" class=\"gt_row gt_left\">predictor</td>\n<td headers=\"source\" class=\"gt_row gt_left\">original</td></tr>\n    <tr><td headers=\"variable\" class=\"gt_row gt_left\">hpi</td>\n<td headers=\"type\" class=\"gt_row gt_center\">double, numeric</td>\n<td headers=\"role\" class=\"gt_row gt_left\">outcome</td>\n<td headers=\"source\" class=\"gt_row gt_left\">original</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n... then the model object.\n\nThe model specification below will be used for both processes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\narima_spec <- arima_reg(         # <1>\n  non_seasonal_ar = 3,           # <2>\n  non_seasonal_ma = 5,           # <3>\n  non_seasonal_differences = 1,  # <4>\n  seasonal_differences = 1,      # <5>\n  seasonal_period = 12           # <6>\n) |>\n  set_engine(\"arima\")            # <7>\n\narima_spec\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nARIMA Regression Model Specification (regression)\n\nMain Arguments:\n  seasonal_period = 12\n  non_seasonal_ar = 3\n  non_seasonal_differences = 1\n  non_seasonal_ma = 5\n  seasonal_differences = 1\n\nComputational engine: arima \n```\n\n\n:::\n:::\n\n\n1.  Call the API for building ARIMA models\n2.  Set the AR order (*p* in conventional notation)\n3.  Set the MA order (*q* in conventional notation)\n4.  Set the degree of non-seasonal differencing (*d* in conventional notation)\n5.  Set the degree of seasonal differencing (*D* in conventional notation)\n6.  Set the length of the seasonal period\n7.  Set the modeling engine to `stats::arima()`\n\nNow that those are complete I can put them together in a `workflow` object.\n\n\n::: {.cell}\n\n```{.r .cell-code}\narima_wflow_global <- workflow() |>   # <1>\n  add_model(arima_spec) |>            # <2>\n  add_recipe(arima_rec_global)        # <3>\n\narima_wflow_global\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n══ Workflow ════════════════════════════════════════════════════════════════════\nPreprocessor: Recipe\nModel: arima_reg()\n\n── Preprocessor ────────────────────────────────────────────────────────────────\n0 Recipe Steps\n\n── Model ───────────────────────────────────────────────────────────────────────\nARIMA Regression Model Specification (regression)\n\nMain Arguments:\n  seasonal_period = 12\n  non_seasonal_ar = 3\n  non_seasonal_differences = 1\n  non_seasonal_ma = 5\n  seasonal_differences = 1\n\nComputational engine: arima \n```\n\n\n:::\n:::\n\n\n1.  Create a container for a `workflow` object\n2.  Add the above model specification\n3.  Add the recipe\n\nThe final step here is to fit the model\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglobal_fit_start <- proc.time()\n\narima_fit_global <- arima_wflow_global |>\n  fit(training(econ_splits_global))\n\nglobal_fit_end <- proc.time()\n\narima_fit_global\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n══ Workflow [trained] ══════════════════════════════════════════════════════════\nPreprocessor: Recipe\nModel: arima_reg()\n\n── Preprocessor ────────────────────────────────────────────────────────────────\n0 Recipe Steps\n\n── Model ───────────────────────────────────────────────────────────────────────\nSeries: outcome \nARIMA(3,1,5)(0,1,0)[12] \n\nCoefficients:\n          ar1      ar2      ar3     ma1     ma2      ma3     ma4     ma5\n      -1.0582  -0.9518  -0.8510  0.3737  0.1482  -0.2853  0.3877  0.5537\ns.e.   0.0215   0.0290   0.0211  0.0424  0.0587   0.0406  0.0251  0.0324\n\nsigma^2 = 1.659:  log likelihood = -1186.55\nAIC=2391.11   AICc=2391.37   BIC=2432.16\n```\n\n\n:::\n:::\n\n\n### Model evaluation\n\nTo deal with some of the characteristics specific to time series modeling, the `modeltime` framework uses conventions like the `mdl_time_tbl` (modeltime table) class to store a variety of elements of a time series model including accuracy metrics. This class is also used in model calibration and refitting for future forecasting. Here I'll write the modeltime table for the global process.\n\nI'm showing the model time table using a `print()` method rather than as a `gt` table because the list in the second column (list) would render in a cumbersome way.\n\n\n::: {.cell}\n\n```{.r .cell-code}\narima_mtt_global <- modeltime_table(arima_fit_global)\n\narima_mtt_global\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Modeltime Table\n# A tibble: 1 × 3\n  .model_id .model     .model_desc            \n      <int> <list>     <chr>                  \n1         1 <workflow> ARIMA(3,1,5)(0,1,0)[12]\n```\n\n\n:::\n:::\n\n\nThis table contains the model and some additional information about it. I'll now use this table to calibrate the global model to the individual time series with\n\n\n::: {.cell}\n\n```{.r .cell-code}\narima_calib_global <- arima_mtt_global |>\n  modeltime_calibrate(new_data = testing(econ_splits_global), id = \"city\")\n\narima_calib_global\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Modeltime Table\n# A tibble: 1 × 5\n  .model_id .model     .model_desc             .type .calibration_data\n      <int> <list>     <chr>                   <chr> <list>           \n1         1 <workflow> ARIMA(3,1,5)(0,1,0)[12] Test  <tibble [96 × 5]>\n```\n\n\n:::\n:::\n\n\nWith the calibration done I can now look at the accuracy of the model both at a global level and at an individual model level.\n\nGetting the accuracy is done by the same function: `modeltime_accuracy()`. Whether it outputs global or local model accuracy is determined by the `acc_by_id` argument.\n\n#### Global model accuracy\n\n\n::: {#tbl-acc-global .cell}\n\n```{.r .cell-code}\narima_calib_global |>\n  modeltime_accuracy(acc_by_id = FALSE) |>  \n  table_modeltime_accuracy(.interactive = FALSE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"wjoqrmulpw\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#wjoqrmulpw table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#wjoqrmulpw thead, #wjoqrmulpw tbody, #wjoqrmulpw tfoot, #wjoqrmulpw tr, #wjoqrmulpw td, #wjoqrmulpw th {\n  border-style: none;\n}\n\n#wjoqrmulpw p {\n  margin: 0;\n  padding: 0;\n}\n\n#wjoqrmulpw .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#wjoqrmulpw .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#wjoqrmulpw .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#wjoqrmulpw .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#wjoqrmulpw .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#wjoqrmulpw .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wjoqrmulpw .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#wjoqrmulpw .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#wjoqrmulpw .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#wjoqrmulpw .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#wjoqrmulpw .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#wjoqrmulpw .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#wjoqrmulpw .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#wjoqrmulpw .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#wjoqrmulpw .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#wjoqrmulpw .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#wjoqrmulpw .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#wjoqrmulpw .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#wjoqrmulpw .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wjoqrmulpw .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#wjoqrmulpw .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#wjoqrmulpw .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#wjoqrmulpw .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wjoqrmulpw .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#wjoqrmulpw .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#wjoqrmulpw .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wjoqrmulpw .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wjoqrmulpw .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#wjoqrmulpw .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wjoqrmulpw .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#wjoqrmulpw .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wjoqrmulpw .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#wjoqrmulpw .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wjoqrmulpw .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#wjoqrmulpw .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wjoqrmulpw .gt_left {\n  text-align: left;\n}\n\n#wjoqrmulpw .gt_center {\n  text-align: center;\n}\n\n#wjoqrmulpw .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#wjoqrmulpw .gt_font_normal {\n  font-weight: normal;\n}\n\n#wjoqrmulpw .gt_font_bold {\n  font-weight: bold;\n}\n\n#wjoqrmulpw .gt_font_italic {\n  font-style: italic;\n}\n\n#wjoqrmulpw .gt_super {\n  font-size: 65%;\n}\n\n#wjoqrmulpw .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#wjoqrmulpw .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#wjoqrmulpw .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#wjoqrmulpw .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#wjoqrmulpw .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#wjoqrmulpw .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#wjoqrmulpw .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"9\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>Accuracy Table</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".model_id\">.model_id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".model_desc\">.model_desc</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".type\">.type</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mae\">mae</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mape\">mape</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mase\">mase</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"smape\">smape</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"rmse\">rmse</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"rsq\">rsq</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\".model_id\" class=\"gt_row gt_right\">1</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">ARIMA(3,1,5)(0,1,0)[12]</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">19.61</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">6.3</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">0.18</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">6.6</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">29.38</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.94</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n#### Local model accuracy\n\n\n::: {#tbl-acc-global-local .cell tbl-cap='global model accuracy table'}\n\n```{.r .cell-code}\narima_calib_global |>\n  modeltime_accuracy(acc_by_id = TRUE) |>\n  table_modeltime_accuracy(.interactive = FALSE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"oqowoivqxm\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#oqowoivqxm table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#oqowoivqxm thead, #oqowoivqxm tbody, #oqowoivqxm tfoot, #oqowoivqxm tr, #oqowoivqxm td, #oqowoivqxm th {\n  border-style: none;\n}\n\n#oqowoivqxm p {\n  margin: 0;\n  padding: 0;\n}\n\n#oqowoivqxm .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#oqowoivqxm .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#oqowoivqxm .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#oqowoivqxm .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#oqowoivqxm .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#oqowoivqxm .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#oqowoivqxm .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#oqowoivqxm .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#oqowoivqxm .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#oqowoivqxm .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#oqowoivqxm .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#oqowoivqxm .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#oqowoivqxm .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#oqowoivqxm .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#oqowoivqxm .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#oqowoivqxm .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#oqowoivqxm .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#oqowoivqxm .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#oqowoivqxm .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#oqowoivqxm .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#oqowoivqxm .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#oqowoivqxm .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#oqowoivqxm .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#oqowoivqxm .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#oqowoivqxm .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#oqowoivqxm .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#oqowoivqxm .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#oqowoivqxm .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#oqowoivqxm .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#oqowoivqxm .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#oqowoivqxm .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#oqowoivqxm .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#oqowoivqxm .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#oqowoivqxm .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#oqowoivqxm .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#oqowoivqxm .gt_left {\n  text-align: left;\n}\n\n#oqowoivqxm .gt_center {\n  text-align: center;\n}\n\n#oqowoivqxm .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#oqowoivqxm .gt_font_normal {\n  font-weight: normal;\n}\n\n#oqowoivqxm .gt_font_bold {\n  font-weight: bold;\n}\n\n#oqowoivqxm .gt_font_italic {\n  font-style: italic;\n}\n\n#oqowoivqxm .gt_super {\n  font-size: 65%;\n}\n\n#oqowoivqxm .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#oqowoivqxm .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#oqowoivqxm .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#oqowoivqxm .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#oqowoivqxm .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#oqowoivqxm .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#oqowoivqxm .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"10\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>Accuracy Table</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".model_id\">.model_id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".model_desc\">.model_desc</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".type\">.type</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"city\">city</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mae\">mae</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mape\">mape</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mase\">mase</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"smape\">smape</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"rmse\">rmse</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"rsq\">rsq</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\".model_id\" class=\"gt_row gt_right\">1</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">ARIMA(3,1,5)(0,1,0)[12]</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"city\" class=\"gt_row gt_left\">Dallas</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">23.44</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">8.36</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">4.48</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">8.85</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">27.63</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.86</td></tr>\n    <tr><td headers=\".model_id\" class=\"gt_row gt_right\">1</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">ARIMA(3,1,5)(0,1,0)[12]</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"city\" class=\"gt_row gt_left\">Detroit</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">6.47</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">3.89</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">3.68</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">3.74</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">9.62</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.82</td></tr>\n    <tr><td headers=\".model_id\" class=\"gt_row gt_right\">1</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">ARIMA(3,1,5)(0,1,0)[12]</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"city\" class=\"gt_row gt_left\">New York</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">3.80</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">1.45</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">1.60</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">1.43</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">5.15</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.95</td></tr>\n    <tr><td headers=\".model_id\" class=\"gt_row gt_right\">1</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">ARIMA(3,1,5)(0,1,0)[12]</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"city\" class=\"gt_row gt_left\">San Diego</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">44.73</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">11.49</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">5.93</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">12.36</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">50.70</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.68</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\nFor comparison you can jump ahead to see the [iterative model accuracy table @tbl-acc-iterative].\n\n#### Accuracy plot\n\nBelow is a visual representation of how the models performed against the test data (the last 2 years).\n\n\n::: {.cell}\n\n```{.r .cell-code}\narima_calib_global |>                            # <1>\n  modeltime_forecast(                            # <2>\n    new_data = testing(econ_splits_global),      # <3>\n    actual_data = econ_data,                     # <4>\n    conf_by_id = TRUE,                           # <5>\n    keep_data = TRUE                             # <6>\n  ) |>\n  group_by(city) |>                              # <7>\n  plot_modeltime_forecast(                       # <8>\n    .interactive = FALSE,\n    .title = \"Forecast of Test Data - Global\",\n    .facet_ncol = 2\n  ) +\n  theme(plot.title = element_text(hjust = 0.5))\n```\n\n::: {.cell-output-display}\n![global model accuracy plot](forecasting-with-modeltime-part-3_files/figure-html/fig-acc-global-1.png){#fig-acc-global width=768}\n:::\n:::\n\n\n1.  Call up the object containing the calibrated models\n2.  Call the `modeltime_forecast()` function\n3.  Specify the new data to test forecasts against; in this case it's the testing split from the object created by `time_series_split()`\n4.  Specify what to use as the actual data; in this case it's the original `econ_data` object\n5.  Specify whether to generate confidence intervals by individual data series\n6.  Specify whether to keep the columns from the actual data; I specified `TRUE` to keep the \"city\" column\n7.  Group by city to generate the forecasts by city\n8.  Plot the forecasts as a stationary plot\n\nFor comparison you can jump ahead to see the [iterative model accuracy plot @fig-acc-iterative].\n\n### Forecasting the future\n\nThe first step in getting forecasts for the future (with respect to the available data) is to refit the model using all of the training data after calibrating the model. That is done with the `modeltime_refit()` function for a global process.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglobal_refit_start <- proc.time()\n\narima_refit_global <- modeltime_refit(arima_calib_global, data = econ_data) \n\nglobal_refit_end <- proc.time()\n\narima_refit_global\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Modeltime Table\n# A tibble: 1 × 5\n  .model_id .model     .model_desc             .type .calibration_data\n      <int> <list>     <chr>                   <chr> <list>           \n1         1 <workflow> ARIMA(3,1,5)(0,1,0)[12] Test  <tibble [96 × 5]>\n```\n\n\n:::\n:::\n\n\nThe next step is to build a container for the data that has all the correct dates and ID columns. This is done with `timetk::future_frame()` .\n\n::: {.callout-caution title=\"future_frame() with multiple series\" collapse=\"true\"}\n`future_frame()` only generates one series per data set fed to it, so it's really important to group the data before executing the function if you have multiple series or you'll only get one series of future dates.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\narima_future_global <- econ_data |>\n  group_by(city) |>\n  future_frame(.length_out = 12, .bind_data = FALSE, .date_var = date)\n```\n:::\n\n\nAnd finally one can generate a plot of the forecasts with `modeltime_forecast()` and plot the time series with `plot_modeltime_forecast()` . Better not forget to group by series!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nforecast_future_global <- arima_refit_global |>\n  modeltime_forecast(\n    new_data = arima_future_global,\n    actual_data = econ_data,\n    conf_by_id = TRUE\n  )\n\nforecast_future_global |>\n  group_by(city) |>\n  plot_modeltime_forecast(\n    .interactive = FALSE,\n    .title = \"1 Year Forecast into the Future - Global\",\n    .facet_ncol = 2\n  ) +\n  theme(plot.title = element_text(hjust = 0.5))\n```\n\n::: {.cell-output-display}\n![](forecasting-with-modeltime-part-3_files/figure-html/fig-forecast-future-global-1.png){#fig-forecast-future-global width=768}\n:::\n:::\n\n\n## Building an iterative ARIMA model\n\nNow I'll go through an iterative modeling workflow with the same model parameters for comparison. A key difference in the workflow is that the iterative model requires the construction of a nested table.\n\nIn `modeltime` iterative forecasting is called [\"Nested Forecasting\"](https://business-science.github.io/modeltime/articles/nested-forecasting.html?q=nested#nested-forecasting).\n\n### Splitting data\n\nOne of the big differences in building a nested model from building a global model in `modeltime` happens right at the beginning with splitting the data. With this method the future dates are added right up front with `extend_timeseries()` , the length of actual data is distinguished from that of future periods in `nest_timeseries()` and the train/test split is created with `split_nested_timeseries()` .\n\n\n::: {.cell}\n\n```{.r .cell-code}\necon_splits_iterative <- econ_data |>\n  extend_timeseries(\n    .id_var = city,\n    .date_var = date,\n    .length_future = 12\n  ) |>\n  nest_timeseries(\n    .id_var = city,\n    .length_future = 12,\n    .length_actual = 17 * 12\n  ) |>\n  split_nested_timeseries(.length_test = 24)\n\necon_splits_iterative\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 4\n  city      .actual_data       .future_data      .splits         \n  <chr>     <list>             <list>            <list>          \n1 Dallas    <tibble [204 × 2]> <tibble [12 × 2]> <split [180|24]>\n2 Detroit   <tibble [204 × 2]> <tibble [12 × 2]> <split [180|24]>\n3 New York  <tibble [204 × 2]> <tibble [12 × 2]> <split [180|24]>\n4 San Diego <tibble [204 × 2]> <tibble [12 × 2]> <split [180|24]>\n```\n\n\n:::\n:::\n\n\n### Specifying a modeling workflow and fit the model\n\nI'll use the same model specification as above, but the recipe has to be specified to use the new splits object.\n\n\n::: {.cell}\n\n```{.r .cell-code}\narima_rec_iterative <- recipe(\n  hpi ~ date,\n  extract_nested_train_split(econ_splits_iterative)\n)\n\narima_rec_iterative |> summary() |> gt_bold_head()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"qvypoaypxa\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#qvypoaypxa table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#qvypoaypxa thead, #qvypoaypxa tbody, #qvypoaypxa tfoot, #qvypoaypxa tr, #qvypoaypxa td, #qvypoaypxa th {\n  border-style: none;\n}\n\n#qvypoaypxa p {\n  margin: 0;\n  padding: 0;\n}\n\n#qvypoaypxa .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#qvypoaypxa .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#qvypoaypxa .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#qvypoaypxa .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#qvypoaypxa .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#qvypoaypxa .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qvypoaypxa .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#qvypoaypxa .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#qvypoaypxa .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#qvypoaypxa .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#qvypoaypxa .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#qvypoaypxa .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#qvypoaypxa .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#qvypoaypxa .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#qvypoaypxa .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#qvypoaypxa .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#qvypoaypxa .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#qvypoaypxa .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#qvypoaypxa .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qvypoaypxa .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#qvypoaypxa .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#qvypoaypxa .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#qvypoaypxa .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qvypoaypxa .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#qvypoaypxa .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#qvypoaypxa .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qvypoaypxa .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qvypoaypxa .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#qvypoaypxa .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qvypoaypxa .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#qvypoaypxa .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#qvypoaypxa .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#qvypoaypxa .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qvypoaypxa .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#qvypoaypxa .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#qvypoaypxa .gt_left {\n  text-align: left;\n}\n\n#qvypoaypxa .gt_center {\n  text-align: center;\n}\n\n#qvypoaypxa .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#qvypoaypxa .gt_font_normal {\n  font-weight: normal;\n}\n\n#qvypoaypxa .gt_font_bold {\n  font-weight: bold;\n}\n\n#qvypoaypxa .gt_font_italic {\n  font-style: italic;\n}\n\n#qvypoaypxa .gt_super {\n  font-size: 65%;\n}\n\n#qvypoaypxa .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#qvypoaypxa .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#qvypoaypxa .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#qvypoaypxa .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#qvypoaypxa .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#qvypoaypxa .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#qvypoaypxa .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"variable\">variable</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"type\">type</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"role\">role</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"source\">source</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"variable\" class=\"gt_row gt_left\">date</td>\n<td headers=\"type\" class=\"gt_row gt_center\">date</td>\n<td headers=\"role\" class=\"gt_row gt_left\">predictor</td>\n<td headers=\"source\" class=\"gt_row gt_left\">original</td></tr>\n    <tr><td headers=\"variable\" class=\"gt_row gt_left\">hpi</td>\n<td headers=\"type\" class=\"gt_row gt_center\">double, numeric</td>\n<td headers=\"role\" class=\"gt_row gt_left\">outcome</td>\n<td headers=\"source\" class=\"gt_row gt_left\">original</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\nI'll also create a new workflow object that just updates the previous one with the new recipe.\n\n\n::: {.cell}\n\n```{.r .cell-code}\narima_wflow_iterative <- arima_wflow_global |>\n  update_recipe(arima_rec_iterative)\n\narima_wflow_iterative\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n══ Workflow ════════════════════════════════════════════════════════════════════\nPreprocessor: Recipe\nModel: arima_reg()\n\n── Preprocessor ────────────────────────────────────────────────────────────────\n0 Recipe Steps\n\n── Model ───────────────────────────────────────────────────────────────────────\nARIMA Regression Model Specification (regression)\n\nMain Arguments:\n  seasonal_period = 12\n  non_seasonal_ar = 3\n  non_seasonal_differences = 1\n  non_seasonal_ma = 5\n  seasonal_differences = 1\n\nComputational engine: arima \n```\n\n\n:::\n:::\n\n\nAnd now I'll fit the model to all four cities iteratively using `modeltime_nested_fit()` .\n\n\n::: {.cell}\n\n```{.r .cell-code}\niterative_fit_start <- proc.time()\n\narima_fit_iterative <- econ_splits_iterative |>\n  modeltime_nested_fit(arima_wflow_iterative)\n\niterative_fit_end <- proc.time()\n\narima_fit_iterative\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Nested Modeltime Table\n  # A tibble: 4 × 5\n  city      .actual_data       .future_data .splits          .modeltime_tables \n  <chr>     <list>             <list>       <list>           <list>            \n1 Dallas    <tibble [204 × 2]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n2 Detroit   <tibble [204 × 2]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n3 New York  <tibble [204 × 2]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n4 San Diego <tibble [204 × 2]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n```\n\n\n:::\n:::\n\n\n### Model evaluation\n\n#### Local model accuracy\n\n\n::: {#tbl-acc-iterative .cell tbl-cap='iterative model accuracy table'}\n\n```{.r .cell-code}\narima_fit_iterative |>\n  extract_nested_test_accuracy() |>\n  table_modeltime_accuracy(.interactive = FALSE)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"lpharqqdit\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#lpharqqdit table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#lpharqqdit thead, #lpharqqdit tbody, #lpharqqdit tfoot, #lpharqqdit tr, #lpharqqdit td, #lpharqqdit th {\n  border-style: none;\n}\n\n#lpharqqdit p {\n  margin: 0;\n  padding: 0;\n}\n\n#lpharqqdit .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#lpharqqdit .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#lpharqqdit .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#lpharqqdit .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#lpharqqdit .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#lpharqqdit .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#lpharqqdit .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#lpharqqdit .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#lpharqqdit .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#lpharqqdit .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#lpharqqdit .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#lpharqqdit .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#lpharqqdit .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#lpharqqdit .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#lpharqqdit .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#lpharqqdit .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#lpharqqdit .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#lpharqqdit .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#lpharqqdit .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#lpharqqdit .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#lpharqqdit .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#lpharqqdit .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#lpharqqdit .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#lpharqqdit .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#lpharqqdit .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#lpharqqdit .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#lpharqqdit .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#lpharqqdit .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#lpharqqdit .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#lpharqqdit .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#lpharqqdit .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#lpharqqdit .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#lpharqqdit .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#lpharqqdit .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#lpharqqdit .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#lpharqqdit .gt_left {\n  text-align: left;\n}\n\n#lpharqqdit .gt_center {\n  text-align: center;\n}\n\n#lpharqqdit .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#lpharqqdit .gt_font_normal {\n  font-weight: normal;\n}\n\n#lpharqqdit .gt_font_bold {\n  font-weight: bold;\n}\n\n#lpharqqdit .gt_font_italic {\n  font-style: italic;\n}\n\n#lpharqqdit .gt_super {\n  font-size: 65%;\n}\n\n#lpharqqdit .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#lpharqqdit .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#lpharqqdit .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#lpharqqdit .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#lpharqqdit .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#lpharqqdit .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#lpharqqdit .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"10\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>Accuracy Table</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"city\">city</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".model_id\">.model_id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".model_desc\">.model_desc</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\".type\">.type</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mae\">mae</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mape\">mape</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"mase\">mase</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"smape\">smape</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"rmse\">rmse</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"rsq\">rsq</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"city\" class=\"gt_row gt_left\">Dallas</td>\n<td headers=\".model_id\" class=\"gt_row gt_right\">1</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">ARIMA</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">40.94</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">14.63</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">7.82</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">16.09</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">46.48</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.81</td></tr>\n    <tr><td headers=\"city\" class=\"gt_row gt_left\">Detroit</td>\n<td headers=\".model_id\" class=\"gt_row gt_right\">1</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">ARIMA</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">4.64</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">2.84</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">2.64</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">2.88</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">5.38</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.84</td></tr>\n    <tr><td headers=\"city\" class=\"gt_row gt_left\">New York</td>\n<td headers=\".model_id\" class=\"gt_row gt_right\">1</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">ARIMA</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">5.35</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">2.04</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">2.25</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">2.07</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">6.91</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.89</td></tr>\n    <tr><td headers=\"city\" class=\"gt_row gt_left\">San Diego</td>\n<td headers=\".model_id\" class=\"gt_row gt_right\">1</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">ARIMA</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">30.24</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">7.81</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">4.01</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">8.23</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">35.85</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.65</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\nYou can jump back to compare this with the [global model accuracy table @tbl-acc-global-local].\n\n#### Accuracy plot\n\nBelow is a visual representation of how the models from the iterative modeling process performed against the test data (the last 2 years).\n\n\n::: {.cell}\n\n```{.r .cell-code}\narima_fit_iterative |>\n  extract_nested_test_forecast() |>\n  group_by(city) |>\n  plot_modeltime_forecast(\n    .interactive = FALSE,\n    .title = \"Forecast of Test Data - Iterative\",\n    .facet_ncol = 2\n  ) +\n  theme(plot.title = element_text(hjust = 0.5))\n```\n\n::: {.cell-output-display}\n![iterative model accuracy plot](forecasting-with-modeltime-part-3_files/figure-html/fig-acc-iterative-1.png){#fig-acc-iterative width=768}\n:::\n:::\n\n\nYou can jump back to compare this with the [global model accuracy plot @fig-acc-global].\n\n### Forecasting the future\n\nAs with the global process above, the first step here will be to refit the model to the full training data set. Note that the iterative model process requires the use of `modeltime_nested_refit()` rather than `modeltime_refit()` .\n\n::: {.callout-caution title=\"control_* functions\" collapse=\"true\"}\n`modeltime` has separate `control_*` functions for different purposes such as this case in which `modeltime_refit()` has `control_refit()` and `modeltime_nested_refit()` has `control_nested_refit()`. Make sure to use the correct one.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\niterative_refit_start <- proc.time()\n\narima_refit_iterative <- arima_fit_iterative |>\n  modeltime_nested_refit(control = control_nested_refit(verbose = FALSE))\n\niterative_refit_end <- proc.time()\n\narima_refit_iterative\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Nested Modeltime Table\n  # A tibble: 4 × 5\n  city      .actual_data       .future_data .splits          .modeltime_tables \n  <chr>     <list>             <list>       <list>           <list>            \n1 Dallas    <tibble [204 × 2]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n2 Detroit   <tibble [204 × 2]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n3 New York  <tibble [204 × 2]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n4 San Diego <tibble [204 × 2]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n```\n\n\n:::\n:::\n\n\nSince the future data container was already created in the splitting object, I can go right to forecasting the future here.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nforecast_future_iterative <- arima_refit_iterative |>\n  extract_nested_future_forecast()\n\nforecast_future_iterative |>\n  group_by(city) |>\n  plot_modeltime_forecast(\n    .interactive = FALSE,\n    .title = \"1 Year Forecast into the Future - Global\",\n    .facet_ncol = 2\n  ) +\n  theme(plot.title = element_text(hjust = 0.5))\n```\n\n::: {.cell-output-display}\n![](forecasting-with-modeltime-part-3_files/figure-html/fig-forecast-future-iterative-1.png){#fig-forecast-future-iterative width=768}\n:::\n:::\n\n\n## Comparison\n\nThe two processes follow the same workflow, but have some key operational differences:\n\n-   Different structures for the data split objects\n\n-   The iterative workflow does not require calibration to the individual time series\n\n-   Processing time\n\nBelow are two tables showing the processing times for fitting and refitting the global and iterative models.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglobal_fit_time <- (global_fit_end - global_fit_start) |>\n  enframe(name = \"metric\") |>\n  mutate(value = as.numeric(value), model_process = \"Global Fit\") |>\n  drop_na()\n\niterative_fit_time <- (iterative_fit_end - iterative_fit_start) |>\n  enframe(name = \"metric\") |>\n  mutate(value = as.numeric(value), model_process = \"Iterative Fit\") |>\n  drop_na()\n\nbind_rows(global_fit_time, iterative_fit_time) |>\n  ggplot(\n    aes(x = metric, y = value, fill = model_process, group = model_process)\n  ) +\n  geom_col(position = \"dodge\") +\n  labs(\n    fill = NULL,\n    x = NULL,\n    y = \"Time in seconds\",\n    title = \"Comparison of Model Fit Processing Times\"\n  ) +\n  scale_fill_manual(values = c(\"red\", \"blue\")) +\n  theme_timetk +\n  theme(plot.title = element_text(hjust = 0.5))\n```\n\n::: {.cell-output-display}\n![](forecasting-with-modeltime-part-3_files/figure-html/fig-fit-proc-times-1.png){#fig-fit-proc-times width=576}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglobal_refit_time <- (global_refit_end - global_refit_start) |>\n  enframe(name = \"metric\") |>\n  mutate(value = as.numeric(value), model_process = \"Global Refit\") |>\n  drop_na()\n\niterative_refit_time <- (iterative_refit_end - iterative_refit_start) |>\n  enframe(name = \"metric\") |>\n  mutate(value = as.numeric(value), model_process = \"Iterative Refit\") |>\n  drop_na()\n\nbind_rows(global_refit_time, iterative_refit_time) |>\n  ggplot(\n    aes(x = metric, y = value, fill = model_process, group = model_process)\n  ) +\n  geom_col(position = \"dodge\") +\n  labs(\n    fill = NULL,\n    x = NULL,\n    y = \"Time in seconds\",\n    title = \"Model Refit Processing Times\"\n  ) +\n  scale_fill_manual(values = c(\"red\", \"blue\")) +\n  theme_timetk +\n  theme(plot.title = element_text(hjust = 0.5))\n```\n\n::: {.cell-output-display}\n![](forecasting-with-modeltime-part-3_files/figure-html/fig-refit-proc-times-1.png){#fig-refit-proc-times width=576}\n:::\n:::\n\n\nBesides these operational differences, the processes yield different levels of accuracy due to differences in the data on which they are trained (or to which they are initially fit). It's also clear that the differences in models can yield some very big differences in forecasts. Global models have performed well in competitions that involved thousands of time series, so it's possible that the variance across the four time series in this analysis is too high to make global modeling worthwhile.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npatchwork::wrap_plots(\n  forecast_future_global |>\n  group_by(city) |>\n  plot_modeltime_forecast(\n    .interactive = FALSE,\n    .title = \"1 Year Forecast into the Future - Global\",\n    .facet_ncol = 1\n  ) +\n  theme(plot.title = element_text(hjust = 0.5)),\n  forecast_future_iterative |>\n  group_by(city) |>\n  plot_modeltime_forecast(\n    .interactive = FALSE,\n    .title = \"1 Year Forecast into the Future - Iterative\",\n    .facet_ncol = 1\n  ) +\n  theme(plot.title = element_text(hjust = 0.5))\n)\n```\n\n::: {.cell-output-display}\n![](forecasting-with-modeltime-part-3_files/figure-html/show-both-forecasts-1.png){width=1152}\n:::\n:::\n\n\nIn the next post I'll run a global modeling process with a few different algorithms and specifications to get a few hundred models and find which ones run best.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}