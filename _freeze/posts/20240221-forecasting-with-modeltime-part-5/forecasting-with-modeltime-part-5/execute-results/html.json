{
  "hash": "c16bbd91194234b3f0b22c2d7dc422fc",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Forecasting with {modeltime} - Part V\"\nsubtitle: \"Selecting the best model for each city\"\nauthor: \"Arcenis Rojas\"\ndate: \"2/21/2024\"\nbibliography: references.bib\ncategories:\n  - Time Series\n  - Forecasting\n  - Machine Learning\nfig-width: 8\nfig-height: 8\n---\n\n\nThis is the final (planned) post for this series on the [modeltime](https://business-science.github.io/modeltime/index.html) [@modeltime] package I will identify the best model to forecast the Case-Shiller Home Price Index using an iterative modeling process. The models to work with will be the 11 models that I identified through the global modeling process in [Forecasting with {modeltime} - Part IV](../20240220-forecasting-with-modeltime-part-4/forecasting-with-modeltime-part-4.qmd). Additionally I'll be using [parallel](https://rdocumentation.org/packages/parallel/versions/3.6.2) [@parallel] for parallel processing, [tidymodels](https://www.tidymodels.org/) [@tidymodels] for a modeling framework, [tidyverse](https://www.tidyverse.org/) [@tidyverse] for data wrangling and visualization, and [gt](#0) [@gt] for table output.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(timetk)\nlibrary(modeltime)\nlibrary(tidymodels)\nlibrary(parallel)\nlibrary(gt)\nconflicted::conflict_prefer(\"filter\", \"dplyr\")\nconflicted::conflict_prefer(\"lag\", \"dplyr\")\ntidymodels_prefer()\n```\n:::\n\n\n\n\nBelow is a look at the names of the model specifications from the last post.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npart4_mods |> gt() |> gt_bold_head()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"vtzoeifemm\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#vtzoeifemm table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#vtzoeifemm thead, #vtzoeifemm tbody, #vtzoeifemm tfoot, #vtzoeifemm tr, #vtzoeifemm td, #vtzoeifemm th {\n  border-style: none;\n}\n\n#vtzoeifemm p {\n  margin: 0;\n  padding: 0;\n}\n\n#vtzoeifemm .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#vtzoeifemm .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#vtzoeifemm .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#vtzoeifemm .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#vtzoeifemm .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#vtzoeifemm .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vtzoeifemm .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#vtzoeifemm .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#vtzoeifemm .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#vtzoeifemm .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#vtzoeifemm .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#vtzoeifemm .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#vtzoeifemm .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#vtzoeifemm .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#vtzoeifemm .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#vtzoeifemm .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#vtzoeifemm .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#vtzoeifemm .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#vtzoeifemm .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vtzoeifemm .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#vtzoeifemm .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#vtzoeifemm .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#vtzoeifemm .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vtzoeifemm .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#vtzoeifemm .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#vtzoeifemm .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vtzoeifemm .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vtzoeifemm .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#vtzoeifemm .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vtzoeifemm .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#vtzoeifemm .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vtzoeifemm .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#vtzoeifemm .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vtzoeifemm .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#vtzoeifemm .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vtzoeifemm .gt_left {\n  text-align: left;\n}\n\n#vtzoeifemm .gt_center {\n  text-align: center;\n}\n\n#vtzoeifemm .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#vtzoeifemm .gt_font_normal {\n  font-weight: normal;\n}\n\n#vtzoeifemm .gt_font_bold {\n  font-weight: bold;\n}\n\n#vtzoeifemm .gt_font_italic {\n  font-style: italic;\n}\n\n#vtzoeifemm .gt_super {\n  font-size: 65%;\n}\n\n#vtzoeifemm .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#vtzoeifemm .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#vtzoeifemm .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#vtzoeifemm .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#vtzoeifemm .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#vtzoeifemm .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#vtzoeifemm .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\".model_desc\">.model_desc</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_ETS_DEFAULT</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_ARIMA_DEFAULT</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_ARIMA_SPEC2</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_ETS_SPEC14</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_ETS_SPEC6</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">DEMOG_REC_ARIMA_SPEC1</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">DEMOG_REC_ARIMA_SPEC3</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">NNET_REC_NNET_SPEC22</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">NNET_REC_NNET_SPEC9</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">NNET_REC_NNET_SPEC12</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_STLM_SPEC3</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\nAnd this is what the `workflowset` object looked like.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhpi_global_wfset\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A workflow set/tibble: 90 × 4\n   wflow_id               info             option    result    \n   <chr>                  <list>           <list>    <list>    \n 1 base_rec_arima_default <tibble [1 × 4]> <opts[0]> <list [0]>\n 2 base_rec_arima_spec1   <tibble [1 × 4]> <opts[0]> <list [0]>\n 3 base_rec_arima_spec2   <tibble [1 × 4]> <opts[0]> <list [0]>\n 4 base_rec_arima_spec3   <tibble [1 × 4]> <opts[0]> <list [0]>\n 5 base_rec_arima_spec4   <tibble [1 × 4]> <opts[0]> <list [0]>\n 6 econ_rec_arima_default <tibble [1 × 4]> <opts[0]> <list [0]>\n 7 econ_rec_arima_spec1   <tibble [1 × 4]> <opts[0]> <list [0]>\n 8 econ_rec_arima_spec2   <tibble [1 × 4]> <opts[0]> <list [0]>\n 9 econ_rec_arima_spec3   <tibble [1 × 4]> <opts[0]> <list [0]>\n10 econ_rec_arima_spec4   <tibble [1 × 4]> <opts[0]> <list [0]>\n# ℹ 80 more rows\n```\n\n\n:::\n:::\n\n\n## Filtering workflows\n\nI'll first filter the set of workflows to the 11 that I want to keep.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod_ids <- str_to_lower(part4_mods$.model_desc)\n\nhpi_global_wfset <- hpi_global_wfset |>\n  filter(wflow_id %in% mod_ids)\n```\n:::\n\n\nThese are all of the necessary workflows including recipes and model specifications.\n\n## Splitting the data\n\nNext up is creating the data split object. This is a different set of functions than what I used to split the data for the global modeling process. In this workflow the future dates get added for each city up front.\n\n\n::: {.cell}\n\n```{.r .cell-code}\necon_splits <- econ_data |>\n  extend_timeseries(\n    .id_var = city,\n    .date_var = date,\n    .length_future = 12\n  ) |>\n  nest_timeseries(\n    .id_var = city,\n    .length_future = 12,\n    .length_actual = 17 * 12\n  ) |>\n  split_nested_timeseries(.length_test = 24)\n\necon_splits\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 4\n  city      .actual_data        .future_data       .splits         \n  <chr>     <list>              <list>             <list>          \n1 Dallas    <tibble [204 × 15]> <tibble [12 × 15]> <split [180|24]>\n2 Detroit   <tibble [204 × 15]> <tibble [12 × 15]> <split [180|24]>\n3 New York  <tibble [204 × 15]> <tibble [12 × 15]> <split [180|24]>\n4 San Diego <tibble [204 × 15]> <tibble [12 × 15]> <split [180|24]>\n```\n\n\n:::\n:::\n\n\nWith these two objects prepared I can now fit the models iteratively for each city.\n\n## Fit models\n\nI'll first prepare a parallel processing cluster and set a random seed for each node then fit the models.\n\n::: callout-note\n`modeltime_nested_fit()` requires that models be specified individually rather than as a `workflowset` object.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncl <- makePSOCKcluster(nrow(part4_mods))\ndoParallel::registerDoParallel(cl)\ninvisible(\n  clusterCall(cl, function(x) .libPaths(x), .libPaths())\n)\nprint(cl)\ninvisible(clusterEvalQ(cl, set.seed(500)))\n\nhpi_wflowset <- modeltime_nested_fit(\n  econ_splits,\n  hpi_global_wfset |> extract_workflow(mod_ids[1]),\n  hpi_global_wfset |> extract_workflow(mod_ids[2]),\n  hpi_global_wfset |> extract_workflow(mod_ids[3]),\n  hpi_global_wfset |> extract_workflow(mod_ids[4]),\n  hpi_global_wfset |> extract_workflow(mod_ids[5]),\n  hpi_global_wfset |> extract_workflow(mod_ids[6]),\n  hpi_global_wfset |> extract_workflow(mod_ids[7]),\n  hpi_global_wfset |> extract_workflow(mod_ids[8]),\n  hpi_global_wfset |> extract_workflow(mod_ids[9]),\n  hpi_global_wfset |> extract_workflow(mod_ids[10]),\n  hpi_global_wfset |> extract_workflow(mod_ids[11]),\n  control = control_nested_fit(verbose = TRUE, allow_par = TRUE)\n)\n\nstopCluster(cl)\nrm(cl)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhpi_wflowset |> as_tibble()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 5\n  city      .actual_data        .future_data .splits          .modeltime_tables\n  <chr>     <list>              <list>       <list>           <list>           \n1 Dallas    <tibble [204 × 15]> <tibble>     <split [180|24]> <mdl_tm_t>       \n2 Detroit   <tibble [204 × 15]> <tibble>     <split [180|24]> <mdl_tm_t>       \n3 New York  <tibble [204 × 15]> <tibble>     <split [180|24]> <mdl_tm_t>       \n4 San Diego <tibble [204 × 15]> <tibble>     <split [180|24]> <mdl_tm_t>       \n```\n\n\n:::\n:::\n\n\nNotice that this object is grouped by city whereas the [corresponding object for the global modeling process](../20240220-forecasting-with-modeltime-part-4/forecasting-with-modeltime-part-4.html#fitting-the-models){target=\"_blank\"} is listed by model. This happens because `modeltime_nested_fit()` calls a split object that has the data grouped by ID already. All of the functions in the [modeltime Nested Forecasting](https://business-science.github.io/modeltime/articles/nested-forecasting.html) workflow geared toward doing things at the level of the ID variable, which is \"city\" in this case. Each row contains a `mdl_time_tbl` object in the \".modeltime_tables\" column for each row which has one row for each model that was fit to the data of the ID in that row. This `mdl_time_tbl` object contains calibration data, which gets created during the iterative modeling process. Below is an example.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhpi_wflowset |> slice(1) |> pluck(\".modeltime_tables\", 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Modeltime Table\n# A tibble: 11 × 5\n   .model_id .model       .model_desc           .type .calibration_data\n       <int> <named list> <chr>                 <chr> <list>           \n 1         1 <workflow>   ETSAADN               Test  <tibble [24 × 4]>\n 2         2 <workflow>   ARIMA                 Test  <tibble [24 × 4]>\n 3         3 <workflow>   ARIMA                 Test  <tibble [24 × 4]>\n 4         4 <workflow>   ETSAADA               Test  <tibble [24 × 4]>\n 5         5 <workflow>   ETSAADA               Test  <tibble [24 × 4]>\n 6         6 <workflow>   REGRESSION            Test  <tibble [24 × 4]>\n 7         7 <workflow>   REGRESSION            Test  <tibble [24 × 4]>\n 8         8 <NULL>       NULL                  <NA>  <lgl [1]>        \n 9         9 <NULL>       NULL                  <NA>  <lgl [1]>        \n10        10 <NULL>       NULL                  <NA>  <lgl [1]>        \n11        11 <workflow>   SEASONAL DECOMP ARIMA Test  <tibble [24 × 4]>\n```\n\n\n:::\n:::\n\n\n## Selecting the best models\n\n`{modeltime}` has the `modeltime_nested_select_best()` for selecting the best model for each ID in a nested model table. It requires the specification of a metric for determining which model is \"best\". As before, I'll use the Scaled Mean Average Percent Error (SMAPE).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhpi_best <- hpi_wflowset |>\n  modeltime_nested_select_best(\n    metric = \"smape\",\n    minimize = TRUE,\n    filter_test_forecasts = TRUE\n  )\n\nhpi_best\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Nested Modeltime Table\n  # A tibble: 4 × 5\n  city      .actual_data        .future_data .splits          .modeltime_tables \n  <chr>     <list>              <list>       <list>           <list>            \n1 Dallas    <tibble [204 × 15]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n2 Detroit   <tibble [204 × 15]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n3 New York  <tibble [204 × 15]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n4 San Diego <tibble [204 × 15]> <tibble>     <split [180|24]> <mdl_tm_t [1 × 5]>\n```\n\n\n:::\n:::\n\n\nNotice that after selecting the best model it's only the \".modeltime_tables\" column that changes. It now contains a table with one single row corresponding to the model that yielded the best value of the selected metric.\n\n## View accuracy best models\n\nOne gets the accuracy from a nested `modeltime` table by using `extract_nested_test_accuracy()` . Interestingly, this function shows the accuracy of all models even if it's run with the table of the \"best\" models. So below I'll use `group_by()` to get the accuracy for the best model for each city.\n\n\n::: {#tbl-show-acc .cell}\n\n```{.r .cell-code}\nhpi_wflowset |>\n  extract_nested_test_accuracy() |>\n  group_by(city) |>\n  slice_min(smape, n = 1) |>\n  ungroup() |>\n  table_modeltime_accuracy(.interactive = FALSE) |>\n  gt_bold_head()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"vaossgjhsw\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#vaossgjhsw table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#vaossgjhsw thead, #vaossgjhsw tbody, #vaossgjhsw tfoot, #vaossgjhsw tr, #vaossgjhsw td, #vaossgjhsw th {\n  border-style: none;\n}\n\n#vaossgjhsw p {\n  margin: 0;\n  padding: 0;\n}\n\n#vaossgjhsw .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#vaossgjhsw .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#vaossgjhsw .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#vaossgjhsw .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#vaossgjhsw .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#vaossgjhsw .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vaossgjhsw .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#vaossgjhsw .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#vaossgjhsw .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#vaossgjhsw .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#vaossgjhsw .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#vaossgjhsw .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#vaossgjhsw .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#vaossgjhsw .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#vaossgjhsw .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#vaossgjhsw .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#vaossgjhsw .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#vaossgjhsw .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#vaossgjhsw .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vaossgjhsw .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#vaossgjhsw .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#vaossgjhsw .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#vaossgjhsw .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vaossgjhsw .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#vaossgjhsw .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#vaossgjhsw .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vaossgjhsw .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vaossgjhsw .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#vaossgjhsw .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vaossgjhsw .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#vaossgjhsw .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#vaossgjhsw .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#vaossgjhsw .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vaossgjhsw .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#vaossgjhsw .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#vaossgjhsw .gt_left {\n  text-align: left;\n}\n\n#vaossgjhsw .gt_center {\n  text-align: center;\n}\n\n#vaossgjhsw .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#vaossgjhsw .gt_font_normal {\n  font-weight: normal;\n}\n\n#vaossgjhsw .gt_font_bold {\n  font-weight: bold;\n}\n\n#vaossgjhsw .gt_font_italic {\n  font-style: italic;\n}\n\n#vaossgjhsw .gt_super {\n  font-size: 65%;\n}\n\n#vaossgjhsw .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#vaossgjhsw .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#vaossgjhsw .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#vaossgjhsw .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#vaossgjhsw .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#vaossgjhsw .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#vaossgjhsw .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_heading\">\n      <td colspan=\"10\" class=\"gt_heading gt_title gt_font_normal gt_bottom_border\" style>Accuracy Table</td>\n    </tr>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"city\">city</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\".model_id\">.model_id</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\".model_desc\">.model_desc</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\".type\">.type</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"mae\">mae</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"mape\">mape</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"mase\">mase</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"smape\">smape</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"rmse\">rmse</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"rsq\">rsq</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"city\" class=\"gt_row gt_left\">Dallas</td>\n<td headers=\".model_id\" class=\"gt_row gt_right\">11</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">SEASONAL DECOMP ARIMA</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">39.49</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">14.11</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">7.54</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">15.46</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">44.89</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.86</td></tr>\n    <tr><td headers=\"city\" class=\"gt_row gt_left\">Detroit</td>\n<td headers=\".model_id\" class=\"gt_row gt_right\">11</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">SEASONAL DECOMP ARIMA</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">4.16</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">2.56</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">2.37</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">2.59</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">4.80</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.86</td></tr>\n    <tr><td headers=\"city\" class=\"gt_row gt_left\">New York</td>\n<td headers=\".model_id\" class=\"gt_row gt_right\">11</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">SEASONAL DECOMP ARIMA</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">9.12</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">3.50</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">3.84</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">3.58</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">10.70</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.90</td></tr>\n    <tr><td headers=\"city\" class=\"gt_row gt_left\">San Diego</td>\n<td headers=\".model_id\" class=\"gt_row gt_right\">6</td>\n<td headers=\".model_desc\" class=\"gt_row gt_left\">REGRESSION</td>\n<td headers=\".type\" class=\"gt_row gt_left\">Test</td>\n<td headers=\"mae\" class=\"gt_row gt_right\">30.77</td>\n<td headers=\"mape\" class=\"gt_row gt_right\">8.19</td>\n<td headers=\"mase\" class=\"gt_row gt_right\">4.36</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">7.75</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">35.89</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.29</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\nNext are the forecasts against the test data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfcst_pal <- c(                                                     # <1>\n  \"#2c3e50\", \"#FF0000\", \"#00FFFF\", \"#FFFF00\", \"#0000FF\", \"#00FF00\",\n  \"#FF00FF\", \"#FF8000\", \"#0080FF\", \"#80FF00\", \"#8000FF\", \"#00FF80\",\n  \"#FF0080\"\n)\n\nhpi_best |>\n  extract_nested_test_forecast() |>\n  group_by(city) |>\n  plot_modeltime_forecast(.interactive = FALSE) +\n  scale_color_manual(values = fcst_pal)\n```\n\n::: {.cell-output-display}\n![](forecasting-with-modeltime-part-5_files/figure-html/fig-test-forecasts-1.png){#fig-test-forecasts width=768}\n:::\n:::\n\n\n1.  Create a color palette for plotting.\n\nFor Dallas, Detroit, and New York the 11th model in the original workflow which is a Seasonal Decomposition ARIMA model and for San Diego it's the 6th model which is just called \"REGRESSION\". I'll show the table of model names here here with a \"model_num\" column indicating model number.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npart4_mods |>\n  mutate(model_num = row_number()) |>\n  gt() |>\n  gt_bold_head()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"ezrmrdksxp\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#ezrmrdksxp table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#ezrmrdksxp thead, #ezrmrdksxp tbody, #ezrmrdksxp tfoot, #ezrmrdksxp tr, #ezrmrdksxp td, #ezrmrdksxp th {\n  border-style: none;\n}\n\n#ezrmrdksxp p {\n  margin: 0;\n  padding: 0;\n}\n\n#ezrmrdksxp .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#ezrmrdksxp .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#ezrmrdksxp .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#ezrmrdksxp .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#ezrmrdksxp .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ezrmrdksxp .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ezrmrdksxp .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#ezrmrdksxp .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#ezrmrdksxp .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#ezrmrdksxp .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#ezrmrdksxp .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#ezrmrdksxp .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#ezrmrdksxp .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#ezrmrdksxp .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#ezrmrdksxp .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#ezrmrdksxp .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#ezrmrdksxp .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#ezrmrdksxp .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#ezrmrdksxp .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ezrmrdksxp .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#ezrmrdksxp .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#ezrmrdksxp .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#ezrmrdksxp .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ezrmrdksxp .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#ezrmrdksxp .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#ezrmrdksxp .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ezrmrdksxp .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ezrmrdksxp .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#ezrmrdksxp .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ezrmrdksxp .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#ezrmrdksxp .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#ezrmrdksxp .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ezrmrdksxp .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ezrmrdksxp .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#ezrmrdksxp .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#ezrmrdksxp .gt_left {\n  text-align: left;\n}\n\n#ezrmrdksxp .gt_center {\n  text-align: center;\n}\n\n#ezrmrdksxp .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#ezrmrdksxp .gt_font_normal {\n  font-weight: normal;\n}\n\n#ezrmrdksxp .gt_font_bold {\n  font-weight: bold;\n}\n\n#ezrmrdksxp .gt_font_italic {\n  font-style: italic;\n}\n\n#ezrmrdksxp .gt_super {\n  font-size: 65%;\n}\n\n#ezrmrdksxp .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#ezrmrdksxp .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#ezrmrdksxp .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#ezrmrdksxp .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#ezrmrdksxp .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#ezrmrdksxp .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#ezrmrdksxp .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\".model_desc\">.model_desc</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"model_num\">model_num</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_ETS_DEFAULT</td>\n<td headers=\"model_num\" class=\"gt_row gt_right\">1</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_ARIMA_DEFAULT</td>\n<td headers=\"model_num\" class=\"gt_row gt_right\">2</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_ARIMA_SPEC2</td>\n<td headers=\"model_num\" class=\"gt_row gt_right\">3</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_ETS_SPEC14</td>\n<td headers=\"model_num\" class=\"gt_row gt_right\">4</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_ETS_SPEC6</td>\n<td headers=\"model_num\" class=\"gt_row gt_right\">5</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">DEMOG_REC_ARIMA_SPEC1</td>\n<td headers=\"model_num\" class=\"gt_row gt_right\">6</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">DEMOG_REC_ARIMA_SPEC3</td>\n<td headers=\"model_num\" class=\"gt_row gt_right\">7</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">NNET_REC_NNET_SPEC22</td>\n<td headers=\"model_num\" class=\"gt_row gt_right\">8</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">NNET_REC_NNET_SPEC9</td>\n<td headers=\"model_num\" class=\"gt_row gt_right\">9</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">NNET_REC_NNET_SPEC12</td>\n<td headers=\"model_num\" class=\"gt_row gt_right\">10</td></tr>\n    <tr><td headers=\".model_desc\" class=\"gt_row gt_left\">BASE_REC_STLM_SPEC3</td>\n<td headers=\"model_num\" class=\"gt_row gt_right\">11</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\nWe can see that the 11th model is an STLM model and the 6th model is the first ARIMA specification with the \"DEMOG\" recipe (this is the one that included economic and demographic covariates).\n\nThe plot for San Diego does not include a margin of error and it's listed as having an error in the legend. This is something that can be traced to the calibration. First I'll extract the \".modeltime_tables\".\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhpi_wflowset |>\n  filter(city %in% \"San Diego\") |>\n  pluck(\".modeltime_tables\", 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Modeltime Table\n# A tibble: 11 × 5\n   .model_id .model       .model_desc           .type .calibration_data\n       <int> <named list> <chr>                 <chr> <list>           \n 1         1 <workflow>   ETSAADN               Test  <tibble [24 × 4]>\n 2         2 <workflow>   ARIMA                 Test  <tibble [24 × 4]>\n 3         3 <workflow>   ARIMA                 Test  <tibble [24 × 4]>\n 4         4 <workflow>   ETSAADA               Test  <tibble [24 × 4]>\n 5         5 <workflow>   ETSAADA               Test  <tibble [24 × 4]>\n 6         6 <workflow>   REGRESSION            Test  <tibble [24 × 4]>\n 7         7 <workflow>   REGRESSION            Test  <tibble [24 × 4]>\n 8         8 <NULL>       NULL                  <NA>  <lgl [1]>        \n 9         9 <NULL>       NULL                  <NA>  <lgl [1]>        \n10        10 <NULL>       NULL                  <NA>  <lgl [1]>        \n11        11 <workflow>   SEASONAL DECOMP ARIMA Test  <tibble [24 × 4]>\n```\n\n\n:::\n:::\n\n\nI can see that the 6th model does contain calibration data, so this isn't the problem. Now I'll extract the calibration data just for this model to see what's going on.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhpi_wflowset |>\n  filter(city %in% \"San Diego\") |>\n  pluck(\".modeltime_tables\", 1) |>\n  filter(.model_id == 6) |>\n  pluck(\".calibration_data\", 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 24 × 4\n   date       .actual .prediction .residuals\n   <date>       <dbl>       <dbl>      <dbl>\n 1 2021-01-01    302.         NA        NA  \n 2 2021-02-01    311.         NA        NA  \n 3 2021-03-01    321.         NA        NA  \n 4 2021-04-01    332.         NA        NA  \n 5 2021-05-01    341.         NA        NA  \n 6 2021-06-01    350.         NA        NA  \n 7 2021-07-01    355.        409.      -53.6\n 8 2021-08-01    357.        410.      -53.2\n 9 2021-09-01    360.        412.      -51.6\n10 2021-10-01    364.        413.      -48.8\n# ℹ 14 more rows\n```\n\n\n:::\n:::\n\n\nGaaaahhhh! It's the missing data created by the lags in the recipe for this model. It might be interesting to run this model again without those lags, but I'll be happy just to know why there is no margin of error for this one. Interestingly, though, it looks like the STLM did a pretty good job with Detroit and New York.\n\nNow it's on to forecasting the future.\n\n## Forecasting future HPI\n\nThe first step in forecasting is re-fitting the models to the full data set including the test portion. I'll do this with `modeltime_nested_refit()` . I'll immediately use that refit object to plot the forecasts.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhpi_refit <- hpi_best |>\n  modeltime_nested_refit(control = control_nested_refit(verbose = FALSE))\n\nhpi_refit |>\n  extract_nested_future_forecast() |>\n  group_by(city) |>\n  plot_modeltime_forecast(.interactive = FALSE) +\n  scale_color_manual(values = fcst_pal)\n```\n\n::: {.cell-output-display}\n![](forecasting-with-modeltime-part-5_files/figure-html/refit-best-mods-1.png){width=768}\n:::\n:::\n\n\nIt looks like the missing values due to the lags prevented the ARIMA from generating forecasts, but the other forecasts look quite believable and much better than the forecasts made by the global process.\n\n## Comparing forecasts to what really happened\n\nI used data that ended in December 2022 because that's the most recent data I had for some demographic variables. This isn't a problem for the STLM since this model doesn't rely on demographic covariates, but there is HPI data through September of 2023, and the forecasts go through December of 2023. So, here I'll just get the HPI data for 2023 for Dallas, Detroit, and New York.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncase_shiller_ids <- fredr::fredr_series_search_text(\"Case-Shiller\") |>\n  filter(\n    str_detect(\n      title,\n      \"TX-Dallas|NY-New York|MI-Detroit Home Price Index\"\n    ),\n    seasonal_adjustment_short %in% \"NSA\",\n    frequency %in% \"Monthly\"\n  ) |>\n  mutate(city = str_extract(title, \"New York|Dallas|San Diego|Detroit\")) |>\n  select(city, id)\n\n# Get Case Shiller data for 2023\nhpi_data <- case_shiller_ids |>\n  mutate(\n    data = map(\n      id,\n      \\(x) fredr::fredr(\n        series_id = x,\n        observation_start = ymd(\"2020-01-01\"),\n        observation_end = ymd(\"2023-12-31\"),\n        frequency = \"m\"\n      )\n    )\n  ) |>\n  select(-id) |>\n  unnest(data) |>\n  select(city, date, hpi = value)\n\nhpi_data |>\n  pivot_wider(names_from = city, values_from = hpi) |>\n  filter(year(date) == 2023) |>\n  gt() |>\n  gt_bold_head()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"zstlgqxset\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#zstlgqxset table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#zstlgqxset thead, #zstlgqxset tbody, #zstlgqxset tfoot, #zstlgqxset tr, #zstlgqxset td, #zstlgqxset th {\n  border-style: none;\n}\n\n#zstlgqxset p {\n  margin: 0;\n  padding: 0;\n}\n\n#zstlgqxset .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#zstlgqxset .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#zstlgqxset .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#zstlgqxset .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#zstlgqxset .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#zstlgqxset .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zstlgqxset .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#zstlgqxset .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#zstlgqxset .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#zstlgqxset .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#zstlgqxset .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#zstlgqxset .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#zstlgqxset .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#zstlgqxset .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#zstlgqxset .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#zstlgqxset .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#zstlgqxset .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#zstlgqxset .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#zstlgqxset .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zstlgqxset .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#zstlgqxset .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#zstlgqxset .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#zstlgqxset .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zstlgqxset .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#zstlgqxset .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#zstlgqxset .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zstlgqxset .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zstlgqxset .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#zstlgqxset .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zstlgqxset .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#zstlgqxset .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#zstlgqxset .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#zstlgqxset .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zstlgqxset .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#zstlgqxset .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#zstlgqxset .gt_left {\n  text-align: left;\n}\n\n#zstlgqxset .gt_center {\n  text-align: center;\n}\n\n#zstlgqxset .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#zstlgqxset .gt_font_normal {\n  font-weight: normal;\n}\n\n#zstlgqxset .gt_font_bold {\n  font-weight: bold;\n}\n\n#zstlgqxset .gt_font_italic {\n  font-style: italic;\n}\n\n#zstlgqxset .gt_super {\n  font-size: 65%;\n}\n\n#zstlgqxset .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#zstlgqxset .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#zstlgqxset .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#zstlgqxset .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#zstlgqxset .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#zstlgqxset .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#zstlgqxset .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"date\">date</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"Dallas\">Dallas</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"New York\">New York</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"Detroit\">Detroit</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"date\" class=\"gt_row gt_right\">2023-01-01</td>\n<td headers=\"Dallas\" class=\"gt_row gt_right\">281.7092</td>\n<td headers=\"New York\" class=\"gt_row gt_right\">272.8493</td>\n<td headers=\"Detroit\" class=\"gt_row gt_right\">165.3712</td></tr>\n    <tr><td headers=\"date\" class=\"gt_row gt_right\">2023-02-01</td>\n<td headers=\"Dallas\" class=\"gt_row gt_right\">281.6864</td>\n<td headers=\"New York\" class=\"gt_row gt_right\">271.9243</td>\n<td headers=\"Detroit\" class=\"gt_row gt_right\">165.0817</td></tr>\n    <tr><td headers=\"date\" class=\"gt_row gt_right\">2023-03-01</td>\n<td headers=\"Dallas\" class=\"gt_row gt_right\">284.7053</td>\n<td headers=\"New York\" class=\"gt_row gt_right\">274.9276</td>\n<td headers=\"Detroit\" class=\"gt_row gt_right\">168.7419</td></tr>\n    <tr><td headers=\"date\" class=\"gt_row gt_right\">2023-04-01</td>\n<td headers=\"Dallas\" class=\"gt_row gt_right\">288.6548</td>\n<td headers=\"New York\" class=\"gt_row gt_right\">278.5348</td>\n<td headers=\"Detroit\" class=\"gt_row gt_right\">172.7052</td></tr>\n    <tr><td headers=\"date\" class=\"gt_row gt_right\">2023-05-01</td>\n<td headers=\"Dallas\" class=\"gt_row gt_right\">293.1761</td>\n<td headers=\"New York\" class=\"gt_row gt_right\">283.2171</td>\n<td headers=\"Detroit\" class=\"gt_row gt_right\">176.2015</td></tr>\n    <tr><td headers=\"date\" class=\"gt_row gt_right\">2023-06-01</td>\n<td headers=\"Dallas\" class=\"gt_row gt_right\">295.2387</td>\n<td headers=\"New York\" class=\"gt_row gt_right\">286.5359</td>\n<td headers=\"Detroit\" class=\"gt_row gt_right\">177.9996</td></tr>\n    <tr><td headers=\"date\" class=\"gt_row gt_right\">2023-07-01</td>\n<td headers=\"Dallas\" class=\"gt_row gt_right\">296.1252</td>\n<td headers=\"New York\" class=\"gt_row gt_right\">289.0024</td>\n<td headers=\"Detroit\" class=\"gt_row gt_right\">179.2959</td></tr>\n    <tr><td headers=\"date\" class=\"gt_row gt_right\">2023-08-01</td>\n<td headers=\"Dallas\" class=\"gt_row gt_right\">295.6140</td>\n<td headers=\"New York\" class=\"gt_row gt_right\">290.5704</td>\n<td headers=\"Detroit\" class=\"gt_row gt_right\">180.7211</td></tr>\n    <tr><td headers=\"date\" class=\"gt_row gt_right\">2023-09-01</td>\n<td headers=\"Dallas\" class=\"gt_row gt_right\">295.2280</td>\n<td headers=\"New York\" class=\"gt_row gt_right\">292.3354</td>\n<td headers=\"Detroit\" class=\"gt_row gt_right\">181.9622</td></tr>\n    <tr><td headers=\"date\" class=\"gt_row gt_right\">2023-10-01</td>\n<td headers=\"Dallas\" class=\"gt_row gt_right\">294.2782</td>\n<td headers=\"New York\" class=\"gt_row gt_right\">293.4502</td>\n<td headers=\"Detroit\" class=\"gt_row gt_right\">182.6364</td></tr>\n    <tr><td headers=\"date\" class=\"gt_row gt_right\">2023-11-01</td>\n<td headers=\"Dallas\" class=\"gt_row gt_right\">292.4071</td>\n<td headers=\"New York\" class=\"gt_row gt_right\">294.2285</td>\n<td headers=\"Detroit\" class=\"gt_row gt_right\">181.8668</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\nNow I can make a table of accuracy statistics for these series.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhpi_data |>\n  left_join(\n    hpi_refit |>\n      filter(!city %in% \"San Diego\") |>\n      extract_nested_future_forecast() |>\n      filter(.key %in% \"prediction\") |>\n      unite(\"model_name\", .model_id, .model_desc) |>\n      select(!.key),\n    by = c(\"city\", \"date\" = \".index\")\n  ) |>\n  group_nest(city) |>\n  mutate(\n    smape = map_dbl(\n      data,\n      \\(x) smape(x, hpi, .value) |> pull(.estimate)\n    ),\n    rmse = map_dbl(\n      data,\n      \\(x) rmse(x, hpi, .value) |> pull(.estimate)\n    ),\n    rsq = map_dbl(\n      data,\n      \\(x) rsq(x, hpi, .value) |> pull(.estimate)\n    )\n  ) |>\n  select(-data) |>\n  ungroup() |>\n  gt() |>\n  gt_bold_head()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"fuwndwsuuz\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#fuwndwsuuz table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#fuwndwsuuz thead, #fuwndwsuuz tbody, #fuwndwsuuz tfoot, #fuwndwsuuz tr, #fuwndwsuuz td, #fuwndwsuuz th {\n  border-style: none;\n}\n\n#fuwndwsuuz p {\n  margin: 0;\n  padding: 0;\n}\n\n#fuwndwsuuz .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#fuwndwsuuz .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#fuwndwsuuz .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#fuwndwsuuz .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#fuwndwsuuz .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#fuwndwsuuz .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#fuwndwsuuz .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#fuwndwsuuz .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#fuwndwsuuz .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#fuwndwsuuz .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#fuwndwsuuz .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#fuwndwsuuz .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#fuwndwsuuz .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#fuwndwsuuz .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#fuwndwsuuz .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#fuwndwsuuz .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#fuwndwsuuz .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#fuwndwsuuz .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#fuwndwsuuz .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#fuwndwsuuz .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#fuwndwsuuz .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#fuwndwsuuz .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#fuwndwsuuz .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#fuwndwsuuz .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#fuwndwsuuz .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#fuwndwsuuz .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#fuwndwsuuz .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#fuwndwsuuz .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#fuwndwsuuz .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#fuwndwsuuz .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#fuwndwsuuz .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#fuwndwsuuz .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#fuwndwsuuz .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#fuwndwsuuz .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#fuwndwsuuz .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#fuwndwsuuz .gt_left {\n  text-align: left;\n}\n\n#fuwndwsuuz .gt_center {\n  text-align: center;\n}\n\n#fuwndwsuuz .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#fuwndwsuuz .gt_font_normal {\n  font-weight: normal;\n}\n\n#fuwndwsuuz .gt_font_bold {\n  font-weight: bold;\n}\n\n#fuwndwsuuz .gt_font_italic {\n  font-style: italic;\n}\n\n#fuwndwsuuz .gt_super {\n  font-size: 65%;\n}\n\n#fuwndwsuuz .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#fuwndwsuuz .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#fuwndwsuuz .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#fuwndwsuuz .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#fuwndwsuuz .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#fuwndwsuuz .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#fuwndwsuuz .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"city\">city</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"smape\">smape</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"rmse\">rmse</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" style=\"font-weight: bold; border-top-width: 2px; border-top-style: solid; border-top-color: #000000; border-bottom-width: 2px; border-bottom-style: solid; border-bottom-color: #000000;\" scope=\"col\" id=\"rsq\">rsq</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"city\" class=\"gt_row gt_left\">Dallas</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">3.522232</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">13.336181</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.0272001</td></tr>\n    <tr><td headers=\"city\" class=\"gt_row gt_left\">Detroit</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">5.161485</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">10.526957</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.2394261</td></tr>\n    <tr><td headers=\"city\" class=\"gt_row gt_left\">New York</td>\n<td headers=\"smape\" class=\"gt_row gt_right\">1.658322</td>\n<td headers=\"rmse\" class=\"gt_row gt_right\">5.643017</td>\n<td headers=\"rsq\" class=\"gt_row gt_right\">0.9973690</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\nThese are some pretty low (good) values of SMAPE. Let's see what these look like in plots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhpi_data |>\n  mutate(model_name = \"ACTUAL\") |>\n  rename(.value = hpi) |>\n  bind_rows(\n    hpi_refit |>\n      extract_nested_future_forecast() |>\n      filter(.key %in% \"prediction\", !city %in% \"San Diego\") |>\n      unite(\"model_name\", .model_id, .model_desc) |>\n      select(!.key) |>\n      rename(date = .index)\n  ) |>\n  mutate(\n    model_name = fct_relevel(model_name, \"ACTUAL\"),\n    lwidth = if_else(model_name %in% \"ACTUAL\", 1, 2)\n  ) |>\n  ggplot(aes(x = date, group = model_name, color = model_name)) +\n  geom_line(aes(y = .value, linewidth = lwidth)) +\n  geom_ribbon(aes(ymin = .conf_lo, ymax = .conf_hi), alpha = 0.2, color = NA) +\n  scale_color_manual(values = fcst_pal) +\n  scale_y_continuous(expand = c(0.5, 0.5)) +\n  scale_linewidth(range = c(0.5, 1)) +\n  facet_wrap(~ city, scales = \"free_y\", ncol = 1) +\n  labs(\n    color = NULL,\n    x = NULL,\n    y = NULL,\n    title = \"Forecasts vs. Actual Data\"\n  ) +\n  guides(linewidth = \"none\") +\n  theme_timetk +\n  theme(plot.title = element_text(hjust = 0.5))\n```\n\n::: {.cell-output-display}\n![](forecasting-with-modeltime-part-5_files/figure-html/hpi2023-forecast-plot-1.png){width=768}\n:::\n:::\n\n\nNot too bad! All three forecasts look like they were very close in the first few months of the forecast period, but started to underestimate later on.\n\nThis ends the series of planned posts on using [modeltime](https://business-science.github.io/modeltime/index.html) with R. All in all this is a great package with all sorts of goodies for forecasting time series.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}