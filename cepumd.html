<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Arcenis Rojas" />


<title>cepumd</title>

<script src="site_libs/header-attrs-2.18/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">



<!DOCTYPE html>

<div class="navbar navbar-default  navbar-fixed-top" role="navigation" style="background-color:#000fff">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
          <span class="icon-bar"></span>
            <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="index.html" style="color:#FFF">Arcenis Rojas</a> 
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                  <ul class="nav navbar-nav">
                    
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                      <li>
                      <a href="https://github.com/arcenis-r">
                        <span class="fa fa-github fa-lg" style="color:#FFF"></span>
                          
                          </a>
                          </li>
                          <li>
                          <a href="https://linkedin.com/in/arcenisrojas">
                            <span class="fa fa-linkedin fa-lg" style="color:#FFF"></span>
                              
                              </a>
                              </li>
                              </ul>
                              </div><!--/.nav-collapse -->
                              </div><!--/.container -->
                              </div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">cepumd</h1>
<h4 class="author">Arcenis Rojas</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#history-of-ce" id="toc-history-of-ce">History of
CE</a></li>
<li><a href="#overview-of-ce-and-ce-pumd"
id="toc-overview-of-ce-and-ce-pumd">Overview of CE and CE PUMD</a></li>
<li><a href="#challenges-addressed-by-cepumd"
id="toc-challenges-addressed-by-cepumd">Challenges addressed by
{cepumd}</a></li>
<li><a href="#cautions-and-recommendations"
id="toc-cautions-and-recommendations">Cautions and
Recommendations</a></li>
<li><a href="#installation" id="toc-installation">Installation</a></li>
<li><a href="#key-cepumd-functions" id="toc-key-cepumd-functions">Key
cepumd functions</a></li>
<li><a href="#example-workflows" id="toc-example-workflows">Example
workflows</a>
<ul>
<li><a href="#simple-workflow-integrated-pet-expenditures"
id="toc-simple-workflow-integrated-pet-expenditures">Simple workflow:
Integrated Pet Expenditures</a></li>
<li><a
href="#slightly-more-advanced-workflow-used-car-truck-expenditures-by-urbanicity"
id="toc-slightly-more-advanced-workflow-used-car-truck-expenditures-by-urbanicity">Slightly
more advanced workflow: Used Car &amp; Truck Expenditures by
Urbanicity</a></li>
<li><a
href="#very-advanced-workflow-inflation-adjusted-food-away-from-home-expenditures"
id="toc-very-advanced-workflow-inflation-adjusted-food-away-from-home-expenditures">Very
advanced workflow: Inflation adjusted food away from home
expenditures</a></li>
<li><a href="#dealing-with-inconsistent-code-definitions"
id="toc-dealing-with-inconsistent-code-definitions">Dealing with
inconsistent code definitions</a></li>
</ul></li>
</ul>
</div>

<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>The purpose of <code>cepumd</code> is to make working with Consumer
Expenditure Surveys (CE) Public-Use Microdata (PUMD) easier toward
calculating mean, weighted, annual expenditures (henceforth “mean
expenditures”). The challenges <code>cepumd</code> seeks to address deal
primarily with pulling together the necessary data toward this end. Some
of the overarching ideas underlying the package are as follows:</p>
<ul>
<li>Use a <a href="https://www.tidyverse.org/">Tidyverse</a> framework
for most operations and be (hopefully) generally <a
href="https://www.tidyverse.org/">Tidyverse</a> friendly</li>
<li>The best practice is to put all required data in one place, which
<code>cepumd</code> does by default</li>
<li>Balance the effort to make the end user’s experience with CE PUMD
easier while being flexible enough to allow that user to perform any
analysis with the data they wish</li>
<li>Only designed to help users calculate mean
<strong>expenditures</strong> on and of the consumer unit (CU), i.e.,
not income, not assets, not liabilities, not gifts, at least for
now</li>
</ul>
</div>
<div id="history-of-ce" class="section level2">
<h2>History of CE</h2>
<p>First a little history… The first Consumer Expenditure Survey
happened in 1888 (<a href="https://www.bls.gov/opub/hom/cex/history.htm"
class="uri">https://www.bls.gov/opub/hom/cex/history.htm</a>), it was
first used to revise CPI weights in 1972-1973, and it has been collected
on a monthly basis since 1979. For a little bit more detail on the
history of the CE, check out the slide deck of a presentation delivered
by Steve Henderson (former Chief of the Branch of Information and
Analysis) and Adam Safir (current Division Chief of CE) called <a
href="https://www.bls.gov/cex/ce-130-presentation-safir-henderson.pdf">130
Years of theConsumer Expenditure Surveys (CE): 1888 - 2018</a></p>
</div>
<div id="overview-of-ce-and-ce-pumd" class="section level2">
<h2>Overview of CE and CE PUMD</h2>
<p>From the CE home page:</p>
<blockquote>
<p>“The Consumer Expenditure Surveys (CE) program provides data on
expenditures, income, and demographic characteristics of consumers in
the United States. The CE program provides these data in tables, LABSTAT
database, news releases, reports, and public use microdata files.</p>
</blockquote>
<blockquote>
<p>CE data are collected by the Census Bureau for BLS in two surveys,
the Interview Survey for major and/or recurring items and the Diary
Survey for more minor or frequently purchased items. CE data are
primarily used to revise the relative importance of goods and services
in the market basket of the Consumer Price Index. The CE is the only
Federal household survey to provide information on the complete range of
consumers’ expenditures and incomes. Here is an overview of the CE
program and its methods.”</p>
</blockquote>
<p>Some important things to note are that expenditure data are collected
through two different survey instruments (Diary and Interview),
expenditure categories are organized hierarchichally, and data are
stored across thousands of files to which the CE provides access through
their website. Also, given the length of the program, it would be
difficult to harmonize data across all those years and files, so there
are some inconsistencies in the way data are stored, which
<code>cepumd</code> seeks to address (more on this further down).</p>
<p>Please visit the following pages to learn more about the CE program
overall and CE PUMD more specifically.</p>
<ul>
<li>CE homepage: (<a href="https://www.bls.gov/cex/"
class="uri">https://www.bls.gov/cex/</a>)</li>
<li>CE PUMD page: (<a href="https://www.bls.gov/cex/pumd.htm"
class="uri">https://www.bls.gov/cex/pumd.htm</a>)</li>
<li>CE PUMD Getting Started Guide: <a
href="https://www.bls.gov/cex/pumd-getting-started-guide.htm"
class="uri">https://www.bls.gov/cex/pumd-getting-started-guide.htm</a></li>
<li>CE Dictionary for Interview and Diary Surveys (XLSX download) (<a
href="https://www.bls.gov/cex/pumd/ce_pumd_interview_diary_dictionary.xlsx"
class="uri">https://www.bls.gov/cex/pumd/ce_pumd_interview_diary_dictionary.xlsx</a>)</li>
<li>CE PUMD published tables: (<a
href="https://www.bls.gov/cex/tables.htm"
class="uri">https://www.bls.gov/cex/tables.htm</a>)</li>
<li>CE PUMD Handbook of Methods: <a
href="https://www.bls.gov/opub/hom/cex/"
class="uri">https://www.bls.gov/opub/hom/cex/</a></li>
<li>CE Frequently Asked Questions: <a
href="https://www.bls.gov/cex/csxfaqs.htm"
class="uri">https://www.bls.gov/cex/csxfaqs.htm</a></li>
</ul>
</div>
<div id="challenges-addressed-by-cepumd" class="section level2">
<h2>Challenges addressed by {cepumd}</h2>
<p><code>cepumd</code> seeks to address challenges in three categories:
data gathering/organization; managing data inconsistencies; and
calculating weighted, annual metrics.</p>
<ul>
<li><strong>Data gathering/organization</strong>
<ul>
<li>Facilitate data and metadata downloads with
<code>ce_download()</code>, <code>store_ce_hg()</code>, and
<code>store_ce_dict()</code></li>
<li>Convert hierarchical grouping (HG) files to data tables using
<code>ce_hg()</code></li>
<li>Help the user identify the Universal Classification Codes (UCCs)
related to their analysis using a combination of <code>ce_hg()</code>
and <code>ce_uccs()</code></li>
<li>Combine all required files and variables using
<code>ce_prepdata()</code></li>
</ul></li>
<li><strong>Managing data inconsistencies</strong>
<ul>
<li>Provide the ability to recode variable categories using the CE
Dictionary for Interview and Diary Surveys</li>
<li>Resolve some inconsistencies such as differences code definitions
between the Interview and Diary (check the definitions of the “FAM_TYPE”
variable categories in 2015 for an example)</li>
<li>Provide useful errors or warnings when there are multiple categories
of something the user is trying to access, e.g., some titles in the
hierarchical grouping files (“stub” or “HG” files) repeat and requires
more careful selection of UCCs</li>
</ul></li>
<li><strong>Calculating weighted, annual metrics</strong>
<ul>
<li>Calculate a mean expenditure with <code>ce_mean()</code> or
expenditure quantile with <code>ce_quantile()</code></li>
<li>Account for the factor (annual vs. quarterly expenditure)</li>
<li>Account for the “months in scope” of a given consumer unit (CU)</li>
<li>Annualize expenditures for either Diary or Interview
expenditures</li>
<li>Integrate Interview and Diary data as necessary</li>
</ul></li>
</ul>
<p>Source code and other package information is available at <a
href="https://github.com/arcenis-r/cepumd"
class="uri">https://github.com/arcenis-r/cepumd</a></p>
</div>
<div id="cautions-and-recommendations" class="section level2">
<h2>Cautions and Recommendations</h2>
<ul>
<li><p>Estimates produced using PUMD, which is topcoded by the CE and
has some records suppressed to protect respondent confidentiality, will
not match the published estimates released by the CE in most cases. The
CE’s published estimates are based on confidential data that are not
topcoded nor have records suppressed. You can learn more at <a
href="https://www.bls.gov/cex/pumd_disclosure.htm">CE Protection of
Respondent Confidentiality</a>.</p></li>
<li><p>When calculating estimates for sub-samples or crosss-sections of
data it is best to stick to the combinations of variables that the CE
uses in it’s publication tables, e.g., income, geography, composition of
CU, size of CU. This is because CE data are collected using a <a
href="https://www.bls.gov/opub/hom/cex/design.htm">stratified, random
sample</a> (a.k.a., “representative sample”) and only analyses conducted
using the stratification variables are statistically valid. Using other
variables can be helpful to understand spending across different groups,
but unweighted estimates are likely more useful for this.
<code>cepumd</code> currently does not support unweighted estimates, but
data for such an analysis can be prepared using
<code>ce_prepdata()</code>.</p></li>
<li><p>Quantiles should only be generated using data from 1 survey
instrument as the samples for the Interview and Diary are
different.</p></li>
<li><p>Check the expenditure category in the appropriate HG file to
ensure that it is the category for which you intend to generate an
estimate.</p></li>
<li><p>Store an HG object in the environment and call that directly in
<code>ce_prepdata()</code>.</p></li>
</ul>
</div>
<div id="installation" class="section level2">
<h2>Installation</h2>
<p>You can install the development version of <code>cepumd</code> from
<a href="https://github.com">GitHub</a>, but you’ll first need the
<code>devtools</code> package:</p>
<pre class="r"><code>if (!&quot;devtools&quot; %in% installed.packages()[, &quot;Package&quot;]) {
  install.packages(&quot;devtools&quot;, dependencies = TRUE)
}

devtools::install_github(&quot;arcenis-r/cepumd&quot;)</code></pre>
</div>
<div id="key-cepumd-functions" class="section level2">
<h2>Key cepumd functions</h2>
<ul>
<li><p>The workhorse of <code>cepumd</code> is
<code>ce_prepdata()</code>. It merges the household characteristics file
(FMLI/-D) with the corresponding expenditure tabulation file (MTBI/EXPD)
for a specified year, adjusts weights for months-in-scope and the number
of collection quarters, adjusts some cost values by their periodicity
factor (some cost categories are represented as annual figures and
others as quarterly). With the recent update it only requires the first
3 arguments to function: the year, the survey type, and one or more
valid UCCs. <code>ce_prepdata()</code> now creates all of the other
necessary objects within the function if not provided.</p></li>
<li><p>There are three functions for downloading the data and necessary
documentation:</p>
<ul>
<li><code>ce_download()</code> downloads zip files for a given year and
survey instrument directly from the CE website</li>
<li><code>store_ce_hg()</code> downloads the zip file containing all HG
files maintained by the CE to the specified location.</li>
<li><code>store_ce_dict()</code> downloades the CE PUMD dictionary from
CE’s website to the specified location.</li>
</ul></li>
<li><p>There are two functions for wrangling hierarchical grouping data
into more useable formats:</p>
<ul>
<li><code>ce_hg()</code> pulls the requested type of HG file (Interview,
Diary, or Integrated) for a specified year.</li>
<li><code>ce_uccs()</code> filters the HG file for the specified
expenditure category and returns either a data frame with only that
section of the HG file or the Universal Classification Codes (UCCs) that
make up that expenditure category.</li>
</ul></li>
<li><p>There are two functions that the user can use to calculate CE
summary statistics:</p>
<ul>
<li><code>ce_mean()</code> calculates a mean expenditure, standard error
of the mean, coefficient of variation, and an aggregate
expenditure.</li>
<li><code>ce_quantiles()</code> calculates weighted expenditure
quantiles. It is important to note that calculating medians for
integrated expenditures is not recommended because the calculation
involves using weights from both the Diary and Survey instruments.</li>
</ul></li>
<li><p>There are two utility functions to make the workflow a bit
easier:</p>
<ul>
<li><code>ce_pumd_years()</code> scrapes the main PUMD website to get a
vector of years for which PUMD are available. The vector is limited to
the years for which there are also HG files available.</li>
<li><code>ce_cleanup()</code> deletes a file containing CE data that may
only be necessary temporarily.</li>
</ul></li>
</ul>
</div>
<div id="example-workflows" class="section level2">
<h2>Example workflows</h2>
<p>The following are a few sample workflows that show how
<code>cepumd</code> can be used. Before jumping into those I’ll first
install and load the necessary pacakges.</p>
<pre class="r"><code>
# Store a vector of names of additional packages to be used
pkgs &lt;- c(&quot;tidyverse&quot;, &quot;devtools&quot;, &quot;readxl&quot;, &quot;knitr&quot;, &quot;blsR&quot;, &quot;janitor&quot;)

# Install packages from CRAN
invisible(
  sapply(
    pkgs, function(x) if (!x %in% installed.packages()) install.packages(x)
  )
)

library(knitr)
library(readxl)
library(tidyverse)
library(cepumd)</code></pre>
<div id="simple-workflow-integrated-pet-expenditures"
class="section level3">
<h3>Simple workflow: Integrated Pet Expenditures</h3>
<p>The following is an example of how someone might go about using
<code>cepumd</code> to calculate a 2021 annual, weighted estimate of
mean expenditures on pets for all of the U.S. using CE integrated data
without creating a separate directory for the data. This is just a quick
and easy calculation.</p>
<pre class="r"><code>ce_prepdata(
  2021,
  integrated,
  uccs = ce_hg(2021, integrated) %&gt;% ce_uccs(&quot;Pets&quot;)
) %&gt;%
  ce_mean() %&gt;%
  kable(booktabs = TRUE)
#&gt; [1] 2</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">agg_exp</th>
<th align="right">mean_exp</th>
<th align="right">se</th>
<th align="right">cv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">101537912995</td>
<td align="right">761.1465</td>
<td align="right">50.24688</td>
<td align="right">6.601473</td>
</tr>
</tbody>
</table>
<p>Yup… that’s all it takes. I simply ran <code>ce_prepdata()</code>
with the year, the survey type, and the uccs I needed and piped that
directly into <code>ce_mean()</code>.</p>
<p>But where are all the files? Zip files, etc.? They’re in my R
session’s temporary directory under a sub-directory named “ce-data”.</p>
<pre class="r"><code>list.files(file.path(tempdir(), &quot;ce-data&quot;))
#&gt; character(0)</code></pre>
<p>I’ll go ahead and clean those files up really quickly.</p>
<pre class="r"><code>ce_cleanup()
#&gt; [1] &quot;Nothing to clean up.&quot;
list.files(file.path(tempdir(), &quot;ce-data&quot;))
#&gt; character(0)</code></pre>
</div>
<div
id="slightly-more-advanced-workflow-used-car-truck-expenditures-by-urbanicity"
class="section level3">
<h3>Slightly more advanced workflow: Used Car &amp; Truck Expenditures
by Urbanicity</h3>
<p>In this example I’ll calculate estimated annual expenditures on used
cars and trucks by urbanicity also for 2021. Once the data are prepped
with <code>ce_data()</code> I’ll just nest the data by urbanicity and
run <code>ce_means()</code> and <code>ce_quantiles()</code> on the
nested datasets.</p>
<p>First, I’ll get the portion of the stub file pertaining to used cars
and trucks to ensure that I get the correct UCCs.</p>
<pre class="r"><code>stub_2021 &lt;- ce_hg(2021, integrated)

stub_2021 %&gt;%
  filter(str_detect(title, &quot;[C|c]ars&quot;)) %&gt;%
  kable(booktabs = TRUE)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">level</th>
<th align="left">title</th>
<th align="left">ucc</th>
<th align="left">survey</th>
<th align="left">factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">4</td>
<td align="left">Cars and trucks, new</td>
<td align="left">NEWCARS</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">New cars</td>
<td align="left">450110</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">4</td>
<td align="left">Cars and trucks, used</td>
<td align="left">USEDCARS</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Used cars</td>
<td align="left">460110</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
</tbody>
</table>
<p>It looks like the expenditure category I want is “Cars and trucks,
used”.</p>
<pre class="r"><code>ce_uccs(stub_2021, &quot;Cars and trucks, used&quot;, uccs_only = FALSE)
#&gt; # A tibble: 3 × 5
#&gt;   level title                 ucc      survey factor
#&gt;   &lt;chr&gt; &lt;chr&gt;                 &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
#&gt; 1 4     Cars and trucks, used USEDCARS G      1     
#&gt; 2 5     Used cars             460110   I      1     
#&gt; 3 5     Used trucks           460901   I      1</code></pre>
<p>I notice from the “survey” column that all of the UCCs associated
with used cars and trucks come from the Interview survey (as indicated
by the “I”). So when I prepare my data I’ll only need data from the
Interview.</p>
<pre class="r"><code>cars_trucks &lt;- ce_prepdata(
  2021,
  interview,
  uccs = ce_uccs(stub_2021, &quot;Cars and trucks, used&quot;, uccs_only = TRUE),
  bls_urbn,
  recode_variables = TRUE,
  hg = stub_2021
)

cars_trucks %&gt;%
  nest(data = -bls_urbn) %&gt;%
  mutate(ce_mn_df = map(data, ce_mean)) %&gt;% 
  select(-data) %&gt;% 
  unnest(ce_mn_df) %&gt;%
  kable(booktabs = TRUE)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">bls_urbn</th>
<th align="right">agg_exp</th>
<th align="right">mean_exp</th>
<th align="right">se</th>
<th align="right">cv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Urban</td>
<td align="right">310383802180</td>
<td align="right">2472.104</td>
<td align="right">152.2238</td>
<td align="right">6.157661</td>
</tr>
<tr class="even">
<td align="left">Rural</td>
<td align="right">30912654497</td>
<td align="right">3844.600</td>
<td align="right">683.8189</td>
<td align="right">17.786476</td>
</tr>
</tbody>
</table>
<p>Getting the annual, weighted estimate of the median (or another
quantile) would be just as easy. Since I’m using interview data only
here, this would be a good example. I’ll calculate the median and 99th
percentiles for the overall sample rather than breaking it down by
urbanicity.</p>
<pre class="r"><code>ce_quantiles(cars_trucks, probs = c(0.5, 0.99)) %&gt;% kable(booktabs = TRUE)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">probs</th>
<th align="right">quantile</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">50%</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">99%</td>
<td align="right">20000</td>
</tr>
</tbody>
</table>
<pre class="r"><code>ce_cleanup()</code></pre>
</div>
<div
id="very-advanced-workflow-inflation-adjusted-food-away-from-home-expenditures"
class="section level3">
<h3>Very advanced workflow: Inflation adjusted food away from home
expenditures</h3>
<p>In this last example I’m going to assume very little knowledge about
the CE. I’d like to compare mean annual expenditures on food away from
home between 2010 and 2020 by household size and I want to convert
expenditures to 2022 dollars using the CPI. Also, I’m going to set up a
directory on my local machine to put all the data and metadata files
into.</p>
<p>First, I’ll set up that directory. I’ll put the directory path in a
variable called “food_away_dir” for simplicity.</p>
<pre class="r"><code>food_away_dir &lt;- file.path(&quot;..&quot;, &quot;food-away&quot;)
dir.create(food_away_dir)
list.files(food_away_dir)
#&gt; character(0)</code></pre>
<p>Next, I want to make sure that there are data for my years of
interest.</p>
<pre class="r"><code>ce_pumd_years()
#&gt;  [1] 2021 2020 2019 2018 2017 2016 2015 2014 2013 2012 2011 2010 2009 2008 2007
#&gt; [16] 2006 2005 2004 2003 2002 2001 2000 1999 1998 1997</code></pre>
<p>Now I want to store the CE HG files and data dictionary.</p>
<pre class="r"><code>store_ce_hg(food_away_dir)
store_ce_dict(food_away_dir)</code></pre>
<p>Let’s take a look at what the files are called.</p>
<pre class="r"><code>list.files(food_away_dir)
#&gt; [1] &quot;ce-dict.xlsx&quot; &quot;ce-stubs.zip&quot;</code></pre>
<p>Next I want to see what the 2010 HG file looks like for 2010 for
expenditures on “food away from home”. First I’ll download both HG files
(2010 and 2020), then I’ll find the correct title in the 2010 HG file
for my category.</p>
<pre class="r"><code>hg_10 &lt;- ce_hg(2010, integrated, food_away_dir)
hg_20 &lt;- ce_hg(2020, integrated, food_away_dir)

hg_10 %&gt;%
  filter(str_detect(title, &quot;[F|f]ood [A|a]way&quot;)) %&gt;%
  kable(booktabs = TRUE)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">level</th>
<th align="left">title</th>
<th align="left">ucc</th>
<th align="left">survey</th>
<th align="left">factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">3</td>
<td align="left">Food away from home</td>
<td align="left">FOODAWAY</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
</tbody>
</table>
<pre class="r"><code>
hg_20 %&gt;%
  filter(str_detect(title, &quot;[F|f]ood [A|a]way&quot;)) %&gt;%
  kable(booktabs = TRUE)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">level</th>
<th align="left">title</th>
<th align="left">ucc</th>
<th align="left">survey</th>
<th align="left">factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">3</td>
<td align="left">Food away from home</td>
<td align="left">FOODAW</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
</tbody>
</table>
<p>It looks like the title is the same in both years, so I’ll store the
title in a variable to use downstream.</p>
<pre class="r"><code>food_away_title &lt;- hg_10 %&gt;%
  filter(str_detect(title, &quot;[F|f]ood [A|a]way&quot;)) %&gt;%
  pull(title)</code></pre>
<p>Now I’ll use that title to get the UCCs and see the entire table with
“food away from home” expenditures (only for 2010 as a sample).</p>
<pre class="r"><code>food_away_hg_10 &lt;- ce_uccs(hg_10, food_away_title, uccs_only = FALSE)
food_away_hg_20 &lt;- ce_uccs(hg_20, food_away_title, uccs_only = FALSE)

food_away_hg_10 %&gt;% kable(booktabs = TRUE)</code></pre>
<table>
<colgroup>
<col width="3%" />
<col width="83%" />
<col width="5%" />
<col width="3%" />
<col width="3%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">level</th>
<th align="left">title</th>
<th align="left">ucc</th>
<th align="left">survey</th>
<th align="left">factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">3</td>
<td align="left">Food away from home</td>
<td align="left">FOODAWAY</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">Meals at restaurants, carry outs and other</td>
<td align="left">RESTCOAO</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">Lunch</td>
<td align="left">LUNCH</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Lunch at fast food, take-out, delivery, concession
stands, buffet and cafeteria (other than employer and school
cafeteria)</td>
<td align="left">190111</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Lunch at full service restaurants</td>
<td align="left">190112</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Lunch at vending machines and mobile vendors</td>
<td align="left">190113</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Lunch at employer and school cafeterias</td>
<td align="left">190114</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Dinner</td>
<td align="left">DINNER</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Dinner at fast food, take-out, delivery, concession
stands, buffet and cafeteria (other than employer and school
cafeteria)</td>
<td align="left">190211</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Dinner at full service restaurants</td>
<td align="left">190212</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Dinner at vending machines and mobile vendors</td>
<td align="left">190213</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Dinner at employer and school cafeterias</td>
<td align="left">190214</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">Snacks and nonalcoholic beverages</td>
<td align="left">SNKNABEV</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Snacks and nonalcoholic beverages at fast food,
take-out, delivery, concession stands, buffet and cafeteria (other than
employer and school cafeteria)</td>
<td align="left">190311</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Snacks and nonalcoholic beverages at full service
restaurants</td>
<td align="left">190312</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Snacks and nonalcoholic beverages at vending machines
and mobile vendors</td>
<td align="left">190313</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Snacks and nonalcoholic beverages at employer and
school cafeterias</td>
<td align="left">190314</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Breakfast and brunch</td>
<td align="left">BRKFBRUN</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Breakfast and brunch at fast food, take-out, delivery,
concession stands, buffet and cafeteria (other than employer and school
cafeteria)</td>
<td align="left">190321</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Breakfast and brunch at full service restaurants</td>
<td align="left">190322</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Breakfast and brunch at vending machines and mobile
vendors</td>
<td align="left">190323</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Breakfast and brunch at employer and school
cafeterias</td>
<td align="left">190324</td>
<td align="left">D</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">4</td>
<td align="left">Food or board at school</td>
<td align="left">190901</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">Catered affairs</td>
<td align="left">190902</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">4</td>
<td align="left">Food on out-of-town trips</td>
<td align="left">190903</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">School lunches</td>
<td align="left">790430</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">4</td>
<td align="left">Meals as pay</td>
<td align="left">800700</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
</tbody>
</table>
<p>Next I’ll use the dictionary to find the variable for household size.
It’s important to remember that the dictionary is stored as an “XLSX”
file. I’ll use functions from the <code>readxl</code> package to work
with the dictionary.</p>
<p>First I’ll take a look at the sheets in the dictionary.</p>
<pre class="r"><code>ce_dict_file_path &lt;- file.path(food_away_dir, &quot;ce-dict.xlsx&quot;)
excel_sheets(ce_dict_file_path)
#&gt; [1] &quot;Cover&quot;     &quot;Variables&quot; &quot;Codes &quot;</code></pre>
<p>Now I’ll see what variables contain anything about the number of
household members. To do that I’ll have to load the sheet from the
dictionary containing the variable definitions. I also want to filter
the variable data to only the FMLI where the “Last year” column is
missing, i.e., the variable definition is still in use.</p>
<pre class="r"><code>ce_variables &lt;- read_excel(ce_dict_file_path, sheet = &quot;Variables&quot;)

ce_variables %&gt;%
  filter(
    str_detect(File, &quot;FMLI&quot;),
    str_detect(
      tolower(`Variable description`), &quot;number of members&quot;
    )
  ) %&gt;%
  kable(booktabs = TRUE)</code></pre>
<table>
<colgroup>
<col width="4%" />
<col width="2%" />
<col width="5%" />
<col width="14%" />
<col width="6%" />
<col width="4%" />
<col width="6%" />
<col width="28%" />
<col width="5%" />
<col width="4%" />
<col width="5%" />
<col width="5%" />
<col width="4%" />
<col width="3%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Survey</th>
<th align="left">File</th>
<th align="left">Variable Name</th>
<th align="left">Variable description</th>
<th align="left">Formula</th>
<th align="left">Flag name</th>
<th align="left">Section number</th>
<th align="left">Section description</th>
<th align="left">Section part</th>
<th align="right">First year</th>
<th align="right">First Quarter</th>
<th align="right">Last quarter</th>
<th align="right">Last year</th>
<th align="left">Comment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">INTERVIEW</td>
<td align="left">FMLI</td>
<td align="left">AS_COMP5</td>
<td align="left">Number of members under age 2 in CU</td>
<td align="left">COUNT (AGE &lt; 2)</td>
<td align="left">AS_C_MP5</td>
<td align="left">NA</td>
<td align="left">CU characteristics, income, weights, and summary level
expenditures.</td>
<td align="left">NA</td>
<td align="right">1984</td>
<td align="right">1</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">INTERVIEW</td>
<td align="left">FMLI</td>
<td align="left">AS_COMP5</td>
<td align="left">Number of members under age 2 in CU</td>
<td align="left">NA</td>
<td align="left">AS_C_MP5</td>
<td align="left">NA</td>
<td align="left">CU characteristics, income, weights, and summary level
expenditures.</td>
<td align="left">NA</td>
<td align="right">1980</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">1981</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">INTERVIEW</td>
<td align="left">FMLI</td>
<td align="left">FAM_SIZE</td>
<td align="left">Number of Members in CU</td>
<td align="left">NA</td>
<td align="left">FAM__IZE</td>
<td align="left">NA</td>
<td align="left">CU characteristics, income, weights, and summary level
expenditures.</td>
<td align="left">NA</td>
<td align="right">1984</td>
<td align="right">1</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">INTERVIEW</td>
<td align="left">FMLI</td>
<td align="left">FAM_SIZE</td>
<td align="left">Number of Members in CU</td>
<td align="left">NA</td>
<td align="left">FAM__IZE</td>
<td align="left">NA</td>
<td align="left">CU characteristics, income, weights, and summary level
expenditures.</td>
<td align="left">NA</td>
<td align="right">1980</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">1981</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<p>It looks like FAM_SIZE is the variable I want. I can see that this
variable was used from 1980 through 1981 then was dropped and
re-introduced in 1984 and has been in use since. So it looks like it’s
available for my 2 years of interest. Next I’ll check whether the
FAM_SIZE variable has any value codes associated with it. I’ll have to
pull in the “Codes” sheet. (Check your spelling here.)</p>
<pre class="r"><code>ce_codes &lt;- read_excel(ce_dict_file_path, sheet = &quot;Codes &quot;)

ce_codes %&gt;%
  filter(File %in% &quot;FMLI&quot;, Variable %in% &quot;FAM_SIZE&quot;) %&gt;%
  kable(booktabs = TRUE)</code></pre>
<table>
<colgroup>
<col width="6%" />
<col width="4%" />
<col width="8%" />
<col width="9%" />
<col width="15%" />
<col width="9%" />
<col width="12%" />
<col width="9%" />
<col width="11%" />
<col width="7%" />
<col width="5%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Survey</th>
<th align="left">File</th>
<th align="left">Variable</th>
<th align="left">Code value</th>
<th align="left">Code description</th>
<th align="right">First year</th>
<th align="right">First quarter</th>
<th align="right">Last year</th>
<th align="right">Last quarter</th>
<th align="left">Comment</th>
<th align="left">…11</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>It looks like FAM_SIZE is not a coded variable (no observations in
the “Codes” sheet), so it must be numeric. With all that, I’m ready to
prepare my data. The first thing I’ll need are the UCCs for each of the
two years in my analysis.</p>
<pre class="r"><code>food_away_uccs_10 &lt;- ce_uccs(food_away_hg_10, food_away_title, uccs_only = TRUE)
food_away_uccs_20 &lt;- ce_uccs(food_away_hg_20, food_away_title, uccs_only = TRUE)

food_away_uccs_10
#&gt;  [1] &quot;190111&quot; &quot;190112&quot; &quot;190113&quot; &quot;190114&quot; &quot;190211&quot; &quot;190212&quot; &quot;190213&quot; &quot;190214&quot;
#&gt;  [9] &quot;190311&quot; &quot;190312&quot; &quot;190313&quot; &quot;190314&quot; &quot;190321&quot; &quot;190322&quot; &quot;190323&quot; &quot;190324&quot;
#&gt; [17] &quot;190901&quot; &quot;190902&quot; &quot;190903&quot; &quot;790430&quot; &quot;800700&quot;</code></pre>
<pre class="r"><code>food_away_uccs_20
#&gt;  [1] &quot;190111&quot; &quot;190112&quot; &quot;190113&quot; &quot;190114&quot; &quot;190211&quot; &quot;190212&quot; &quot;190213&quot; &quot;190214&quot;
#&gt;  [9] &quot;190311&quot; &quot;190312&quot; &quot;190313&quot; &quot;190314&quot; &quot;190321&quot; &quot;190322&quot; &quot;190323&quot; &quot;190324&quot;
#&gt; [17] &quot;190901&quot; &quot;190902&quot; &quot;190903&quot; &quot;790430&quot; &quot;800700&quot;</code></pre>
<p>The lists of UCCs look identical, but I’ll keep both just to be
cautious.</p>
<p>Next I’ll prepare the 2010 data and get a summary of the FAM_SIZE
variable since it is a continuous variable.</p>
<pre class="r"><code>food_away_data_10 &lt;- ce_prepdata(
  2010,
  integrated,
  food_away_uccs_10,
  ce_dir = food_away_dir,
  hg = food_away_hg_10,
  fam_size
)

summary(food_away_data_10$fam_size)
#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#&gt;   1.000   1.000   2.000   2.667   4.000  14.000</code></pre>
<p>Since some households have as many as 14 people, I’ll create a
FAM_SIZE label with any number greater than 4 taking on the value “5+”.
Next, I’ll prepare the 2020 data and rowbind it with the 2010 data as
well as create the “fam_size_label” variable. I’m also going to convert
“ref_mo” and “ref_yr” to character to make it compatible with the CPI
data that I’ll get later. I’ll also take a look at just a snippet of the
data.</p>
<pre class="r"><code>food_away_data_20 &lt;- ce_prepdata(
  2020,
  integrated,
  food_away_uccs_20,
  ce_dir = food_away_dir,
  hg = food_away_hg_20,
  fam_size
)

food_away_comp_data &lt;- food_away_data_10 %&gt;%
  mutate(year = &quot;2010&quot;) %&gt;%
  bind_rows(food_away_data_20 %&gt;% mutate(year = &quot;2020&quot;)) %&gt;%
  mutate(
    fam_size_label = if_else(fam_size &gt; 4, &quot;5+&quot;, as.character(fam_size)),
    ref_yr = as.character(ref_yr)
  )

food_away_comp_data %&gt;%
  select(survey, year, newid, finlwt21, cost, ucc, ref_yr, ref_mo) %&gt;%
  filter(!is.na(ucc)) %&gt;%
  group_by(year, survey) %&gt;%
  slice_sample(n = 3) %&gt;%
  ungroup() %&gt;%
  kable(booktabs = TRUE)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">survey</th>
<th align="left">year</th>
<th align="left">newid</th>
<th align="right">finlwt21</th>
<th align="right">cost</th>
<th align="left">ucc</th>
<th align="left">ref_yr</th>
<th align="right">ref_mo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">D</td>
<td align="left">2010</td>
<td align="left">01077271</td>
<td align="right">36400.79</td>
<td align="right">58.5000</td>
<td align="left">190114</td>
<td align="left">2010</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">D</td>
<td align="left">2010</td>
<td align="left">01113982</td>
<td align="right">20848.16</td>
<td align="right">14.3000</td>
<td align="left">190113</td>
<td align="left">2010</td>
<td align="right">9</td>
</tr>
<tr class="odd">
<td align="left">D</td>
<td align="left">2010</td>
<td align="left">01072932</td>
<td align="right">30438.06</td>
<td align="right">234.0000</td>
<td align="left">190114</td>
<td align="left">2010</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">I</td>
<td align="left">2010</td>
<td align="left">02185554</td>
<td align="right">15130.05</td>
<td align="right">104.0000</td>
<td align="left">790430</td>
<td align="left">2010</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">I</td>
<td align="left">2010</td>
<td align="left">02293872</td>
<td align="right">17276.10</td>
<td align="right">60.0000</td>
<td align="left">190903</td>
<td align="left">2010</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">I</td>
<td align="left">2010</td>
<td align="left">02334032</td>
<td align="right">24310.86</td>
<td align="right">233.3333</td>
<td align="left">800700</td>
<td align="left">2010</td>
<td align="right">9</td>
</tr>
<tr class="odd">
<td align="left">D</td>
<td align="left">2020</td>
<td align="left">04374641</td>
<td align="right">51933.91</td>
<td align="right">319.8000</td>
<td align="left">190321</td>
<td align="left">2020</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">D</td>
<td align="left">2020</td>
<td align="left">04450382</td>
<td align="right">55277.16</td>
<td align="right">64.8700</td>
<td align="left">190311</td>
<td align="left">2020</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">D</td>
<td align="left">2020</td>
<td align="left">04362691</td>
<td align="right">42724.20</td>
<td align="right">76.4400</td>
<td align="left">190321</td>
<td align="left">2020</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">I</td>
<td align="left">2020</td>
<td align="left">04324332</td>
<td align="right">30819.70</td>
<td align="right">200.0000</td>
<td align="left">190903</td>
<td align="left">2020</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">I</td>
<td align="left">2020</td>
<td align="left">04506691</td>
<td align="right">21062.71</td>
<td align="right">35.0000</td>
<td align="left">190903</td>
<td align="left">2020</td>
<td align="right">8</td>
</tr>
<tr class="even">
<td align="left">I</td>
<td align="left">2020</td>
<td align="left">04419663</td>
<td align="right">31004.50</td>
<td align="right">200.0000</td>
<td align="left">190903</td>
<td align="left">2020</td>
<td align="right">11</td>
</tr>
</tbody>
</table>
<p>Since I’m going to adjust for inflation, I also want to see the years
in which expenditures were made just as an extra check.</p>
<pre class="r"><code>food_away_comp_data %&gt;%
  drop_na(ref_yr) %&gt;%
  distinct(ref_yr) %&gt;%
  kable(booktabs = TRUE)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">ref_yr</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2010</td>
</tr>
<tr class="even">
<td align="left">2020</td>
</tr>
</tbody>
</table>
<p>This means I’ll need CPI data for the above years as well as 2022.
Next I’ll use the <code>blsR</code> package (<a
href="https://github.com/groditi/blsR"
class="uri">https://github.com/groditi/blsR</a>) to get CPI data. I’m
going to use the “All Urban Consumers (Current Series)” series, which
has series ID “CUUR0000SA0”.</p>
<p>N.B., the <code>blsR</code> package does have functions for tyding
data, but I’ve discovered that in this case at the time of this writing,
the <code>data_as_table()</code> and <code>data_as_tidy_table()</code>
were erroring out, so I’m using some <code>purrr</code> functions to do
the wrangling.</p>
<pre class="r"><code>cpi_data &lt;- blsR::get_series(
  &quot;CUUR0000SA0&quot;,
  start_year = 2010,
  end_year = 2022
) %&gt;%
  pluck(&quot;data&quot;) %&gt;%
  map(
    ~ list_flatten(.x) %&gt;%
      enframe() %&gt;%
      filter(!name %in% &quot;footnotes&quot;) %&gt;%
      unnest(value) %&gt;%
      pivot_wider(everything(), values_from = &quot;value&quot;, names_from = &quot;name&quot;)
  ) %&gt;%
  list_rbind() %&gt;%
  rename(cpi = &quot;value&quot;) %&gt;%
  mutate(month = match(periodName, month.name))

cpi_base &lt;- cpi_data %&gt;% filter(latest %in% &quot;true&quot;)

cpi_data &lt;- cpi_data %&gt;% filter(year %in% c(&quot;2010&quot;, &quot;2020&quot;))

cpi_data %&gt;% slice(1:10) %&gt;% kable(booktabs = TRUE)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">year</th>
<th align="left">period</th>
<th align="left">periodName</th>
<th align="left">latest</th>
<th align="left">cpi</th>
<th align="right">month</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2020</td>
<td align="left">M12</td>
<td align="left">December</td>
<td align="left">NA</td>
<td align="left">260.474</td>
<td align="right">12</td>
</tr>
<tr class="even">
<td align="left">2020</td>
<td align="left">M11</td>
<td align="left">November</td>
<td align="left">NA</td>
<td align="left">260.229</td>
<td align="right">11</td>
</tr>
<tr class="odd">
<td align="left">2020</td>
<td align="left">M10</td>
<td align="left">October</td>
<td align="left">NA</td>
<td align="left">260.388</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="left">2020</td>
<td align="left">M09</td>
<td align="left">September</td>
<td align="left">NA</td>
<td align="left">260.280</td>
<td align="right">9</td>
</tr>
<tr class="odd">
<td align="left">2020</td>
<td align="left">M08</td>
<td align="left">August</td>
<td align="left">NA</td>
<td align="left">259.918</td>
<td align="right">8</td>
</tr>
<tr class="even">
<td align="left">2020</td>
<td align="left">M07</td>
<td align="left">July</td>
<td align="left">NA</td>
<td align="left">259.101</td>
<td align="right">7</td>
</tr>
<tr class="odd">
<td align="left">2020</td>
<td align="left">M06</td>
<td align="left">June</td>
<td align="left">NA</td>
<td align="left">257.797</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">2020</td>
<td align="left">M05</td>
<td align="left">May</td>
<td align="left">NA</td>
<td align="left">256.394</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="left">2020</td>
<td align="left">M04</td>
<td align="left">April</td>
<td align="left">NA</td>
<td align="left">256.389</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">2020</td>
<td align="left">M03</td>
<td align="left">March</td>
<td align="left">NA</td>
<td align="left">258.115</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
<p>The base that I’m going to covert to is November 2022.</p>
<pre class="r"><code>cpi_base %&gt;% kable(booktabs = TRUE)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">year</th>
<th align="left">period</th>
<th align="left">periodName</th>
<th align="left">latest</th>
<th align="left">cpi</th>
<th align="right">month</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2022</td>
<td align="left">M11</td>
<td align="left">November</td>
<td align="left">true</td>
<td align="left">297.711</td>
<td align="right">11</td>
</tr>
</tbody>
</table>
<p>Next I’m going to join the CPI data to the CE data and adjust the
“cost” variable for inflation. Note that I replace resulting missing
values in the “cost” variable with “0”. Missing values will result when
I multiply a cost of “0” by an adjustment factor and
<code>ce_mean()</code> will not function with missing values.</p>
<pre class="r"><code>food_away_comp_data &lt;- food_away_comp_data %&gt;%
  left_join(
    select(cpi_data, year, month, cpi),
    by = c(&quot;ref_yr&quot; = &quot;year&quot;, &quot;ref_mo&quot; = &quot;month&quot;)
  ) %&gt;%
  mutate(
    base_cpi = pull(cpi_base, cpi),
    across(c(base_cpi, cpi), as.numeric),
    cost = cost * (base_cpi / cpi) %&gt;% replace_na(0)
  )

food_away_comp_data %&gt;%
  select(survey, year, newid, finlwt21, cost, ucc, ref_yr, ref_mo) %&gt;%
  filter(!is.na(ucc)) %&gt;%
  group_by(year, survey) %&gt;%
  slice_sample(n = 3) %&gt;%
  ungroup() %&gt;%
  kable(booktabs = TRUE)</code></pre>
<table>
<colgroup>
<col width="10%" />
<col width="7%" />
<col width="14%" />
<col width="17%" />
<col width="17%" />
<col width="10%" />
<col width="10%" />
<col width="10%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">survey</th>
<th align="left">year</th>
<th align="left">newid</th>
<th align="right">finlwt21</th>
<th align="right">cost</th>
<th align="left">ucc</th>
<th align="left">ref_yr</th>
<th align="right">ref_mo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">D</td>
<td align="left">2010</td>
<td align="left">01153501</td>
<td align="right">33879.965</td>
<td align="right">277.70558</td>
<td align="left">190211</td>
<td align="left">2010</td>
<td align="right">11</td>
</tr>
<tr class="even">
<td align="left">D</td>
<td align="left">2010</td>
<td align="left">01071752</td>
<td align="right">27920.376</td>
<td align="right">105.00903</td>
<td align="left">190111</td>
<td align="left">2010</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">D</td>
<td align="left">2010</td>
<td align="left">01152282</td>
<td align="right">34111.184</td>
<td align="right">40.83493</td>
<td align="left">190321</td>
<td align="left">2010</td>
<td align="right">11</td>
</tr>
<tr class="even">
<td align="left">I</td>
<td align="left">2010</td>
<td align="left">02313852</td>
<td align="right">13074.800</td>
<td align="right">109.03218</td>
<td align="left">190903</td>
<td align="left">2010</td>
<td align="right">9</td>
</tr>
<tr class="odd">
<td align="left">I</td>
<td align="left">2010</td>
<td align="left">02244223</td>
<td align="right">18729.821</td>
<td align="right">13.64533</td>
<td align="left">190903</td>
<td align="left">2010</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">I</td>
<td align="left">2010</td>
<td align="left">02252092</td>
<td align="right">11552.995</td>
<td align="right">68.22663</td>
<td align="left">190903</td>
<td align="left">2010</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="left">D</td>
<td align="left">2020</td>
<td align="left">04473832</td>
<td align="right">126457.798</td>
<td align="right">103.40211</td>
<td align="left">190321</td>
<td align="left">2020</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">D</td>
<td align="left">2020</td>
<td align="left">04678152</td>
<td align="right">114644.168</td>
<td align="right">2185.67974</td>
<td align="left">190322</td>
<td align="left">2020</td>
<td align="right">12</td>
</tr>
<tr class="odd">
<td align="left">D</td>
<td align="left">2020</td>
<td align="left">04444432</td>
<td align="right">6478.887</td>
<td align="right">246.11872</td>
<td align="left">190111</td>
<td align="left">2020</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">I</td>
<td align="left">2020</td>
<td align="left">04430893</td>
<td align="right">33312.490</td>
<td align="right">731.73510</td>
<td align="left">190903</td>
<td align="left">2020</td>
<td align="right">10</td>
</tr>
<tr class="odd">
<td align="left">I</td>
<td align="left">2020</td>
<td align="left">04618351</td>
<td align="right">17644.390</td>
<td align="right">365.86755</td>
<td align="left">190903</td>
<td align="left">2020</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="left">I</td>
<td align="left">2020</td>
<td align="left">04286004</td>
<td align="right">18755.279</td>
<td align="right">103.41137</td>
<td align="left">190903</td>
<td align="left">2020</td>
<td align="right">7</td>
</tr>
</tbody>
</table>
<p>The next step is to calculate means, for which I’ll use some more
Tidyverse functions.</p>
<pre class="r"><code>food_away_means &lt;- food_away_comp_data %&gt;%
  nest(data = -c(year, fam_size_label)) %&gt;%
  mutate(ce_mn_df = map(data, ce_mean)) %&gt;%
  select(-data) %&gt;% 
  unnest(ce_mn_df) %&gt;%
  mutate(lower = mean_exp - cv, upper = mean_exp + cv)

food_away_means %&gt;% kable(booktabs = TRUE)</code></pre>
<table style="width:100%;">
<colgroup>
<col width="6%" />
<col width="18%" />
<col width="16%" />
<col width="11%" />
<col width="12%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">year</th>
<th align="left">fam_size_label</th>
<th align="right">agg_exp</th>
<th align="right">mean_exp</th>
<th align="right">se</th>
<th align="right">cv</th>
<th align="right">lower</th>
<th align="right">upper</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2010</td>
<td align="left">2</td>
<td align="right">130420221196</td>
<td align="right">3299.820</td>
<td align="right">98.42922</td>
<td align="right">2.982866</td>
<td align="right">3296.838</td>
<td align="right">3302.803</td>
</tr>
<tr class="even">
<td align="left">2010</td>
<td align="left">3</td>
<td align="right">67021069687</td>
<td align="right">3810.955</td>
<td align="right">183.66110</td>
<td align="right">4.819293</td>
<td align="right">3806.136</td>
<td align="right">3815.774</td>
</tr>
<tr class="odd">
<td align="left">2010</td>
<td align="left">1</td>
<td align="right">72428285424</td>
<td align="right">2067.680</td>
<td align="right">85.10479</td>
<td align="right">4.115956</td>
<td align="right">2063.564</td>
<td align="right">2071.796</td>
</tr>
<tr class="even">
<td align="left">2010</td>
<td align="left">5+</td>
<td align="right">57318822679</td>
<td align="right">4404.588</td>
<td align="right">257.43849</td>
<td align="right">5.844780</td>
<td align="right">4398.743</td>
<td align="right">4410.433</td>
</tr>
<tr class="odd">
<td align="left">2010</td>
<td align="left">4</td>
<td align="right">74679749487</td>
<td align="right">4742.988</td>
<td align="right">202.09679</td>
<td align="right">4.260960</td>
<td align="right">4738.727</td>
<td align="right">4747.248</td>
</tr>
<tr class="even">
<td align="left">2020</td>
<td align="left">1</td>
<td align="right">64576900272</td>
<td align="right">1646.821</td>
<td align="right">81.17216</td>
<td align="right">4.929022</td>
<td align="right">1641.892</td>
<td align="right">1651.750</td>
</tr>
<tr class="odd">
<td align="left">2020</td>
<td align="left">2</td>
<td align="right">118826976839</td>
<td align="right">2734.484</td>
<td align="right">127.43499</td>
<td align="right">4.660295</td>
<td align="right">2729.823</td>
<td align="right">2739.144</td>
</tr>
<tr class="even">
<td align="left">2020</td>
<td align="left">4</td>
<td align="right">66450879297</td>
<td align="right">4058.404</td>
<td align="right">255.44176</td>
<td align="right">6.294144</td>
<td align="right">4052.110</td>
<td align="right">4064.698</td>
</tr>
<tr class="odd">
<td align="left">2020</td>
<td align="left">3</td>
<td align="right">59005969584</td>
<td align="right">3058.002</td>
<td align="right">197.12332</td>
<td align="right">6.446147</td>
<td align="right">3051.556</td>
<td align="right">3064.448</td>
</tr>
<tr class="even">
<td align="left">2020</td>
<td align="left">5+</td>
<td align="right">47067346009</td>
<td align="right">3607.071</td>
<td align="right">318.43740</td>
<td align="right">8.828144</td>
<td align="right">3598.243</td>
<td align="right">3615.899</td>
</tr>
</tbody>
</table>
<p>Plotting these data would be pretty straightforward, as well.</p>
<pre class="r"><code>food_away_means %&gt;%
  ggplot(aes(x = fam_size_label, y = mean_exp, fill = year, group = year)) +
  geom_bar(stat = &quot;identity&quot;, position = &quot;dodge&quot;, width = 0.8) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    width = 0.4,
    position = position_dodge(0.75)
  ) +
  scale_fill_manual(values = c(&quot;red&quot;, &quot;blue&quot;)) +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title =
      &quot;Estimated annual mean food away from home expenditures by CU size&quot;,
    x = &quot;CU size&quot;,
    y = &quot;Estimated, weighted, annual mean expenditure&quot;,
    fill = &quot;Year&quot;
  ) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = &quot;bottom&quot;)</code></pre>
<p><img src="cepumd_files/figure-html/cepumd-plot_food_away_means-1.png" width="100%" /></p>
<p>Here we can see that on an inflation-adjusted basis, households of
all sizes had higher expenditures on food away from home in 2010 than
they did in 2020.</p>
<p>Now I’ll generate a plot of the expenditures at each weighted,
annual, estimated quantile (from 0.01 through 0.99, by 0.01) for the
same years, but only using Diary data, since most of the UCCs (16 out of
21) in the “food away from home” category come from the Diary. I’ll also
make sure that the Diary files are in my data directory first.</p>
<pre class="r"><code>ce_download(2010, diary, food_away_dir)
ce_download(2020, diary, food_away_dir)

food_away_comp_quantiles &lt;- map2(
  c(2010, 2020),
  c(&quot;diary10.zip&quot;, &quot;diary20.zip&quot;),
  ~ ce_prepdata(
    .x,
    diary,
    ce_hg(.x, diary) %&gt;% ce_uccs(food_away_title),
    ce_dir = food_away_dir,
    dia_zp = .y,
    hg = ce_hg(.x, diary)
  ) %&gt;%
    mutate(year = .x, ref_yr = as.character(ref_yr))
) %&gt;%
  list_rbind() %&gt;%
  left_join(
    select(cpi_data, year, month, cpi),
    by = c(&quot;ref_yr&quot; = &quot;year&quot;, &quot;ref_mo&quot; = &quot;month&quot;)
  ) %&gt;%
  mutate(
    base_cpi = pull(cpi_base, cpi),
    across(c(base_cpi, cpi), as.numeric),
    cost = cost * (base_cpi / cpi) %&gt;% replace_na(0)
  ) %&gt;%
  mutate(year = factor(year)) %&gt;%
  nest(data = -year) %&gt;%
  mutate(
    fa_qtile = map(data, ce_quantiles, probs = c(seq(0, 0.95, by = 0.05), 0.99))
  ) %&gt;%
  select(-data) %&gt;%
  unnest(fa_qtile) %&gt;%
  mutate(probs = parse_number(probs) / 100)

food_away_comp_quantiles %&gt;%
  ggplot(aes(x = probs, y = quantile, group = year, color = year)) +
  geom_line() +
  scale_color_manual(values = c(&quot;red&quot;, &quot;blue&quot;)) +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title =
      &quot;Estimated, annual food away from home expenditure quantiles&quot;,
    x = &quot;Quantile&quot;,
    y = &quot;Estimated, weighted, annual expenditure&quot;,
    color = &quot;Year&quot;
  ) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = &quot;bottom&quot;)</code></pre>
<p><img src="cepumd_files/figure-html/cepumd-plot_food_away_quantiles-1.png" width="100%" /></p>
<pre class="r"><code>ce_cleanup(food_away_dir)</code></pre>
<p>Interestingly the expenditures don’t appear to have changed much
between 2010 and 2020 across quantiles on an inflation-adjusted basis,
but we can see that across all quantiles, CU’s spent less in 2020 than
they did in 2010 on food away from home, which is consistent with the
means that we calculated above. There are a lot of 0-value reported
expenditures, though, in the CE on food away from home. Unfortunately, I
can’t perform an analysis using only respondents that did have
expenditures in this category, i.e., dropping the 0’s, because whether
someone had an expenditure on food away from home is not one of the
variables used for generating the survey weights. In other words, the
analysis can be done, but it would not be statistically valid and I
definitely wouldn’t be able to infer from it. This is my cautionary note
to anyone using this package who might use it in a way that is not
statistically sound. Please visit the <a
href="https://www.bls.gov/cex/">CE’s website</a> and read the <a
href="https://www.bls.gov/cex/tables.htm">CE PUMD Getting Started
Guide</a> for more information.</p>
</div>
<div id="dealing-with-inconsistent-code-definitions"
class="section level3">
<h3>Dealing with inconsistent code definitions</h3>
<p>In this workflow I’m going to calculate estimated mean utilities
expenditures for 2015 using integrated data by CU composition using the
FAM_TYPE variable. In this case I’m going to start by looking at the
codes for that variable to show how one might run into an inconsistency
in code definitions across survey instruments. First I’m going to set up
a sub-directory in my temporary directory and store what I’ll need to
get started.</p>
<pre class="r"><code>data_dir &lt;- file.path(tempdir(), &quot;ce-utilities-data&quot;)
dir.create(data_dir)

store_ce_dict(data_dir, &quot;ce-data-dictionary.xlsx&quot;)
store_ce_hg(data_dir, &quot;ce-stubs.zip&quot;)

list.files(data_dir)
#&gt; [1] &quot;ce-data-dictionary.xlsx&quot; &quot;ce-stubs.zip&quot;</code></pre>
<p>Now I can look at the code descriptions for the “FAM_TYPE” variable
in the dictionary.</p>
<pre class="r"><code>ce_codes &lt;- read_excel(
  file.path(data_dir, &quot;ce-data-dictionary.xlsx&quot;),
  sheet = &quot;Codes &quot;
) %&gt;%
  janitor::clean_names() %&gt;%
  select(survey:last_quarter)

ce_codes %&gt;% filter(
  variable %in% &quot;FAM_TYPE&quot;,
  first_year &lt;= 2015,
  (last_year &gt;= 2015 | is.na(last_year)),
  code_value %in% c(&quot;3&quot;, &quot;5&quot;, &quot;7&quot;)
) %&gt;%
  select(survey, code_value, code_description) %&gt;%
  arrange(code_value, survey) %&gt;%
  kable(booktabs = TRUE)</code></pre>
<table>
<colgroup>
<col width="12%" />
<col width="13%" />
<col width="73%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">survey</th>
<th align="left">code_value</th>
<th align="left">code_description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">DIARY</td>
<td align="left">3</td>
<td align="left">Married couple, own children only, oldest child &gt; 6,
&lt; 18</td>
</tr>
<tr class="even">
<td align="left">INTERVIEW</td>
<td align="left">3</td>
<td align="left">Married Couple, own children only oldest child &gt;= 6,
&lt;= 17</td>
</tr>
<tr class="odd">
<td align="left">DIARY</td>
<td align="left">5</td>
<td align="left">All other Married couple families</td>
</tr>
<tr class="even">
<td align="left">INTERVIEW</td>
<td align="left">5</td>
<td align="left">All other Husband and wife families</td>
</tr>
<tr class="odd">
<td align="left">DIARY</td>
<td align="left">7</td>
<td align="left">One parent, female, own children, at least one age &lt;
18</td>
</tr>
<tr class="even">
<td align="left">INTERVIEW</td>
<td align="left">7</td>
<td align="left">One parent, female, own children, at least one age &lt;
18</td>
</tr>
</tbody>
</table>
<p>The code descriptions for these 3 code values are different across
instruments. To resolve this I’m going to create a table containing only
codes from the Interview survey.</p>
<pre class="r"><code>fam_type_codes &lt;- ce_codes %&gt;%
  filter(
    variable %in% &quot;FAM_TYPE&quot;,
    first_year &lt;= 2015,
    (last_year &gt;= 2015 | is.na(last_year))
  )

codes2keep &lt;- fam_type_codes %&gt;%
  filter(survey %in% &quot;INTERVIEW&quot;) %&gt;%
  select(code_value, code_description)

fam_type_codes &lt;- fam_type_codes %&gt;%
  select(-code_description) %&gt;%
  left_join(codes2keep, by = &quot;code_value&quot;) %&gt;%
  relocate(code_description, .after = code_value)

fam_type_codes %&gt;%
  filter(code_value %in% c(&quot;3&quot;, &quot;5&quot;, &quot;7&quot;)) %&gt;%
  select(survey, code_value, code_description) %&gt;%
  arrange(code_value, survey) %&gt;%
  kable(booktabs = TRUE)</code></pre>
<table>
<colgroup>
<col width="12%" />
<col width="13%" />
<col width="73%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">survey</th>
<th align="left">code_value</th>
<th align="left">code_description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">DIARY</td>
<td align="left">3</td>
<td align="left">Married Couple, own children only oldest child &gt;= 6,
&lt;= 17</td>
</tr>
<tr class="even">
<td align="left">INTERVIEW</td>
<td align="left">3</td>
<td align="left">Married Couple, own children only oldest child &gt;= 6,
&lt;= 17</td>
</tr>
<tr class="odd">
<td align="left">DIARY</td>
<td align="left">5</td>
<td align="left">All other Husband and wife families</td>
</tr>
<tr class="even">
<td align="left">INTERVIEW</td>
<td align="left">5</td>
<td align="left">All other Husband and wife families</td>
</tr>
<tr class="odd">
<td align="left">DIARY</td>
<td align="left">7</td>
<td align="left">One parent, female, own children, at least one age &lt;
18</td>
</tr>
<tr class="even">
<td align="left">INTERVIEW</td>
<td align="left">7</td>
<td align="left">One parent, female, own children, at least one age &lt;
18</td>
</tr>
</tbody>
</table>
<p>Now the codes are consistent across survey instruments and I can use
this codebook in my call to <code>ce_prepdata()</code> using the
“own_codebook” argument. Then I’ll pass that to <code>ce_mean()</code>
per usual.</p>
<p>Next I’ll get some information about how utilities expenditures are
organized using the stub file.</p>
<pre class="r"><code>hg_15 &lt;- ce_hg(2015, integrated, data_dir, &quot;ce-stubs.zip&quot;)

hg_15 %&gt;% filter(str_detect(title, &quot;[U|u]tilities&quot;)) %&gt;% kable(booktabs = TRUE)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">level</th>
<th align="left">title</th>
<th align="left">ucc</th>
<th align="left">survey</th>
<th align="left">factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">3</td>
<td align="left">Utilities, fuels, and public services</td>
<td align="left">UTILS</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
</tbody>
</table>
<p>The expenditure category associated with utilities is “Utilities,
fuels, and public services”. I’ll store that title to work with later
and narrow down the section of the stub file that includes only these
expenditures.</p>
<pre class="r"><code>utilities_title &lt;- hg_15 %&gt;%
  filter(str_detect(title, &quot;[U|u]tilities&quot;)) %&gt;%
  pull(title)

utilities_hg &lt;- ce_uccs(hg_15, expenditure = utilities_title, uccs_only = FALSE)

utilities_hg %&gt;% kable(booktabs = TRUE)</code></pre>
<table style="width:100%;">
<colgroup>
<col width="7%" />
<col width="64%" />
<col width="9%" />
<col width="9%" />
<col width="9%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">level</th>
<th align="left">title</th>
<th align="left">ucc</th>
<th align="left">survey</th>
<th align="left">factor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">3</td>
<td align="left">Utilities, fuels, and public services</td>
<td align="left">UTILS</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">Natural gas</td>
<td align="left">NATRLG</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">Utility-natural gas (renter)</td>
<td align="left">260211</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Utility-natural gas (owned home)</td>
<td align="left">260212</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">Utility-natural gas (owned vacation)</td>
<td align="left">260213</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Utility-natural gas (rented vacation)</td>
<td align="left">260214</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">4</td>
<td align="left">Electricity</td>
<td align="left">ELECTR</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Electricity (renter)</td>
<td align="left">260111</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">Electricity (owned home)</td>
<td align="left">260112</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Electricity (owned vacation)</td>
<td align="left">260113</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">Electricity (rented vacation)</td>
<td align="left">260114</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">Fuel oil and other fuels</td>
<td align="left">OTHRFU</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">Fuel oil</td>
<td align="left">FUELOI</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Fuel oil (renter)</td>
<td align="left">250111</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Fuel oil (owned home)</td>
<td align="left">250112</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Fuel oil (owned vacation)</td>
<td align="left">250113</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Fuel oil (rented vacation)</td>
<td align="left">250114</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Coal, wood, and other fuels</td>
<td align="left">CLWDOT</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Coal, wood, other fuels (renter)</td>
<td align="left">250911</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Coal, wood, other fuels (owned home)</td>
<td align="left">250912</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Coal, wood, other fuels (owned vacation)</td>
<td align="left">250913</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Coal, wood, other fuels (rented vacation)</td>
<td align="left">250914</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">Bottled gas</td>
<td align="left">BOTTLG</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Gas, btld/tank (renter)</td>
<td align="left">250211</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Gas, btld/tank (owned home)</td>
<td align="left">250212</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Gas, btld/tank (owned vacation)</td>
<td align="left">250213</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Gas, btld/tank (rented vacation)</td>
<td align="left">250214</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">Telephone services</td>
<td align="left">PHONE</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">Residential phone service, VOIP, and phone cards</td>
<td align="left">RESPHO</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Phone cards</td>
<td align="left">270104</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Residential telephone including VOIP</td>
<td align="left">270106</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Cellular phone service</td>
<td align="left">270102</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">4</td>
<td align="left">Water and other public services</td>
<td align="left">WATER</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Water and sewerage maintenance</td>
<td align="left">SEWER</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Water/sewer maint. (renter)</td>
<td align="left">270211</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Water/sewer maint. (owned home)</td>
<td align="left">270212</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Water/sewer maint. (owned vacation)</td>
<td align="left">270213</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Water/sewer maint. (rented vacation)</td>
<td align="left">270214</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">Trash and garbage collection</td>
<td align="left">TRASH</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Trash/garb. coll. (renter)</td>
<td align="left">270411</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Trash/garb. coll. (owned home)</td>
<td align="left">270412</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Trash/garb. coll. (owned vacation)</td>
<td align="left">270413</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Trash/garb. coll. (rented vacation)</td>
<td align="left">270414</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Septic tank cleaning</td>
<td align="left">SEPTAN</td>
<td align="left">G</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Septic tank clean. (renter)</td>
<td align="left">270901</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Septic tank clean. (owned home)</td>
<td align="left">270902</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">6</td>
<td align="left">Septic tank clean. (owned vacation)</td>
<td align="left">270903</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">Septic tank clean. (rented vacation)</td>
<td align="left">270904</td>
<td align="left">I</td>
<td align="left">1</td>
</tr>
</tbody>
</table>
<p>I also want to know what survey instruments the expenditures are
collected through for published estimates. My stub file is the
integrated stub file, so I should see both “I” and “D” in the survey
colum of the stub file if expenditures are collected through both
instruments.</p>
<pre class="r"><code>utilities_hg %&gt;% distinct(survey) %&gt;% kable(booktabs = TRUE)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">survey</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">G</td>
</tr>
<tr class="even">
<td align="left">I</td>
</tr>
</tbody>
</table>
<p>It seems utlities expenditures are collected only through the
Interview survey, so I’ll only need to download Interview data
files.</p>
<pre class="r"><code>ce_download(2015, interview, data_dir)</code></pre>
<p>Now I can go ahead and calculate estimates.</p>
<pre class="r"><code>
fam_type_utilities &lt;- ce_prepdata(
  2015,
  interview,
  ce_uccs(utilities_hg, expenditure = utilities_title, uccs_only = TRUE),
  recode_variables = TRUE,
  own_codebook = fam_type_codes,
  ce_dir = data_dir,
  int_zp = &quot;intrvw15.zip&quot;,
  hg = utilities_hg,
  fam_type
) %&gt;%
  nest(data = -fam_type) %&gt;%
  mutate(ce_mean_df = map(data, ce_mean)) %&gt;%
  select(-data) %&gt;%
  unnest(ce_mean_df)

fam_type_utilities %&gt;% arrange(fam_type) %&gt;% kable(booktabs = TRUE)</code></pre>
<table style="width:100%;">
<colgroup>
<col width="58%" />
<col width="12%" />
<col width="8%" />
<col width="9%" />
<col width="9%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">fam_type</th>
<th align="right">agg_exp</th>
<th align="right">mean_exp</th>
<th align="right">se</th>
<th align="right">cv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Married Couple only</td>
<td align="right">122623482952</td>
<td align="right">4378.377</td>
<td align="right">76.25699</td>
<td align="right">1.741673</td>
</tr>
<tr class="even">
<td align="left">Married Couple, own children only, oldest child &lt;
6</td>
<td align="right">21592090354</td>
<td align="right">4073.529</td>
<td align="right">241.48233</td>
<td align="right">5.928087</td>
</tr>
<tr class="odd">
<td align="left">Married Couple, own children only oldest child &gt;= 6,
&lt;= 17</td>
<td align="right">73899626502</td>
<td align="right">5136.781</td>
<td align="right">132.53306</td>
<td align="right">2.580080</td>
</tr>
<tr class="even">
<td align="left">Married Couple, own children only, oldest child &gt;
17</td>
<td align="right">53687574363</td>
<td align="right">5585.027</td>
<td align="right">190.15164</td>
<td align="right">3.404668</td>
</tr>
<tr class="odd">
<td align="left">All other Husband and wife families</td>
<td align="right">26767356778</td>
<td align="right">5699.177</td>
<td align="right">331.83382</td>
<td align="right">5.822487</td>
</tr>
<tr class="even">
<td align="left">One parent, male, own children at least one age &lt;
18</td>
<td align="right">4647315390</td>
<td align="right">3887.863</td>
<td align="right">532.21229</td>
<td align="right">13.689069</td>
</tr>
<tr class="odd">
<td align="left">One parent, female, own children, at least one age &lt;
18</td>
<td align="right">22862016917</td>
<td align="right">3684.480</td>
<td align="right">237.12762</td>
<td align="right">6.435851</td>
</tr>
<tr class="even">
<td align="left">Single consumers</td>
<td align="right">88002147354</td>
<td align="right">2348.182</td>
<td align="right">40.59815</td>
<td align="right">1.728919</td>
</tr>
<tr class="odd">
<td align="left">Other families</td>
<td align="right">84986387660</td>
<td align="right">3942.345</td>
<td align="right">122.97865</td>
<td align="right">3.119429</td>
</tr>
</tbody>
</table>
<p>And finally, a quick lollipop plot.</p>
<pre class="r"><code>fam_type_utilities %&gt;%
  mutate(fam_type = fct_reorder(fam_type, mean_exp)) %&gt;%
  ggplot(aes(x = mean_exp, y = fam_type, mean_exp)) +
  geom_segment(aes(x = 0, xend = mean_exp, yend = fam_type)) +
  geom_point(color = &quot;red&quot;, size = 5) +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 25)) +
  scale_x_continuous(labels = scales::dollar) +
  labs(
    y = &quot;CU composition (FAM_TYPE)&quot;,
    x = &quot;Estimated, weighted, annual mean expenditure&quot;,
    title =
      &quot;Estimated annual mean utilities expenditures by CU composition&quot;
  ) +
  theme_bw()</code></pre>
<p><img src="cepumd_files/figure-html/cepumd-plot_fam_type_utilities-1.png" width="100%" /></p>
<pre class="r"><code>ce_cleanup(data_dir)</code></pre>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
